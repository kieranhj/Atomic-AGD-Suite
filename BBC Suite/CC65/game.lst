ca65 V2.17 - Git cc5c093
Main file   : game.asm
Current file: game.asm

000000r 1               ;----------------------------------------------
000000r 1               ; BBC AGD Engine
000000r 1               ; Z80 conversion by Kees van Oss 2017
000000r 1               ; BBC Micro version by Kieran Connell 2018
000000r 1               ;----------------------------------------------
000000r 1               
000000r 1               .DEFINE asm_code $0e00		; assembly address _BEEB
000000r 1               .DEFINE load_address $1200	; load address _BEEB
000000r 1               
000000r 1               ;----------------------------------------------------------------------
000000r 1               ; BBC MICRO PLATFORM DEFINES
000000r 1               ;----------------------------------------------------------------------
000000r 1               
000000r 1               ; _BEEB MOS calls
000000r 1               
000000r 1               	OSBYTE	 = $fff4
000000r 1               	OSFILE	 = $ffdd
000000r 1               	OSWRCH	 = $ffee
000000r 1               	OSASCI	 = $ffe3
000000r 1               	OSWORD	 = $fff1
000000r 1               	OSFIND	 = $ffce
000000r 1               	OSGBPB	 = $ffd1
000000r 1               	OSARGS	 = $ffda
000000r 1               
000000r 1               	EVENTV	 = $0220
000000r 1               
000000r 1               	PAL_black = 0 ^ 7
000000r 1               	PAL_red = 1 ^ 7
000000r 1               	PAL_green = 2 ^ 7
000000r 1               	PAL_yellow = 3 ^ 7
000000r 1               	PAL_blue = 4 ^ 7
000000r 1               	PAL_magenta = 5 ^ 7
000000r 1               	PAL_cyan = 6 ^ 7
000000r 1               	PAL_white = 7 ^ 7
000000r 1               
000000r 1               ; System constants
000000r 1               
000000r 1               	ScreenSize  = $3000	; Startaddress video RAM _BEEB
000000r 1               	ScreenAddr 	= $8000 - ScreenSize	; Screen size bytes _BEEB
000000r 1               	ScreenRowBytes = 512				; 40 columns
000000r 1               
000000r 1               	SpriteMaxY	= 177	; used for clipping bottom of screen
000000r 1               
000000r 1               ; AGD Engine Workspace
000000r 1               
000000r 1               	MAP 		= $300				; properties map buffer (3x256 bytes)
000000r 1               	SCADTB_lb	= MAP + $300
000000r 1               	SCADTB_hb	= SCADTB_lb + $100
000000r 1               
000000r 1               .if pflag
000000r 1                   SHRAPN 		= $B00 - (NUMSHR * SHRSIZ)	; shrapnel table (55x6 bytes)
000000r 1               .endif
000000r 1               
000000r 1               	sprtab		= $B00				; NUMSPR*TABSIZ
000000r 1               
000000r 1               	.macro DEBUG_PAL pal
000000r 1               	;	SET_PAL pal
000000r 1               	.endmacro
000000r 1               
000000r 1               	.macro SET_PAL pal
000000r 1               		lda #$00+pal
000000r 1               		sta $fe21
000000r 1               		lda #$10+pal
000000r 1               		sta $fe21
000000r 1               		lda #$20+pal
000000r 1               		sta $fe21
000000r 1               		lda #$30+pal
000000r 1               		sta $fe21
000000r 1               		lda #$40+pal
000000r 1               		sta $fe21
000000r 1               		lda #$50+pal
000000r 1               		sta $fe21
000000r 1               		lda #$60+pal
000000r 1               		sta $fe21
000000r 1               		lda #$70+pal
000000r 1               		sta $fe21
000000r 1               	.endmacro
000000r 1               
000000r 1               ;----------------------------------------------------------------------
000000r 1               ; ZERO PAGE SEGMENT
000000r 1               ;----------------------------------------------------------------------
000000r 1               
000000r 1               .segment "ZEROPAGE"
000000r 1               
000000r 1               .include "z80-zp.inc"
000000r 2               ;ws	 = $60
000000r 2               
000000r 2  xx           z80_f: .res 1;	 = ws+$00
000001r 2  xx           z80_a: .res 1;	 = ws+$01
000002r 2               z80_af	 = z80_f
000002r 2               
000002r 2  xx           z80_c: .res 1;	 = ws+$02
000003r 2  xx           z80_b: .res 1;	 = ws+$03
000004r 2               z80_bc	 = z80_c
000004r 2               
000004r 2  xx           z80_e: .res 1;	 = ws+$04
000005r 2  xx           z80_d: .res 1;	 = ws+$05
000006r 2               z80_de	 = z80_e
000006r 2               
000006r 2  xx           z80_l: .res 1;	 = ws+$06
000007r 2  xx           z80_h: .res 1;	 = ws+$07
000008r 2               z80_hl	 = z80_l
000008r 2               
000008r 2  xx           z80_x: .res 1;    = ws+$08
000009r 2  xx           z80_i: .res 1;    = ws+$09
00000Ar 2               z80_ix	 = z80_x
00000Ar 2               
00000Ar 2  xx xx        z80_iy: .res 2;	 = ws+$0a
00000Cr 2               
00000Cr 2  xx           z80_fp: .res 1;	 = ws+$0c
00000Dr 2  xx           z80_ap: .res 1;	 = ws+$0d
00000Er 2               
00000Er 2  xx           z80_cp: .res 1;	 = ws+$0e
00000Fr 2  xx           z80_bp: .res 1;	 = ws+$0f
000010r 2               z80_bcp	 = z80_cp
000010r 2               
000010r 2  xx           z80_ep: .res 1;	 = ws+$10
000011r 2  xx           z80_dp: .res 1;	 = ws+$11
000012r 2               z80_dep	 = z80_ep
000012r 2               
000012r 2  xx           z80_lp: .res 1;	 = ws+$12
000013r 2  xx           z80_hp: .res 1;	 = ws+$13
000014r 2               z80_hlp	 = z80_lp
000014r 2               
000014r 2  xx xx        z80_sp: .res 2;   = ws+$14
000016r 2               
000016r 2  xx           z80_reg0: .res 1; = ws+$16
000017r 2  xx           z80_reg1: .res 1; = ws+$17
000018r 2  xx           z80_reg2: .res 1; = ws+$18
000019r 2  xx           z80_reg3: .res 1; = ws+$19
00001Ar 2               
00001Ar 2               ;z80_r: .res 1;	 = ws+$1a
00001Ar 2               
00001Ar 1               .include "engine-zp.inc"
00001Ar 2               ;----------------------------------------------------------------------
00001Ar 2               ; AGD 6502 Engine Zero Page Variables
00001Ar 2               ;----------------------------------------------------------------------
00001Ar 2               
00001Ar 2               ; Variables start here.
00001Ar 2               
00001Ar 2  xx           scno:	.res 1			; present screen number.
00001Br 2  xx           numlif:	.res 1			; number of lives.
00001Cr 2               
00001Cr 2  xx           vara:	.res 1			; general-purpose variable.
00001Dr 2  xx           varb:	.res 1			; general-purpose variable.
00001Er 2  xx           varc:	.res 1			; general-purpose variable.
00001Fr 2  xx           vard:	.res 1			; general-purpose variable.
000020r 2  xx           vare:	.res 1			; general-purpose variable.
000021r 2  xx           varf:	.res 1			; general-purpose variable.
000022r 2  xx           varg:	.res 1			; general-purpose variable.
000023r 2  xx           varh:	.res 1			; general-purpose variable.
000024r 2  xx           vari:	.res 1			; general-purpose variable.
000025r 2  xx           varj:	.res 1			; general-purpose variable.
000026r 2  xx           vark:	.res 1			; general-purpose variable.
000027r 2  xx           varl:	.res 1			; general-purpose variable.
000028r 2  xx           varm:	.res 1			; general-purpose variable.
000029r 2  xx           varn:	.res 1			; general-purpose variable.
00002Ar 2  xx           varo:	.res 1			; general-purpose variable.
00002Br 2  xx           varp:	.res 1			; general-purpose variable.
00002Cr 2  xx           varq:	.res 1			; general-purpose variable.
00002Dr 2  xx           varr:	.res 1			; general-purpose variable.
00002Er 2  xx           vars:	.res 1			; general-purpose variable.
00002Fr 2  xx           vart:	.res 1			; general-purpose variable.
000030r 2  xx           varu:	.res 1			; general-purpose variable.
000031r 2  xx           varv:	.res 1			; general-purpose variable.
000032r 2  xx           varw:	.res 1			; general-purpose variable.
000033r 2  xx           varz:	.res 1			; general-purpose variable.
000034r 2               
000034r 2  xx           charx:	.res 1			; cursor x position.
000035r 2  xx           chary:	.res 1			; cursor y position.
000036r 2               
000036r 2  xx           clock:	.res 1			; last clock reading.
000037r 2  xx           varrnd:	.res 1	        ; last random number.
000038r 2  xx           varobj:	.res 1  	    ; last object number.
000039r 2  xx           varopt:	.res 1     		; last option chosen from menu.
00003Ar 2  xx           varblk:	.res 1  		; block type.
00003Br 2  xx           nexlev:	.res 1			; next level flag.
00003Cr 2  xx           restfl:	.res 1			; restart screen flag.
00003Dr 2  xx           deadf:	.res 1			; dead flag.
00003Er 2  xx           gamwon:	.res 1			; game won flag.
00003Fr 2  xx           dispx:	.res 1			; cursor x position.
000040r 2  xx           dispy:	.res 1			; cursor y position.
000041r 2               
000041r 2  xx           contrl:	.res 1			; control = keyboard, 1 = Kempston, 2 = Sinclair, 3 = Mouse.
000042r 2  xx           joyval:	.res 1			; joystick reading.
000043r 2  xx           frmno:	.res 1			; selected frame.
000044r 2               
000044r 2               ;----------------------------------------------------
000044r 2               ; Missing vars
000044r 2               ;----------------------------------------------------
000044r 2               
000044r 2  xx           loopa:		.res 1
000045r 2  xx           loopb:		.res 1
000046r 2  xx           loopc:		.res 1
000047r 2  xx xx        FontPtr:    .res 2
000049r 2               
000049r 2               ; Local vars
000049r 2               
000049r 2  xx xx        scraddr:    .res 2
00004Br 2  xx xx        fntaddr:    .res 2
00004Dr 2  xx xx        tileaddr:   .res 2
00004Fr 2  xx xx        bufaddr:    .res 2
000051r 2               
000051r 2  xx xx        tmp:        .res 2
000053r 2  xx xx        scr_l:      .res 2
000055r 2  xx xx        scr_r:      .res 2
000057r 2  xx xx        scr_txt:    .res 2
000059r 2               
000059r 2  xx           xtmp:	    .res 1
00005Ar 2  xx           spcnt:	    .res 1
00005Br 2  xx xx        spptr:	    .res 2		; spawned sprite pointer.
00005Dr 2  xx           seed:	    .res 1		; seed for random numbers.
00005Er 2               
00005Er 2  xx           ccnt:       .res 1
00005Fr 2  xx           flag:	    .res 1
000060r 2  xx           rcol:	    .res 1
000061r 2  xx           rrow:	    .res 1
000062r 2               
000062r 2  xx           combyt:	    .res 1		; byte type compressed.
000063r 2  xx           comcnt:	    .res 1		; compression counter.
000064r 2  xx           prtmod:	    .res 1      ; print mode, 0 = standard, 1 = double-height.
000065r 2  xx           qscnt:	    .res 1
000066r 2               
000066r 2  xx           sprptr:	    .res 1      ; not a ptr
000067r 2  xx           sprcnt:	    .res 1
000068r 2               
000068r 2  xx xx        skptr:	    .res 2		; search pointer.
00006Ar 2  xx           sktptr:	    .res 1      ; not a ptr
00006Br 2  xx           tmproom:	.res 1
00006Cr 2  xx xx        ogptr:	    .res 2		; original sprite pointer.
00006Er 2               
00006Er 2  xx xx xx     spr:	    .res 3      ; static sprite data
000071r 2  xx           vsync_count:.res 1
000072r 2  xx           colpatt:	.res 1
000073r 2  xx           sprtmp:     .res 1
000074r 2  xx           sprtmp2:    .res 1
000075r 2  xx           sprshft:    .res 1
000076r 2               
000076r 2  xx           spriteink:  .res 1
000077r 2  xx           colour_byte:.res 1
000078r 2  xx           colour_xor: .res 1
000079r 2               
000079r 2               .if mflag
000079r 2               TmpAddr:	.res 2
000079r 2               bwid:	    .res 1     ; box/menu width.
000079r 2               blen:	    .res 1     ; box/menu height.
000079r 2               btop:	    .res 1     ; box coordinates.
000079r 2               blft:	    .res 1
000079r 2               .endif
000079r 2               
000079r 2               .if pflag
000079r 2               shrctr:	    .res 1
000079r 2               explcnt:	.res 1
000079r 2               seed3:	    .res 1
000079r 2               .endif
000079r 2               
000079r 1               
000079r 1               ;----------------------------------------------------------------------
000079r 1               ; ZCODE SEGMENT
000079r 1               ;----------------------------------------------------------------------
000079r 1               
000079r 1               .segment "CODE"
000000r 1               .org asm_code
000E00  1               
000E00  1               start_asm:
000E00  1               
000E00  1  4C F5 50     	jmp relocate + load_address - asm_code
000E03  1               
000E03  1               boot_game:
000E03  1               
000E03  1               ; Zero ZP vars
000E03  1               
000E03  1               clear_zp:
000E03  1  A2 00        	ldx #0
000E05  1  8A           	txa
000E06  1               	:
000E06  1  95 00        	sta $00, x
000E08  1  E8           	inx
000E09  1  E0 A0        	cpx #$a0
000E0B  1  D0 F9        	bne :-
000E0D  1               
000E0D  1               	; Init non-zero vars
000E0D  1  A9 03        	lda #3
000E0F  1  85 rr        	sta numlif
000E11  1               
000E11  1  A2 FF        	ldx #255
000E13  1  86 rr        	stx varrnd
000E15  1  86 rr        	stx varopt
000E17  1  86 rr        	stx varblk
000E19  1  CA           	dex
000E1A  1  86 rr        	stx varobj
000E1C  1               
000E1C  1               	; TEMP
000E1C  1  A9 FF        	lda #$ff
000E1E  1  85 rr        	sta colour_byte
000E20  1               
000E20  1  20 84 0E     	jsr bbcinit
000E23  1               
000E23  1               	; Call AGD Engine start game
000E23  1  20 00 18     	jsr start_game
000E26  1               
000E26  1  20 A3 0E     	jsr bbckill
000E29  1               
000E29  1                   ; Wait for keypress
000E29  1  A2 FF        	ldx #$ff
000E2B  1  A0 7F        	ldy #$7f
000E2D  1  A9 81        	lda #$81
000E2F  1  20 F4 FF     	jsr OSBYTE
000E32  1               
000E32  1               	; Restart or exit
000E32  1  4C 03 0E     	jmp boot_game
000E35  1               
000E35  1               ;----------------------------------------------------------------------
000E35  1               ; PLATFORM SPECIFIC ENGINE CODE
000E35  1               ;----------------------------------------------------------------------
000E35  1               
000E35  1               	.include "z80.asm"
000E35  2               ;------------------------------------------------------
000E35  2               ; z80.asm
000E35  2               ; spectrum stuff
000E35  2               ; adresses
000E35  2               
000E35  2               ;ws	 = $60
000E35  2               
000E35  2               ;z80_f	 = ws+$00
000E35  2               ;z80_a	 = ws+$01
000E35  2               ;z80_af	 = z80_f
000E35  2               
000E35  2               ;z80_c	 = ws+$02
000E35  2               ;z80_b	 = ws+$03
000E35  2               ;z80_bc	 = z80_c
000E35  2               
000E35  2               ;z80_e	 = ws+$04
000E35  2               ;z80_d	 = ws+$05
000E35  2               ;z80_de	 = z80_e
000E35  2               
000E35  2               ;z80_l	 = ws+$06
000E35  2               ;z80_h	 = ws+$07
000E35  2               ;z80_hl	 = z80_l
000E35  2               
000E35  2               ;z80_x    = ws+$08
000E35  2               ;z80_i    = ws+$09
000E35  2               ;z80_ix	 = z80_x
000E35  2               
000E35  2               ;z80_iy	 = ws+$0a
000E35  2               
000E35  2               ;z80_fp	 = ws+$0c
000E35  2               ;z80_ap	 = ws+$0d
000E35  2               
000E35  2               ;z80_cp	 = ws+$0e
000E35  2               ;z80_bp	 = ws+$0f
000E35  2               ;z80_bcp = z80_cp
000E35  2               
000E35  2               ;z80_ep	 = ws+$10
000E35  2               ;z80_dp	 = ws+$11
000E35  2               ;z80_dep = z80_ep
000E35  2               
000E35  2               ;z80_lp	 = ws+$12
000E35  2               ;z80_hp	 = ws+$13
000E35  2               ;z80_hlp = z80_lp
000E35  2               
000E35  2               ;z80_sp   = ws+$14
000E35  2               
000E35  2               ;z80_reg0 = ws+$16
000E35  2               ;z80_reg1 = ws+$17
000E35  2               ;z80_reg2 = ws+$18
000E35  2               ;z80_reg3 = ws+$19
000E35  2               
000E35  2               ;z80_r	 = ws+$1a
000E35  2               
000E35  2               ; Contains seperatly 1 bit set
000E35  2               ; _BEEB this is not safe memory to use as required by MOS
000E35  2               
000E35  2               _bitmem0	= $f8
000E35  2               _bitmem1	= $f9
000E35  2               _bitmem2	= $fa
000E35  2               _bitmem3	= $fb
000E35  2               _bitmem4	= $fc
000E35  2               _bitmem5	= $fd
000E35  2               _bitmem6	= $fe
000E35  2               _bitmem7	= $ff
000E35  2               
000E35  2               ; constants
000E35  2               _bitvalue0	= $01
000E35  2               _bitvalue1	= $02
000E35  2               _bitvalue2	= $04
000E35  2               _bitvalue3	= $08
000E35  2               _bitvalue4	= $10
000E35  2               _bitvalue5	= $20
000E35  2               _bitvalue6	= $40
000E35  2               _bitvalue7	= $80
000E35  2               
000E35  2               _notbitvalue0	= $fe
000E35  2               _notbitvalue1	= $fd
000E35  2               _notbitvalue2	= $fb
000E35  2               _notbitvalue3	= $f7
000E35  2               _notbitvalue4	= $ef
000E35  2               _notbitvalue5	= $df
000E35  2               _notbitvalue6	= $bf
000E35  2               _notbitvalue7	= $7f
000E35  2               
000E35  2               
000E35  2               ;add_hl_bc:
000E35  2               ;		lda z80_l
000E35  2               ;		clc
000E35  2               ;		adc z80_c
000E35  2               ;		sta z80_l
000E35  2               ;		lda z80_h
000E35  2               ;		adc z80_b
000E35  2               ;		sta z80_h
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;add_ix_de:
000E35  2               ;		lda z80_ix
000E35  2               ;		clc
000E35  2               ;		adc z80_e
000E35  2               ;		sta z80_ix
000E35  2               ;		lda z80_ix+1
000E35  2               ;		adc z80_d
000E35  2               ;		sta z80_ix+1
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;add_iy_de:
000E35  2               ;		lda z80_iy
000E35  2               ;		clc
000E35  2               ;		adc z80_e
000E35  2               ;		sta z80_iy
000E35  2               ;		lda z80_iy+1
000E35  2               ;		adc z80_d
000E35  2               ;		sta z80_iy+1
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;add_hl_de:
000E35  2               ;		lda z80_l
000E35  2               ;		clc
000E35  2               ;		adc z80_e
000E35  2               ;		sta z80_l
000E35  2               ;		lda z80_h
000E35  2               ;		adc z80_d
000E35  2               ;		sta z80_h
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;add_ix_bc:
000E35  2               ;		lda z80_ix
000E35  2               ;		clc
000E35  2               ;		adc z80_c
000E35  2               ;		sta z80_ix
000E35  2               ;		lda z80_ix+1
000E35  2               ;		adc z80_b
000E35  2               ;		sta z80_ix+1
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;add_iy_bc:
000E35  2               ;		lda z80_iy
000E35  2               ;		clc
000E35  2               ;		adc z80_c
000E35  2               ;		sta z80_iy
000E35  2               ;		lda z80_iy+1
000E35  2               ;		adc z80_b
000E35  2               ;		sta z80_iy+1
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;sbc_hl_de:
000E35  2               ;		lda z80_l
000E35  2               ;		sbc z80_e
000E35  2               ;		sta z80_l
000E35  2               ;		lda z80_h
000E35  2               ;		sbc z80_d
000E35  2               ;		sta z80_h
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;sbc_hl_bc:
000E35  2               ;		lda z80_l
000E35  2               ;		sbc z80_c
000E35  2               ;		sta z80_l
000E35  2               ;		lda z80_h
000E35  2               ;		sbc z80_b
000E35  2               ;		sta z80_h
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;cmp_hl_bc:
000E35  2               ;		lda z80_l
000E35  2               ;		cmp z80_c
000E35  2               ;		bne cmp_hl_bc_end
000E35  2               ;		lda z80_h
000E35  2               ;		cmp z80_b
000E35  2               ;cmp_hl_bc_end:
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;cmp_iy_ix:
000E35  2               ;		lda z80_iy
000E35  2               ;		cmp z80_ix
000E35  2               ;		bne cmp_iy_ix_end
000E35  2               ;		lda z80_iy+1
000E35  2               ;		cmp z80_ix+1
000E35  2               ;cmp_iy_ix_end:
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;dec_hl:
000E35  2               ;		lda z80_l
000E35  2               ;		bne dec_hl_no_dec_h
000E35  2               ;		dec z80_h
000E35  2               ;dec_hl_no_dec_h:
000E35  2               ;		dec z80_l
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;dec_ix:
000E35  2               ;		lda z80_ix
000E35  2               ;		bne dec_ix_no_dec_h
000E35  2               ;		dec z80_ix+1
000E35  2               ;dec_ix_no_dec_h:
000E35  2               ;		dec z80_ix
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;dec_bc:
000E35  2               ;		lda z80_c
000E35  2               ;		bne dec_bc_no_dec_b
000E35  2               ;		dec z80_b
000E35  2               ;dec_bc_no_dec_b:
000E35  2               ;		dec z80_c
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;dec_de:
000E35  2               ;		lda z80_e
000E35  2               ;		bne dec_de_no_dec_d
000E35  2               ;		dec z80_d
000E35  2               ;dec_de_no_dec_d:
000E35  2               ;		dec z80_e
000E35  2               ;		rts
000E35  2               ;
000E35  2               ;ex_af_afs:
000E35  2               ;	rts
000E35  2               ;ex_de_hl:
000E35  2               ;		lda z80_e
000E35  2               ;		ldx z80_l
000E35  2               ;		stx z80_e
000E35  2               ;		sta z80_l
000E35  2               ;		lda z80_d
000E35  2               ;		ldx z80_h
000E35  2               ;		stx z80_d
000E35  2               ;		sta z80_h
000E35  2               ;		rts
000E35  2               ;
000E35  2               exx:
000E35  2  A5 rr        		lda z80_c
000E37  2  A4 rr        		ldy z80_cp
000E39  2  84 rr        		sty z80_c
000E3B  2  85 rr        		sta z80_cp
000E3D  2  A5 rr        		lda z80_b
000E3F  2  A4 rr        		ldy z80_bp
000E41  2  84 rr        		sty z80_b
000E43  2  85 rr        		sta z80_bp
000E45  2  A5 rr        		lda z80_e
000E47  2  A4 rr        		ldy z80_ep
000E49  2  84 rr        		sty z80_e
000E4B  2  85 rr        		sta z80_ep
000E4D  2  A5 rr        		lda z80_d
000E4F  2  A4 rr        		ldy z80_dp
000E51  2  84 rr        		sty z80_d
000E53  2  85 rr        		sta z80_dp
000E55  2  A5 rr        		lda scraddr
000E57  2  A4 rr        		ldy z80_lp
000E59  2  84 rr        		sty scraddr
000E5B  2  85 rr        		sta z80_lp
000E5D  2  A5 rr        		lda scraddr+1
000E5F  2  A4 rr        		ldy z80_hp
000E61  2  84 rr        		sty scraddr+1
000E63  2  85 rr        		sta z80_hp
000E65  2  60           		rts
000E66  2               
000E66  2               ;ex_sp_hl:
000E66  2               ;		tsx
000E66  2               ;		lda $0103,x
000E66  2               ;		ldy z80_h
000E66  2               ;		sta z80_h
000E66  2               ;		tya
000E66  2               ;		sta $0103,x
000E66  2               ;		lda $0104,x
000E66  2               ;		ldy z80_l
000E66  2               ;		sta z80_l
000E66  2               ;		tya
000E66  2               ;		sta $104,x
000E66  2               ;		rts
000E66  2               ;
000E66  2               ;ldi:
000E66  2               ;	rts
000E66  2               ;ldir:
000E66  2               ;		ldy #$00
000E66  2               ;		ldx z80_b
000E66  2               ;		beq ldir_last_page
000E66  2               ;ldir_loop:
000E66  2               ;		lda (z80_hl),y
000E66  2               ;		sta (z80_de),y
000E66  2               ;		iny
000E66  2               ;		bne ldir_loop
000E66  2               ;		inc z80_h
000E66  2               ;		inc z80_d
000E66  2               ;		dex
000E66  2               ;		bne ldir_loop
000E66  2               ;ldir_last_page:
000E66  2               ;		lda z80_c
000E66  2               ;		beq ldir_end
000E66  2               ;ldir_last_page_loop:
000E66  2               ;		lda (z80_hl),y
000E66  2               ;		sta (z80_de),y
000E66  2               ;		iny
000E66  2               ;		cpy z80_c
000E66  2               ;		bne ldir_last_page_loop
000E66  2               ;ldir_end:
000E66  2               ;		stx z80_c
000E66  2               ;		stx z80_b
000E66  2               ;		tya
000E66  2               ;		clc
000E66  2               ;		adc z80_l
000E66  2               ;		sta z80_l
000E66  2               ;		bcc *+4
000E66  2               ;		inc z80_h
000E66  2               ;		tya
000E66  2               ;		clc
000E66  2               ;		adc z80_e
000E66  2               ;		sta z80_e
000E66  2               ;		bcc *+4
000E66  2               ;		inc z80_d
000E66  2               ;		rts
000E66  2               ;
000E66  2               ;lddr:		ldy #$00
000E66  2               ;lddr_loop:
000E66  2               ;		lda (z80_hl),y
000E66  2               ;		sta (z80_de),y
000E66  2               ;		jsr dec_hl
000E66  2               ;		jsr dec_de
000E66  2               ;		jsr dec_bc
000E66  2               ;		lda z80_b
000E66  2               ;		ora z80_c
000E66  2               ;		bne lddr_loop
000E66  2               ;		rts
000E66  2               ;ei:
000E66  2               ;		rts
000E66  2               ;di:
000E66  2               ;		rts
000E66  2               
000E66  2               ;-------------------------------------------------------------
000E66  2               ; Set bits in bitmem
000E66  2               ;-------------------------------------------------------------
000E66  2               
000E66  2               .if 0
000E66  2               z80_init:
000E66  2               	ldx #$00
000E66  2               	lda #$01
000E66  2               z80_init_loop:
000E66  2               	sta _bitmem0,x
000E66  2               	inx
000E66  2               	asl a
000E66  2               	bne z80_init_loop
000E66  2               	rts
000E66  2               .endif
000E66  2               
000E66  2               push_af:
000E66  2               push_bc:
000E66  2               push_de:
000E66  2               push_hl:
000E66  2               
000E66  2               pop_af:
000E66  2               pop_bc:
000E66  2               pop_de:
000E66  2               pop_ix:
000E66  2               pop_hl:
000E66  2               
000E66  2               add_hl_hl:
000E66  2               
000E66  2               inc_bc:
000E66  2               inc_de:
000E66  2               inc_hl:
000E66  2               inc_ix:
000E66  2               inc_sp:
000E66  2               
000E66  2               cpir:
000E66  2               
000E66  2               ex_af_af:
000E66  2               ;	rts
000E66  2               
000E66  1               	.include "bbc.inc"
000E66  2               ;----------------------------------------------------------------------
000E66  2               ; BBC Platform Specific functions
000E66  2               ;----------------------------------------------------------------------
000E66  2               
000E66  2               ;--------------------------------------------------------
000E66  2               ; Keys
000E66  2               ;
000E66  2               ; Out: joyval=x65FUDLR (bit cleared if key pressed)
000E66  2               ;             ||||||||
000E66  2               ;             |||||||+> Right    KEY 0  - X
000E66  2               ;             ||||||+-> Left     KEY 1  - Z
000E66  2               ;             |||||+--> Down     KEY 2  - .
000E66  2               ;             ||||+---> Up       KEY 3  - ;
000E66  2               ;             |||+----> Fire1    KEY 4  - SPC
000E66  2               ;             ||+-----> Fire2    KEY 5  - Q
000E66  2               ;             |+------> Fire3    KEY 6  - P
000E66  2               ;             +-------> Not used
000E66  2               ;
000E66  2               ;                       Option1  KEY 7  - 1
000E66  2               ;                       Option2  KEY 8  - 2
000E66  2               ;                       Option3  KEY 9  - 3
000E66  2               ;                       Option4  KEY 10 - 4
000E66  2               ;--------------------------------------------------------
000E66  2               
000E66  2               ;              X   Z   .   ;  SPC  Q   P
000E66  2               ;keys:   .byte $42,$61,$68,$48,$62,$10,$37       ; Keys defined by game designer.
000E66  2               ;        .byte $30,$31,$11,$12                   ; menu options.
000E66  2               
000E66  2  42 61 68 48  jkeys:  .byte $42,$61,$68,$48,$62,$10,$37       ; Keys defined by game designer.
000E6A  2  62 10 37     
000E6D  2  30 31 11 12          .byte $30,$31,$11,$12                   ; menu options.
000E71  2               
000E71  2               ;----------------------------------------------------
000E71  2               ; Wait for keypress.
000E71  2               ;----------------------------------------------------
000E71  2               
000E71  2               prskey:
000E71  2  8A           	txa
000E72  2  48           	pha
000E73  2               prsloop:
000E73  2  20 12 0F     	jsr vsync
000E76  2               
000E76  2  A9 79        	lda #$79
000E78  2  A2 01        	ldx #$01
000E7A  2  20 F4 FF     	jsr OSBYTE
000E7D  2               
000E7D  2  E0 FF        	cpx #$ff
000E7F  2  F0 F2        	beq prsloop		; wait until key pressed
000E81  2  68           	pla
000E82  2  AA           	tax
000E83  2  60           	rts
000E84  2               
000E84  2               bbcinit:
000E84  2  78           	sei
000E85  2  AD 20 02     	lda EVENTV
000E88  2  8D B8 0E     	sta old_eventv
000E8B  2  AD 21 02     	lda EVENTV+1
000E8E  2  8D B9 0E     	sta old_eventv+1
000E91  2               
000E91  2  A9 BA        	lda #<event_handler
000E93  2  8D 20 02     	sta EVENTV
000E96  2  A9 0E        	lda #>event_handler
000E98  2  8D 21 02     	sta EVENTV+1
000E9B  2  58           	cli
000E9C  2               
000E9C  2               	; Enable VSYNC event.
000E9C  2  A9 0E        	lda #14
000E9E  2  A2 04        	ldx #4
000EA0  2  4C F4 FF     	jmp OSBYTE
000EA3  2               
000EA3  2               bbckill:
000EA3  2  78           	sei
000EA4  2  AD B8 0E     	lda old_eventv
000EA7  2  8D 20 02     	sta EVENTV
000EAA  2  AD B9 0E     	lda old_eventv+1
000EAD  2  8D 21 02     	sta EVENTV+1
000EB0  2  58           	cli
000EB1  2               
000EB1  2               	; Disable VSYNC event.
000EB1  2  A9 0D        	lda #13
000EB3  2  A2 04        	ldx #4
000EB5  2  4C F4 FF     	jmp OSBYTE
000EB8  2               
000EB8  2               
000EB8  2               old_eventv:
000EB8  2  xx xx        	.res 2
000EBA  2               
000EBA  2               event_handler:
000EBA  2  08           	php
000EBB  2  C9 04        	cmp #4
000EBD  2  D0 02        	bne not_vsync
000EBF  2               
000EBF  2  E6 rr        	inc vsync_count
000EC1  2               
000EC1  2               not_vsync:
000EC1  2  28           	plp
000EC2  2  6C B8 0E     	jmp (old_eventv)
000EC5  2               
000EC5  2               bbcsync:
000EC5  2  A5 rr        	lda vsync_count
000EC7  2  C9 02        	cmp #2
000EC9  2  90 FA        	bcc bbcsync
000ECB  2  A9 00        	lda #0
000ECD  2  85 rr        	sta vsync_count
000ECF  2  60           	rts
000ED0  2               
000ED0  2               ;--------------------------------------------------------
000ED0  2               ; Keyboard test routine.
000ED0  2               ;
000ED0  2               ; Input:
000ED0  2               ;  A = key to read, high nibble=row and low nibble=col
000ED0  2               ;
000ED0  2               ; Output:
000ED0  2               ;  carry clr = key pressed
000ED0  2               ;  carry set = key not pressed
000ED0  2               ;--------------------------------------------------------
000ED0  2               
000ED0  2               ktest:
000ED0  2  85 rr        	sta z80_a		; save key
000ED2  2  98           	tya
000ED3  2  48           	pha
000ED4  2               
000ED4  2               ; _BEEB keyboard read
000ED4  2  A5 rr        	lda z80_a
000ED6  2  49 80        	eor #$80		; _BEEB just look for this key
000ED8  2  AA           	tax
000ED9  2               
000ED9  2  A9 79        	lda #$79
000EDB  2  20 F4 FF     	jsr OSBYTE
000EDE  2               
000EDE  2  8A           	txa
000EDF  2  30 04        	bmi pressed 	; _BEEB X is negative if key is pressed
000EE1  2               
000EE1  2  38           	sec			; key not pressed
000EE2  2  68           	pla
000EE3  2  A8           	tay
000EE4  2  60           	rts
000EE5  2               
000EE5  2               pressed:
000EE5  2  18           	clc			; key pressed
000EE6  2  68           	pla
000EE7  2  A8           	tay
000EE8  2  60           	rts
000EE9  2               
000EE9  2               ;---------------------------------------------------------------
000EE9  2               ; Getkey in column,row format
000EE9  2               ;
000EE9  2               ; Output:
000EE9  2               ;  A = high nibble=row and low nibble=column key in matrix
000EE9  2               ;---------------------------------------------------------------
000EE9  2               
000EE9  2               kget:
000EE9  2  86 rr        	stx xtmp
000EEB  2               
000EEB  2               kget1:
000EEB  2  A9 79        	lda #$79			; _BEEB read keyboard with OSBYTE &79
000EED  2  A2 01        	ldx #$01
000EEF  2  20 F4 FF     	jsr OSBYTE
000EF2  2               
000EF2  2  E0 FF        	cpx #$ff
000EF4  2  F0 F5        	beq kget1
000EF6  2               
000EF6  2  8A           	txa
000EF7  2               
000EF7  2  A6 rr        	ldx xtmp
000EF9  2  60           	rts
000EFA  2               
000EFA  2               ;----------------------------------------------------
000EFA  2               ; AtoMMC joystick controls.
000EFA  2               ; _BEEB TODO
000EFA  2               ;----------------------------------------------------
000EFA  2               
000EFA  2               joyinit:
000EFA  2               joysin:
000EFA  2  60           	rts
000EFB  2               
000EFB  2               
000EFB  2               ;----------------------------------------------------
000EFB  2               ; Delay routine 1/50 sec
000EFB  2               ;
000EFB  2               ; Wait 1/60 sec = 16666 usec
000EFB  2               ; Wait 208 x 16 =  3328 usec
000EFB  2               ;                 19994 usec
000EFB  2               ; rts           =     6 usec
000EFB  2               ; Total         = 20000 usec
000EFB  2               ;----------------------------------------------------
000EFB  2               
000EFB  2               delay:
000EFB  2  85 rr        	sta xtmp
000EFD  2               del_loop:
000EFD  2  A9 13        	lda #19
000EFF  2  20 F4 FF     	jsr OSBYTE		; wait for vsync _BEEB
000F02  2               
000F02  2  A0 D0        	ldy #208		; wait 208 x 16 = 3328 usec
000F04  2               delay1:
000F04  2  61 80        	adc ($80,x)		;	 6 usec
000F06  2  61 80        	adc ($80,x)		;	 6 usec
000F08  2  88           	dey			;	 2 usec
000F09  2  D0 F9        	bne delay1		;	 2 usec
000F0B  2  EA           	nop			; 2 usec
000F0C  2  EA           	nop			; 2 usec
000F0D  2               				; tot: 20000 usec
000F0D  2  C6 rr        	dec xtmp
000F0F  2  D0 EC        	bne del_loop
000F11  2  60           	rts
000F12  2               
000F12  2               ;-------------------------------------------------------------
000F12  2               ; Screen synchronisation.
000F12  2               ;
000F12  2               ;  - read joystick/keyboard
000F12  2               ;  - handle sound
000F12  2               ;  - sync framerate with clock
000F12  2               ;  - handle shrapnel every even frame
000F12  2               ;-------------------------------------------------------------
000F12  2               
000F12  2               vsync:
000F12  2  48           	pha
000F13  2  98           	tya
000F14  2  48           	pha
000F15  2  8A           	txa
000F16  2  48           	pha
000F17  2  20 53 21     	jsr joykey		; read joystick/keyboard.
000F1A  2               vsync1:
000F1A  2               ; Don't sync to vsync here - we can sync to every other vsync in main loop
000F1A  2               ;	lda #19
000F1A  2               ;	jsr OSBYTE		; _BEEB vsync
000F1A  2               
000F1A  2  A5 rr        	lda clock
000F1C  2  29 01        	and #1
000F1E  2  D0 03        	bne:+
000F20  2  20 D8 18     	jsr proshr		; handle shrapnel every even frame
000F23  2               :
000F23  2  AD 2E 0F     	lda sndtyp
000F26  2  F0 00        	beq sndskip
000F28  2               
000F28  2               ; _BEEB TODO SOUND
000F28  2               ;sndloop:
000F28  2               ;	lda SpeakerBit		; handle sound
000F28  2               ;	ldy sndtyp
000F28  2               ;sndwait:
000F28  2               ;	dey
000F28  2               ;	bne sndwait
000F28  2               ;	eor #4
000F28  2               ;	sta SpeakerBit
000F28  2               ;	dec sndtyp
000F28  2               ;	bne sndloop
000F28  2               
000F28  2               sndskip:
000F28  2  68           	pla
000F29  2  AA           	tax
000F2A  2  68           	pla
000F2B  2  A8           	tay
000F2C  2  68           	pla
000F2D  2  60           	rts
000F2E  2               
000F2E  2  00           sndtyp:	.byte 0
000F2F  2               
000F2F  2               ;----------------------------------------------------------------------
000F2F  2               ; BBC video hardware fns
000F2F  2               ;----------------------------------------------------------------------
000F2F  2               
000F2F  2               screeninit:
000F2F  2  A2 0D        	ldx #13
000F31  2               crtcloop:
000F31  2  8E 00 FE     	stx $FE00
000F34  2  BD 51 0F     	lda crtc_regs_high,x
000F37  2  8D 01 FE     	sta $FE01
000F3A  2  CA           	dex
000F3B  2  10 F4        	bpl crtcloop
000F3D  2               
000F3D  2                   ; Set ULA
000F3D  2  A9 D8            lda #$D8            ; MODE 4=$88 MODE 1=$D8
000F3F  2  8D 48 02         sta $248            ; Tell the OS or it will mess with ULA settings at vsync
000F42  2  8D 20 FE         sta $FE20
000F45  2               
000F45  2               ; fall through to palette
000F45  2               
000F45  2               setpal:
000F45  2  A2 0F        	ldx #15
000F47  2               palloop:
000F47  2  BD 5F 0F     	lda ula_pal,x
000F4A  2  8D 21 FE     	sta $fe21
000F4D  2  CA           	dex
000F4E  2  10 F7        	bpl palloop
000F50  2  60           	rts
000F51  2               
000F51  2               crtc_regs_high:
000F51  2  7F           	.byte 127				; R0  horizontal total
000F52  2  40           	.byte 64				; R1  horizontal displayed
000F53  2  62           	.byte 98				; R2  horizontal position
000F54  2  28           	.byte $28				; R3  sync width 40 = &28
000F55  2  26           	.byte 38				; R4  vertical total
000F56  2  00           	.byte 0					; R5  vertical total adjust
000F57  2  18           	.byte 24				; R6  vertical displayed
000F58  2  23           	.byte 35				; R7  vertical position; 35=top of screen
000F59  2  00           	.byte $00				; R8  interlace
000F5A  2  07           	.byte 7					; R9  scanlines per row
000F5B  2  20           	.byte 32				; R10 cursor start
000F5C  2  08           	.byte 8					; R11 cursor end
000F5D  2  0A           	.byte >(ScreenAddr/8)	; R12 screen start address, high
000F5E  2  00           	.byte <(ScreenAddr/8)	; R13 screen start address, low
000F5F  2               
000F5F  2               ula_pal:
000F5F  2  07           	.byte $00 + PAL_black
000F60  2  17           	.byte $10 + PAL_black
000F61  2  23           	.byte $20 + PAL_blue
000F62  2  33           	.byte $30 + PAL_blue
000F63  2  47           	.byte $40 + PAL_black
000F64  2  57           	.byte $50 + PAL_black
000F65  2  63           	.byte $60 + PAL_blue
000F66  2  73           	.byte $70 + PAL_blue
000F67  2  86           	.byte $80 + PAL_red
000F68  2  96           	.byte $90 + PAL_red
000F69  2  A0           	.byte $a0 + PAL_white
000F6A  2  B0           	.byte $b0 + PAL_white
000F6B  2  C6           	.byte $c0 + PAL_red
000F6C  2  D6           	.byte $d0 + PAL_red
000F6D  2  E0           	.byte $e0 + PAL_white
000F6E  2  F0           	.byte $f0 + PAL_white
000F6F  2               
000F6F  2               ;----------------------------------------------------
000F6F  2               ; Draw sprite
000F6F  2               ;----------------------------------------------------
000F6F  2               
000F6F  2               sprite:
000F6F  2  86 rr        	stx xtmp		; Save X-reg
000F71  2  20 18 10     	jsr scadd 		; get screen address in scraddr.
000F74  2               
000F74  2  A5 rr        	lda dispx 		; x position.
000F76  2  29 07        	and #7 			; position straddling cells.
000F78  2  85 rr        	sta z80_b		; store in b register.
000F7A  2               
000F7A  2  A5 rr        	lda z80_l		; store sprite graphic address.
000F7C  2  8D 8D 0F     	sta sprit1+1
000F7F  2  8D 93 0F     	sta sprit2+1
000F82  2  A5 rr        	lda z80_h
000F84  2  8D 8E 0F     	sta sprit1+2
000F87  2  8D 94 0F     	sta sprit2+2
000F8A  2               
000F8A  2  A2 00        	ldx #0				; pixel height.
000F8C  2               sprit1:
000F8C  2  BD DD 44     	lda objdta,x		; fetch first byte.
000F8F  2  85 rr        	sta spr
000F91  2  E8           	inx
000F92  2               sprit2:
000F92  2  BD DD 44     	lda objdta,x
000F95  2  85 rr        	sta spr+1
000F97  2               
000F97  2  A9 00        	lda #0
000F99  2  85 rr        	sta spr+2
000F9B  2  20 ED 1D     	jsr sprit7			; shift sprite
000F9E  2               
000F9E  2  A5 rr        	lda spr				; fetch graphic.
000FA0  2  4A           	lsr a				; top nibble
000FA1  2  4A           	lsr a
000FA2  2  4A           	lsr a
000FA3  2  4A           	lsr a
000FA4  2  A8           	tay
000FA5  2  B9 DC 13     	lda pixels_to_mode1,y
000FA8  2  25 rr        	and colour_byte
000FAA  2               
000FAA  2  A0 00        	ldy #0				; _BEEB
000FAC  2  51 rr        	eor (scraddr),y		; merge with screen image.
000FAE  2  91 rr        	sta (scraddr),y		; write to screen.
000FB0  2               
000FB0  2  A5 rr        	lda spr				; fetch graphic.
000FB2  2  29 0F        	and #$0f
000FB4  2  A8           	tay
000FB5  2  B9 DC 13     	lda pixels_to_mode1,y
000FB8  2  25 rr        	and colour_byte
000FBA  2               
000FBA  2  A0 08        	ldy #8				; _BEEB
000FBC  2  51 rr        	eor (scraddr),y		; merge with screen image.
000FBE  2  91 rr        	sta (scraddr),y		; write to screen.
000FC0  2               
000FC0  2  A5 rr        	lda spr+1			; fetch graphic.
000FC2  2  4A           	lsr a				; top nibble
000FC3  2  4A           	lsr a
000FC4  2  4A           	lsr a
000FC5  2  4A           	lsr a
000FC6  2  A8           	tay
000FC7  2  B9 DC 13     	lda pixels_to_mode1,y
000FCA  2  25 rr        	and colour_byte
000FCC  2               
000FCC  2  A0 10        	ldy #16				; _BEEB
000FCE  2  51 rr        	eor (scraddr),y		; merge with screen image.
000FD0  2  91 rr        	sta (scraddr),y		; write to screen.
000FD2  2               
000FD2  2  A5 rr        	lda spr+1			; fetch graphic.
000FD4  2  29 0F        	and #$0f
000FD6  2  A8           	tay
000FD7  2  B9 DC 13     	lda pixels_to_mode1,y
000FDA  2  25 rr        	and colour_byte
000FDC  2  A0 18        	ldy #24				; _BEEB
000FDE  2  51 rr        	eor (scraddr),y		; merge with screen image.
000FE0  2  91 rr        	sta (scraddr),y		; write to screen.
000FE2  2               
000FE2  2  A5 rr        	lda spr+2			; fetch graphic.
000FE4  2  4A           	lsr a				; top nibble
000FE5  2  4A           	lsr a
000FE6  2  4A           	lsr a
000FE7  2  4A           	lsr a
000FE8  2  A8           	tay
000FE9  2  B9 DC 13     	lda pixels_to_mode1,y
000FEC  2  25 rr        	and colour_byte
000FEE  2               
000FEE  2  A0 20        	ldy #32				; _BEEB
000FF0  2  51 rr        	eor (scraddr),y		; merge with screen image.
000FF2  2  91 rr        	sta (scraddr),y		; write to screen.
000FF4  2               
000FF4  2  A5 rr        	lda spr+2			; fetch graphic.
000FF6  2  29 0F        	and #$0f
000FF8  2  A8           	tay
000FF9  2  B9 DC 13     	lda pixels_to_mode1,y
000FFC  2  25 rr        	and colour_byte
000FFE  2  A0 28        	ldy #40				; _BEEB
001000  2  51 rr        	eor (scraddr),y		; merge with screen image.
001002  2  91 rr        	sta (scraddr),y		; write to screen.
001004  2               
001004  2  20 5B 11     	jsr nline
001007  2               
001007  2  A5 rr        	lda colour_byte
001009  2  45 rr        	eor colour_xor
00100B  2  85 rr        	sta colour_byte		; toggle colour mask each line
00100D  2               
00100D  2  E8           	inx					; next source byte.
00100E  2  E0 20        	cpx #32
001010  2  B0 03        	bcs :+				; repeat
001012  2  4C 8C 0F     	jmp sprit1
001015  2               :
001015  2  A6 rr        	ldx xtmp			; retreive X-reg
001017  2  60           	rts
001018  2               
001018  2               ;------------------------------------------------------------------
001018  2               ; This routine returns a screen address for (dispx, dispy) in scraddr.
001018  2               ;------------------------------------------------------------------
001018  2               
001018  2               scadd:
001018  2  A6 rr        	ldx dispy
00101A  2               
00101A  2  A9 00        	lda #0
00101C  2  85 rr        	sta scraddr+1
00101E  2               
00101E  2  A5 rr        	lda dispx		; x*2
001020  2  29 F8        	and #$f8
001022  2  0A           	asl a
001023  2  26 rr        	rol scraddr+1
001025  2               
001025  2  18           	clc
001026  2  7D 00 06     	adc SCADTB_lb,x
001029  2  85 rr        	sta scraddr
00102B  2  BD 00 07     	lda SCADTB_hb,x
00102E  2  65 rr        	adc scraddr+1
001030  2  85 rr        	sta scraddr+1
001032  2  60           	rts
001033  2               
001033  2               ;-----------------------------------------------------------------
001033  2               ; These are the sprite routines.
001033  2               ; sspria = single sprite, old (ix).
001033  2               ; ssprib = single sprite, new (ix+5).
001033  2               ; sspric = both sprites, old (ix) and new (ix+5).
001033  2               ;-----------------------------------------------------------------
001033  2               
001033  2               sspria:
001033  2  20 A1 24     	jsr gsprad		; get old sprite address.
001036  2               sspri2:
001036  2               
001036  2  A5 rr        	lda z80_e				; 3c
001038  2  8D CE 10     	sta dline_spraddr1+1	; 4c
00103B  2  8D 01 11     	sta dline_spraddr2+1	; 4c
00103E  2               
00103E  2  A5 rr        	lda z80_d				; 3c
001040  2  8D CF 10     	sta dline_spraddr1+2	; 4c
001043  2  8D 02 11     	sta dline_spraddr2+2	; 4c
001046  2               
001046  2  A6 rr        	ldx sprshft
001048  2  BD C5 10     	lda shift_table,x
00104B  2  8D D1 10     	sta dline_shift1+1
00104E  2  8D 04 11     	sta dline_shift2+1
001051  2  BD C6 10     	lda shift_table+1,x
001054  2  8D D2 10     	sta dline_shift1+2
001057  2  8D 05 11     	sta dline_shift2+2
00105A  2               
00105A  2  A2 00        	ldx #0			; vertical lines.
00105C  2               sspri0:
00105C  2  20 CD 10     	jsr dline		; draw a line.
00105F  2  E0 20        	cpx #32
001061  2  D0 F9        	bne sspri0		; repeat 16 times x 2 bytes
001063  2  60           	rts
001064  2               
001064  2               ;-----------------------------------------------------------------
001064  2               
001064  2               ssprib:
001064  2  20 82 24     	jsr gspran 		; get new sprite address.
001067  2  4C 36 10     	jmp sspri2
00106A  2               
00106A  2               ;-----------------------------------------------------------------
00106A  2               
00106A  2               sspric:
00106A  2  20 A1 24     	jsr gsprad 		; get old sprite address.
00106D  2               
00106D  2  A5 rr        	lda z80_e				; 3c
00106F  2  8D 16 12     	sta ddline_spraddr3+1	; 4c
001072  2  8D 49 12     	sta ddline_spraddr4+1	; 4c
001075  2               
001075  2  A5 rr        	lda z80_d				; 3c
001077  2  8D 17 12     	sta ddline_spraddr3+2	; 4c
00107A  2  8D 4A 12     	sta ddline_spraddr4+2	; 4c
00107D  2               
00107D  2  A6 rr        	ldx sprshft
00107F  2  BD C5 10     	lda shift_table,x
001082  2  8D 19 12     	sta ddline_shift3+1
001085  2  8D 4C 12     	sta ddline_shift4+1
001088  2  BD C6 10     	lda shift_table+1,x
00108B  2  8D 1A 12     	sta ddline_shift3+2
00108E  2  8D 4D 12     	sta ddline_shift4+2
001091  2               
001091  2  20 35 0E     	jsr exx  		; store addresses.
001094  2  20 82 24     	jsr gspran 		; get new sprite addresses.
001097  2               
001097  2  A5 rr        	lda z80_e				; 3c
001099  2  8D 75 11     	sta ddline_spraddr1+1	; 4c
00109C  2  8D A8 11     	sta ddline_spraddr2+1	; 4c
00109F  2               
00109F  2  A5 rr        	lda z80_d				; 3c
0010A1  2  8D 76 11     	sta ddline_spraddr1+2	; 4c
0010A4  2  8D A9 11     	sta ddline_spraddr2+2	; 4c
0010A7  2               
0010A7  2  A6 rr        	ldx sprshft
0010A9  2  BD C5 10     	lda shift_table,x
0010AC  2  8D 78 11     	sta ddline_shift1+1
0010AF  2  8D AB 11     	sta ddline_shift2+1
0010B2  2  BD C6 10     	lda shift_table+1,x
0010B5  2  8D 79 11     	sta ddline_shift1+2
0010B8  2  8D AC 11     	sta ddline_shift2+2
0010BB  2               
0010BB  2  A2 00        	ldx #0
0010BD  2               lloop:
0010BD  2  20 74 11     	jsr ddline 		; draw a line.
0010C0  2  E0 20        	cpx #32
0010C2  2  D0 F9        	bne lloop
0010C4  2  60           	rts
0010C5  2               
0010C5  2               shift_table:
0010C5  2  00 14        .word shift0
0010C7  2  00 15        .word shift2
0010C9  2  00 16        .word shift4
0010CB  2  00 17        .word shift6
0010CD  2               
0010CD  2               ;-------------------------------------------------------------
0010CD  2               ; Drop through.
0010CD  2               ; Line drawn, now work out next target address.
0010CD  2               ;
0010CD  2               ; Input:
0010CD  2               ;  B  = right mask
0010CD  2               ;  C  = left mask
0010CD  2               ;  DE = spriteaddress
0010CD  2               ;  scraddr = screen address
0010CD  2               ;-------------------------------------------------------------
0010CD  2               
0010CD  2               dline:
0010CD  2               
0010CD  2               ; first screen byte
0010CD  2               
0010CD  2               dline_spraddr1:
0010CD  2  BC FF FF     	ldy $ffff,x 		; graphic data.
0010D0  2               dline_shift1:
0010D0  2  B9 FF FF     	lda $ffff,y
0010D3  2  85 rr        	sta sprtmp
0010D5  2  25 rr        	and z80_c 			; mask away what's not needed.
0010D7  2               
0010D7  2  4A           	lsr a				; top nibble
0010D8  2  4A           	lsr a
0010D9  2  4A           	lsr a
0010DA  2  4A           	lsr a
0010DB  2  A8           	tay
0010DC  2  B9 DC 13     	lda pixels_to_mode1,y
0010DF  2  25 rr        	and colour_byte
0010E1  2               
0010E1  2  A0 00        	ldy #0
0010E3  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
0010E5  2  91 rr        	sta (scraddr),y 	; bung it in.
0010E7  2               
0010E7  2  A5 rr        	lda sprtmp			; fetch data.
0010E9  2  25 rr        	and z80_c 			; mask away what's not needed.
0010EB  2  29 0F        	and #$f				; bottom nibble
0010ED  2  A8           	tay
0010EE  2  B9 DC 13     	lda pixels_to_mode1,y
0010F1  2  25 rr        	and colour_byte
0010F3  2  A0 08        	ldy #8
0010F5  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
0010F7  2  91 rr        	sta (scraddr),y 	; bung it in.
0010F9  2               
0010F9  2               ; carry to next screen byte
0010F9  2               
0010F9  2  A5 rr        	lda sprtmp			; fetch data.
0010FB  2  25 rr        	and z80_b 			; mask away unwanted
0010FD  2  85 rr        	sta sprtmp
0010FF  2               
0010FF  2               ; middle screen byte
0010FF  2               
0010FF  2  E8           	inx
001100  2               dline_spraddr2:
001100  2  BC FF FF     	ldy $ffff,x 		; second bit of data.
001103  2               dline_shift2:
001103  2  B9 FF FF     	lda $ffff,y
001106  2  85 rr        	sta sprtmp2
001108  2  25 rr        	and z80_c 			; mask away what's not needed.
00110A  2  05 rr        	ora sprtmp
00110C  2  85 rr        	sta sprtmp
00110E  2               
00110E  2  4A           	lsr a				; top nibble
00110F  2  4A           	lsr a
001110  2  4A           	lsr a
001111  2  4A           	lsr a
001112  2  A8           	tay
001113  2  B9 DC 13     	lda pixels_to_mode1,y
001116  2  25 rr        	and colour_byte
001118  2               
001118  2  A0 10        	ldy #16
00111A  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
00111C  2  91 rr        	sta (scraddr),y 	; bung it in.
00111E  2               
00111E  2  A5 rr        	lda sprtmp			; fetch data.
001120  2  29 0F        	and #$f				; bottom nibble
001122  2  A8           	tay
001123  2  B9 DC 13     	lda pixels_to_mode1,y
001126  2  25 rr        	and colour_byte
001128  2  A0 18        	ldy #24
00112A  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
00112C  2  91 rr        	sta (scraddr),y 	; bung it in.
00112E  2               
00112E  2               ; carry to last screen byte
00112E  2               
00112E  2  A5 rr        	lda sprtmp2
001130  2  25 rr        	and z80_b 			; mask away unwanted
001132  2               
001132  2  4A           	lsr a				; top nibble
001133  2  4A           	lsr a
001134  2  4A           	lsr a
001135  2  4A           	lsr a
001136  2  A8           	tay
001137  2  B9 DC 13     	lda pixels_to_mode1,y
00113A  2  25 rr        	and colour_byte
00113C  2               
00113C  2  A0 20        	ldy #32
00113E  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
001140  2  91 rr        	sta (scraddr),y 	; bung it in.
001142  2               
001142  2  A5 rr        	lda sprtmp2
001144  2  25 rr        	and z80_b 			; mask away unwanted
001146  2  29 0F        	and #$f				; bottom nibble
001148  2  A8           	tay
001149  2  B9 DC 13     	lda pixels_to_mode1,y
00114C  2  25 rr        	and colour_byte
00114E  2  A0 28        	ldy #40
001150  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
001152  2  91 rr        	sta (scraddr),y 	; bung it in.
001154  2               
001154  2  A5 rr        	lda colour_byte
001156  2  45 rr        	eor colour_xor
001158  2  85 rr        	sta colour_byte
00115A  2               
00115A  2  E8           	inx
00115B  2               
00115B  2               ;----------------------------------------------------------------------
00115B  2               ; Line drawn, now work out next target address.
00115B  2               ;----------------------------------------------------------------------
00115B  2               
00115B  2               ; _BEEB screen arrangement
00115B  2               
00115B  2               nline:
00115B  2  A5 rr        	lda scraddr 		; get low byte of address.
00115D  2  29 07        	and #7
00115F  2  C9 07        	cmp #7				; is this last line of row?
001161  2  F0 03        	beq beeb_next_row
001163  2               
001163  2               	; within same row
001163  2  E6 rr        	inc scraddr			; new low byte of address.
001165  2               ;	bne :+
001165  2               ;	inc scraddr+1		; new high byte of address.
001165  2               :
001165  2  60           	rts
001166  2               
001166  2               beeb_next_row:
001166  2  18           	clc
001167  2  A5 rr        	lda scraddr
001169  2  69 F9        	adc #<(ScreenRowBytes-7)
00116B  2  85 rr        	sta scraddr			; new low byte of address.
00116D  2  A5 rr        	lda scraddr+1
00116F  2  69 01        	adc #>(ScreenRowBytes-7)
001171  2  85 rr        	sta scraddr+1		; new high byte of address.
001173  2  60           	rts
001174  2               
001174  2               ;-------------------------------------------------------------
001174  2               ; Drop through.
001174  2               ; Line drawn, now work out next target address.
001174  2               ;
001174  2               ; Input:
001174  2               ;  B  = right mask
001174  2               ;  C  = left mask
001174  2               ;  DE = spriteaddress
001174  2               ;  scraddr = screen address
001174  2               ;-------------------------------------------------------------
001174  2               
001174  2               ddline:
001174  2               
001174  2               ; NEW SPRITE
001174  2               
001174  2               ; first screen byte
001174  2               
001174  2               ddline_spraddr1:
001174  2  BC FF FF     	ldy $ffff,x 		; graphic data.
001177  2               ddline_shift1:
001177  2  B9 FF FF     	lda $ffff,y
00117A  2  85 rr        	sta sprtmp
00117C  2  25 rr        	and z80_c 			; mask away what's not needed.
00117E  2               
00117E  2  4A           	lsr a				; top nibble
00117F  2  4A           	lsr a
001180  2  4A           	lsr a
001181  2  4A           	lsr a
001182  2  A8           	tay
001183  2  B9 DC 13     	lda pixels_to_mode1,y
001186  2  25 rr        	and colour_byte
001188  2               
001188  2  A0 00        	ldy #0
00118A  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
00118C  2  91 rr        	sta (scraddr),y 	; bung it in.
00118E  2               
00118E  2  A5 rr        	lda sprtmp
001190  2  25 rr        	and z80_c 			; mask away what's not needed.
001192  2  29 0F        	and #$f				; bottom nibble
001194  2  A8           	tay
001195  2  B9 DC 13     	lda pixels_to_mode1,y
001198  2  25 rr        	and colour_byte
00119A  2  A0 08        	ldy #8
00119C  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
00119E  2  91 rr        	sta (scraddr),y 	; bung it in.
0011A0  2               
0011A0  2               ; carry to next screen byte
0011A0  2               
0011A0  2  A5 rr        	lda sprtmp			; fetch data.
0011A2  2  25 rr        	and z80_b 			; mask away unwanted
0011A4  2  85 rr        	sta sprtmp
0011A6  2               
0011A6  2               ; middle screen byte
0011A6  2               
0011A6  2  E8           	inx
0011A7  2               ddline_spraddr2:
0011A7  2  BC FF FF     	ldy $ffff,x 		; second bit of data.
0011AA  2               ddline_shift2:
0011AA  2  B9 FF FF     	lda $ffff,y
0011AD  2  85 rr        	sta sprtmp2
0011AF  2  25 rr        	and z80_c 			; mask away what's not needed.
0011B1  2  05 rr        	ora sprtmp
0011B3  2  85 rr        	sta sprtmp
0011B5  2               
0011B5  2  4A           	lsr a				; top nibble
0011B6  2  4A           	lsr a
0011B7  2  4A           	lsr a
0011B8  2  4A           	lsr a
0011B9  2  A8           	tay
0011BA  2  B9 DC 13     	lda pixels_to_mode1,y
0011BD  2  25 rr        	and colour_byte
0011BF  2               
0011BF  2  A0 10        	ldy #16
0011C1  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
0011C3  2  91 rr        	sta (scraddr),y 	; bung it in.
0011C5  2               
0011C5  2  A5 rr        	lda sprtmp
0011C7  2  29 0F        	and #$f				; bottom nibble
0011C9  2  A8           	tay
0011CA  2  B9 DC 13     	lda pixels_to_mode1,y
0011CD  2  25 rr        	and colour_byte
0011CF  2  A0 18        	ldy #24
0011D1  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
0011D3  2  91 rr        	sta (scraddr),y 	; bung it in.
0011D5  2               
0011D5  2               ; carry to last screen byte
0011D5  2               
0011D5  2  A5 rr        	lda sprtmp2
0011D7  2  25 rr        	and z80_b 			; mask away unwanted
0011D9  2               
0011D9  2  4A           	lsr a				; top nibble
0011DA  2  4A           	lsr a
0011DB  2  4A           	lsr a
0011DC  2  4A           	lsr a
0011DD  2  A8           	tay
0011DE  2  B9 DC 13     	lda pixels_to_mode1,y
0011E1  2  25 rr        	and colour_byte
0011E3  2               
0011E3  2  A0 20        	ldy #32
0011E5  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
0011E7  2  91 rr        	sta (scraddr),y 	; bung it in.
0011E9  2               
0011E9  2  A5 rr        	lda sprtmp2
0011EB  2  25 rr        	and z80_b 			; mask away unwanted
0011ED  2  29 0F        	and #$f				; bottom nibble
0011EF  2  A8           	tay
0011F0  2  B9 DC 13     	lda pixels_to_mode1,y
0011F3  2  25 rr        	and colour_byte
0011F5  2  A0 28        	ldy #40
0011F7  2  51 rr        	eor (scraddr),y 	; XOR with what's there.
0011F9  2  91 rr        	sta (scraddr),y 	; bung it in.
0011FB  2               
0011FB  2               ; _BEEB next row
0011FB  2               
0011FB  2  A5 rr        	lda scraddr 		; get low byte of address.
0011FD  2  29 07        	and #7
0011FF  2  C9 07        	cmp #7				; is this last line of row?
001201  2  F0 04        	beq :+
001203  2               
001203  2               	; within same row can't increment page
001203  2  E6 rr        	inc scraddr			; new low byte of address.
001205  2  D0 0D        	bne ddline2
001207  2               
001207  2               :
001207  2  18           	clc
001208  2  A5 rr        	lda scraddr
00120A  2  69 F9        	adc #<(ScreenRowBytes-7)
00120C  2  85 rr        	sta scraddr			; new low byte of address.
00120E  2  A5 rr        	lda scraddr+1
001210  2  69 01        	adc #>(ScreenRowBytes-7)
001212  2  85 rr        	sta scraddr+1		; new high byte of address.
001214  2               
001214  2               ; OLD SPRITE
001214  2               
001214  2               ddline2:
001214  2               
001214  2               ; still first row but different data!
001214  2               
001214  2  CA           	dex
001215  2               
001215  2               ; first screen byte
001215  2               
001215  2               ddline_spraddr3:
001215  2  BC FF FF     	ldy $ffff,x			; graphic data.
001218  2               ddline_shift3:
001218  2  B9 FF FF     	lda $ffff,y
00121B  2  85 rr        	sta sprtmp
00121D  2  25 rr        	and z80_cp 			; mask away what's not needed.
00121F  2               
00121F  2  4A           	lsr a				; top nibble
001220  2  4A           	lsr a
001221  2  4A           	lsr a
001222  2  4A           	lsr a
001223  2  A8           	tay
001224  2  B9 DC 13     	lda pixels_to_mode1,y
001227  2  25 rr        	and colour_byte
001229  2               
001229  2  A0 00        	ldy #0
00122B  2  51 rr        	eor (z80_hlp),y 	; XOR with what's there.
00122D  2  91 rr        	sta (z80_hlp),y 	; bung it in.
00122F  2               
00122F  2  A5 rr        	lda sprtmp
001231  2  25 rr        	and z80_cp 			; mask away what's not needed.
001233  2  29 0F        	and #$f				; bottom nibble
001235  2  A8           	tay
001236  2  B9 DC 13     	lda pixels_to_mode1,y
001239  2  25 rr        	and colour_byte
00123B  2  A0 08        	ldy #8
00123D  2  51 rr        	eor (z80_hlp),y 	; XOR with what's there.
00123F  2  91 rr        	sta (z80_hlp),y 	; bung it in.
001241  2               
001241  2               ; carry to next screen byte
001241  2               
001241  2  A5 rr        	lda sprtmp			; fetch data.
001243  2  25 rr        	and z80_bp 			; mask away unwanted
001245  2  85 rr        	sta sprtmp
001247  2               
001247  2               ; middle screen byte
001247  2               
001247  2  E8           	inx
001248  2               ddline_spraddr4:
001248  2  BC FF FF     	ldy $ffff,x 		; second bit of data.
00124B  2               ddline_shift4:
00124B  2  B9 FF FF     	lda $ffff,y
00124E  2  85 rr        	sta sprtmp2
001250  2  25 rr        	and z80_cp 			; mask away what's not needed.
001252  2  05 rr        	ora sprtmp
001254  2  85 rr        	sta sprtmp
001256  2               
001256  2  4A           	lsr a				; top nibble
001257  2  4A           	lsr a
001258  2  4A           	lsr a
001259  2  4A           	lsr a
00125A  2  A8           	tay
00125B  2  B9 DC 13     	lda pixels_to_mode1,y
00125E  2  25 rr        	and colour_byte
001260  2               
001260  2  A0 10        	ldy #16
001262  2  51 rr        	eor (z80_hlp),y 	; XOR with what's there.
001264  2  91 rr        	sta (z80_hlp),y 	; bung it in.
001266  2               
001266  2  A5 rr        	lda sprtmp
001268  2  29 0F        	and #$f				; bottom nibble
00126A  2  A8           	tay
00126B  2  B9 DC 13     	lda pixels_to_mode1,y
00126E  2  25 rr        	and colour_byte
001270  2  A0 18        	ldy #24
001272  2  51 rr        	eor (z80_hlp),y 	; XOR with what's there.
001274  2  91 rr        	sta (z80_hlp),y 	; bung it in.
001276  2               
001276  2               ; last screen byte
001276  2               
001276  2  A5 rr        	lda sprtmp2			; fetch data.
001278  2  25 rr        	and z80_bp 			; mask away unwanted
00127A  2               
00127A  2  4A           	lsr a				; top nibble
00127B  2  4A           	lsr a
00127C  2  4A           	lsr a
00127D  2  4A           	lsr a
00127E  2  A8           	tay
00127F  2  B9 DC 13     	lda pixels_to_mode1,y
001282  2  25 rr        	and colour_byte
001284  2               
001284  2  A0 20        	ldy #32
001286  2  51 rr        	eor (z80_hlp),y 	; XOR with what's there.
001288  2  91 rr        	sta (z80_hlp),y 	; bung it in.
00128A  2               
00128A  2  A5 rr        	lda sprtmp2			; fetch data.
00128C  2  25 rr        	and z80_bp 			; mask away unwanted
00128E  2  29 0F        	and #$f				; bottom nibble
001290  2  A8           	tay
001291  2  B9 DC 13     	lda pixels_to_mode1,y
001294  2  25 rr        	and colour_byte
001296  2  A0 28        	ldy #40
001298  2  51 rr        	eor (z80_hlp),y 	; XOR with what's there.
00129A  2  91 rr        	sta (z80_hlp),y 	; bung it in.
00129C  2               
00129C  2               ; next row of sprite data
00129C  2               
00129C  2  E8           	inx
00129D  2               
00129D  2  A5 rr        	lda colour_byte
00129F  2  45 rr        	eor colour_xor
0012A1  2  85 rr        	sta colour_byte
0012A3  2               
0012A3  2               ; _BEEB screen arrangement
0012A3  2               
0012A3  2  A5 rr        	lda z80_lp 			; get low byte of address.
0012A5  2  29 07        	and #7
0012A7  2  C9 07        	cmp #7				; is this last line of row?
0012A9  2  F0 03        	beq :+
0012AB  2               
0012AB  2               	; within same row can't increment page
0012AB  2  E6 rr        	inc z80_lp			; new low byte of address.
0012AD  2  60           	rts
0012AE  2               
0012AE  2               :
0012AE  2  18           	clc
0012AF  2  A5 rr        	lda z80_lp
0012B1  2  69 F9        	adc #<(ScreenRowBytes-7)
0012B3  2  85 rr        	sta z80_lp			; new low byte of address.
0012B5  2  A5 rr        	lda z80_lp+1
0012B7  2  69 01        	adc #>(ScreenRowBytes-7)
0012B9  2  85 rr        	sta z80_lp+1		; new high byte of address.
0012BB  2  60           	rts
0012BC  2               
0012BC  2               ;----------------------------------------------------
0012BC  2               ; Display character in A at dispx,dispy.
0012BC  2               ;
0012BC  2               ; Input:
0012BC  2               ;  A 	   = character to print
0012BC  2               ;----------------------------------------------------
0012BC  2               
0012BC  2               pchar:
0012BC  2  85 rr        	sta fntaddr
0012BE  2  A9 00        	lda #0
0012C0  2  85 rr        	sta fntaddr+1
0012C2  2  06 rr        	asl fntaddr  		; multiply char by 8.
0012C4  2  26 rr        	rol fntaddr+1
0012C6  2  06 rr        	asl fntaddr
0012C8  2  26 rr        	rol fntaddr+1
0012CA  2  06 rr        	asl fntaddr
0012CC  2  26 rr        	rol fntaddr+1
0012CE  2               
0012CE  2  A5 rr        	lda fntaddr
0012D0  2  18           	clc
0012D1  2  65 rr        	adc FontPtr
0012D3  2  85 rr        	sta fntaddr		; that's the low byte.
0012D5  2  A5 rr        	lda fntaddr+1
0012D7  2  65 rr        	adc FontPtr+1
0012D9  2  85 rr        	sta fntaddr+1		; add displacement.
0012DB  2               pchark:
0012DB  2  20 0A 13     	jsr gprad		; get screen address.
0012DE  2  A0 00        	ldy #0
0012E0  2  A2 00        	ldx #0
0012E2  2               
0012E2  2               pchar0:
0012E2  2  8A           	txa
0012E3  2  A8           	tay
0012E4  2  B1 rr        	lda (fntaddr),y 	; get image byte.
0012E6  2  49 00        	eor #TxtInvert		; Invert
0012E8  2  85 rr        	sta tmp
0012EA  2               
0012EA  2  4A           	lsr a
0012EB  2  4A           	lsr a
0012EC  2  4A           	lsr a
0012ED  2  4A           	lsr a
0012EE  2  A8           	tay
0012EF  2  B9 DC 13     	lda pixels_to_mode1,y
0012F2  2  A0 00        	ldy #0
0012F4  2  91 rr        	sta (scraddr),y 	; copy to screen.
0012F6  2               
0012F6  2  A5 rr        	lda tmp
0012F8  2  29 0F        	and #$0f
0012FA  2  A8           	tay
0012FB  2  B9 DC 13     	lda pixels_to_mode1,y
0012FE  2  A0 08        	ldy #8
001300  2  91 rr        	sta (scraddr),y 	; copy to screen.
001302  2               
001302  2  E6 rr        	inc scraddr
001304  2               
001304  2  E8           	inx					; next screen row down.
001305  2  E0 08        	cpx #8				; number lines
001307  2  90 D9        	bcc pchar0			; repeat.
001309  2  60           	rts
00130A  2               
00130A  2               ;----------------------------------------------------
00130A  2               ; Get print address.
00130A  2               ;----------------------------------------------------
00130A  2               
00130A  2               gprad:
00130A  2  98           	tya
00130B  2  48           	pha
00130C  2               
00130C  2  A5 rr        	lda dispx 		; x coordinate.
00130E  2  85 rr        	sta scraddr
001310  2  A9 00        	lda #0
001312  2  85 rr        	sta scraddr+1
001314  2  06 rr        	asl scraddr  	; multiply char by 16
001316  2  26 rr        	rol scraddr+1
001318  2  06 rr        	asl scraddr
00131A  2  26 rr        	rol scraddr+1
00131C  2  06 rr        	asl scraddr
00131E  2  26 rr        	rol scraddr+1
001320  2  06 rr        	asl scraddr
001322  2  26 rr        	rol scraddr+1
001324  2               
001324  2  A5 rr        	lda dispy		; y coordinate.
001326  2  0A           	asl a
001327  2  0A           	asl a
001328  2  0A           	asl a			; multiply char by 8
001329  2  A8           	tay
00132A  2               
00132A  2  18           	clc
00132B  2  A5 rr        	lda scraddr
00132D  2  79 00 06     	adc SCADTB_lb,y
001330  2  85 rr        	sta scraddr
001332  2  A5 rr        	lda scraddr+1
001334  2  79 00 07     	adc SCADTB_hb,y
001337  2  85 rr        	sta scraddr+1
001339  2               
001339  2  68           	pla
00133A  2  A8           	tay
00133B  2  60           	rts
00133C  2               
00133C  2               ;--------------------------------------------------------------
00133C  2               ; Get property buffer address of char at (dispx, dispy) in hl.
00133C  2               ;
00133C  2               ; Output:
00133C  2               ;  bufaddr = MAP + dispy*32 + dispx
00133C  2               ;--------------------------------------------------------------
00133C  2               
00133C  2               pradd:
00133C  2  A5 rr        	lda dispy 		; y coordinate.
00133E  2  85 rr        	sta bufaddr
001340  2  A9 00        	lda #0
001342  2  85 rr        	sta bufaddr+1
001344  2  06 rr        	asl bufaddr  		; multiply char by 32
001346  2  26 rr        	rol bufaddr+1
001348  2  06 rr        	asl bufaddr
00134A  2  26 rr        	rol bufaddr+1
00134C  2  06 rr        	asl bufaddr
00134E  2  26 rr        	rol bufaddr+1
001350  2  06 rr        	asl bufaddr
001352  2  26 rr        	rol bufaddr+1
001354  2  06 rr        	asl bufaddr
001356  2  26 rr        	rol bufaddr+1
001358  2  18           	clc			; add address of MAP graphics.
001359  2  A5 rr        	lda bufaddr
00135B  2  65 rr        	adc dispx
00135D  2  69 00        	adc #<MAP
00135F  2  85 rr        	sta bufaddr
001361  2  A5 rr        	lda bufaddr+1
001363  2  69 03        	adc #>MAP
001365  2  85 rr        	sta bufaddr+1
001367  2  60           	rts
001368  2               
001368  2               ;----------------------------------------------
001368  2               ; Print attributes, properties and pixels.
001368  2               ;
001368  2               ; Input:
001368  2               ;  A	= tile number
001368  2               ;----------------------------------------------
001368  2               
001368  2               pattr:
001368  2               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
001368  2               .if aflag
001368  2               	pha
001368  2               	jsr wbloc		; save blockinfo
001368  2               	pla
001368  2               .endif
001368  2               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
001368  2               
001368  2               pattr2:
001368  2  85 rr        	sta z80_b		; store cell in b register for now.
00136A  2  AA           	tax
00136B  2  BD 7B 3E     	lda bprop,x 		; block properties.
00136E  2  85 rr        	sta z80_c
001370  2  C9 08        	cmp #COLECT
001372  2  D0 04        	bne :+
001374  2  A5 rr        	lda z80_b
001376  2  85 rr        	sta colpatt
001378  2               :
001378  2  20 3C 13     	jsr pradd 		; get property buffer address.
00137B  2  A5 rr        	lda z80_c
00137D  2  A0 00        	ldy #0
00137F  2  91 rr        	sta (bufaddr),y 	; write property.
001381  2  A5 rr        	lda z80_b 		; restore cell.
001383  2               
001383  2               ; Print attributes, no properties.
001383  2               
001383  2               panp:
001383  2  85 rr        	sta z80_e		; displacement in e.
001385  2  A9 00        	lda #0
001387  2  85 rr        	sta z80_d		; no high byte.
001389  2  06 rr        	asl z80_e  		; multiply char by 16.
00138B  2  26 rr        	rol z80_d
00138D  2  06 rr        	asl z80_e
00138F  2  26 rr        	rol z80_d
001391  2  06 rr        	asl z80_e
001393  2  26 rr        	rol z80_d
001395  2  06 rr        	asl z80_e
001397  2  26 rr        	rol z80_d
001399  2  18           	clc
00139A  2  A5 rr        	lda z80_e
00139C  2  69 BB        	adc #<chgfx 		; address of graphics.
00139E  2  85 rr        	sta tileaddr
0013A0  2  A5 rr        	lda z80_d
0013A2  2  69 3B        	adc #>chgfx
0013A4  2  85 rr        	sta tileaddr+1
0013A6  2               
0013A6  2  20 0A 13     	jsr gprad 		; get screen address.
0013A9  2  A2 00        	ldx #0			; number of pixel rows to write.
0013AB  2               
0013AB  2               panp0:
0013AB  2  8A           	txa
0013AC  2  A8           	tay
0013AD  2  B1 rr        	lda (tileaddr),y 	; get image byte.
0013AF  2  49 00        	eor #TxtInvert		; Invert
0013B1  2  A0 00        	ldy #0
0013B3  2  91 rr        	sta (scraddr),y 	; copy to screen.
0013B5  2               
0013B5  2  E8           	inx
0013B6  2  8A           	txa
0013B7  2  A8           	tay
0013B8  2  B1 rr        	lda (tileaddr),y 	; get image byte.
0013BA  2  49 00        	eor #TxtInvert		; Invert
0013BC  2  A0 08        	ldy #8
0013BE  2  91 rr        	sta (scraddr),y 	; copy to screen.
0013C0  2               
0013C0  2  E6 rr        	inc scraddr			; within char
0013C2  2  E8           	inx	 		; repeat for 8 pixel rows.
0013C3  2  E0 10        	cpx #16
0013C5  2  90 E4        	bcc panp0
0013C7  2  E6 rr        	inc dispx 		; move along one.
0013C9  2  E6 rr        	inc charx
0013CB  2  60           	rts
0013CC  2               
0013CC  2               ;----------------------------------------------------
0013CC  2               ; MODE 1 Colour Lookups
0013CC  2               ;----------------------------------------------------
0013CC  2               
0013CC  2               ink_to_mode1:
0013CC  2  00 00        	.byte $00, $00 ^ $00 ; solid 0
0013CE  2  0F 00        	.byte $0f, $0f ^ $0f ; solid 1
0013D0  2  F0 00        	.byte $f0, $f0 ^ $f0 ; solid 2
0013D2  2  5A FF        	.byte $5a, $a5 ^ $5a ; stipple 1,2
0013D4  2  DA 7D        	.byte $da, $a7 ^ $da ; stripple 1,2,3
0013D6  2  5F F0        	.byte $5f, $af ^ $5f ; stipple 1,3
0013D8  2  F5 0F        	.byte $f5, $fa ^ $f5 ; stipple 2,3
0013DA  2  FF 00        	.byte $ff, $ff ^ $ff ; solid 3
0013DC  2               
0013DC  2               pixels_to_mode1:
0013DC  2  00 11 22 33  	.byte $00,$11,$22,$33,$44,$55,$66,$77
0013E0  2  44 55 66 77  
0013E4  2  88 99 AA BB  	.byte $88,$99,$aa,$bb,$cc,$dd,$ee,$ff
0013E8  2  CC DD EE FF  
0013EC  2               
0013EC  2               ;----------------------------------------------------
0013EC  2               ; Shift tables
0013EC  2               ;----------------------------------------------------
0013EC  2               
0013EC  2               .if 1
0013EC  2  xx xx xx xx  .align 256
0013F0  2  xx xx xx xx  
0013F4  2  xx xx xx xx  
001400  2               shift0:
001400  2  00 01 02 03  .repeat 256, i
001404  2  04 05 06 07  
001408  2  08 09 0A 0B  
001500  2               	.byte i
001500  2               .endrep
001500  2               
001500  2               shift2:
001500  2  00 40 80 C0  .repeat 256, i
001504  2  01 41 81 C1  
001508  2  02 42 82 C2  
001600  2               	.byte (i >> 2) | (i << 6) & $c0
001600  2               .endrep
001600  2               
001600  2               shift4:
001600  2  00 10 20 30  .repeat 256, i
001604  2  40 50 60 70  
001608  2  80 90 A0 B0  
001700  2               	.byte (i >> 4) | ((i << 4) & $f0)
001700  2               .endrep
001700  2               
001700  2               shift6:
001700  2  00 04 08 0C  .repeat 256, i
001704  2  10 14 18 1C  
001708  2  20 24 28 2C  
001800  2               	.byte (i >> 6) | ((i << 2) & $fc)
001800  2               .endrep
001800  2               .align 1
001800  2               .endif
001800  2               
001800  1               
001800  1               ;----------------------------------------------------------------------
001800  1               ; AGD 6502 ENGINE CODE + COMPILED GAME SCRIPT
001800  1               ;----------------------------------------------------------------------
001800  1               
001800  1               start_game:
001800  1               
001800  1               	.include "game.inc"
001800  2               .include "balloon.inc"
001800  3               ; Game engine code --------------------------------------------------------------
001800  3               
001800  3               ; Arcade Game Designer.
001800  3               ; (C) 2008 Jonathan Cauldwell.
001800  3               ; ZX Spectrum Next Engine v0.1.
001800  3               
001800  3               ; Global definitions ------------------------------------------------------------
001800  3               
001800  3               	FONT = font			; Font address
001800  3               
001800  3               ; Block characteristics.
001800  3               
001800  3               	PLATFM = 1			; platform.
001800  3               	WALL = PLATFM + 1	; solid wall.
001800  3               	LADDER = WALL + 1	; ladder.
001800  3               	FODDER = LADDER + 1	; fodder block.
001800  3               	DEADLY = FODDER + 1	; deadly block.
001800  3               	CUSTOM = DEADLY + 1	; custom block.
001800  3               	WATER  = CUSTOM + 1	; water block.
001800  3                   COLECT = WATER + 1      ; collectable block.
001800  3                   NUMTYP = COLECT + 1     ; number of types.
001800  3               
001800  3               ; Sprites.
001800  3               
001800  3               	NUMSPR = 12			; number of sprites.
001800  3               	TABSIZ = 17			; size of each entry.
001800  3               	SPRBUF = NUMSPR * TABSIZ; size of entire table.
001800  3               	NMESIZ = 4			; bytes stored in nmetab for each sprite.
001800  3               
001800  3               ; Sprite table variable offsets.
001800  3               
001800  3               	var_Type = 0		; sprite type
001800  3               	var_Image = 1		; sprite time number
001800  3               	var_Frame = 2		; sprite frame
001800  3               	var_Y = 3			; sprite y coordinate
001800  3               	var_X = 4			; sprite X coordinate
001800  3               
001800  3               	var_newType = 5		; sprite new type
001800  3               	var_newImage = 6	; sprite new image number
001800  3               	var_newFrame = 7	; sprite new frame
001800  3               	var_newY = 8		; sprite new y coordinate
001800  3               	var_newX = 9		; sprite new x coordinate
001800  3               
001800  3               	var_Direction = 10	; sprite direction
001800  3               	var_Param1 = 11		; sprite parameter 1
001800  3               	var_Param2 = 12		; sprite parameter 2
001800  3               
001800  3               	var_jumpLo = 13		; sprite jump ptr low
001800  3               	var_jumpHi = 14		; sprite jump ptr high
001800  3               	var_dataLo = 15		; sprite data ptr low
001800  3               	var_dataHi = 16		; sprite data ptr high
001800  3               
001800  3               ; Particle engine.
001800  3               
001800  3               	NUMSHR = 55			; pieces of shrapnel.
001800  3               	SHRSIZ = 6			; bytes per particle.
001800  3               
001800  3               ; Conditional compilation flags
001800  3               ; Flags are set in commandline assembly
001800  3               
001800  3               ;	mflag = 0 		; MENU + INV
001800  3               ;	pflag = 0		; Particle engine
001800  3               ;	sflag = 0		; scrollytext
001800  3               ;	fflag = 1		; Fontflag
001800  3               
001800  3               .if iflag
001800  3               	TxtInvert   = $ff	; Invert byte for character printing
001800  3               	ScrFillByte = $ff	; Screen fill byte for CLS
001800  3               .else
001800  3               	TxtInvert   = $00	; Invert byte for character printing
001800  3               	ScrFillByte = $00	; Screen fill byte for CLS
001800  3               .endif
001800  3               
001800  3               	ASCII_NEWLINE = 13
001800  3               
001800  3               ;===============================================================
001800  3               ; Game starts here
001800  3               ;===============================================================
001800  3               
001800  3               ;--------------------------------------------------------------
001800  3               ; If a font is required...
001800  3               ;--------------------------------------------------------------
001800  3               
001800  3  A9 E9        	lda #<(FONT-256)	; address of font.
001802  3  85 rr        	sta FontPtr
001804  3  A9 48        	lda #>(FONT-256)
001806  3  85 rr        	sta FontPtr+1
001808  3               
001808  3  20 D9 18     	jsr game	 		; start the game.
00180B  3  60           	rts
00180C  3               
00180C  3               ; Don't change the order of these four.
00180C  3               ; Menu routine relies on winlft following wintop.
00180C  3               
00180C  3  00           wintop:	.byte WINDOWTOP		; top of window.
00180D  3  00           winlft:	.byte WINDOWLFT		; left edge.
00180E  3  17           winhgt:	.byte WINDOWHGT		; window height.
00180F  3  1E           winwid:	.byte WINDOWWID		; window width.
001810  3  22           numob:	.byte NUMOBJ		; number of objects in game.
001811  3               
001811  3               ; Pixel versions of wintop, winlft, winhgt, winwid.
001811  3               
001811  3  00           wntopx:	.byte (8 * WINDOWTOP)
001812  3  00           wnlftx:	.byte (8 * WINDOWLFT)
001813  3  A8           wnbotx:	.byte ((WINDOWTOP * 8) + (WINDOWHGT * 8) - 16)
001814  3  DE           wnrgtx:	.byte ((WINDOWLFT * 8) + (WINDOWWID * 8) - 16)-2
001815  3               
001815  3               ; Make sure pointers are arranged in the same order as the data itself.
001815  3               
001815  3  47 43        frmptr:	.word frmlst         ; sprite frames.
001817  3               
001817  3               ; Assorted game routines which can go in contended memory.
001817  3               
001817  3               ;--------------------------------------------------------------
001817  3               ; Modify for inventory.
001817  3               ; called by the INV command
001817  3               ;
001817  3               ; Input:
001817  3               ;  X   = message nr with objects seperated with ,
001817  3               ;
001817  3               ; Output:
001817  3               ;  OPT = selected line nr of INV menu
001817  3               ;--------------------------------------------------------------
001817  3               
001817  3               .if mflag
001817  3               minve:
001817  3               	lda #<(invdis)		; routine address.
001817  3               	sta mod0+1		; set up menu routine.
001817  3               	sta mod2+1		; set up count routine.
001817  3               	lda #>(invdis)
001817  3               	sta mod0+2
001817  3               	sta mod2+2
001817  3               	lda #<(fopt)		; find option from available objects.
001817  3               	sta mod1+1		; set up routine.
001817  3               	lda #>(fopt)
001817  3               	sta mod1+1+1
001817  3               	jmp dbox		; do menu routine.
001817  3               
001817  3               ;--------------------------------------------------------------
001817  3               ; Modify for menu.
001817  3               ; called by the MENU command
001817  3               ;
001817  3               ; Input:
001817  3               ;  X   = message nr with menu items seperated with ,
001817  3               ;
001817  3               ; Output:
001817  3               ;  OPT = selected line nr of MENU menu
001817  3               ;--------------------------------------------------------------
001817  3               
001817  3               mmenu:
001817  3               	lda #<(always)		; routine address.
001817  3               	sta mod0+1		; set up routine.
001817  3               	sta mod2+1		; set up count routine.
001817  3               	lda #>(always)
001817  3               	sta mod0+2
001817  3               	sta mod2+2
001817  3               
001817  3               	lda #<(fstd)		; standard option selection.
001817  3               	sta mod1+1		; set up routine.
001817  3               	lda #>(fstd)
001817  3               	sta mod1+2
001817  3               
001817  3               ; Drop through into box routine.
001817  3               
001817  3               ;--------------------------------------------------------------
001817  3               ; Work out size of box for message or menu.
001817  3               ;--------------------------------------------------------------
001817  3               
001817  3               dbox:
001817  3               	lda #<(msgdat)		; pointer to messages.
001817  3               	sta z80_l
001817  3               	lda #>(msgdat)
001817  3               	sta z80_h
001817  3               
001817  3               	jsr getwrd		; get message number.
001817  3               
001817  3               	lda z80_h		; store pointer to message.
001817  3               	sta TmpAddr
001817  3               	lda z80_l
001817  3               	sta TmpAddr+1
001817  3               
001817  3               	lda #1			; height.
001817  3               	sta z80_d
001817  3               	lda #0			; start at object zero.
001817  3               	sta combyt		; store number of object in combyt.
001817  3               	sta z80_e		; maximum width.
001817  3               dbox5:
001817  3               	lda #0			; this line"s width.
001817  3               	sta z80_b
001817  3               mod2:
001817  3               	jsr always		; item in player"s possession?
001817  3               	cmp #255
001817  3               	bne dbox6		; not in inventory, skip this line.
001817  3               	inc z80_d		; add to tally.
001817  3               dbox6:
001817  3               	ldy #0			; get character.
001817  3               	lda (z80_hl),y
001817  3               	sta z80_a
001817  3               	inc z80_l		; next character.
001817  3               	bne :+
001817  3               	inc z80_h
001817  3               :
001817  3               	lda z80_a		; reached end of line?
001817  3               	cmp #','
001817  3               	beq dbox3		; yes.
001817  3               	cmp #ASCII_NEWLINE
001817  3               	beq dbox3		; yes.
001817  3               	inc z80_b		; add to this line"s width.
001817  3               	lda z80_a
001817  3               	bmi dbox4		; end of message? yes, end count.
001817  3               	jmp dbox6		; repeat until we find the end.
001817  3               dbox3:
001817  3               	lda z80_e		; maximum line width.
001817  3               	cmp z80_b		; have we exceeded longest so far?
001817  3               	bpl dbox5		; no, carry on looking.
001817  3               	lda z80_b		; make this the widest so far.
001817  3               	sta z80_e
001817  3               	jmp dbox5		; keep looking.
001817  3               dbox4:
001817  3               	lda z80_e		; maximum line width.
001817  3               	cmp z80_b		; have we exceeded longest so far?
001817  3               	bpl dbox8		; no, carry on looking.
001817  3               	lda z80_b		; final line is the longest so far.
001817  3               	sta z80_e
001817  3               dbox8:
001817  3               	dec z80_d		; decrement items found.
001817  3               	bne :+			; total was zero.
001817  3               	jmp dbox15
001817  3               :
001817  3               	lda z80_e		; longest line.
001817  3               	bne :+			; was it zero?
001817  3               	jmp dbox15		; total was zero.
001817  3               :
001817  3               	sta bwid		; set up size.
001817  3               	lda z80_d
001817  3               	sta blen
001817  3               
001817  3               ;--------------------------------------------------------------
001817  3               ; That's set up our box size.
001817  3               ;--------------------------------------------------------------
001817  3               
001817  3               	lda winhgt		; window height in characters.
001817  3               	sec
001817  3               	sbc z80_d		; subtract height of box.
001817  3               	lsr a			; divide by 2.
001817  3               	clc
001817  3               	adc wintop		; add top edge of window.
001817  3               	sta btop		; set up box top.
001817  3               
001817  3               	lda winwid		; window width in characters.
001817  3               	sec
001817  3               	sbc z80_e		; subtract box width.
001817  3               	lsr a			; divide by 2.
001817  3               	clc
001817  3               	adc winlft		; add left edge of window.
001817  3               	sta blft		; box left.
001817  3               
001817  3               	lda FontPtr		; font.
001817  3               	sta grbase		; set up for text display.
001817  3               	lda FontPtr+1
001817  3               	sta grbase+1
001817  3               
001817  3               	lda TmpAddr+1		; restore message pointer.
001817  3               	sta z80_l
001817  3               	lda TmpAddr
001817  3               	sta z80_h
001817  3               
001817  3               	lda btop		; box top.
001817  3               	sta dispy		; set display coordinate.
001817  3               	lda #0			; start at object zero.
001817  3               	sta combyt		; store number of object in combyt.
001817  3               dbox2:
001817  3               	lda combyt		; get object number.
001817  3               	sta z80_a
001817  3               mod0:
001817  3               	jsr always		; check inventory for display.
001817  3               	cmp #255
001817  3               	beq :+
001817  3               	jmp dbox13		; not in inventory, skip this line.
001817  3               :
001817  3               	lda blft		; box left.
001817  3               	sta dispx		; set left display position.
001817  3               	lda bwid		; box width.
001817  3               	sta z80_b		; store width.
001817  3               dbox0:
001817  3               	ldy #0			; get character.
001817  3               	lda (z80_hl),y
001817  3               	cmp #','		; end of line?
001817  3               	beq dbox1		; yes, next one.
001817  3               	cmp #ASCII_NEWLINE			; end of line?
001817  3               	beq dbox1		; yes, next one.
001817  3               
001817  3               	dec z80_b		; one less to display.
001817  3               	and #127		; remove terminator.
001817  3               
001817  3               	jsr pchr		; display on screen.
001817  3               
001817  3               	ldy #0
001817  3               	lda (z80_hl),y		; get character.
001817  3               	sta z80_a
001817  3               	inc z80_l		; next character.
001817  3               	bne :+
001817  3               	inc z80_h
001817  3               :
001817  3               	lda z80_a
001817  3               	cmp #128		; end of message?
001817  3               	bmi :+
001817  3               	jmp dbox7		; yes, job done.
001817  3               :
001817  3               	lda z80_b		; chars remaining.
001817  3               	beq :+			; are any left?
001817  3               	jmp dbox0		; yes, continue.
001817  3               :
001817  3               ;---------------------------------------------------
001817  3               ; Reached limit of characters per line.
001817  3               ;---------------------------------------------------
001817  3               
001817  3               dbox9:
001817  3               	ldy #0
001817  3               	lda (z80_hl),y		; get character.
001817  3               	inc z80_l		; next one.
001817  3               	bne :+
001817  3               	inc z80_h
001817  3               :
001817  3               	cmp #','		; another line?
001817  3               	beq dbox10		; yes, do next line.
001817  3               	cmp #ASCII_NEWLINE			; another line?
001817  3               	beq dbox10		; yes, do next line.
001817  3               	cmp #128		; end of message?
001817  3               	bcs :+
001817  3               	jmp dbox11		; yes, finish message.
001817  3               :
001817  3               	jmp dbox9
001817  3               
001817  3               ;---------------------------------------------------
001817  3               ; Fill box to end of line.
001817  3               ;---------------------------------------------------
001817  3               
001817  3               dboxf:
001817  3               	lda #32			; space character.
001817  3               	jsr pchr		; display character.
001817  3               	dec z80_b
001817  3               	beq :+
001817  3               	jmp dboxf		; repeat for remaining chars on line.
001817  3               :
001817  3               	rts
001817  3               dbox1:
001817  3               	inc z80_l		; skip character.
001817  3               	bne :+
001817  3               	inc z80_h
001817  3               :
001817  3               	jsr dboxf		; fill box out to right side.
001817  3               dbox10:
001817  3               	inc dispy		; y coordinate down a line next position.
001817  3               	jmp dbox2		; next line.
001817  3               dbox7:
001817  3               	lda z80_b		; chars remaining.
001817  3               	bne :+			; are any left?
001817  3               	jmp dbox11		; no, nothing to draw.
001817  3               :
001817  3               	jsr dboxf		; fill message to line.
001817  3               
001817  3               ;------------------------------------------------------
001817  3               ; Drawn the box menu, now select option.
001817  3               ;------------------------------------------------------
001817  3               
001817  3               dbox11:
001817  3               	lda btop		; box top.
001817  3               	sta dispy		; set bar position.
001817  3               dbox14:
001817  3               	jsr joykey		; get controls.
001817  3               	cmp #$7f		; anything pressed?
001817  3               	bne dbox14		; yes, debounce it.
001817  3               	jsr dbar		; draw bar.
001817  3               dbox12:
001817  3               	jsr joykey		; get controls.
001817  3               	cmp #$7f		; anything pressed?
001817  3               	beq dbox12		; no, nothing.
001817  3               	and #16			; fire button pressed?
001817  3               	bne :+
001817  3               mod1:
001817  3               	jmp fstd		; yes, job done.
001817  3               :
001817  3               	jsr dbar		; delete bar.
001817  3               
001817  3               	lda joyval		; joystick reading.
001817  3               	and #8			; going up?
001817  3               	beq dboxu		; yes, go up.
001817  3               
001817  3               	ldx dispy		; vertical position of bar.
001817  3               	inx			; look down.
001817  3               	txa
001817  3               	sec
001817  3               	sbc btop		; find distance from top.
001817  3               	cmp blen		; top of box.
001817  3               	bne :+
001817  3               	jmp dbox14		; yes, go no further.
001817  3               :
001817  3               	inc dispy		; move bar.
001817  3               	jmp dbox14		; continue.
001817  3               dboxu:
001817  3               	lda dispy		; vertical position of bar.
001817  3               	cmp btop		; are we at the top?
001817  3               	bne :+
001817  3               	jmp dbox14		; yes, go no further.
001817  3               :
001817  3               	dec dispy		; move bar.
001817  3               	jmp dbox14		; continue.
001817  3               fstd:
001817  3               	lda dispy		; bar position.
001817  3               	sec
001817  3               	sbc btop		; find selected option.
001817  3               	sta varopt		; store the option.
001817  3               	jmp redraw		; redraw the screen.
001817  3               
001817  3               ;------------------------------------------------------
001817  3               ; Option not available.  Skip this line.
001817  3               ;------------------------------------------------------
001817  3               
001817  3               dbox13:
001817  3               	ldy #0
001817  3               	lda (z80_hl),y		; get character.
001817  3               	inc z80_l		; next one.
001817  3               	bne :+
001817  3               	inc z80_h
001817  3               :
001817  3               	cmp #','		; another line?
001817  3               	bne :+
001817  3               	jmp dbox2		; yes, do next line.
001817  3               :
001817  3               	cmp #ASCII_NEWLINE			; another line?
001817  3               	bne :+
001817  3               	jmp dbox2		; yes, do next line.
001817  3               :
001817  3               
001817  3               	bpl :+			; end of message?
001817  3               	jmp dbox11		; yes, finish message.
001817  3               :
001817  3               	jmp dbox13
001817  3               dbox15:
001817  3               	lda TmpAddr		; pop message pointer from the stack.
001817  3               	sta z80_h
001817  3               	lda TmpAddr+1
001817  3               	sta z80_l
001817  3               	rts
001817  3               
001817  3               ;------------------------------------------------------
001817  3               ; Invert bar
001817  3               ;------------------------------------------------------
001817  3               
001817  3               dbar:
001817  3               	lda blft		; box left.
001817  3               	sta dispx		; set display coordinate.
001817  3               	jsr gprad		; get printing address.
001817  3               
001817  3               	lda bwid		; box width.
001817  3               	sta z80_c		; loop counter in c.
001817  3               	lda z80_h
001817  3               	sta z80_d		; store screen address high byte.
001817  3               dbar1:
001817  3               	ldy #7			; pixel height in b.
001817  3               dbar0:
001817  3               	lda (scraddr),y		; get screen byte.
001817  3               	eor #255		; reverse all bits.
001817  3               	sta (scraddr),y		; write back to screen.
001817  3               	dey			; next line down.
001817  3               	bpl dbar0		; draw rest of character.
001817  3               
001817  3               	clc
001817  3               	lda scraddr		; one char right.
001817  3               	adc #8
001817  3               	sta scraddr
001817  3               	bcc :+
001817  3               	inc scraddr+1
001817  3               :
001817  3               
001817  3               	dec z80_c		; decrement character counter.
001817  3               	beq :+
001817  3               	jmp dbar1		; repeat for whole line.
001817  3               :
001817  3               	rts
001817  3               
001817  3               ;------------------------------------------------------
001817  3               ; Point to object
001817  3               ;
001817  3               ; Input:
001817  3               ;  -
001817  3               ;
001817  3               ; Output:
001817  3               ;  A = object number, A=255 if already in possession
001817  3               ;------------------------------------------------------
001817  3               
001817  3               invdis:
001817  3               	lda z80_l		; store message text pointer.
001817  3               	pha
001817  3               	lda z80_h
001817  3               	pha
001817  3               	lda combyt		; object number.
001817  3               	inc combyt		; ready for next one.
001817  3               	jsr gotob		; check if we have object.
001817  3               	tay
001817  3               	pla
001817  3               	sta z80_h
001817  3               	pla
001817  3               	sta z80_l
001817  3               	tya
001817  3               	rts
001817  3               
001817  3               ;------------------------------------------------------
001817  3               ; Find option selected.
001817  3               ;
001817  3               ; Input:
001817  3               ;  -
001817  3               ;
001817  3               ; Output:
001817  3               ;  OPT = selected object
001817  3               ;------------------------------------------------------
001817  3               
001817  3               fopt:
001817  3               	lda dispy
001817  3               	sec
001817  3               	sbc btop		; find selected option.
001817  3               	sta tmp+2		; option selected in b register.
001817  3               	inc tmp+2
001817  3               
001817  3               	lda #0			; set to first item.
001817  3               	sta combyt		; object number.
001817  3               fopt0:
001817  3               	jsr fobj		; find next object in inventory.
001817  3               	dec tmp+2
001817  3               	bne fopt0		; repeat for relevant steps down the list.
001817  3               
001817  3               	lda combyt		; get option.
001817  3               	sta varopt		; store the option.
001817  3               	dec varopt		; one less, due to where we increment combyt.
001817  3               	jmp redraw		; redraw the screen.
001817  3               fobj:
001817  3               	ldy combyt		; object number.
001817  3               	inc combyt		; ready for next item.
001817  3               	tya
001817  3               	jsr gotob		; do we have this item?
001817  3               	cmp #255
001817  3               	bne :+
001817  3               	rts
001817  3               :
001817  3               	jmp fobj		; yes, it's on the list.
001817  3               .endif
001817  3               
001817  3               ;----------------------------------------------------
001817  3               ; Clear sprite table.
001817  3               ;
001817  3               ; sprtab[0] - sprtab[SPRBUF-1] = 255
001817  3               ;----------------------------------------------------
001817  3               
001817  3               xspr:
001817  3  A9 FF        	lda #255		; clear byte.
001819  3  A2 00        	ldx #0			; length of table.
00181B  3               xspr0:
00181B  3  9D 00 0B     	sta sprtab,x		; sprite table.
00181E  3  E8           	inx			; move to next byte.
00181F  3  E0 CC        	cpx #SPRBUF
001821  3  D0 F8        	bne xspr0		; repeat for rest of table.
001823  3  60           	rts
001824  3               
001824  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
001824  3               ; Sound, NOT IMPLEMENTED!!!
001824  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
001824  3               ;
001824  3               ;silenc:
001824  3               ;	jsr silen1 		; silence channel 1.
001824  3               ;	jsr silen2 		; silence channel 2.
001824  3               ;	jsr silen3 		; silence channel 3.
001824  3               ;	jmp plsnd 		; play all channels to switch them off.
001824  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
001824  3               
001824  3               ;-------------------------------------------------------------
001824  3               ; Initialise all objects.
001824  3               ;
001824  3               ; Reset current room,y,x to start room,y,x for all objects
001824  3               ;-------------------------------------------------------------
001824  3               
001824  3               iniob:
001824  3  A9 DD        	lda #<objdta 		; objects table.
001826  3  85 rr        	sta z80_x
001828  3  A9 44        	lda #>objdta
00182A  3  85 rr        	sta z80_i
00182C  3               
00182C  3  AE 10 18     	ldx numob 		; number of objects in the game.
00182F  3               iniob0:
00182F  3  A0 23        	ldy #35
001831  3  B1 rr        	lda (z80_ix),y 		; start screen.
001833  3  A0 20        	ldy #32
001835  3  91 rr        	sta (z80_ix),y 		; set start screen.
001837  3               
001837  3  A0 24        	ldy #36
001839  3  B1 rr        	lda (z80_ix),y 		; find start y.
00183B  3  A0 21        	ldy #33
00183D  3  91 rr        	sta (z80_ix),y 		; set start y.
00183F  3               
00183F  3  A0 25        	ldy #37
001841  3  B1 rr        	lda (z80_ix),y 		; get initial x.
001843  3  A0 22        	ldy #34
001845  3  91 rr        	sta (z80_ix),y 		; set x coord.
001847  3               
001847  3  18           	clc 			; point to next object.
001848  3  A5 rr        	lda z80_x
00184A  3  69 26        	adc #38			; distance between objects.
00184C  3  85 rr        	sta z80_x
00184E  3  90 02        	bcc :+
001850  3  E6 rr        	inc z80_i
001852  3               :
001852  3  CA           	dex 			; repeat.
001853  3  D0 DA        	bne iniob0
001855  3               
001855  3  60           	rts
001856  3               
001856  3               ;-----------------------------------------------
001856  3               ; Redraw the screen.
001856  3               ;
001856  3               ; Remove old copy of all sprites for redraw.
001856  3               ;-----------------------------------------------
001856  3               
001856  3               redraw:
001856  3  A5 rr        	lda z80_i 		; place sprite pointer on stack.
001858  3  48           	pha
001859  3  A5 rr        	lda z80_x
00185B  3  48           	pha
00185C  3               
00185C  3  20 31 1E     	jsr droom		; show screen layout.
00185F  3  20 CB 1A     	jsr shwob		; draw objects.
001862  3               numsp0:
001862  3  A9 0C        	lda #NUMSPR		; sprites to draw.
001864  3  85 rr        	sta tmp
001866  3               
001866  3  A9 00        	lda #<sprtab		; sprite table.
001868  3  85 rr        	sta z80_x
00186A  3  A9 0B        	lda #>sprtab
00186C  3  85 rr        	sta z80_i
00186E  3               redrw0:
00186E  3  A0 00        	ldy #0
001870  3  B1 rr        	lda (z80_ix),y		; old sprite type.
001872  3  C9 FF        	cmp #255		; is it enabled?
001874  3  F0 0B        	beq redrw1 		; no, find next one.
001876  3               
001876  3  A0 03        	ldy #var_Y
001878  3  B1 rr        	lda (z80_ix),y 		; sprite y.
00187A  3  C9 B1        	cmp #177		; beyond maximum?
00187C  3  B0 03        	bcs redrw1		; yes, nothing to draw.
00187E  3               
00187E  3  20 33 10     	jsr sspria		; show single sprite.
001881  3               
001881  3               redrw1:
001881  3  18           	clc			; next sprite.
001882  3  A5 rr        	lda z80_x
001884  3  69 11        	adc #TABSIZ		; distance to next odd/even entry.
001886  3  85 rr        	sta z80_x
001888  3  90 02        	bcc :+
00188A  3  E6 rr        	inc z80_i
00188C  3               :
00188C  3  C6 rr        	dec tmp			; repeat for remaining sprites.
00188E  3  D0 DE        	bne redrw0
001890  3               
001890  3               rpblc1:
001890  3               ;	jsr dshrp		; redraw shrapnel.
001890  3               
001890  3  68           	pla			; retrieve sprite pointer.
001891  3  85 rr        	sta z80_x
001893  3  68           	pla
001894  3  85 rr        	sta z80_i
001896  3               
001896  3  60           	rts
001897  3               
001897  3               ;----------------------------------------------------------------------
001897  3               ; Clear screen routine.
001897  3               ;
001897  3               ; Fill screenmem $8000-$97ff with ScrFillByte
001897  3               ;----------------------------------------------------------------------
001897  3               
001897  3               cls:
001897  3  A9 50        	lda #>ScreenAddr		; screen address.
001899  3  8D A2 18     	sta clsloop+2
00189C  3  A9 00        	lda #ScrFillByte
00189E  3  A0 00        	ldy #0
0018A0  3               clsloop:
0018A0  3  99 00 50     	sta ScreenAddr,y
0018A3  3  C8           	iny
0018A4  3  D0 FA        	bne clsloop
0018A6  3  EE A2 18     	inc clsloop+2
0018A9  3  AE A2 18     	ldx clsloop+2
0018AC  3  E0 80        	cpx #>(ScreenAddr+ScreenSize)		; _BEEB
0018AE  3  D0 F0        	bne clsloop
0018B0  3  60           	rts
0018B1  3               
0018B1  3               ;----------------------------------------------------------------------
0018B1  3               ; FODDER check
0018B1  3               ;----------------------------------------------------------------------
0018B1  3               
0018B1  3               fdchk:
0018B1  3  C9 04        	cmp #FODDER 		; is it fodder?
0018B3  3  F0 01        	beq :+
0018B5  3  60           	rts 			; no.
0018B6  3               :
0018B6  3  A9 00        	lda #0			; wipe fodder in MAP
0018B8  3  A0 00        	ldy #0
0018BA  3  91 rr        	sta (bufaddr),y 	; rewrite block type.
0018BC  3               
0018BC  3  A5 rr        	lda dispx		; x=x/8
0018BE  3  48           	pha
0018BF  3  4A           	lsr a
0018C0  3  4A           	lsr a
0018C1  3  4A           	lsr a
0018C2  3  85 rr        	sta dispx
0018C4  3               
0018C4  3  A5 rr        	lda dispy		; y=y/8
0018C6  3  48           	pha
0018C7  3  4A           	lsr a
0018C8  3  4A           	lsr a
0018C9  3  4A           	lsr a
0018CA  3  85 rr        	sta dispy
0018CC  3               
0018CC  3  A9 00        	lda #0 			; block to write.
0018CE  3  20 68 13     	jsr pattr 		; write block.
0018D1  3               
0018D1  3  68           	pla
0018D2  3  85 rr        	sta dispy
0018D4  3  68           	pla
0018D5  3  85 rr        	sta dispx
0018D7  3  60           	rts
0018D8  3               
0018D8  3               ;----------------------------------------------------
0018D8  3               ; Scrolly text and puzzle variables.
0018D8  3               ;----------------------------------------------------
0018D8  3               
0018D8  3               .if sflag
0018D8  3               txtbit:	.byte 128		; bit to write.
0018D8  3               txtwid:	.byte 16		; width of ticker message.
0018D8  3               txtpos:	.word msgdat
0018D8  3               txtini:	.word msgdat
0018D8  3               txtscr:	.word ScreenAddr
0018D8  3               .endif
0018D8  3               
0018D8  3               ;----------------------------------------------------
0018D8  3               ; Specialist routines.
0018D8  3               ; Process shrapnel.
0018D8  3               ;----------------------------------------------------
0018D8  3               proshr:
0018D8  3               .if pflag
0018D8  3               	lda #<SHRAPN		; table.
0018D8  3               	sta z80_x
0018D8  3               	lda #>SHRAPN
0018D8  3               	sta z80_i
0018D8  3               
0018D8  3               	lda #NUMSHR		; shrapnel pieces to process.
0018D8  3               	sta shrctr
0018D8  3               prosh0:
0018D8  3               	ldy #0
0018D8  3               	lda (z80_ix),y		; on/off marker.
0018D8  3               	asl a
0018D8  3               proshx:
0018D8  3               	bcs :+
0018D8  3               	jsr prosh1 		; on, so process it.
0018D8  3               :
0018D8  3               	clc
0018D8  3               	lda z80_x
0018D8  3               	adc #SHRSIZ
0018D8  3               	sta z80_x
0018D8  3               	bcc :+
0018D8  3               	inc z80_i
0018D8  3               :
0018D8  3               	dec shrctr		; round again.
0018D8  3               	bne prosh0
0018D8  3               .endif
0018D8  3               .if sflag
0018D8  3               	jsr scrly
0018D8  3               .endif
0018D8  3  60           	rts
0018D9  3               
0018D9  3               .if pflag
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Proces shrapnel piece
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               prosh1:
0018D9  3               	jsr plot 		; delete the pixel.
0018D9  3               
0018D9  3               	lda #<shrptr		; shrapnel routine pointers.
0018D9  3               	sta z80_l
0018D9  3               	lda #>shrptr
0018D9  3               	sta z80_h
0018D9  3               
0018D9  3               	ldy #0
0018D9  3               	lda (z80_ix),y		; restore shrapnel type.
0018D9  3               	jsr prosh2 		; run the routine.
0018D9  3               	jsr chkxy		; check x and y are good before we redisplay.
0018D9  3               
0018D9  3               	lda #<SHRSIZ 		; distance to next.
0018D9  3               	sta z80_e
0018D9  3               	lda #>SHRSIZ
0018D9  3               	sta z80_d
0018D9  3               	rts
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Run the routine
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               prosh2:
0018D9  3               	asl a 			; 2 bytes per address.
0018D9  3               	tay
0018D9  3               	lda shrptr,y
0018D9  3               	sta z80_l
0018D9  3               	lda shrptr+1,y 		; fetch high byte from table.
0018D9  3               	sta z80_h
0018D9  3               	jmp (z80_hl) 		; jump to routine.
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Paricle routine table
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               shrptr:	.word laser		; laser.
0018D9  3               	.word trail		; vapour trail.
0018D9  3               	.word shrap		; shrapnel from explosion.
0018D9  3               	.word dotl		; horizontal starfield left.
0018D9  3               	.word dotr		; horizontal starfield right.
0018D9  3               	.word dotu		; vertical starfield up.
0018D9  3               	.word dotd		; vertical starfield down.
0018D9  3               	.word ptcusr		; user particle.
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Explosion shrapnel.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               shrap:
0018D9  3               	ldy #1
0018D9  3               	lda (z80_ix),y 		; get the angle.
0018D9  3               	clc
0018D9  3               	adc #<shrsin		; shrapnel sine table.
0018D9  3               	sta z80_l
0018D9  3               	lda #>shrsin
0018D9  3               	adc #0
0018D9  3               	sta z80_h
0018D9  3               
0018D9  3               	ldy #0
0018D9  3               	lda (z80_hl),y 		; fetch value from table.
0018D9  3               	sta z80_e
0018D9  3               	inc z80_l 		; next byte of table.
0018D9  3               	bne :+
0018D9  3               	inc z80_h
0018D9  3               :
0018D9  3               	ldy #0
0018D9  3               	lda (z80_hl),y		; fetch value from table.
0018D9  3               	sta z80_d
0018D9  3               	inc z80_l		; next byte of table.
0018D9  3               	bne :+
0018D9  3               	inc z80_h
0018D9  3               :
0018D9  3               	ldy #0
0018D9  3               	lda (z80_hl),y 		; fetch value from table.
0018D9  3               	sta z80_c
0018D9  3               	inc z80_l 		; next byte of table.
0018D9  3               	bne :+
0018D9  3               	inc z80_h
0018D9  3               :
0018D9  3               	ldy #0
0018D9  3               	lda (z80_hl),y 		; fetch value from table.
0018D9  3               	sta z80_b
0018D9  3               
0018D9  3               	ldy #2
0018D9  3               	lda (z80_ix),y 		; x coordinate in hl.
0018D9  3               	clc
0018D9  3               	adc z80_e		; add sine lb
0018D9  3               	sta (z80_ix),y		; store new coordinate lb.
0018D9  3               	ldy #3
0018D9  3               	lda (z80_ix),y
0018D9  3               	adc z80_d		; add sine hb
0018D9  3               	sta (z80_ix),y		; store new coordinate hb.
0018D9  3               
0018D9  3               	ldy #4
0018D9  3               	lda (z80_ix),y	 	; y coordinate in hl.
0018D9  3               	clc
0018D9  3               	adc z80_c		; add cosine lb
0018D9  3               	sta (z80_ix),y		; store new coordinate lb.
0018D9  3               	ldy #5
0018D9  3               	lda (z80_ix),y
0018D9  3               	adc z80_b		; add cosine lb
0018D9  3               	sta (z80_ix),y		; store new coordinate hb.
0018D9  3               
0018D9  3               	rts
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Move dots
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               dotl:
0018D9  3               	ldy #5
0018D9  3               	lda (z80_ix),y
0018D9  3               	sec
0018D9  3               	sbc #1		 	; move left.
0018D9  3               	sta (z80_ix),y
0018D9  3               	rts
0018D9  3               dotr:
0018D9  3               	ldy #5
0018D9  3               	lda (z80_ix),y
0018D9  3               	clc
0018D9  3               	adc #1		 	; move left.
0018D9  3               	sta (z80_ix),y
0018D9  3               	rts
0018D9  3               dotu:
0018D9  3               	ldy #3
0018D9  3               	lda (z80_ix),y
0018D9  3               	sec
0018D9  3               	sbc #1		 	; move up.
0018D9  3               	sta (z80_ix),y
0018D9  3               	rts
0018D9  3               dotd:
0018D9  3               	ldy #3
0018D9  3               	lda (z80_ix),y
0018D9  3               	clc
0018D9  3               	adc #1			; move down.
0018D9  3               	sta (z80_ix),y
0018D9  3               	rts
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Check if coordinates are ok before redrawing at new position.
0018D9  3               ;
0018D9  3               ; left:   X>L		X=L	Ok
0018D9  3               ; right:  R+15>X	X=R	Ok
0018D9  3               ; top:    Y>T		Y=T	Ok
0018D9  3               ; bottom: B+15>Y	Y=B	Ok
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               chkxy:
0018D9  3               
0018D9  3               ; top:    Y>T		Y=T	Ok
0018D9  3               
0018D9  3               	ldy #3
0018D9  3               	lda (z80_ix),y	 	; fetch shrapnel coordinate.
0018D9  3               	cmp wntopx		; window top.
0018D9  3               	bcs :+			; compare with top window limit.
0018D9  3               	jmp kilshr		; out of window, kill shrapnel.
0018D9  3               :
0018D9  3               ; left:   X>L		X=L	Ok
0018D9  3               
0018D9  3               	ldy #5
0018D9  3               	lda (z80_ix),y	 	; fetch shrapnel coordinate.
0018D9  3               	cmp wnlftx		; left edge.
0018D9  3               	bcs :+			; compare with left window limit.
0018D9  3               	jmp kilshr		; out of window, kill shrapnel.
0018D9  3               :
0018D9  3               ; bottom: B+15>Y	Y=B	Ok
0018D9  3               
0018D9  3               	lda wnbotx		; point to bottom.
0018D9  3               	clc
0018D9  3               	adc #15
0018D9  3               	ldy #3
0018D9  3               	cmp (z80_ix),y	 	; fetch shrapnel coordinate.
0018D9  3               	bcs :+			; compare with shrapnel x coordinate.
0018D9  3               	jmp kilshr		; off screen, kill shrapnel..
0018D9  3               :
0018D9  3               ; right:  R+15>X	X=R	Ok
0018D9  3               
0018D9  3               	lda wnrgtx		; point to right edge.
0018D9  3               	clc
0018D9  3               	adc #15
0018D9  3               	ldy #5
0018D9  3               	cmp (z80_ix),y	 	; fetch shrapnel coordinate.
0018D9  3               	bcs :+			; compare with window limit.
0018D9  3               	jmp kilshr		; off screen, kill shrapnel.
0018D9  3               :
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Drop through.
0018D9  3               ; Display shrapnel.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               plot:
0018D9  3               	ldy #3
0018D9  3               	lda (z80_ix),y		; y integer.
0018D9  3               	sta dispy	 	; workspace coordinates.
0018D9  3               	ldy #5
0018D9  3               	lda (z80_ix),y	 	; x integer.
0018D9  3               	sta dispx 		; workspace coordinates.
0018D9  3               
0018D9  3               	ldy #0
0018D9  3               	lda (z80_ix),y 		; type.
0018D9  3               	bne :+			; is it a laser?
0018D9  3               	jmp plot1 		; yes, draw laser instead.
0018D9  3               :
0018D9  3               plot0:
0018D9  3               	lda dispx		; which pixel within byte do we
0018D9  3               	and #7			; want to set first?
0018D9  3               	tay
0018D9  3               	lda dots,y 		; table of small pixel positions.
0018D9  3               	sta z80_e 		; get value.
0018D9  3               
0018D9  3               	jsr scadd 		; screen address.
0018D9  3               	ldy #0
0018D9  3               	lda (scraddr),y		; see what's already there.
0018D9  3               	eor z80_e
0018D9  3               	sta (scraddr),y 	; put back on screen.
0018D9  3               	rts
0018D9  3               
0018D9  3               plot1:
0018D9  3               	jsr scadd 		; screen address.
0018D9  3               	ldy #0
0018D9  3               	lda (scraddr),y 	; fetch byte there.
0018D9  3               	eor #255 		; toggle all bits.
0018D9  3               	sta (scraddr),y 	; new byte.
0018D9  3               	rts
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Switch off shrapnel
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               kilshr:
0018D9  3               	lda #128
0018D9  3               	ldy #0
0018D9  3               	sta (z80_ix),y	; switch off shrapnel.
0018D9  3               	rts
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Sine/cosine table
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               shrsin:	.word 0,1024,391,946,724,724,946,391
0018D9  3               	.word 1024,0,946,65144,724,64811,391,64589
0018D9  3               	.word 0,64512,65144,64589,64811,64811,64589,65144
0018D9  3               	.word 64512,0,64589,391,64811,724,65144,946
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Create trail
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               trail:
0018D9  3               	ldy #1
0018D9  3               	lda (z80_ix),y 	; time remaining.
0018D9  3               	sec
0018D9  3               	sbc #1
0018D9  3               	sta (z80_ix),y
0018D9  3               	bne :+
0018D9  3               	jmp trailk		; time to switch it off.
0018D9  3               :
0018D9  3               	jsr qrand		; get a random number.
0018D9  3               	lsr a 			; x or y axis?
0018D9  3               	bcc :+
0018D9  3               	jmp trailv		; use y.
0018D9  3               :
0018D9  3               ; Trail horizontal
0018D9  3               
0018D9  3               	lsr a 			; which direction?
0018D9  3               	bcc :+
0018D9  3               	jmp traill		; go left.
0018D9  3               :
0018D9  3               ; Trail right
0018D9  3               
0018D9  3               	ldy #5
0018D9  3               	lda (z80_ix),y
0018D9  3               	clc
0018D9  3               	adc #1	 		; go right.
0018D9  3               	sta (z80_ix),y
0018D9  3               	rts
0018D9  3               
0018D9  3               ; Trail left
0018D9  3               
0018D9  3               traill:
0018D9  3               	ldy #5
0018D9  3               	lda (z80_ix),y
0018D9  3               	sec
0018D9  3               	sbc #1 			; go left.
0018D9  3               	sta (z80_ix),y
0018D9  3               	rts
0018D9  3               
0018D9  3               ; Trail vertical
0018D9  3               
0018D9  3               trailv:
0018D9  3               	lsr a		 	; which direction?
0018D9  3               	bcc :+
0018D9  3               	jmp trailu		; go up.
0018D9  3               :
0018D9  3               ; Trail down
0018D9  3               
0018D9  3               	ldy #3
0018D9  3               	lda (z80_ix),y
0018D9  3               	clc
0018D9  3               	adc #1 			; go down.
0018D9  3               	sta (z80_ix),y
0018D9  3               	rts
0018D9  3               
0018D9  3               ; Trail up
0018D9  3               
0018D9  3               trailu:
0018D9  3               	ldy #3
0018D9  3               	lda (z80_ix),y
0018D9  3               	sec
0018D9  3               	sbc #1 			; go up.
0018D9  3               	sta (z80_ix),y
0018D9  3               	rts
0018D9  3               
0018D9  3               ; Kill trail
0018D9  3               
0018D9  3               trailk:
0018D9  3               	lda #200		; set off-screen to kill vapour trail.
0018D9  3               	ldy #3
0018D9  3               	sta (z80_ix),y
0018D9  3               	rts
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Create laser beam
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               laser:
0018D9  3               	ldy #1
0018D9  3               	lda (z80_ix),y 		; direction.
0018D9  3               	ror a 			; left or right?
0018D9  3               	bcs :+
0018D9  3               	jmp laserl		; move left.
0018D9  3               :
0018D9  3               ; Laser right
0018D9  3               
0018D9  3               	lda #8			; distance to travel.
0018D9  3               	sta z80_b
0018D9  3               	jmp laserm		; move laser.
0018D9  3               
0018D9  3               ; Laser left
0018D9  3               
0018D9  3               laserl:
0018D9  3               	lda #248		; distance to travel.
0018D9  3               	sta z80_b
0018D9  3               laserm:
0018D9  3               	ldy #5
0018D9  3               	lda (z80_ix),y		; x position.
0018D9  3               	clc
0018D9  3               	adc z80_b		; add distance.
0018D9  3               	sta (z80_ix),y		; set new x coordinate.
0018D9  3               
0018D9  3               ; Test new block.
0018D9  3               
0018D9  3               	sta dispx 		; set x for block collision detection purposes.
0018D9  3               	ldy #3
0018D9  3               	lda (z80_ix),y 		; get y.
0018D9  3               	sta dispy		; set coordinate for collision test.
0018D9  3               	jsr tstbl 		; get block type there.
0018D9  3               	cmp #WALL		; is it solid?
0018D9  3               	bne :+
0018D9  3               	jmp trailk		; yes, it cannot pass.
0018D9  3               :
0018D9  3                       cmp #FODDER             ; is it fodder?
0018D9  3                       bne :+
0018D9  3                       jsr fdchk               ; remove fodder block.
0018D9  3                       jmp trailk              ; destroy laser.
0018D9  3               :
0018D9  3                       rts                     ; no, ignore it.
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Dots mask
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               dots:	.byte 128,64,32,16,8,4,2,1
0018D9  3               
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Plot, preserving de.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               plotde:
0018D9  3               	lda z80_d 		; put de on stack.
0018D9  3               	pha
0018D9  3               	lda z80_e
0018D9  3               	pha
0018D9  3               
0018D9  3               	jsr plot 		; plot pixel.
0018D9  3               
0018D9  3               	pla			; restore de from stack.
0018D9  3               	sta z80_e
0018D9  3               	pla
0018D9  3               	sta z80_d
0018D9  3               
0018D9  3               	rts
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Shoot a laser.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               shoot:
0018D9  3               	sta z80_c		; store direction in c register.
0018D9  3               	ldy #8
0018D9  3               	lda (z80_ix),y 		; y coordinate.
0018D9  3               shoot1:
0018D9  3               	clc
0018D9  3               	adc #7 			; down 7 pixels.
0018D9  3               	sta z80_l 		; puty y coordinate in l.
0018D9  3               
0018D9  3               	ldy #9
0018D9  3               	lda (z80_ix),y 		; x coordinate in h.
0018D9  3               	sta z80_h
0018D9  3               
0018D9  3               	lda z80_i		; store pointer to sprite.
0018D9  3               	pha
0018D9  3               	lda z80_x
0018D9  3               	pha
0018D9  3               
0018D9  3               	jsr fpslot 		; find particle slot.
0018D9  3               	bcs :+
0018D9  3               	jmp vapou2		; failed, restore ix.
0018D9  3               :
0018D9  3               	lda #0
0018D9  3               	ldy #0
0018D9  3               	sta (z80_ix),y 		; set up a laser.
0018D9  3               
0018D9  3               	lda z80_c
0018D9  3               	ldy #1
0018D9  3               	sta (z80_ix),y 		; set the direction.
0018D9  3               
0018D9  3               	lda z80_l
0018D9  3               	ldy #3
0018D9  3               	sta (z80_ix),y		; set y coordinate.
0018D9  3               
0018D9  3               	ror z80_c		; check direction we want.
0018D9  3               	bcc :+
0018D9  3               	jmp shootr		; shoot right.
0018D9  3               :
0018D9  3               	lda z80_h		; X position.
0018D9  3               shoot0:
0018D9  3               	and #248		; align on character boundary.
0018D9  3               	ldy #5
0018D9  3               	sta (z80_ix),y		; set x coordinate.
0018D9  3               	jmp vapou0 		; draw first image.
0018D9  3               shootr:
0018D9  3               	lda z80_h		; x position.
0018D9  3               	clc
0018D9  3               	adc #15			; look right.
0018D9  3               	jmp shoot0		; align and continue.
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Create a bit of vapour trail.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               vapour:
0018D9  3               	lda z80_i		; store pointer to sprite.
0018D9  3               	pha
0018D9  3               	lda z80_x
0018D9  3               	pha
0018D9  3               
0018D9  3               	ldy #8
0018D9  3               	lda (z80_ix),y 		; y coordinate.
0018D9  3               	clc
0018D9  3               	adc #7			; mid-point of sprite.
0018D9  3               	sta z80_l
0018D9  3               
0018D9  3               	ldy #9
0018D9  3               	lda (z80_ix),y 		; x coordinate.
0018D9  3               	adc #7
0018D9  3               	sta z80_h
0018D9  3               
0018D9  3               	jsr fpslot 		; find particle slot.
0018D9  3               	bcc :+
0018D9  3               	jmp vapou1		; no, we can use it.
0018D9  3               :
0018D9  3               vapou2:
0018D9  3               	pla
0018D9  3               	sta z80_x
0018D9  3               	pla
0018D9  3               	sta z80_i
0018D9  3               	rts
0018D9  3               vapou1:
0018D9  3               	lda z80_l
0018D9  3               	ldy #3
0018D9  3               	sta (z80_ix),y		; set up y.
0018D9  3               
0018D9  3               	lda z80_h
0018D9  3               	ldy #5
0018D9  3               	sta (z80_ix),y 		; set up x coordinate.
0018D9  3               
0018D9  3               	jsr qrand		; get quick random number.
0018D9  3               	and #15			; random time.
0018D9  3               	clc
0018D9  3               	adc #15			; minimum time on screen.
0018D9  3               	ldy #1
0018D9  3               	sta (z80_ix),y		; set time on screen.
0018D9  3               
0018D9  3               	lda #1
0018D9  3               	ldy #0
0018D9  3               	sta (z80_ix),y		; define particle as vapour trail.
0018D9  3               vapou0:
0018D9  3               	jsr chkxy		; plot first position.
0018D9  3               	jmp vapou2
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Create a user particle.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               ptusr:
0018D9  3               	sta z80_f		; store timer.
0018D9  3               
0018D9  3               	ldy #8
0018D9  3               	lda (z80_ix),y 		; y coordinate.
0018D9  3               	clc
0018D9  3               	adc #7			; mid-point of sprite.
0018D9  3               	sta z80_l
0018D9  3               
0018D9  3               	ldy #9
0018D9  3               	lda (z80_ix),y 		; x coordinate.
0018D9  3               	clc
0018D9  3               	adc #7			; mid-point of sprite.
0018D9  3               	sta z80_h
0018D9  3               
0018D9  3               	jsr fpslot 		; find particle slot.
0018D9  3               	bcs ptusr1
0018D9  3               	rts 			; out of slots, can't generate anything.
0018D9  3               ptusr1:
0018D9  3               	lda z80_l
0018D9  3               	ldy #3
0018D9  3               	sta (z80_ix),y 		; set up y.
0018D9  3               
0018D9  3               	lda z80_h
0018D9  3               	ldy #5
0018D9  3               	sta (z80_ix),y		; set up x coordinate.
0018D9  3               
0018D9  3               	lda z80_f 		; restore timer.
0018D9  3               	ldy #1
0018D9  3               	sta (z80_ix),y		; set time on screen.
0018D9  3               
0018D9  3               	lda #7
0018D9  3               	ldy #0
0018D9  3               	sta (z80_ix),y		; define particle as user particle.
0018D9  3               
0018D9  3               	jmp chkxy		; plot first position.
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Create a vertical or horizontal star.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               star:
0018D9  3               	lda z80_i		; store pointer to sprite.
0018D9  3               	pha
0018D9  3               	lda z80_x
0018D9  3               	pha
0018D9  3               
0018D9  3               	jsr fpslot 		; find particle slot.
0018D9  3               	bcs star7		; found one we can use.
0018D9  3               star0:
0018D9  3               	pla 			; restore sprite pointer.
0018D9  3               	sta z80_x
0018D9  3               	pla
0018D9  3               	sta z80_i
0018D9  3               	rts 			; out of slots, can't generate anything.
0018D9  3               star7:
0018D9  3               	lda z80_c		; direction.
0018D9  3               	and #3 			; is it left?
0018D9  3               	bne :+
0018D9  3               	jmp star1 		; yes, it's left.
0018D9  3               :
0018D9  3               	cmp #1 			; is it right?
0018D9  3               	bne :+
0018D9  3               	jmp star2 		; yes, it's right.
0018D9  3               :
0018D9  3               	cmp #2 			; is it up?
0018D9  3               	bne :+
0018D9  3               	jmp star3 		; yes, it's up.
0018D9  3               :
0018D9  3               	ldy wntopx 		; get edge of screen.
0018D9  3               	iny			; down one pixel.
0018D9  3               	tya
0018D9  3               star8:
0018D9  3               	ldy #3
0018D9  3               	sta (z80_ix),y 		; set y coord.
0018D9  3               	jsr qrand 		; get quick random number.
0018D9  3               star9:
0018D9  3               	ldy #5
0018D9  3               	sta (z80_ix),y		; set x position.
0018D9  3               
0018D9  3               	lda z80_c		; direction.
0018D9  3               	and #3			; zero to three.
0018D9  3               	clc
0018D9  3               	adc #3			; 3 to 6 for starfield.
0018D9  3               	ldy #0
0018D9  3               	sta (z80_ix),y		; define particle as star.
0018D9  3               	jsr chkxy		; plot first position.
0018D9  3               	jmp star0
0018D9  3               star1:
0018D9  3               	jsr qrand		; get quick random number.
0018D9  3               	ldy #3
0018D9  3               	sta (z80_ix),y 		; set y coord.
0018D9  3               
0018D9  3               	lda wnrgtx 		; get edge of screen.
0018D9  3               	clc
0018D9  3               	adc #15			; add width of sprite minus 1.
0018D9  3               	jmp star9
0018D9  3               star2:
0018D9  3               	jsr qrand 		; get quick random number.
0018D9  3               	ldy #3
0018D9  3               	sta (z80_ix),y		; set y coord.
0018D9  3               
0018D9  3               	lda wnlftx		; get edge of screen.
0018D9  3               	jmp star9
0018D9  3               star3:
0018D9  3               	lda wnbotx 		; get edge of screen.
0018D9  3               	clc
0018D9  3               	adc #15 		; height of sprite minus one pixel.
0018D9  3               	jmp star8
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Find particle slot for lasers or vapour trail.
0018D9  3               ; can't use alternate accumulator.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               fpslot:
0018D9  3               	lda #<SHRAPN 		; shrapnel table.
0018D9  3               	sta z80_x
0018D9  3               	lda #>SHRAPN
0018D9  3               	sta z80_i
0018D9  3               
0018D9  3               	lda #NUMSHR		; number of pieces in table.
0018D9  3               	sta z80_b
0018D9  3               fpslt0:
0018D9  3               	ldy #0
0018D9  3               	lda (z80_ix),y		; get type.
0018D9  3               	asl a  			; is this slot in use?
0018D9  3               	bcc :+
0018D9  3               	rts			; no, we can use it.
0018D9  3               :
0018D9  3               	clc			; point to more shrapnel.
0018D9  3               	lda z80_x
0018D9  3               	adc #SHRSIZ
0018D9  3               	sta z80_x
0018D9  3               	bcc :+
0018D9  3               	inc z80_i
0018D9  3               :
0018D9  3               	dec z80_b		; repeat for all shrapnel.
0018D9  3               	bne fpslt0
0018D9  3               
0018D9  3               	clc
0018D9  3               	rts 			; out of slots, can't generate anything.
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Create an explosion at sprite position.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               explod:
0018D9  3               	sta z80_c 		; particles to create.
0018D9  3               
0018D9  3               	lda z80_i 		; store pointer to sprite.
0018D9  3               	pha
0018D9  3               	lda z80_x
0018D9  3               	pha
0018D9  3               
0018D9  3               	ldy #8
0018D9  3               	lda (z80_ix),y 		; y coordinate.
0018D9  3               	sta z80_l
0018D9  3               	ldy #9
0018D9  3               	lda (z80_ix),y		; x coordinate.
0018D9  3               	sta z80_h
0018D9  3               
0018D9  3               	lda #<SHRAPN		; shrapnel table.
0018D9  3               	sta z80_x
0018D9  3               	lda #>SHRAPN
0018D9  3               	sta z80_i
0018D9  3               
0018D9  3               	lda #NUMSHR		; number of pieces in table.
0018D9  3               	sta explcnt
0018D9  3               expld0:
0018D9  3               	ldy #0
0018D9  3               	lda (z80_ix),y		; get type.
0018D9  3               	asl a 			; is this slot in use?
0018D9  3               	bcs expld1		; no, we can use it.
0018D9  3               expld2:
0018D9  3               	clc
0018D9  3               	lda z80_x
0018D9  3               	adc #SHRSIZ
0018D9  3               	sta z80_x
0018D9  3               	bcc :+
0018D9  3               	inc z80_i
0018D9  3               :
0018D9  3               	dec explcnt		; repeat for all shrapnel.
0018D9  3               	bne expld0
0018D9  3               expld3:
0018D9  3               	pla			; restore sprite pointer.
0018D9  3               	sta z80_x
0018D9  3               	pla
0018D9  3               	sta z80_i
0018D9  3               	rts 			; out of slots, can't generate any more.
0018D9  3               
0018D9  3               expld1:
0018D9  3               	lda z80_c		; shrapnel counter.
0018D9  3               	and #15			; 0 to 15.
0018D9  3               	clc			; add to x.
0018D9  3               	adc z80_l
0018D9  3               	ldy #3
0018D9  3               	sta (z80_ix),y		; y coord.
0018D9  3               
0018D9  3               	lda seed3 		; crap random number.
0018D9  3               	and #15			; 0 to 15.
0018D9  3               	clc 			; add to y.
0018D9  3               	adc z80_h
0018D9  3               	ldy #5
0018D9  3               	sta (z80_ix),y		; x coord.
0018D9  3               
0018D9  3               	lda #2
0018D9  3               	ldy #0
0018D9  3               	sta (z80_ix),y		; switch it on.
0018D9  3               
0018D9  3               	jsr chkxy		; plot first position.
0018D9  3               	jsr qrand		; quick random angle.
0018D9  3               	and #60 		; keep within range.
0018D9  3               	ldy #1
0018D9  3               	sta (z80_ix),y		; angle.
0018D9  3               
0018D9  3               	dec z80_c		; one less piece of shrapnel to generate.
0018D9  3               	bne expld2 		; back to main explosion loop.
0018D9  3               	jmp expld3 		; restore sprite pointer and exit.
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Quick random
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               qrand:
0018D9  3               	jsr random		; r register.
0018D9  3               	eor seed3		; combine with seed.
0018D9  3               	sta seed3 		; new seed.
0018D9  3               	rts
0018D9  3               
0018D9  3               ;----------------------------------------------------
0018D9  3               ; Display all shrapnel.
0018D9  3               ;----------------------------------------------------
0018D9  3               
0018D9  3               dshrp:
0018D9  3               	lda #<plotde		; display routine.
0018D9  3               	sta proshx+1
0018D9  3               	lda #>plotde
0018D9  3               	sta proshx+2
0018D9  3               	jsr proshr		; process shrapnel.
0018D9  3               
0018D9  3               	lda #<prosh1		; processing routine.
0018D9  3               	sta proshx+1
0018D9  3               	lda #>prosh1
0018D9  3               	sta proshx+2
0018D9  3               	rts
0018D9  3               
0018D9  3               ;------------------------------------------------------
0018D9  3               ; Particle engine.
0018D9  3               ;
0018D9  3               ; Init particle data for 55 particles in SHRAPN table.
0018D9  3               ; Every particle has 6 bytes.
0018D9  3               ;
0018D9  3               ; global:	-
0018D9  3               ; local:	x,y,hl
0018D9  3               ; calls:	-
0018D9  3               ;------------------------------------------------------
0018D9  3               
0018D9  3               inishr:
0018D9  3               	lda #<SHRAPN 		; table.
0018D9  3               	sta z80_l
0018D9  3               	lda #>SHRAPN
0018D9  3               	sta z80_h
0018D9  3               
0018D9  3               	ldy #0
0018D9  3               	ldx #NUMSHR		; shrapnel pieces to process.
0018D9  3               inish0:
0018D9  3               	lda #255 		; kill the shrapnel.
0018D9  3               	sta (z80_hl),y
0018D9  3               
0018D9  3               	clc 			; point there.
0018D9  3               	lda z80_l
0018D9  3               	adc #SHRSIZ		; distance to next.
0018D9  3               	sta z80_l
0018D9  3               	bcc :+
0018D9  3               	inc z80_h
0018D9  3               :
0018D9  3               	dex
0018D9  3               	bne inish0 		; round again.
0018D9  3               	rts
0018D9  3               
0018D9  3               ;------------------------------------------------------
0018D9  3               ; Check for collision between laser and sprite.
0018D9  3               ;------------------------------------------------------
0018D9  3               
0018D9  3               lcol:
0018D9  3               	lda #<SHRAPN		; shrapnel table.
0018D9  3               	sta z80_l
0018D9  3               	lda #>SHRAPN
0018D9  3               	sta z80_h
0018D9  3               
0018D9  3               	lda #NUMSHR		; number of pieces in table.
0018D9  3               	sta z80_b
0018D9  3               lcol0:
0018D9  3               	ldy #0
0018D9  3               	lda (z80_hl),y 		; get type.
0018D9  3               	beq lcol1		; yes, check collision.
0018D9  3               lcol3:
0018D9  3               	clc			; point to more shrapnel.
0018D9  3               	lda z80_l
0018D9  3               	adc #SHRSIZ
0018D9  3               	sta z80_l
0018D9  3               	bcc :+
0018D9  3               	inc z80_h
0018D9  3               :
0018D9  3               	dec z80_b		; repeat for all shrapnel.
0018D9  3               	bne lcol0
0018D9  3               	rts 			; no collision, carry not set.
0018D9  3               lcol1:
0018D9  3               	ldy #3
0018D9  3               	lda (z80_hl),y		; get y.
0018D9  3               	sec
0018D9  3               	ldy #8
0018D9  3               	sbc (z80_ix),y		; subtract sprite y.
0018D9  3               lcolh:
0018D9  3               	cmp #16 		; within range?
0018D9  3               	bcc :+
0018D9  3               	jmp lcol2		; no, missed.
0018D9  3               :
0018D9  3               	ldy #5
0018D9  3               	lda (z80_hl),y 		; get x.
0018D9  3               	sec
0018D9  3               	ldy #9
0018D9  3               	sbc (z80_ix),y 		; subtract sprite y.
0018D9  3               	cmp #16			; within range?
0018D9  3               	bcs :+
0018D9  3               	jmp lcol4 		; yes, collision occurred.
0018D9  3               :
0018D9  3               lcol2:
0018D9  3               	jmp lcol3
0018D9  3               lcol4:
0018D9  3               	sec
0018D9  3               	rts 			; return with carry set for collision.
0018D9  3               .endif
0018D9  3               
0018D9  3               ;------------------------------------------------------
0018D9  3               ; Main game engine code starts here.
0018D9  3               ; After initialisation, mloop is the main loop
0018D9  3               ;------------------------------------------------------
0018D9  3               
0018D9  3               game:
0018D9  3               
0018D9  3               ; Set up screen address table.
0018D9  3               
0018D9  3               setsat:
0018D9  3  A9 00        	lda #<ScreenAddr		; start of screen.
0018DB  3  85 rr        	sta scraddr
0018DD  3  A9 50        	lda #>ScreenAddr
0018DF  3  85 rr        	sta scraddr+1
0018E1  3               
0018E1  3  A0 00        	ldy #0			; vertical lines on screen.
0018E3  3               setsa0:
0018E3  3  A5 rr        	lda scraddr
0018E5  3  99 00 06     	sta SCADTB_lb,y		; write low byte.
0018E8  3  A5 rr        	lda scraddr+1
0018EA  3  99 00 07     	sta SCADTB_hb,y		; write high byte.
0018ED  3  20 5B 11     	jsr nline		; next line down.
0018F0  3  C8           	iny			; next position in table.
0018F1  3  D0 F0        	bne setsa0
0018F3  3               
0018F3  3               ; Init graphics mode
0018F3  3               
0018F3  3  20 2F 0F     	jsr screeninit
0018F6  3               
0018F6  3               ; Init AtoMMC joystick
0018F6  3  20 FA 0E     	jsr joyinit		; AtoMMC joystick on PORT B
0018F9  3               
0018F9  3               rpblc2:
0018F9  3               .if pflag
0018F9  3               	jsr inishr 		; initialise particle engine.
0018F9  3               .endif
0018F9  3               evintr:
0018F9  3  20 00 3A     	jsr evnt12 		; call intro/menu event.
0018FC  3               
0018FC  3  A9 02        	lda #WALL 		; write default property.
0018FE  3  A2 00        	ldx #0
001900  3               clrmap:
001900  3  9D 00 03     	sta MAP,x 		; block properties.
001903  3  9D 00 04     	sta MAP+256,x
001906  3  9D 00 05     	sta MAP+512,x
001909  3  E8           	inx			; next byte.
00190A  3  D0 F4        	bne clrmap
00190C  3               
00190C  3  20 24 18     	jsr iniob 		; initialise objects.
00190F  3               
00190F  3  A9 00        	lda #0			; put zero in accumulator.
001911  3  85 rr        	sta gamwon		; reset game won flag.
001913  3               
001913  3  20 7B 1A     	jsr inisc 		; init the score.
001916  3               mapst:
001916  3  AD 5B 29     	lda stmap 		; start position on map.
001919  3  8D 50 29     	sta roomtb		; set up position in table, if there is one.
00191C  3               
00191C  3               inipbl:
00191C  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
00191C  3               .if aflag
00191C  3               	lda #<eop		; reset blockpointer
00191C  3               	sta pbptr
00191C  3               	lda #>eop
00191C  3               	sta pbptr+1
00191C  3               .endif
00191C  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
00191C  3  20 07 26     	jsr initsc 		; set up first screen.
00191F  3               
00191F  3  A9 3F        	lda #<ssprit 		; default to spare sprite in table.
001921  3  85 rr        	sta z80_x
001923  3  A9 29        	lda #>ssprit
001925  3  85 rr        	sta z80_i
001927  3               evini:
001927  3  20 01 3A     	jsr evnt13 		; initialisation.
00192A  3               
00192A  3               ; Two restarts.
00192A  3               ; First restart - clear all sprites and initialise everything.
00192A  3               
00192A  3               rstrt:
00192A  3  20 1B 1A     	jsr rsevt 		; restart events.
00192D  3  20 17 18     	jsr xspr 		; clear sprite table.
001930  3  20 73 27     	jsr sprlst 		; fetch pointer to screen sprites.
001933  3  20 FC 27     	jsr ispr 		; initialise sprite table.
001936  3               
001936  3  4C 45 19     	jmp rstrt0
001939  3               
001939  3               ; Second restart - clear all but player, and don't initialise him.
001939  3               
001939  3               rstrtn:
001939  3  20 1B 1A     	jsr rsevt		; restart events.
00193C  3  20 A0 27     	jsr nspr 		; clear all non-player sprites.
00193F  3  20 73 27     	jsr sprlst 		; fetch pointer to screen sprites.
001942  3  20 39 28     	jsr kspr 		; initialise sprite table, no more players.
001945  3               
001945  3               ; Set up the player and/or enemy sprites.
001945  3               
001945  3               rstrt0:
001945  3  A9 00        	lda #0 			; zero in accumulator.
001947  3  85 rr        	sta nexlev 		; reset next level flag.
001949  3  85 rr        	sta restfl 		; reset restart flag.
00194B  3  85 rr        	sta deadf 		; reset dead flag.
00194D  3  20 31 1E     	jsr droom 		; show screen layout.
001950  3               rpblc0:
001950  3               .if pflag
001950  3               	jsr inishr 		; initialise particle engine.
001950  3               .endif
001950  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
001950  3               .if aflag
001950  3               	jsr rbloc		; draw blocks for this screen
001950  3               .endif
001950  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
001950  3  20 CB 1A     	jsr shwob		; draw objects.
001953  3               
001953  3  A9 00        	lda #<sprtab 		; address of sprite table, even sprites.
001955  3  85 rr        	sta z80_x
001957  3  A9 0B        	lda #>sprtab
001959  3  85 rr        	sta z80_i
00195B  3               
00195B  3  20 D1 23     	jsr dspr 		; display sprites.
00195E  3               
00195E  3  A9 11        	lda #<(sprtab+TABSIZ) 	; address of first odd sprite.
001960  3  85 rr        	sta z80_x
001962  3  A9 0B        	lda #>(sprtab+TABSIZ)
001964  3  85 rr        	sta z80_i
001966  3  20 D1 23     	jsr dspr 		; display sprites.
001969  3               
001969  3               mloop:
001969  3  20 C5 0E     	jsr bbcsync
00196C  3               
00196C  3  20 12 0F     	jsr vsync 		; synchronise with display.
00196F  3               
00196F  3  A9 00        	lda #<sprtab 		; address of sprite table, even sprites.
001971  3  85 rr        	sta z80_x
001973  3  A9 0B        	lda #>sprtab
001975  3  85 rr        	sta z80_i
001977  3               
001977  3               DEBUG_PAL PAL_red
001977  3  20 D1 23     	jsr dspr 		; display even sprites.
00197A  3               DEBUG_PAL PAL_black
00197A  3               
00197A  3  20 CA 1A     	jsr plsnd 		; play sounds.
00197D  3  20 12 0F     	jsr vsync 		; synchronise with display.
001980  3               
001980  3  A9 11        	lda #<(sprtab+TABSIZ) 	; address of first odd sprite.
001982  3  85 rr        	sta z80_x
001984  3  A9 0B        	lda #>(sprtab+TABSIZ)
001986  3  85 rr        	sta z80_i
001988  3               
001988  3               DEBUG_PAL PAL_red
001988  3  20 D1 23     	jsr dspr 		; display odd sprites.
00198B  3               DEBUG_PAL PAL_black
00198B  3               
00198B  3  A9 3F        	lda #<(ssprit) 		; point to spare sprite for spawning purposes.
00198D  3  85 rr        	sta z80_x
00198F  3  A9 29        	lda #>(ssprit)
001991  3  85 rr        	sta z80_i
001993  3               evlp1:
001993  3               DEBUG_PAL PAL_green
001993  3  20 DF 39     	jsr evnt10 		; called once per main loop.
001996  3  20 4F 23     	jsr pspr 		; process sprites.
001999  3               DEBUG_PAL PAL_black
001999  3               
001999  3               ; Main loop events.
001999  3               
001999  3  A9 3F        	lda #<ssprit 		; point to spare sprite for spawning purposes.
00199B  3  85 rr        	sta z80_x
00199D  3  A9 29        	lda #>ssprit
00199F  3  85 rr        	sta z80_i
0019A1  3               DEBUG_PAL PAL_green
0019A1  3               evlp2:
0019A1  3  20 FF 39     	jsr evnt11 		; called once per main loop.
0019A4  3               bsortx:
0019A4  3  20 C5 22     	jsr bsort 		; sort sprites.
0019A7  3               DEBUG_PAL PAL_black
0019A7  3               
0019A7  3  A5 rr        	lda nexlev		; finished level flag.
0019A9  3  D0 1F        	bne newlev		; is set, go to next level.
0019AB  3  A5 rr        	lda gamwon		; finished game flag.
0019AD  3  D0 2A        	bne evwon		; is set, finish the game.
0019AF  3  A5 rr        	lda restfl 		; finished level flag.
0019B1  3  C9 01        	cmp #1			; has it been set?
0019B3  3  D0 03        	bne :+
0019B5  3  4C 2A 19     	jmp rstrt		; yes, go to next level.
0019B8  3               :
0019B8  3  C9 02        	cmp #2			; has it been set?
0019BA  3  D0 03        	bne :+
0019BC  3  4C 39 19     	jmp rstrtn		; yes, go to next level.
0019BF  3               :
0019BF  3  A5 rr        	lda deadf 		; dead flag.
0019C1  3  D0 1C        	bne pdead		; yes, player dead.
0019C3  3               
0019C3  3               ; back to start of main loop.
0019C3  3               
0019C3  3  E6 rr        	inc frmno
0019C5  3  E6 rr        	inc clock
0019C7  3  4C 69 19     	jmp mloop		; switched to a jmp mloop during test mode.
0019CA  3               
0019CA  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
0019CA  3               
0019CA  3               ;----------------------------------------------------------
0019CA  3               ; Read blocks from list and update screen accordingly.
0019CA  3               ;----------------------------------------------------------
0019CA  3               
0019CA  3               .if aflag
0019CA  3               rbloc:
0019CA  3               	lda #<eop		; reset temp blockpointer
0019CA  3               	sta tmp
0019CA  3               	lda #>eop
0019CA  3               	sta tmp+1
0019CA  3               
0019CA  3               rbloc2:
0019CA  3               	lda tmp			; check for last block
0019CA  3               	cmp pbptr
0019CA  3               	bne rbloc1
0019CA  3               	lda tmp+1
0019CA  3               	cmp pbptr+1
0019CA  3               	bne rbloc1
0019CA  3               	rts
0019CA  3               rbloc1:
0019CA  3               	ldy #0
0019CA  3               	lda (tmp),y		; check if block for this scno
0019CA  3               	cmp scno
0019CA  3               	bne rbloc0		; if not, skip
0019CA  3               	iny
0019CA  3               	lda (tmp),y		; get y
0019CA  3               	sta dispy
0019CA  3               	iny
0019CA  3               	lda (tmp),y		; get x
0019CA  3               	sta dispx
0019CA  3               	iny
0019CA  3               	lda (tmp),y		; get blocknr
0019CA  3               	jsr pattr2		; draw block
0019CA  3               rbloc0:
0019CA  3               	clc			; point to next block
0019CA  3               	lda tmp
0019CA  3               	adc #4
0019CA  3               	sta tmp
0019CA  3               	bcc rbloc2
0019CA  3               	inc tmp+1
0019CA  3               	jmp rbloc2
0019CA  3               .endif
0019CA  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
0019CA  3               
0019CA  3               ;----------------------------------------------------------
0019CA  3               ; New level
0019CA  3               ;----------------------------------------------------------
0019CA  3               
0019CA  3               newlev:
0019CA  3  A5 rr        	lda scno 			; current screen.
0019CC  3  18           	clc
0019CD  3  69 01        	adc #1				; next screen.
0019CF  3  CD AA 44     	cmp numsc			; total number of screens.
0019D2  3  B0 05        	bcs evwon			; yes, game finished.
0019D4  3  85 rr        	sta scno			; set new level number.
0019D6  3  4C 2A 19     	jmp rstrt			; restart, clearing all aliens.
0019D9  3               
0019D9  3               evwon:
0019D9  3  20 AA 3A     	jsr evnt18		 	; game completed.
0019DC  3  4C F0 19     	jmp tidyup			; tidy up and return to BASIC/calling routine.
0019DF  3               
0019DF  3               ;----------------------------------------------------------
0019DF  3               ; Player dead.
0019DF  3               ;----------------------------------------------------------
0019DF  3               
0019DF  3               pdead:
0019DF  3  A9 00        	lda #0				; zeroise accumulator.
0019E1  3  85 rr        	sta deadf			; reset dead flag.
0019E3  3               evdie:
0019E3  3  20 A8 3A     	jsr evnt16 			; death subroutine.
0019E6  3  A5 rr        	lda numlif			; number of lives.
0019E8  3  F0 03        	beq :+
0019EA  3  4C 2A 19     	jmp rstrt 			; restart game.
0019ED  3               :
0019ED  3               evfail:
0019ED  3  20 A9 3A     	jsr evnt17 			; failure event.
0019F0  3               
0019F0  3               ;----------------------------------------------------------
0019F0  3               ; Tidy things up
0019F0  3               ;----------------------------------------------------------
0019F0  3               
0019F0  3               tidyup:
0019F0  3  A0 00        	ldy #0				; digits to check.
0019F2  3               tidyu2:
0019F2  3  B9 95 1C     	lda score,y 			; get score digit.
0019F5  3  CD 9B 1C     	cmp hiscor 			; are we larger than high score digit?
0019F8  3  90 07        	bcc tidyu0			; high score is bigger.
0019FA  3  D0 0E        	bne tidyu1			; score is greater, record new high score.
0019FC  3  C8           	iny				; next digit of high score.
0019FD  3  C0 06        	cpy #6
0019FF  3  D0 F1        	bne tidyu2			; repeat for all digits
001A01  3               tidyu0:
001A01  3  A9 95        	lda #<score			; return pointing to score.
001A03  3  85 rr        	sta z80_c
001A05  3  A9 1C        	lda #>score
001A07  3  85 rr        	sta z80_b
001A09  3  60           	rts
001A0A  3               tidyu1:
001A0A  3  A0 05        	ldy #5
001A0C  3               tidyu3:
001A0C  3  B9 95 1C     	lda score,y			; score.
001A0F  3  99 9B 1C     	sta hiscor,y			; high score.
001A12  3  88           	dey
001A13  3  10 F7        	bpl tidyu3 			; copy score to high score.
001A15  3               evnewh:
001A15  3  20 AB 3A     	jsr evnt19			; new high score event.
001A18  3  4C 01 1A     	jmp tidyu0			; tidy up.
001A1B  3               
001A1B  3               ;--------------------------------------------------
001A1B  3               ; Restart event.
001A1B  3               ;--------------------------------------------------
001A1B  3               
001A1B  3               rsevt:
001A1B  3  A9 3F        	lda #<ssprit 			; default to spare element in table.
001A1D  3  85 rr        	sta z80_x
001A1F  3  A9 29        	lda #>ssprit
001A21  3  85 rr        	sta z80_i
001A23  3               evrs:
001A23  3  4C 0A 3A     	jmp evnt14	 		; call restart event.
001A26  3               
001A26  3               ;------------------------------------------------------------------
001A26  3               ; Copy number passed in a to string position bc, right-justified.
001A26  3               ;
001A26  3               ; Input:
001A26  3               ;  A  = number
001A26  3               ;  BC = string address
001A26  3               ;
001A26  3               ; Output:
001A26  3               ;  BC = string with number
001A26  3               ;-----------------------------------------------------------------
001A26  3               
001A26  3               num2ch:
001A26  3  85 rr        	sta z80_d		; Save number
001A28  3               
001A28  3  A9 00        	lda #0
001A2A  3  85 rr        	sta flag
001A2C  3               numdg3:
001A2C  3  A2 64        	ldx #100		; hundreds column.
001A2E  3  86 rr        	stx z80_e
001A30  3  20 40 1A     	jsr numdg		; show digit.
001A33  3               numdg2:
001A33  3  A2 0A        	ldx #10			; tens column.
001A35  3  86 rr        	stx z80_e
001A37  3  20 40 1A     	jsr numdg		; show digit.
001A3A  3               
001A3A  3  E6 rr        	inc flag
001A3C  3  A2 01        	ldx #1			; units column.
001A3E  3  86 rr        	stx z80_e
001A40  3               numdg:
001A40  3  A9 30        	lda #48			; clear digit.
001A42  3  85 rr        	sta z80_a
001A44  3               numdg1:
001A44  3  A5 rr        	lda z80_d
001A46  3  C5 rr        	cmp z80_e
001A48  3  90 0E        	bcc numdg0		; nothing to show.
001A4A  3  38           	sec
001A4B  3  A5 rr        	lda z80_d
001A4D  3  E5 rr        	sbc z80_e		; subtract from column.
001A4F  3  85 rr        	sta z80_d
001A51  3  E6 rr        	inc z80_a		; increment digit.
001A53  3  E6 rr        	inc flag
001A55  3  4C 44 1A     	jmp numdg1		; repeat until column is zero.
001A58  3               numdg0:
001A58  3  A0 00        	ldy #0
001A5A  3  A5 rr        	lda z80_a
001A5C  3  91 rr        	sta (z80_bc),y		; write digit to buffer.
001A5E  3  A5 rr        	lda flag
001A60  3  F0 06        	beq :+
001A62  3  E6 rr        	inc z80_c		; next buffer position.
001A64  3  D0 02        	bne :+
001A66  3  E6 rr        	inc z80_b
001A68  3               :
001A68  3  60           	rts
001A69  3               num2dd:
001A69  3  85 rr        	sta z80_d		; Save number
001A6B  3               
001A6B  3  A9 01        	lda #1
001A6D  3  85 rr        	sta flag
001A6F  3               
001A6F  3  4C 33 1A     	jmp numdg2
001A72  3               num2td:
001A72  3  85 rr        	sta z80_d		; Save number
001A74  3               
001A74  3  A9 01        	lda #1
001A76  3  85 rr        	sta flag
001A78  3  4C 2C 1A     	jmp numdg3
001A7B  3               
001A7B  3               ;---------------------------------------------------------
001A7B  3               ; Reset score to "000000"
001A7B  3               ;---------------------------------------------------------
001A7B  3               
001A7B  3               inisc:
001A7B  3  A9 30        	lda #'0'
001A7D  3  A2 05        	ldx #5			; digits to initialise.
001A7F  3               inisc0:
001A7F  3  9D 95 1C     	sta score,x 		; write zero digit.
001A82  3  CA           	dex			; next column.
001A83  3  10 FA        	bpl inisc0		; repeat for all digits.
001A85  3               
001A85  3  60           	rts
001A86  3               
001A86  3               ;-----------------------------------------------------
001A86  3               ; Multiply h by d and return in hl.
001A86  3               ;
001A86  3               ; Input:
001A86  3               ;  H = first number
001A86  3               ;  D = second number
001A86  3               ;
001A86  3               ; Output:
001A86  3               ;  HL = result H x D
001A86  3               ;-----------------------------------------------------
001A86  3               
001A86  3               imul:
001A86  3  A5 rr        	lda z80_d		; HL = H * D
001A88  3  85 rr        	sta z80_e
001A8A  3  A5 rr        	lda z80_h
001A8C  3  85 rr        	sta z80_c		; make c first multiplier.
001A8E  3               imul0:
001A8E  3  A9 00        	lda #0			; zeroise total.
001A90  3  85 rr        	sta z80_l
001A92  3  85 rr        	sta z80_h
001A94  3               
001A94  3  A5 rr        	lda z80_h
001A96  3  85 rr        	sta z80_d		; zeroise high byte.
001A98  3               
001A98  3  A9 08        	lda #8			; repeat 8 times.
001A9A  3  85 rr        	sta z80_b
001A9C  3               imul1:
001A9C  3  46 rr        	lsr z80_c		; rotate rightmost bit into carry.
001A9E  3  90 0E        	bcc imul2		; wasn't set.
001AA0  3  18           	clc			; bit was set, so add de.
001AA1  3  A5 rr        	lda z80_l
001AA3  3  65 rr        	adc z80_e
001AA5  3  85 rr        	sta z80_l
001AA7  3  A5 rr        	lda z80_h
001AA9  3  65 rr        	adc z80_d
001AAB  3  85 rr        	sta z80_h
001AAD  3  18           	clc 			; reset carry.
001AAE  3               imul2:
001AAE  3  06 rr        	asl z80_e 		; shift de 1 bit left.
001AB0  3  26 rr        	rol z80_d
001AB2  3  C6 rr        	dec z80_b
001AB4  3  D0 E6        	bne imul1		; repeat 8 times.
001AB6  3               
001AB6  3  60           	rts
001AB7  3               
001AB7  3               ;-----------------------------------------------
001AB7  3               ; Divide d by e and return in d, remainder in a.
001AB7  3               ;
001AB7  3               ; Input:
001AB7  3               ;  D = first number
001AB7  3               ;  E = second number
001AB7  3               ;
001AB7  3               ; Output:
001AB7  3               ;  D = result D/E
001AB7  3               ;  A = remainder
001AB7  3               ;-----------------------------------------------
001AB7  3               
001AB7  3               idiv:
001AB7  3  A9 00        	lda #0
001AB9  3  A0 08        	ldy #8		 	; bits to shift.
001ABB  3  06 rr        	asl z80_d
001ABD  3               idiv0:
001ABD  3  2A           	rol a 			; multiply d by 2.
001ABE  3  C5 rr        	cmp z80_e 		; test if e is smaller.
001AC0  3  90 02        	bcc idiv1		; e is greater, no division this time.
001AC2  3  E5 rr        	sbc z80_e		; subtract it.
001AC4  3               idiv1:
001AC4  3  26 rr        	rol z80_d		; rotate into d.
001AC6  3  88           	dey
001AC7  3  D0 F4        	bne idiv0		; repeat
001AC9  3  60           	rts
001ACA  3               
001ACA  3               ;---------------------------------------------------
001ACA  3               ; Play AY sound effect
001ACA  3               ;---------------------------------------------------
001ACA  3               
001ACA  3               plsnd:
001ACA  3  60           	rts
001ACB  3               
001ACB  3               ;---------------------------------------------------
001ACB  3               ; Objects handling.
001ACB  3               ; 32 bytes for image
001ACB  3               ; 3 for room, y and x
001ACB  3               ; 3 for starting room, y and x.
001ACB  3               ; 254 = disabled.
001ACB  3               ; 255 = object in player"s pockets.
001ACB  3               ;---------------------------------------------------
001ACB  3               
001ACB  3               ;---------------------------------------------------
001ACB  3               ; Show items present.
001ACB  3               ;---------------------------------------------------
001ACB  3               
001ACB  3               shwob:
001ACB  3  A9 DD        	lda #<objdta 			; objects table.
001ACD  3  85 rr        	sta z80_l
001ACF  3  A9 44        	lda #>objdta
001AD1  3  85 rr        	sta z80_h
001AD3  3               
001AD3  3  AD 10 18     	lda numob 			; number of objects in the game.
001AD6  3  85 rr        	sta sprcnt
001AD8  3               shwob0:
001AD8  3  A0 20        	ldy #32 			; distance to room number.
001ADA  3  B1 rr        	lda (z80_hl),y 			; same as an item?
001ADC  3  C5 rr        	cmp scno 			; current location.
001ADE  3  D0 03        	bne :+
001AE0  3  20 F5 1A     	jsr dobj 			; yes, display object.
001AE3  3               :
001AE3  3  18           	clc
001AE4  3  A5 rr        	lda z80_l
001AE6  3  69 26        	adc #38 			; distance to next item.
001AE8  3  85 rr        	sta z80_l
001AEA  3  A5 rr        	lda z80_h
001AEC  3  69 00        	adc #0
001AEE  3  85 rr        	sta z80_h	 		; point to it.
001AF0  3  C6 rr        	dec sprcnt
001AF2  3  D0 E4        	bne shwob0 			; repeat for others.
001AF4  3  60           	rts
001AF5  3               
001AF5  3               ;---------------------------------------------------
001AF5  3               ; Display object.
001AF5  3               ; hl must point to object's start address.
001AF5  3               ;
001AF5  3               ; Input:
001AF5  3               ;  HL = object address
001AF5  3               ;---------------------------------------------------
001AF5  3               
001AF5  3               dobj:
001AF5  3  A0 21        	ldy #33
001AF7  3  B1 rr        	lda (z80_hl),y 			; point to y.
001AF9  3  85 rr        	sta dispy
001AFB  3  C8           	iny
001AFC  3  B1 rr        	lda (z80_hl),y 			; point to x.
001AFE  3  85 rr        	sta dispx
001B00  3               dobj1:
001B00  3  4C 6F 0F     	jmp sprite 			; draw this sprite.
001B03  3               
001B03  3               ;--------------------------------------
001B03  3               ; Remove an object.
001B03  3               ;
001B03  3               ; Input:
001B03  3               ;  A = object number
001B03  3               ;--------------------------------------
001B03  3               
001B03  3               remob:
001B03  3  CD 10 18     	cmp numob			; number of objects in game.
001B06  3  90 01        	bcc :+				; are we checking past the end?
001B08  3  60           	rts				; yes, can't get non-existent item.
001B09  3               :
001B09  3  48           	pha				; remember object.
001B0A  3  20 18 1B     	jsr getob			; pick it up if we haven't already got it.
001B0D  3  68           	pla				; retrieve object number.
001B0E  3  20 47 1B     	jsr gotob			; get its address.
001B11  3  A9 FE        	lda #254
001B13  3  A0 20        	ldy #32
001B15  3  91 rr        	sta (z80_hl),y			; remove it.
001B17  3  60           	rts
001B18  3               
001B18  3               ;---------------------------------------------------
001B18  3               ; Pick up object number held in the accumulator.
001B18  3               ;
001B18  3               ; Input:
001B18  3               ;  A = object number
001B18  3               ;---------------------------------------------------
001B18  3               
001B18  3               getob:
001B18  3  CD 10 18     	cmp numob 		; number of objects in game.
001B1B  3  90 01        	bcc :+			; are we checking past the end?
001B1D  3  60           	rts			; yes, can't get non-existent item.
001B1E  3               :
001B1E  3  20 47 1B     	jsr gotob 		; check if we already have it.
001B21  3  C9 FF        	cmp #255
001B23  3  D0 01        	bne :+
001B25  3  60           	rts			; we already do.
001B26  3               :
001B26  3  A0 20        	ldy #32
001B28  3  B1 rr        	lda (z80_hl),y		; is it on this screen?
001B2A  3  C5 rr        	cmp scno 		; current screen.
001B2C  3  D0 14        	bne getob0		; not on screen, so nothing to delete.
001B2E  3               
001B2E  3  A9 FF        	lda #255
001B30  3  91 rr        	sta (z80_hl),y		; pick it up.
001B32  3  C8           	iny 			; point to y coord.
001B33  3               getob1:
001B33  3  A0 21        	ldy #33
001B35  3  B1 rr        	lda (z80_hl),y		; y coord.
001B37  3  85 rr        	sta dispy
001B39  3  A0 22        	ldy #34
001B3B  3  B1 rr        	lda (z80_hl),y 		; x coord.
001B3D  3  85 rr        	sta dispx
001B3F  3  4C 00 1B     	jmp dobj1 		; delete object sprite.
001B42  3               getob0:
001B42  3  A9 FF        	lda #255
001B44  3  91 rr        	sta (z80_hl),y 		; pick it up.
001B46  3  60           	rts
001B47  3               
001B47  3               ;-----------------------------------------------------------------
001B47  3               ; Got object check.
001B47  3               ; Call with object in accumulator, returns zero set if in pockets.
001B47  3               ;
001B47  3               ; Input:
001B47  3               ;  A = object number
001B47  3               ;-----------------------------------------------------------------
001B47  3               
001B47  3               gotob:
001B47  3  CD 10 18     	cmp numob 		; number of objects in game.
001B4A  3  90 03        	bcc :+ 			; are we checking past the end?
001B4C  3  4C 53 1B     	jmp gotob0 		; yes, we can't have a non-existent object.
001B4F  3               :
001B4F  3  20 58 1B     	jsr findob		; find the object.
001B52  3               gotob1:
001B52  3  60           	rts
001B53  3               
001B53  3               gotob0:
001B53  3  A9 FE        	lda #254 		; missing.
001B55  3  4C 52 1B     	jmp gotob1
001B58  3               
001B58  3               findob:
001B58  3  48           	pha			; save object number
001B59  3  A9 DD        	lda #<objdta 		; objects.
001B5B  3  85 rr        	sta z80_l
001B5D  3  A9 44        	lda #>objdta
001B5F  3  85 rr        	sta z80_h
001B61  3  68           	pla			; retreive object number
001B62  3  F0 0F        	beq fndob1 		; is it zero? yes, skip loop.
001B64  3  AA           	tax 			; loop counter
001B65  3               fndob2:
001B65  3  18           	clc
001B66  3  A5 rr        	lda z80_l
001B68  3  69 26        	adc #38 		; size of each object.
001B6A  3  85 rr        	sta z80_l
001B6C  3  90 02        	bcc :+
001B6E  3  E6 rr        	inc z80_h
001B70  3               :
001B70  3  CA           	dex 			; repeat until we find address.
001B71  3  D0 F2        	bne fndob2
001B73  3               fndob1:
001B73  3  A0 20        	ldy #32			; distance to room it's in.
001B75  3  B1 rr        	lda (z80_hl),y		; fetch status.
001B77  3  60           	rts
001B78  3               
001B78  3               ;---------------------------------------------
001B78  3               ; Drop object number at (dispx, dispy).
001B78  3               ;
001B78  3               ; Input:
001B78  3               ;  A = object number
001B78  3               ;---------------------------------------------
001B78  3               
001B78  3               drpob:
001B78  3  CD 10 18     	cmp numob 		; are we checking past the end?
001B7B  3  90 01        	bcc :+
001B7D  3  60           	rts			; yes, can't drop non-existent item.
001B7E  3               :
001B7E  3  20 47 1B     	jsr gotob		; make sure object is in inventory.
001B81  3  C5 rr        	cmp scno		; already on this screen?
001B83  3  D0 01        	bne :+
001B85  3  60           	rts			; yes, nothing to do.
001B86  3               :
001B86  3  A0 20        	ldy #32
001B88  3  A5 rr        	lda scno
001B8A  3  91 rr        	sta (z80_hl),y		; bring onto screen.
001B8C  3  A5 rr        	lda dispy		; sprite y coordinate.
001B8E  3  C8           	iny
001B8F  3  91 rr        	sta (z80_hl),y		; point to object y.
001B91  3  A5 rr        	lda dispx 		; sprite x coordinate.
001B93  3  C8           	iny
001B94  3  91 rr        	sta (z80_hl),y 		; point to object x
001B96  3  4C F5 1A     	jmp dobj		; draw the object sprite.
001B99  3               
001B99  3               ;-----------------------------------------------
001B99  3               ; Seek objects at sprite position.
001B99  3               ;
001B99  3               ; Output:
001B99  3               ;  A = object number, if not found A=255
001B99  3               ;-----------------------------------------------
001B99  3               
001B99  3               skobj:
001B99  3  A9 DD        	lda #<objdta 		; pointer to objects.
001B9B  3  85 rr        	sta z80_l
001B9D  3  A9 44        	lda #>objdta
001B9F  3  85 rr        	sta z80_h
001BA1  3               
001BA1  3  AD 10 18     	lda numob 		; number of objects in game.
001BA4  3  85 rr        	sta z80_b 		; set up the loop counter.
001BA6  3               skobj0:
001BA6  3  A5 rr        	lda scno		; current room number.
001BA8  3  A0 20        	ldy #32
001BAA  3  D1 rr        	cmp (z80_hl),y		; is object in here?
001BAC  3  D0 03        	bne :+
001BAE  3  20 C3 1B     	jsr skobj1		; yes, check coordinates.
001BB1  3               :
001BB1  3  18           	clc			; point to next object in table.
001BB2  3  A5 rr        	lda z80_l
001BB4  3  69 26        	adc #38			; size of each object.
001BB6  3  85 rr        	sta z80_l
001BB8  3  90 02        	bcc :+
001BBA  3  E6 rr        	inc z80_h
001BBC  3               :
001BBC  3  C6 rr        	dec z80_b
001BBE  3  D0 E6        	bne skobj0		; repeat for all objects.
001BC0  3               
001BC0  3  A9 FF        	lda #255		; end of list and nothing found, return 255.
001BC2  3  60           	rts
001BC3  3               
001BC3  3               skobj1:
001BC3  3  A0 21        	ldy #33			; point to y coordinate.
001BC5  3  B1 rr        	lda (z80_hl),y		; point to y coordinate.
001BC7  3  38           	sec
001BC8  3  A0 08        	ldy #var_newY
001BCA  3  F1 rr        	sbc (z80_ix),y 		; subtract sprite y.
001BCC  3  18           	clc
001BCD  3  69 0F        	adc #15			; add sprite height minus one.
001BCF  3  C9 1F        	cmp #31			; within range?
001BD1  3  90 03        	bcc :+
001BD3  3  4C F1 1B     	jmp skobj2		; no, ignore object.
001BD6  3               :
001BD6  3  A0 22        	ldy #34			; point to x coordinate now.
001BD8  3  B1 rr        	lda (z80_hl),y 		; get coordinate.
001BDA  3  38           	sec
001BDB  3  A0 09        	ldy #var_newX
001BDD  3  F1 rr        	sbc (z80_ix),y 		; subtract the sprite x.
001BDF  3  18           	clc			; add sprite width minus one.
001BE0  3  69 0F        	adc #15
001BE2  3  C9 1F        	cmp #31			; within range?
001BE4  3  90 03        	bcc :+
001BE6  3  4C F1 1B     	jmp skobj2		; no, ignore object.
001BE9  3               :
001BE9  3  68           	pla			; remove return address from stack.
001BEA  3  68           	pla
001BEB  3               
001BEB  3  AD 10 18     	lda numob 		; objects in game.
001BEE  3  38           	sec
001BEF  3  E5 rr        	sbc z80_b		; subtract loop counter.
001BF1  3               skobj2:
001BF1  3  60           	rts			; accumulator now points to object.
001BF2  3               
001BF2  3               
001BF2  3               ;---------------------------------------------------------------------
001BF2  3               ; Spawn a new sprite.
001BF2  3               ;---------------------------------------------------------------------
001BF2  3               
001BF2  3               spawn:
001BF2  3  A9 00        	lda #<sprtab		; sprite table.
001BF4  3  85 rr        	sta z80_l
001BF6  3  A9 0B        	lda #>sprtab
001BF8  3  85 rr        	sta z80_h
001BFA  3               numsp1:
001BFA  3  A9 0C        	lda #NUMSPR		; number of sprites.
001BFC  3  85 rr        	sta spcnt
001BFE  3               spaw0:
001BFE  3  A0 00        	ldy #var_Type
001C00  3  B1 rr        	lda (z80_hl),y		; get sprite type.
001C02  3  C9 FF        	cmp #255		; is it an unused slot?
001C04  3  F0 0F        	beq spaw1 		; yes, we can use this one.
001C06  3               
001C06  3  18           	clc 			; point to next sprite in table.
001C07  3  A5 rr        	lda z80_l
001C09  3  69 11        	adc #TABSIZ		; size of each entry.
001C0B  3  85 rr        	sta z80_l
001C0D  3  90 02        	bcc :+
001C0F  3  E6 rr        	inc z80_h
001C11  3               :
001C11  3  C6 rr        	dec spcnt		; one less iteration.
001C13  3  D0 E9        	bne spaw0		; keep going until we find a slot.
001C15  3               
001C15  3               ; Didn't find one but drop through and set up a dummy sprite instead.
001C15  3               
001C15  3               spaw1:
001C15  3  A5 rr        	lda z80_i		; address of original sprite.
001C17  3  48           	pha
001C18  3  A5 rr        	lda z80_x
001C1A  3  48           	pha
001C1B  3               
001C1B  3  A5 rr        	lda z80_l		; store spawned sprite address.
001C1D  3  85 rr        	sta spptr
001C1F  3  A5 rr        	lda z80_h
001C21  3  85 rr        	sta spptr+1
001C23  3               
001C23  3  A5 rr        	lda z80_c
001C25  3  A0 00        	ldy #var_Type
001C27  3  91 rr        	sta (z80_hl),y 		; set the type.
001C29  3  A0 05        	ldy #var_newType
001C2B  3  91 rr        	sta (z80_hl),y		; copy
001C2D  3               
001C2D  3  A5 rr        	lda z80_b
001C2F  3  A0 01        	ldy #var_Image
001C31  3  91 rr        	sta (z80_hl),y		; set the image.
001C33  3  A0 06        	ldy #var_newImage
001C35  3  91 rr        	sta (z80_hl),y		; copy
001C37  3               
001C37  3  A9 00        	lda #0 				; frame zero.
001C39  3  A0 02        	ldy #var_Frame
001C3B  3  91 rr        	sta (z80_hl),y		; set frame.
001C3D  3  A0 07        	ldy #var_newFrame
001C3F  3  91 rr        	sta (z80_hl),y		; copy
001C41  3               
001C41  3  A0 09        	ldy #9
001C43  3  B1 rr        	lda (z80_ix),y 		; x coordinate.
001C45  3  A0 04        	ldy #var_X
001C47  3  91 rr        	sta (z80_hl),y		; set sprite coordinate.
001C49  3  A0 09        	ldy #var_newX
001C4B  3  91 rr        	sta (z80_hl),y		; copy
001C4D  3               
001C4D  3  A0 08        	ldy #8
001C4F  3  B1 rr        	lda (z80_ix),y 		; y coordinate.
001C51  3  A0 03        	ldy #var_Y
001C53  3  91 rr        	sta (z80_hl),y		; set sprite coordinate.
001C55  3  A0 08        	ldy #var_newY
001C57  3  91 rr        	sta (z80_hl),y		; copy
001C59  3               
001C59  3  A0 0A        	ldy #10				; direction of original.
001C5B  3  B1 rr        	lda (z80_ix),y
001C5D  3  A0 0A        	ldy #var_Direction
001C5F  3  91 rr        	sta (z80_hl),y		; direction
001C61  3               
001C61  3  A9 00        	lda #0
001C63  3  A0 0D        	ldy #var_jumpLo
001C65  3  91 rr        	sta (z80_hl),y		; reset parameter.
001C67  3  C8           	iny
001C68  3  91 rr        	sta (z80_hl),y		; reset parameter.
001C6A  3  C8           	iny
001C6B  3  91 rr        	sta (z80_hl),y		; reset parameter.
001C6D  3  C8           	iny
001C6E  3  91 rr        	sta (z80_hl),y		; reset parameter.
001C70  3               rtssp:
001C70  3  A5 rr        	lda spptr			; address of new sprite.
001C72  3  85 rr        	sta z80_x
001C74  3  A5 rr        	lda spptr+1
001C76  3  85 rr        	sta z80_i
001C78  3               evis1:
001C78  3  20 C0 39     	jsr evnt09 			; call sprite initialisation event.
001C7B  3               
001C7B  3  A5 rr        	lda spptr 			; address of new sprite.
001C7D  3  85 rr        	sta z80_x
001C7F  3  A5 rr        	lda spptr+1
001C81  3  85 rr        	sta z80_i
001C83  3               
001C83  3               	; _BEEB clipping code copied from CPC Engine - MISSING?!
001C83  3  A0 03        	ldy #var_Y
001C85  3  B1 rr        	lda (z80_hl), y		; old x coord
001C87  3  C9 B1        	cmp #SpriteMaxY     ; beyond maximum?
001C89  3  B0 03        	bcs :+				; yes, don't draw it.
001C8B  3               
001C8B  3  20 33 10     	jsr sspria 			; display the new sprite.
001C8E  3               :
001C8E  3  68           	pla					; address of original sprite.
001C8F  3  85 rr        	sta z80_x
001C91  3  68           	pla
001C92  3  85 rr        	sta z80_i
001C94  3               
001C94  3  60           	rts
001C95  3               
001C95  3  30 30 30 30  score:	.byte "000000"		; player"s score.
001C99  3  30 30        
001C9B  3  30 30 30 30  hiscor:	.byte "000000"		; high score.
001C9F  3  30 30        
001CA1  3  30 30 30 30  bonus:	.byte "000000"		; bonus.
001CA5  3  30 30        
001CA7  3  00 50        grbase:	.word ScreenAddr	; graphics base address.
001CA9  3               
001CA9  3               ;----------------------------------------------------
001CA9  3               ; Check y-pos
001CA9  3               ;----------------------------------------------------
001CA9  3               
001CA9  3               checkx:
001CA9  3  A5 rr        	lda dispy		; y position.
001CAB  3  C9 18        	cmp #24			; off screen?
001CAD  3  B0 01        	bcs :+
001CAF  3  60           	rts			; no, it's okay.
001CB0  3               :
001CB0  3  68           	pla			; remove return address from stack.
001CB1  3  85 rr        	sta z80_l
001CB3  3  68           	pla
001CB4  3  85 rr        	sta z80_h
001CB6  3  60           	rts
001CB7  3               
001CB7  3               ;-----------------------------------------------
001CB7  3               ; Displays the current high score.
001CB7  3               ;-----------------------------------------------
001CB7  3               
001CB7  3               dhisc:
001CB7  3  A9 9B        	lda #<hiscor 		; high score text.
001CB9  3  85 rr        	sta z80_l
001CBB  3  A9 1C        	lda #>hiscor
001CBD  3  85 rr        	sta z80_h
001CBF  3  4C CA 1C     	jmp dscor1		; check in printable range then show 6 digits.
001CC2  3               
001CC2  3               ;------------------------------------------------------
001CC2  3               ; Displays the current score.
001CC2  3               ;------------------------------------------------------
001CC2  3               
001CC2  3               dscor:
001CC2  3  A9 95        	lda #<score		; score text.
001CC4  3  85 rr        	sta z80_l
001CC6  3  A9 1C        	lda #>score
001CC8  3  85 rr        	sta z80_h
001CCA  3               dscor1:
001CCA  3  20 99 22     	jsr preprt		; set up font and print position.
001CCD  3  20 A9 1C     	jsr checkx		; make sure we're in a printable range.
001CD0  3               
001CD0  3  A9 06        	lda #6			; digits to display.
001CD2  3  85 rr        	sta z80_b
001CD4  3  A5 rr        	lda prtmod		; get print mode.
001CD6  3  F0 03        	beq :+			; standard size text?
001CD8  3  4C F7 1C     	jmp bscor0		; no, show double-height.
001CDB  3               :
001CDB  3               dscor0:
001CDB  3  A0 00        	ldy #0
001CDD  3  B1 rr        	lda (z80_hl),y 		; fetch character.
001CDF  3  20 BC 12     	jsr pchar 		; display character.
001CE2  3  E6 rr        	inc dispx		; move along x coordinate
001CE4  3               
001CE4  3  E6 rr        	inc z80_l		; next score column.
001CE6  3  D0 02        	bne :+
001CE8  3  E6 rr        	inc z80_h
001CEA  3               :
001CEA  3  C6 rr        	dec z80_b
001CEC  3  D0 ED        	bne dscor0 		; repeat for all digits.
001CEE  3               dscor2:
001CEE  3  A5 rr        	lda dispx 		; set up display coordinates.
001CF0  3  85 rr        	sta charx
001CF2  3  A5 rr        	lda dispy
001CF4  3  85 rr        	sta chary
001CF6  3  60           	rts
001CF7  3               
001CF7  3               ;------------------------------------------------------
001CF7  3               ; Displays the current score in double-height characters.
001CF7  3               ;
001CF7  3               ; Input:
001CF7  3               ;  B  = digit number
001CF7  3               ;  HL = score string
001CF7  3               ;------------------------------------------------------
001CF7  3               
001CF7  3               bscor0:
001CF7  3  A0 00        	ldy #0
001CF9  3               
001CF9  3  B1 rr        	lda (z80_hl),y 		; fetch character.
001CFB  3  20 1C 22     	jsr bchar 		; display big char.
001CFE  3               
001CFE  3  E6 rr        	inc z80_l 		; next score column.
001D00  3  D0 02        	bne :+
001D02  3  E6 rr        	inc z80_h
001D04  3               :
001D04  3  C6 rr        	dec z80_b
001D06  3  F0 03        	beq :+
001D08  3  4C F7 1C     	jmp bscor0 		; repeat for all digits.
001D0B  3               :
001D0B  3  4C EE 1C     	jmp dscor2 		; tidy up line and column variables.
001D0E  3               
001D0E  3               ;-----------------------------------------------------
001D0E  3               ; Adds number in the hl pair to the score.
001D0E  3               ;-----------------------------------------------------
001D0E  3               
001D0E  3               addsc:
001D0E  3  A9 96        	lda #<(score+1) 	; ten thousands column.
001D10  3  85 rr        	sta z80_e
001D12  3  A9 1C        	lda #>(score+1)
001D14  3  85 rr        	sta z80_d
001D16  3  A9 10        	lda #<10000		; amount to add each time.
001D18  3  85 rr        	sta z80_c
001D1A  3  A9 27        	lda #>10000
001D1C  3  85 rr        	sta z80_b
001D1E  3  20 62 1D     	jsr incsc		; add to score.
001D21  3               
001D21  3  E6 rr        	inc z80_e		; thousands column.
001D23  3  D0 02        	bne :+
001D25  3  E6 rr        	inc z80_d
001D27  3               :
001D27  3  A9 E8        	lda #<1000		; amount to add each time.
001D29  3  85 rr        	sta z80_c
001D2B  3  A9 03        	lda #>1000
001D2D  3  85 rr        	sta z80_b
001D2F  3  20 62 1D     	jsr incsc 		; add to score.
001D32  3               
001D32  3  E6 rr        	inc z80_e		; hundreds column.
001D34  3  D0 02        	bne :+
001D36  3  E6 rr        	inc z80_d
001D38  3               :
001D38  3  A9 64        	lda #<100		; amount to add each time.
001D3A  3  85 rr        	sta z80_c
001D3C  3  A9 00        	lda #>100
001D3E  3  85 rr        	sta z80_b
001D40  3  20 62 1D     	jsr incsc		; add to score.
001D43  3               
001D43  3  E6 rr        	inc z80_e 		; tens column.
001D45  3  D0 02        	bne :+
001D47  3  E6 rr        	inc z80_d
001D49  3               :
001D49  3  A9 0A        	lda #<10		; amount to add each time.
001D4B  3  85 rr        	sta z80_c
001D4D  3  A9 00        	lda #>10
001D4F  3  85 rr        	sta z80_b
001D51  3  20 62 1D     	jsr incsc 		; add to score.
001D54  3               
001D54  3  E6 rr        	inc z80_e		; units column.
001D56  3  D0 02        	bne :+
001D58  3  E6 rr        	inc z80_d
001D5A  3               :
001D5A  3  A9 01        	lda #<1			; units.
001D5C  3  85 rr        	sta z80_c
001D5E  3  A9 00        	lda #>1
001D60  3  85 rr        	sta z80_b
001D62  3               incsc:
001D62  3  A5 rr        	lda z80_h		; store amount to add.
001D64  3  48           	pha
001D65  3  A5 rr        	lda z80_l
001D67  3  48           	pha
001D68  3               
001D68  3  38           	sec			; subtract from amount to add.
001D69  3  A5 rr        	lda z80_l
001D6B  3  E5 rr        	sbc z80_c
001D6D  3  85 rr        	sta z80_l
001D6F  3  A5 rr        	lda z80_h
001D71  3  E5 rr        	sbc z80_b
001D73  3  85 rr        	sta z80_h
001D75  3  90 14        	bcc incsc0		; too much, restore value.
001D77  3               
001D77  3  68           	pla			; delete the previous amount from the stack.
001D78  3  68           	pla
001D79  3               
001D79  3  A5 rr        	lda z80_d 		; store column position.
001D7B  3  48           	pha
001D7C  3  A5 rr        	lda z80_e
001D7E  3  48           	pha
001D7F  3  20 92 1D     	jsr incsc2		; do the increment.
001D82  3               
001D82  3  68           	pla			; restore column.
001D83  3  85 rr        	sta z80_e
001D85  3  68           	pla
001D86  3  85 rr        	sta z80_d
001D88  3  4C 62 1D     	jmp incsc		; repeat until all added.
001D8B  3               
001D8B  3               incsc0:
001D8B  3  68           	pla			; restore previous value.
001D8C  3  85 rr        	sta z80_l
001D8E  3  68           	pla
001D8F  3  85 rr        	sta z80_h
001D91  3  60           	rts
001D92  3               incsc2:
001D92  3  A0 00        	ldy #0
001D94  3  B1 rr        	lda (z80_de),y 		; get amount.
001D96  3  18           	clc
001D97  3  69 01        	adc #1			; add one to column.
001D99  3  91 rr        	sta (z80_de),y		; write new column total.
001D9B  3  C9 3A        	cmp #'9'+1		; gone beyond range of digits?
001D9D  3  B0 01        	bcs :+
001D9F  3  60           	rts			; no, carry on.
001DA0  3               :
001DA0  3  A9 30        	lda #'0'		; make it zero.
001DA2  3  91 rr        	sta (z80_de),y		; write new column total.
001DA4  3  C6 rr        	dec z80_e		; back one column.
001DA6  3  D0 02        	bne :+
001DA8  3  C6 rr        	dec z80_d
001DAA  3               :
001DAA  3  4C 92 1D     	jmp incsc2
001DAD  3               
001DAD  3               ;------------------------------------
001DAD  3               ; Add bonus to score and reset bonus
001DAD  3               ;------------------------------------
001DAD  3               
001DAD  3               addbo:
001DAD  3  A2 05        	ldx #5			; last digit.
001DAF  3  18           	clc			; clear carry.
001DB0  3               addbo0:
001DB0  3  BD 95 1C     	lda score,x		; get score.
001DB3  3  7D A1 1C     	adc bonus,x		; add bonus.
001DB6  3  38           	sec			; 0 to 18.
001DB7  3  E9 30        	sbc #48
001DB9  3  48           	pha
001DBA  3  A9 30        	lda #'0'
001DBC  3  9D A1 1C     	sta bonus,x		; zeroise bonus.
001DBF  3  68           	pla
001DC0  3  C9 3A        	cmp #58			; carried?
001DC2  3  B0 07        	bcs addbo2		; no, do next one.
001DC4  3  38           	sec
001DC5  3  E9 0A        	sbc #10			; subtract 10.
001DC7  3  38           	sec
001DC8  3  4C CC 1D     	jmp addbo1
001DCB  3               addbo2:
001DCB  3  18           	clc
001DCC  3               addbo1:
001DCC  3  9D 95 1C     	sta score,x		; write new score.
001DCF  3  CA           	dex			; next digit.
001DD0  3  10 DE        	bpl addbo0		; repeat for all 6 digits.
001DD2  3  60           	rts
001DD3  3               
001DD3  3               ;------------------------------------
001DD3  3               ; Swap score and bonus.
001DD3  3               ;------------------------------------
001DD3  3               
001DD3  3               swpsb:
001DD3  3  A2 05        	ldx #5			; digits to add.
001DD5  3               swpsb0:
001DD5  3  BD 95 1C     	lda score,x 		; get score digits.
001DD8  3  48           	pha			; save digit
001DD9  3  BD A1 1C     	lda bonus,x 		; get bonus digits.
001DDC  3  9D 95 1C     	sta score,x		; switch score-bonus
001DDF  3  68           	pla
001DE0  3  9D A1 1C     	sta bonus,x
001DE3  3  CA           	dex 			; repeat for all 6 digits.
001DE4  3  10 EF        	bpl swpsb0
001DE6  3  60           	rts
001DE7  3               
001DE7  3               ;----------------------------------------------
001DE7  3               ; Write block
001DE7  3               ;----------------------------------------------
001DE7  3               
001DE7  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
001DE7  3               .if aflag
001DE7  3               wbloc:
001DE7  3               	ldy #3
001DE7  3               	sta (pbptr),y		; store block number
001DE7  3               	dey
001DE7  3               	lda dispx
001DE7  3               	sta (pbptr),y		; write x position of block.
001DE7  3               	dey
001DE7  3               	lda dispy
001DE7  3               	sta (pbptr),y		; write y position of block.
001DE7  3               	dey
001DE7  3               	lda scno
001DE7  3               	sta (pbptr),y		; write screen.
001DE7  3               	clc			; point to next free location
001DE7  3               	lda pbptr
001DE7  3               	adc #4
001DE7  3               	sta pbptr
001DE7  3               	bcc :+
001DE7  3               	inc pbptr+1
001DE7  3               :
001DE7  3               	rts
001DE7  3               .endif
001DE7  3               ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
001DE7  3               
001DE7  3               ;----------------------------------------------
001DE7  3               ; Print character pixels, no more.
001DE7  3               ;
001DE7  3               ; Input:
001DE7  3               ;  A	= character to print
001DE7  3               ;----------------------------------------------
001DE7  3               
001DE7  3               pchr:
001DE7  3  20 BC 12     	jsr pchar 		; show character in accumulator.
001DEA  3  E6 rr        	inc dispx		; move along one.
001DEC  3  60           	rts
001DED  3               
001DED  3               ;----------------------------------------------------
001DED  3               ; Shifter sprite routine for objects.
001DED  3               ;----------------------------------------------------
001DED  3               
001DED  3               sprit7:
001DED  3  A5 rr        	lda z80_b
001DEF  3  F0 0A        	beq sprit0
001DF1  3  A8           	tay
001DF2  3               sprit3:
001DF2  3  46 rr        	lsr spr			; shift into position.
001DF4  3  66 rr        	ror spr+1
001DF6  3  66 rr        	ror spr+2
001DF8  3  88           	dey				; one less iteration.
001DF9  3  D0 F7        	bne sprit3
001DFB  3               sprit0:
001DFB  3  60           	rts 			; now apply to screen.
001DFC  3               
001DFC  3               ;-----------------------------------------------------------
001DFC  3               ; Get room address.
001DFC  3               ;-----------------------------------------------------------
001DFC  3               
001DFC  3               groom:
001DFC  3  A6 rr        	ldx scno 		; screen number.
001DFE  3  A0 00        	ldy #0
001E00  3               groomx:
001E00  3  A9 65        	lda #<scdat 		; pointer to screens.
001E02  3  85 rr        	sta z80_l
001E04  3  A9 43        	lda #>scdat
001E06  3  85 rr        	sta z80_h
001E08  3               groom1:
001E08  3  E0 00        	cpx #0			; is it the first one?
001E0A  3  F0 15        	beq groom0 		; no more screens to skip.
001E0C  3               
001E0C  3  18           	clc
001E0D  3  A5 rr        	lda z80_l
001E0F  3  79 65 43     	adc scdat,y 		; low byte of screen size.
001E12  3  85 rr        	sta z80_l
001E14  3  C8           	iny			; point to high byte.
001E15  3  A5 rr        	lda z80_h
001E17  3  79 65 43     	adc scdat,y 		; high byte of screen size.
001E1A  3  85 rr        	sta z80_h
001E1C  3  C8           	iny			; next address.
001E1D  3               
001E1D  3  CA           	dex 			; one less iteration.
001E1E  3  4C 08 1E     	jmp groom1 		; loop until we reach the end.
001E21  3               groom0:
001E21  3  AD AA 44     	lda numsc 		; add displacement.
001E24  3  0A           	asl a
001E25  3  18           	clc			; add double displacement to address.
001E26  3  65 rr        	adc z80_l
001E28  3  85 rr        	sta z80_l
001E2A  3  A5 rr        	lda z80_h
001E2C  3  69 00        	adc #0
001E2E  3  85 rr        	sta z80_h
001E30  3  60           	rts
001E31  3               
001E31  3               ;-----------------------------------------------------------
001E31  3               ; Draw present room.
001E31  3               ;-----------------------------------------------------------
001E31  3               
001E31  3               droom:
001E31  3  AD 0C 18     	lda wintop 		; window top.
001E34  3  85 rr        	sta dispy		; set cursor y position.
001E36  3               droom2:
001E36  3  20 FC 1D     	jsr groom 		; get address of current room.
001E39  3  A9 00        	lda #0	 		; zero in accumulator.
001E3B  3  85 rr        	sta comcnt 		; reset compression counter.
001E3D  3  AD 0E 18     	lda winhgt 		; height of window.
001E40  3  85 rr        	sta rrow		; set row counter
001E42  3               droom0:
001E42  3  AD 0D 18     	lda winlft 		; window left edge.
001E45  3  85 rr        	sta dispx 		; set cursor x position.
001E47  3  AD 0F 18     	lda winwid 		; width of window.
001E4A  3  85 rr        	sta rcol		; set column counter
001E4C  3               droom1:
001E4C  3  20 5D 1E     	jsr flbyt 		; decompress next byte on the fly.
001E4F  3  20 68 13     	jsr pattr2 		; show attributes and block.
001E52  3  C6 rr        	dec rcol		; one less column.
001E54  3  D0 F6        	bne droom1 		; repeat for entire line.
001E56  3  E6 rr        	inc dispy		; move down one line.
001E58  3  C6 rr        	dec rrow 		; one less row.
001E5A  3  D0 E6        	bne droom0 		; repeat for all rows.
001E5C  3  60           	rts
001E5D  3               
001E5D  3               ;----------------------------------------------
001E5D  3               ; Decompress bytes on-the-fly.
001E5D  3               ;----------------------------------------------
001E5D  3               
001E5D  3               flbyt:
001E5D  3  A5 rr        	lda comcnt 		; compression counter.
001E5F  3  D0 21        	bne flbyt1		; any more to decompress?  yes.
001E61  3               
001E61  3  A0 00        	ldy #0
001E63  3  B1 rr        	lda (z80_hl),y 		; fetch next byte.
001E65  3  E6 rr        	inc z80_l 		; point to next cell.
001E67  3  D0 02        	bne :+
001E69  3  E6 rr        	inc z80_h
001E6B  3               :
001E6B  3  C9 FF        	cmp #255 		; is this byte a control code?
001E6D  3  F0 01        	beq :+
001E6F  3  60           	rts 			; no, this byte is uncompressed.
001E70  3               :
001E70  3  B1 rr        	lda (z80_hl),y 		; fetch byte type.
001E72  3  85 rr        	sta combyt 		; set up the type.
001E74  3  E6 rr        	inc z80_l 		; point to quantity.
001E76  3  D0 02        	bne :+
001E78  3  E6 rr        	inc z80_h
001E7A  3               :
001E7A  3  B1 rr        	lda (z80_hl),y 		; get quantity.
001E7C  3  E6 rr        	inc z80_l 		; point to next byte.
001E7E  3  D0 02        	bne :+
001E80  3  E6 rr        	inc z80_h
001E82  3               :
001E82  3               flbyt1:
001E82  3  85 rr        	sta comcnt 		; store new quantity.
001E84  3  C6 rr        	dec comcnt		; one less.
001E86  3  A5 rr        	lda combyt 		; byte to expand.
001E88  3  60           	rts
001E89  3               
001E89  3               ;------------------------------------------
001E89  3               ; Ladder down check.
001E89  3               ;
001E89  3               ; Input:
001E89  3               ;  IX = sprite pointer
001E89  3               ;------------------------------------------
001E89  3               
001E89  3               laddd:
001E89  3  A0 09        	ldy #var_newX
001E8B  3  B1 rr        	lda (z80_ix),y		; x coordinate.
001E8D  3  85 rr        	sta dispx
001E8F  3               
001E8F  3  A0 08        	ldy #var_newY
001E91  3  B1 rr        	lda (z80_ix),y		; y coordinate.
001E93  3  29 FE        	and #254		; make it even.
001E95  3  91 rr        	sta (z80_ix),y 		; reset it.
001E97  3               numsp5:
001E97  3  18           	clc 			; look down 16 pixels.
001E98  3  69 10        	adc #16
001E9A  3  85 rr        	sta dispy		; coords in dispx,dispy.
001E9C  3  4C B2 1E     	jmp laddv
001E9F  3               
001E9F  3               ;------------------------------------------
001E9F  3               ; Ladder up check.
001E9F  3               ;
001E9F  3               ; Input:
001E9F  3               ;  IX = sprite pointer
001E9F  3               ;
001E9F  3               ; Output:
001E9F  3               ;  A  = 0 is ok, A <>0 is not ok
001E9F  3               ;------------------------------------------
001E9F  3               
001E9F  3               laddu:
001E9F  3  A0 09        	ldy #var_newX
001EA1  3  B1 rr        	lda (z80_ix),y		; x coordinate.
001EA3  3  85 rr        	sta dispx
001EA5  3               
001EA5  3  A0 08        	ldy #var_newY
001EA7  3  B1 rr        	lda (z80_ix),y		; y coordinate.
001EA9  3  29 FE        	and #254 		; make it even.
001EAB  3  91 rr        	sta (z80_ix),y		; reset it.
001EAD  3               numsp6:
001EAD  3  18           	clc 			; look 2 pixels above feet.
001EAE  3  69 0E        	adc #14
001EB0  3  85 rr        	sta dispy		; coords in dispx,dispy.
001EB2  3               laddv:
001EB2  3  20 F4 20     	jsr tstbl 		; get map address.
001EB5  3  20 BF 1F     	jsr ldchk 		; standard ladder check.
001EB8  3  F0 01        	beq :+
001EBA  3  60           	rts 			; no way through.
001EBB  3               :
001EBB  3  E6 rr        	inc bufaddr 		; look right one cell.
001EBD  3  D0 02        	bne :+
001EBF  3  E6 rr        	inc bufaddr+1
001EC1  3               :
001EC1  3  20 BF 1F     	jsr ldchk 		; do the check.
001EC4  3  F0 01        	beq :+
001EC6  3  60           	rts 			; impassable.
001EC7  3               :
001EC7  3  A5 rr        	lda dispx 		; y coordinate.
001EC9  3  29 07        	and #7 			; position straddling block cells.
001ECB  3  D0 01        	bne :+
001ECD  3  60           	rts 			; no more checks needed.
001ECE  3               :
001ECE  3  E6 rr        	inc bufaddr 		; look to third cell.
001ED0  3  D0 02        	bne :+
001ED2  3  E6 rr        	inc bufaddr+1
001ED4  3               :
001ED4  3  20 BF 1F     	jsr ldchk 		; do the check.
001ED7  3  60           	rts  			; return with zero flag set accordingly.
001ED8  3               
001ED8  3               ;---------------------------------------------------------
001ED8  3               ; Can go up check.
001ED8  3               ;
001ED8  3               ; Input:
001ED8  3               ;  IX = sprite pointer
001ED8  3               ;
001ED8  3               ; Output:
001ED8  3               ;  A  = 0 is ok, A <>0 is not ok
001ED8  3               ;---------------------------------------------------------
001ED8  3               
001ED8  3               cangu:
001ED8  3  A0 09        	ldy #var_newX
001EDA  3  B1 rr        	lda (z80_ix),y		; x coordinate.
001EDC  3  85 rr        	sta dispx
001EDE  3  A0 08        	ldy #var_newY
001EE0  3  B1 rr        	lda (z80_ix),y 		; y coordinate.
001EE2  3  38           	sec
001EE3  3  E9 02        	sbc #2
001EE5  3  85 rr        	sta dispy		; coords in dispx,dispy.
001EE7  3  20 F4 20     	jsr tstbl 		; get map address.
001EEA  3  20 8A 1F     	jsr lrchk 		; standard left/right check.
001EED  3  F0 01        	beq :+
001EEF  3  60           	rts			; no way through.
001EF0  3               :
001EF0  3  E6 rr        	inc bufaddr		; look right one cell.
001EF2  3  D0 02        	bne :+
001EF4  3  E6 rr        	inc bufaddr+1
001EF6  3               :
001EF6  3  20 8A 1F     	jsr lrchk 		; do the check.
001EF9  3  F0 01        	beq :+
001EFB  3  60           	rts			; impassable.
001EFC  3               :
001EFC  3  A5 rr        	lda dispx		; x coordinate.
001EFE  3  29 07        	and #7			; position straddling block cells.
001F00  3  D0 01        	bne :+
001F02  3  60           	rts			; no more checks needed.
001F03  3               :
001F03  3  E6 rr        	inc bufaddr		; look to third cell.
001F05  3  D0 02        	bne :+
001F07  3  E6 rr        	inc bufaddr+1
001F09  3               :
001F09  3  20 8A 1F     	jsr lrchk		; do the check.
001F0C  3  60           	rts 			; return with zero flag set accordingly.
001F0D  3               
001F0D  3               ;---------------------------------------------------------
001F0D  3               ; Can go down check.
001F0D  3               ;
001F0D  3               ; Input:
001F0D  3               ;  IX = sprite pointer
001F0D  3               ;
001F0D  3               ; Output:
001F0D  3               ;  A  = 0 is ok, A <>0 is not ok
001F0D  3               ;---------------------------------------------------------
001F0D  3               
001F0D  3               cangd:
001F0D  3  A0 09        	ldy #var_newX
001F0F  3  B1 rr        	lda (z80_ix),y 		; x coordinate.
001F11  3  85 rr        	sta dispx
001F13  3  A0 08        	ldy #var_newY
001F15  3  B1 rr        	lda (z80_ix),y		; y coordinate.
001F17  3               numsp3:
001F17  3  18           	clc
001F18  3  69 10        	adc #16 		; look down 16 pixels.
001F1A  3  85 rr        	sta dispy		; coords in dispx,dispy.
001F1C  3  20 F4 20     	jsr tstbl 		; get map address.
001F1F  3  20 9F 1F     	jsr plchk 		; block, platform check.
001F22  3  F0 01        	beq :+
001F24  3  60           	rts			; no way through.
001F25  3               :
001F25  3  E6 rr        	inc bufaddr		; look right one cell.
001F27  3  D0 02        	bne :+
001F29  3  E6 rr        	inc bufaddr+1
001F2B  3               :
001F2B  3  20 9F 1F     	jsr plchk		; block, platform check.
001F2E  3  F0 01        	beq :+
001F30  3  60           	rts			; impassable.
001F31  3               :
001F31  3  A5 rr        	lda dispx		; x coordinate.
001F33  3  29 07        	and #7			; position straddling block cells.
001F35  3  D0 01        	bne :+
001F37  3  60           	rts			; no more checks needed.
001F38  3               :
001F38  3  E6 rr        	inc bufaddr		; look to third cell.
001F3A  3  D0 02        	bne :+
001F3C  3  E6 rr        	inc bufaddr+1
001F3E  3               :
001F3E  3  20 9F 1F     	jsr plchk		; block, platform check.
001F41  3  60           	rts			; return with zero flag set accordingly.
001F42  3               
001F42  3               ;---------------------------------------------------------
001F42  3               ; Can go left check.
001F42  3               ;
001F42  3               ; Input:
001F42  3               ;  IX = sprite pointer
001F42  3               ;
001F42  3               ; Output:
001F42  3               ;  A  = 0 is ok, A <>0 is not ok
001F42  3               ;---------------------------------------------------------
001F42  3               
001F42  3               cangl:
001F42  3  A0 08        	ldy #var_newY
001F44  3  B1 rr        	lda (z80_ix),y 		; y coordinate.
001F46  3  85 rr        	sta dispy
001F48  3  A0 09        	ldy #var_newX
001F4A  3  B1 rr        	lda (z80_ix),y 		; x coordinate.
001F4C  3  38           	sec
001F4D  3  E9 02        	sbc #2			; look left 2 pixels.
001F4F  3  85 rr        	sta dispx		; coords in dispx,dispy.
001F51  3  4C 63 1F     	jmp cangh		; test if we can go there.
001F54  3               
001F54  3               ;---------------------------------------------------------
001F54  3               ; Can go right check.
001F54  3               ;
001F54  3               ; Input:
001F54  3               ;  IX = sprite pointer
001F54  3               ;
001F54  3               ; Output:
001F54  3               ;  A  = 0 is ok, A <>0 is not ok
001F54  3               ;---------------------------------------------------------
001F54  3               
001F54  3               cangr:
001F54  3  A0 08        	ldy #var_newY
001F56  3  B1 rr        	lda (z80_ix),y		; y coordinate.
001F58  3  85 rr        	sta dispy
001F5A  3  A0 09        	ldy #var_newX
001F5C  3  B1 rr        	lda (z80_ix),y		; x coordinate.
001F5E  3  18           	clc
001F5F  3  69 10        	adc #16			; look right 16 pixels.
001F61  3  85 rr        	sta dispx		; coords in dispx,dispy.
001F63  3               cangh:
001F63  3               cangh2:
001F63  3  A9 03        	lda #3			; default rows to write.
001F65  3  85 rr        	sta z80_b
001F67  3  A5 rr        	lda dispy		; y position.
001F69  3  29 07        	and #7			; does x straddle cells?
001F6B  3  D0 02        	bne cangh0		; yes, loop counter is good.
001F6D  3  C6 rr        	dec z80_b		; one less row to write.
001F6F  3               cangh0:
001F6F  3  20 F4 20     	jsr tstbl		; get map address.
001F72  3               cangh1:
001F72  3  20 8A 1F     	jsr lrchk		; standard left/right check.
001F75  3  F0 01        	beq :+
001F77  3  60           	rts			; no way through.
001F78  3               :
001F78  3  48           	pha
001F79  3  18           	clc
001F7A  3  A5 rr        	lda bufaddr
001F7C  3  69 20        	adc #32			; look down.
001F7E  3  85 rr        	sta bufaddr
001F80  3  90 02        	bcc :+
001F82  3  E6 rr        	inc bufaddr+1
001F84  3               :
001F84  3  68           	pla
001F85  3               
001F85  3  C6 rr        	dec z80_b
001F87  3  D0 E9        	bne cangh1
001F89  3  60           	rts
001F8A  3               
001F8A  3               ;-------------------------------------
001F8A  3               ; Check left/right movement is okay.
001F8A  3               ;
001F8A  3               ; Input:
001F8A  3               ;  bufaddr = MAP + x/8 + y/8*32
001F8A  3               ;
001F8A  3               ; Output:
001F8A  3               ;  A  = 0 is ok, A <>0 is not ok
001F8A  3               ;-------------------------------------
001F8A  3               
001F8A  3               lrchk:
001F8A  3  A0 00        	ldy #0
001F8C  3  B1 rr        	lda (bufaddr),y		; fetch map cell.
001F8E  3  C9 02        	cmp #WALL 		; is it passable?
001F90  3  F0 0A        	beq lrchkx		; no.
001F92  3               
001F92  3  C9 04        	cmp #FODDER		; fodder has to be dug.
001F94  3  F0 06        	beq lrchkx		; not passable.
001F96  3  A9 00        	lda #0
001F98  3  60           	rts
001F99  3               
001F99  3               ;--------------------------------------------------------------
001F99  3               ; Called by mmenu
001F99  3               ;--------------------------------------------------------------
001F99  3               
001F99  3               always:
001F99  3  A9 FF        	lda #255		; report it as okay.
001F9B  3  60           	rts
001F9C  3               
001F9C  3               lrchkx:
001F9C  3  A9 01        	lda #1 			; reset all bits.
001F9E  3  60           	rts
001F9F  3               
001F9F  3               
001F9F  3               ;--------------------------------------------------------------
001F9F  3               ; Check platform or solid item is not in way.
001F9F  3               ;
001F9F  3               ; Input:
001F9F  3               ;  bufaddr = MAP + x/8 + y/8*32
001F9F  3               ;
001F9F  3               ; Output:
001F9F  3               ;  A  = 0 is ok, A <>0 is not ok
001F9F  3               ;--------------------------------------------------------------
001F9F  3               
001F9F  3               plchk:
001F9F  3  A0 00        	ldy #0
001FA1  3  B1 rr        	lda (bufaddr),y 	; fetch map cell.
001FA3  3  C9 02        	cmp #WALL 		; is it passable?
001FA5  3  F0 F5        	beq lrchkx		; no.
001FA7  3               
001FA7  3  C9 04        	cmp #FODDER		; fodder has to be dug.
001FA9  3  F0 F1        	beq lrchkx		; not passable.
001FAB  3               
001FAB  3  C9 01        	cmp #PLATFM		; platform is solid.
001FAD  3  F0 07        	beq plchkx		; not passable.
001FAF  3               
001FAF  3  C9 03        	cmp #LADDER		; is it a ladder?
001FB1  3  F0 E9        	beq lrchkx		; on ladder, deny movement.
001FB3  3               plchk0:
001FB3  3  A9 00        	lda #0			; report as ok
001FB5  3  60           	rts
001FB6  3               plchkx:
001FB6  3  A5 rr        	lda dispy		; x coordinate.
001FB8  3  29 07        	and #7			; position straddling blocks.
001FBA  3  F0 E0        	beq lrchkx		; on platform, deny movement.
001FBC  3  4C B3 1F     	jmp plchk0
001FBF  3               
001FBF  3               ;--------------------------------------------------------------
001FBF  3               ; Check ladder is available.
001FBF  3               ;
001FBF  3               ; Input:
001FBF  3               ;  bufaddr = MAP + x/8 + y/8*32
001FBF  3               ;
001FBF  3               ; Output:
001FBF  3               ;  A  = 0 is ok, A <>0 is not ok
001FBF  3               ;--------------------------------------------------------------
001FBF  3               
001FBF  3               ldchk:
001FBF  3  A0 00        	ldy #0
001FC1  3  B1 rr        	lda (bufaddr),y 	; fetch cell.
001FC3  3  C9 03        	cmp #LADDER 		; is it a ladder?
001FC5  3  F0 03        	beq :+
001FC7  3  A9 01        	lda #1
001FC9  3  60           	rts  			; return with zero flag set accordingly.
001FCA  3               :
001FCA  3  A9 00        	lda #0
001FCC  3  60           	rts
001FCD  3               
001FCD  3               ;--------------------------------------------------------------
001FCD  3               ; Get collectables.
001FCD  3               ;--------------------------------------------------------------
001FCD  3               
001FCD  3               getcol:
001FCD  3  A9 08            lda #COLECT             ; collectable blocks.
001FCF  3  85 rr            sta z80_b
001FD1  3  20 39 20         jsr tded                ; test for collectable blocks.
001FD4  3  C5 rr            cmp z80_b               ; did we find one?
001FD6  3  F0 01            beq :+
001FD8  3  60               rts                     ; none were found, job done.
001FD9  3               :
001FD9  3  20 E2 1F         jsr gtblk               ; get block.
001FDC  3               
001FDC  3  20 AC 3A         jsr evnt20              ; collected block event.
001FDF  3  4C CD 1F         jmp getcol              ; repeat until none left.
001FE2  3               
001FE2  3               ; Get collectable block.
001FE2  3               
001FE2  3               gtblk:
001FE2  3  A0 00        	ldy #0
001FE4  3  B1 rr        	lda (bufaddr),y
001FE6  3  85 rr        	sta z80_a
001FE8  3  A9 00                lda #0
001FEA  3  91 rr                sta (bufaddr),y		; make it empty now.
001FEC  3               
001FEC  3  A5 rr        	lda bufaddr		; set dispx
001FEE  3  29 1F        	and #31
001FF0  3  85 rr        	sta dispx
001FF2  3               
001FF2  3  A5 rr        	lda bufaddr+1		; Set dispy
001FF4  3  38           	sec
001FF5  3  E9 03        	sbc #>MAP
001FF7  3  85 rr        	sta bufaddr+1
001FF9  3  06 rr        	asl bufaddr
001FFB  3  26 rr        	rol bufaddr+1
001FFD  3  06 rr        	asl bufaddr
001FFF  3  26 rr        	rol bufaddr+1
002001  3  06 rr        	asl bufaddr
002003  3  26 rr        	rol bufaddr+1
002005  3  A5 rr        	lda bufaddr+1
002007  3  85 rr        	sta dispy
002009  3               
002009  3  A5 rr        	lda colpatt		; get blocknr
00200B  3  85 rr        	sta z80_e		; displacement in e.
00200D  3  A9 00        	lda #0
00200F  3  85 rr        	sta z80_d		; no high byte.
002011  3  06 rr        	asl z80_e  		; multiply char by 8.
002013  3  26 rr        	rol z80_d
002015  3  06 rr        	asl z80_e
002017  3  26 rr        	rol z80_d
002019  3  06 rr        	asl z80_e
00201B  3  26 rr        	rol z80_d
00201D  3  18           	clc
00201E  3  A5 rr        	lda z80_e
002020  3  69 BB        	adc #<chgfx 		; address of graphics.
002022  3  85 rr        	sta tileaddr
002024  3  A5 rr        	lda z80_d
002026  3  69 3B        	adc #>chgfx
002028  3  85 rr        	sta tileaddr+1
00202A  3  20 0A 13     	jsr gprad 		; get screen address.
00202D  3  A0 07        	ldy #7			; number of pixel rows to write.
00202F  3               gtblk0:
00202F  3  B1 rr        	lda (tileaddr),y 	; get image byte.
002031  3  51 rr        	eor (scraddr),y 	; XOR tile on screen
002033  3  91 rr        	sta (scraddr),y 	; copy to screen.
002035  3  88           	dey	 		; repeat for 8 pixel rows.
002036  3  10 F7        	bpl gtblk0
002038  3  60           	rts
002039  3               
002039  3               ;--------------------------------------------------------------
002039  3               ; Touched deadly block check.
002039  3               ; returns with DEADLY (must be non-zero) in accumulator if true.
002039  3               ;
002039  3               ; Input:
002039  3               ;  IX = sprite address
002039  3               ;
002039  3               ; Output:
002039  3               ;  A  = 0 is ok, A=5 is not ok
002039  3               ;--------------------------------------------------------------
002039  3               
002039  3               tded:
002039  3  A0 08        	ldy #var_newY
00203B  3  B1 rr        	lda (z80_ix),y 		; y coordinate.
00203D  3  85 rr        	sta dispy
00203F  3  C8           	iny
002040  3  B1 rr        	lda (z80_ix),y 		; x coordinate.
002042  3  85 rr        	sta dispx		; coords in dispx,dispy.
002044  3  20 F4 20     	jsr tstbl		; get map address.
002047  3  48           	pha
002048  3  A9 1F        	lda #31			; default distance to next line down.
00204A  3  85 rr        	sta z80_e
00204C  3  68           	pla
00204D  3  C5 rr        	cmp z80_b		; is this the required block?
00204F  3  D0 01        	bne :+
002051  3  60           	rts			; yes.
002052  3               :
002052  3  E6 rr        	inc bufaddr 		; next cell.
002054  3  D0 02        	bne :+
002056  3  E6 rr        	inc bufaddr+1
002058  3               :
002058  3  A0 00        	ldy #0
00205A  3  B1 rr        	lda (bufaddr),y		; fetch type.
00205C  3  C5 rr        	cmp z80_b 		; is this deadly/custom?
00205E  3  D0 01        	bne :+
002060  3  60           	rts			; yes.
002061  3               :
002061  3  A5 rr        	lda dispx		; horizontal position.
002063  3  85 rr        	sta z80_c 		; store column in c register.
002065  3  29 07        	and #7			; is it straddling cells?
002067  3  D0 03        	bne :+
002069  3  4C 7D 20     	jmp tded0		; no.
00206C  3               :
00206C  3  E6 rr        	inc bufaddr 		; last cell.
00206E  3  D0 02        	bne :+
002070  3  E6 rr        	inc bufaddr+1
002072  3               :
002072  3  A0 00        	ldy #0
002074  3  B1 rr        	lda (bufaddr),y 	; fetch type.
002076  3  C5 rr        	cmp z80_b		; is this the block?
002078  3  D0 01        	bne :+
00207A  3  60           	rts			; yes.
00207B  3               :
00207B  3  C6 rr        	dec z80_e		; one less cell to next row down.
00207D  3               tded0:
00207D  3  18           	clc 			; point to next row.
00207E  3  A5 rr        	lda bufaddr
002080  3  65 rr        	adc z80_e
002082  3  85 rr        	sta bufaddr
002084  3  90 02        	bcc :+
002086  3  E6 rr        	inc bufaddr+1
002088  3               :
002088  3  A0 00        	ldy #0
00208A  3  B1 rr        	lda (bufaddr),y		; fetch left cell block.
00208C  3  C5 rr        	cmp z80_b		; is this fatal?
00208E  3  D0 01        	bne :+
002090  3  60           	rts			; yes.
002091  3               :
002091  3  E6 rr        	inc bufaddr 		; next cell.
002093  3  D0 02        	bne :+
002095  3  E6 rr        	inc bufaddr+1
002097  3               :
002097  3  A0 00        	ldy #0
002099  3  B1 rr        	lda (bufaddr),y 	; fetch type.
00209B  3  C5 rr        	cmp z80_b		; is this fatal?
00209D  3  D0 01        	bne :+
00209F  3  60           	rts			; yes.
0020A0  3               :
0020A0  3  A5 rr        	lda z80_c		; horizontal position.
0020A2  3  29 07        	and #7			; is it straddling cells?
0020A4  3  D0 03        	bne :+
0020A6  3  4C B8 20     	jmp tded1 		; no.
0020A9  3               :
0020A9  3  E6 rr        	inc bufaddr		; last cell.
0020AB  3  D0 02        	bne :+
0020AD  3  E6 rr        	inc bufaddr+1
0020AF  3               :
0020AF  3  A0 00        	ldy #0
0020B1  3  B1 rr        	lda (bufaddr),y		; fetch type.
0020B3  3  C5 rr        	cmp z80_b		; is this fatal?
0020B5  3  D0 01        	bne :+
0020B7  3  60           	rts			; yes.
0020B8  3               :
0020B8  3               tded1:
0020B8  3  A5 rr        	lda dispy		; vertical position.
0020BA  3  29 07        	and #7 			; is it straddling cells?
0020BC  3  D0 01        	bne :+
0020BE  3  60           	rts			; no, job done.
0020BF  3               :
0020BF  3  18           	clc			; point to next row.
0020C0  3  A5 rr        	lda bufaddr
0020C2  3  65 rr        	adc z80_e
0020C4  3  85 rr        	sta bufaddr
0020C6  3  90 02        	bcc :+
0020C8  3  E6 rr        	inc bufaddr+1
0020CA  3               :
0020CA  3  A0 00        	ldy #0
0020CC  3  B1 rr        	lda (bufaddr),y 	; fetch left cell block.
0020CE  3  C5 rr        	cmp z80_b		; is this fatal?
0020D0  3  D0 01        	bne :+
0020D2  3  60           	rts			; yes.
0020D3  3               :
0020D3  3  E6 rr        	inc bufaddr		; next cell.
0020D5  3  D0 02        	bne :+
0020D7  3  E6 rr        	inc bufaddr+1
0020D9  3               :
0020D9  3  A0 00        	ldy #0
0020DB  3  B1 rr        	lda (bufaddr),y 	; fetch type.
0020DD  3  C5 rr        	cmp z80_b		; is this fatal?
0020DF  3  D0 01        	bne :+
0020E1  3  60           	rts			; yes.
0020E2  3               :
0020E2  3  A5 rr        	lda z80_c		; horizontal position.
0020E4  3  29 07        	and #7			; is it straddling cells?
0020E6  3  D0 01        	bne :+
0020E8  3  60           	rts			; no.
0020E9  3               :
0020E9  3  E6 rr        	inc bufaddr		; last cell.
0020EB  3  D0 02        	bne :+
0020ED  3  E6 rr        	inc bufaddr+1
0020EF  3               :
0020EF  3  A0 00        	ldy #0
0020F1  3  B1 rr        	lda (bufaddr),y		; fetch final type.
0020F3  3  60           	rts 			; return with final type in accumulator.
0020F4  3               
0020F4  3               ;---------------------------------------------------
0020F4  3               ; Fetch block type at (dispx, dispy).
0020F4  3               ;
0020F4  3               ; Output:
0020F4  3               ;  A = block type
0020F4  3               ;---------------------------------------------------
0020F4  3               
0020F4  3               tstbl:
0020F4  3  A5 rr        	lda dispy 			; fetch y coord.
0020F6  3  4A           	lsr a				; bufaddr = y/8
0020F7  3  4A           	lsr a
0020F8  3  4A           	lsr a
0020F9  3  85 rr        	sta chary
0020FB  3               
0020FB  3  85 rr        	sta bufaddr
0020FD  3  A9 00        	lda #0
0020FF  3  85 rr        	sta bufaddr+1
002101  3               
002101  3  06 rr        	asl bufaddr  		; bufaddr = y/8 * 32
002103  3  26 rr        	rol bufaddr+1
002105  3  06 rr        	asl bufaddr
002107  3  26 rr        	rol bufaddr+1
002109  3  06 rr        	asl bufaddr
00210B  3  26 rr        	rol bufaddr+1
00210D  3  06 rr        	asl bufaddr
00210F  3  26 rr        	rol bufaddr+1
002111  3  06 rr        	asl bufaddr
002113  3  26 rr        	rol bufaddr+1
002115  3               
002115  3  A5 rr        	lda dispx			; x/8
002117  3  4A           	lsr a
002118  3  4A           	lsr a
002119  3  4A           	lsr a
00211A  3  85 rr        	sta charx
00211C  3               
00211C  3  18           	clc					; bufaddr = MAP + x/8 + y/8*32
00211D  3  65 rr        	adc bufaddr
00211F  3               ;	adc #<MAP			; only works because <MAP == $0
00211F  3  85 rr        	sta bufaddr
002121  3  A5 rr        	lda bufaddr+1
002123  3  69 03        	adc #>MAP
002125  3  85 rr        	sta bufaddr+1
002127  3               
002127  3  A0 00        	ldy #0
002129  3  B1 rr        	lda (bufaddr),y 	; fetch byte there.
00212B  3  60           	rts
00212C  3               
00212C  3               ;-------------------------------------------------------------------
00212C  3               ; Jump - if we can.
00212C  3               ; Requires initial speed to be set up in accumulator prior to call.
00212C  3               ;
00212C  3               ; Input:
00212C  3               ;  IX = sprite address
00212C  3               ;-------------------------------------------------------------------
00212C  3               
00212C  3               jump:
00212C  3  A0 0D        	ldy #var_jumpLo
00212E  3  B1 rr        	lda (z80_ix),y		; jump table low.
002130  3  A0 0E        	ldy #var_jumpHi
002132  3  11 rr        	ora (z80_ix),y		; jump table high.
002134  3  F0 01        	beq :+
002136  3  60           	rts			; already in the air.
002137  3               :
002137  3  A9 4C        	lda #>jtab
002139  3  A0 0E        	ldy #var_jumpHi
00213B  3  91 rr        	sta (z80_ix),y		; set jump high.
00213D  3  A9 E9        	lda #<jtab		; jump table start.
00213F  3  A0 0D        	ldy #var_jumpLo
002141  3  91 rr        	sta (z80_ix),y		; set jump low.
002143  3  60           	rts
002144  3               
002144  3               ; Jump table.
002144  3               
002144  3               ;jtab:
002144  3               ;	.byte 248,250,252
002144  3               ;	.byte 254,254,255
002144  3               ;	.byte 255,255,0,0
002144  3               ;	.byte 0,1,1,1,2,2
002144  3               ;	.byte 4,6,8,8,8,99
002144  3               
002144  3               ;------------------------------------------------
002144  3               ; Random numbers code.
002144  3               ; Pseudo-random number generator, 8-bit.
002144  3               ;
002144  3               ; Output:
002144  3               ;  RND = random number
002144  3               ;------------------------------------------------
002144  3               
002144  3               random:
002144  3  A5 rr        	lda seed		; get last random number.
002146  3  0A           	asl a
002147  3  0A           	asl a
002148  3  18           	clc
002149  3  65 rr        	adc seed
00214B  3  18           	clc
00214C  3  69 45        	adc #$45
00214E  3  85 rr        	sta seed		; store new seed.
002150  3  85 rr        	sta varrnd		; return number in variable.
002152  3  60           	rts
002153  3               
002153  3               ;-------------------------------------------------------
002153  3               ; Joystick and keyboard reading routines.
002153  3               ;
002153  3               ; contrl = 0, Keyboard
002153  3               ;          1, JoyKeyb
002153  3               ;          2, JoyMMC
002153  3               ;-------------------------------------------------------
002153  3               
002153  3               joykey:
002153  3  A5 rr        	lda contrl 		; control flag.
002155  3  C9 01        	cmp #1
002157  3  D0 03        	bne :+
002159  3  4C 77 21     	jmp joyjoy 		; read keyboard joystick
00215C  3               :
00215C  3  C9 02        	cmp #2
00215E  3  D0 03        	bne :+
002160  3  4C FA 0E     	jmp joysin 		; read MMC joystick.
002163  3               :
002163  3               ; Keyboard controls.
002163  3               
002163  3  A9 00        	lda #0		 	; zero reading.
002165  3  85 rr        	sta z80_e
002167  3               
002167  3  A0 06        	ldy #6	 		; address of last key.
002169  3               joyke0:
002169  3  B9 EA 4C     	lda keys,y 		; get key from table.
00216C  3  20 D0 0E     	jsr ktest		; being pressed?
00216F  3  26 rr        	rol z80_e 		; rotate into reading.
002171  3               
002171  3  88           	dey		 	; next key.
002172  3  10 F5        	bpl joyke0 		; repeat for all keys.
002174  3  4C 88 21     	jmp joyjo1 		; store the value.
002177  3               
002177  3               ; Keyboard joystick controls.
002177  3               
002177  3               joyjoy:
002177  3  A9 00        	lda #0		 	; zero reading.
002179  3  85 rr        	sta z80_e
00217B  3               
00217B  3  A0 06        	ldy #6	 		; address of last key.
00217D  3               joyjo3:
00217D  3  B9 66 0E     	lda jkeys,y 		; get key from table.
002180  3  20 D0 0E     	jsr ktest		; being pressed?
002183  3  26 rr        	rol z80_e 		; rotate into reading.
002185  3               
002185  3  88           	dey		 	; next key.
002186  3  10 F5        	bpl joyjo3 		; repeat for all keys.
002188  3               joyjo1:
002188  3  A5 rr        	lda z80_e 		; copy e register to accumulator.
00218A  3               joyjo2:
00218A  3  85 rr        	sta joyval		; remember value.
00218C  3  60           	rts
00218D  3               
00218D  3               ;---------------------------------------------------------------
00218D  3               ; Display message.
00218D  3               ;
00218D  3               ; Input:
00218D  3               ;  A = message number
00218D  3               ;---------------------------------------------------------------
00218D  3               
00218D  3               dmsg:
00218D  3  AA           	tax
00218E  3  A9 AE        	lda #<msgdat		; pointer to messages.
002190  3  85 rr        	sta z80_l
002192  3  A9 3A        	lda #>msgdat
002194  3  85 rr        	sta z80_h
002196  3  20 AC 22     	jsr getwrd		; get message number.
002199  3               dmsg3:
002199  3  20 99 22     	jsr preprt		; pre-printing stuff.
00219C  3  20 A9 1C     	jsr checkx		; make sure we"re in a printable range.
00219F  3  A5 rr        	lda prtmod		; print mode.
0021A1  3  D0 47        	bne bmsg1		; no, double-height text.
0021A3  3               dmsg0:
0021A3  3  A5 rr        	lda z80_h		; store string pointer.
0021A5  3  48           	pha
0021A6  3  A5 rr        	lda z80_l
0021A8  3  48           	pha
0021A9  3               
0021A9  3  A0 00        	ldy #0
0021AB  3  B1 rr        	lda (z80_hl),y		; fetch byte to display.
0021AD  3  29 7F        	and #127		; remove any end marker.
0021AF  3  C9 0D        	cmp #ASCII_NEWLINE
0021B1  3  F0 24        	beq dmsg1
0021B3  3  20 BC 12     	jsr pchar		; display character.
0021B6  3  20 84 22     	jsr nexpos 		; display position.
0021B9  3  D0 03        	bne dmsg2		; not on a new line.
0021BB  3  20 8B 22     	jsr nexlin		; next line down.
0021BE  3               dmsg2:
0021BE  3  68           	pla			; retrieve string pointer
0021BF  3  85 rr        	sta z80_l
0021C1  3  68           	pla
0021C2  3  85 rr        	sta z80_h
0021C4  3               
0021C4  3  A0 00        	ldy #0
0021C6  3  B1 rr        	lda (z80_hl),y		; fetch last character.
0021C8  3  0A           	asl a  			; was it the end?
0021C9  3  90 03        	bcc :+
0021CB  3  4C EE 1C     	jmp dscor2		; yes, job done.
0021CE  3               :
0021CE  3  E6 rr        	inc z80_l		; next character to display.
0021D0  3  D0 02        	bne :+
0021D2  3  E6 rr        	inc z80_h
0021D4  3               :
0021D4  3  4C A3 21     	jmp dmsg0
0021D7  3               dmsg1:
0021D7  3  E6 rr        	inc dispy
0021D9  3  A5 rr        	lda dispy
0021DB  3  C9 18        	cmp #24
0021DD  3  90 04        	bcc dmsg4
0021DF  3  A9 00        	lda #0
0021E1  3  85 rr        	sta dispy
0021E3  3               dmsg4:
0021E3  3  A9 00        	lda #0
0021E5  3  85 rr        	sta dispx
0021E7  3  4C BE 21     	jmp dmsg2
0021EA  3               
0021EA  3               ;----------------------------------------------------------
0021EA  3               ; Display message in big text.
0021EA  3               ;
0021EA  3               ; Input:
0021EA  3               ;  HL = string pointer
0021EA  3               ;----------------------------------------------------------
0021EA  3               
0021EA  3               bmsg1:
0021EA  3  A0 00        	ldy #0
0021EC  3  B1 rr        	lda (z80_hl),y 		; get character to display.
0021EE  3  29 7F        	and #127		; only want 7 bits.
0021F0  3  C9 0D        	cmp #ASCII_NEWLINE
0021F2  3  F0 13        	beq bmsg2
0021F4  3  20 1C 22     	jsr bchar 		; display big char.
0021F7  3               bmsg3:
0021F7  3  A0 00        	ldy #0
0021F9  3  B1 rr        	lda (z80_hl),y 		; look at last character.
0021FB  3  48           	pha
0021FC  3  E6 rr        	inc z80_l 		; next character in list.
0021FE  3  D0 02        	bne :+
002200  3  E6 rr        	inc z80_h
002202  3               :
002202  3  68           	pla
002203  3  0A           	asl a  			; was terminator flag set?
002204  3  90 E4        	bcc bmsg1		; no, keep going.
002206  3               :
002206  3  60           	rts
002207  3               bmsg2:
002207  3  A9 00        	lda #0
002209  3  85 rr        	sta dispx
00220B  3  E6 rr        	inc dispy
00220D  3  E6 rr        	inc dispy
00220F  3  A5 rr        	lda dispy
002211  3  C9 17        	cmp #23
002213  3  90 E2        	bcc bmsg3
002215  3  A9 00        	lda #0
002217  3  85 rr        	sta dispy
002219  3  4C F7 21     	jmp bmsg3
00221C  3               
00221C  3               ;----------------------------------------------------------
00221C  3               ; Big character display.
00221C  3               ;
00221C  3               ; Input:
00221C  3               ;  A = character
00221C  3               ;----------------------------------------------------------
00221C  3               
00221C  3               bchar:
00221C  3  85 rr        	sta z80_e		; save char in lb
00221E  3  A9 00        	lda #0
002220  3  85 rr        	sta z80_d		; reset hb
002222  3               
002222  3  06 rr        	asl z80_e 		; multiply char by 8.
002224  3  26 rr        	rol z80_d
002226  3  06 rr        	asl z80_e
002228  3  26 rr        	rol z80_d
00222A  3  06 rr        	asl z80_e
00222C  3  26 rr        	rol z80_d		; de = a*8
00222E  3               
00222E  3  18           	clc			; de = FontPtr + a*8
00222F  3  A5 rr        	lda z80_e
002231  3  65 rr        	adc FontPtr 		; address of font.
002233  3  85 rr        	sta z80_e
002235  3  A5 rr        	lda z80_d
002237  3  65 rr        	adc FontPtr+1
002239  3  85 rr        	sta z80_d
00223B  3               
00223B  3  20 0A 13     	jsr gprad 		; get screen address.
00223E  3               
00223E  3  A2 00        	ldx #0			; height of character in font.
002240  3               bchar0:
002240  3  A0 00        	ldy #0
002242  3  B1 rr        	lda (z80_de),y 		; get a bit of the font.
002244  3               
002244  3  49 00        	eor #TxtInvert		; Invert
002246  3               
002246  3  91 rr        	sta (scraddr),y
002248  3  48           	pha
002249  3  20 5B 11     	jsr nline 		; next line down.
00224C  3  68           	pla
00224D  3  91 rr        	sta (scraddr),y
00224F  3  20 5B 11     	jsr nline 		; next line down.
002252  3               
002252  3  18           	clc
002253  3  E6 rr        	inc z80_e 		; next line of font.
002255  3  D0 02        	bne :+
002257  3  E6 rr        	inc z80_d
002259  3               :
002259  3  E8           	inx
00225A  3  E0 08        	cpx #8
00225C  3  D0 E2        	bne bchar0
00225E  3               
00225E  3  20 84 22     	jsr nexpos		; display position.
002261  3  D0 05        	bne bchar2 		; not on a new line.
002263  3               bchar3:
002263  3  E6 rr        	inc dispy
002265  3  20 8B 22     	jsr nexlin 		; next line check.
002268  3               bchar2:
002268  3  4C EE 1C     	jmp dscor2		; tidy up line and column variables.
00226B  3               
00226B  3               
00226B  3               ;-------------------------------------------------
00226B  3               ; Display a character.
00226B  3               ;
00226B  3               ; Input:
00226B  3               ;  A = character
00226B  3               ;-------------------------------------------------
00226B  3               
00226B  3               achar:
00226B  3  85 rr        	sta z80_b 		; copy to b.
00226D  3  20 99 22     	jsr preprt 		; get ready to print.
002270  3  A5 rr        	lda z80_b		; character in accumulator.
002272  3  A6 rr        	ldx prtmod 		; print mode.
002274  3  F0 03        	beq :+
002276  3  4C 1C 22     	jmp bchar 		; no, double-height text.
002279  3               :
002279  3  20 BC 12     	jsr pchar 		; display character.
00227C  3  20 84 22     	jsr nexpos 		; display position.
00227F  3  F0 E2        	beq bchar3		; next line down.
002281  3  4C 68 22     	jmp bchar2 		; tidy up.
002284  3               
002284  3               
002284  3               ;-------------------------------------------------
002284  3               ; Get next print column position.
002284  3               ;-------------------------------------------------
002284  3               
002284  3               nexpos:
002284  3  E6 rr        	inc dispx		; move along one position.
002286  3  A5 rr        	lda dispx 		; get coordinate.
002288  3  29 1F        	and #31
00228A  3  60           	rts 			; return with status in zero flag.
00228B  3               
00228B  3               ;-------------------------------------------------
00228B  3               ; Get next print line position.
00228B  3               ;-------------------------------------------------
00228B  3               
00228B  3               nexlin:
00228B  3  E6 rr        	inc dispy 		; newline.
00228D  3  A5 rr        	lda dispy		; vertical position.
00228F  3  C9 18        	cmp #24			; past screen edge?
002291  3  B0 01        	bcs :+
002293  3  60           	rts			; no, still okay.
002294  3               :
002294  3  A9 00        	lda #0			; restart at top.
002296  3  85 rr        	sta dispy
002298  3  60           	rts
002299  3               
002299  3               ;--------------------------------------------------------
002299  3               ; Pre-print preliminaries.
002299  3               ;--------------------------------------------------------
002299  3               
002299  3               preprt:
002299  3  A5 rr        	lda FontPtr		; font pointer.
00229B  3  8D A7 1C     	sta grbase		; set up graphics base.
00229E  3  A5 rr        	lda FontPtr+1
0022A0  3  8D A8 1C     	sta grbase+1
0022A3  3               prescr:
0022A3  3  A5 rr        	lda charx 		; display coordinates.
0022A5  3  85 rr        	sta dispx		; set up general coordinates.
0022A7  3  A5 rr        	lda chary
0022A9  3  85 rr        	sta dispy
0022AB  3  60           	rts
0022AC  3               
0022AC  3               ;--------------------------------------------------------------
0022AC  3               ; Get messagenr x in hl
0022AC  3               ;
0022AC  3               ; Input:
0022AC  3               ;  HL = pointer to message list
0022AC  3               ;  X  = message number.
0022AC  3               ;--------------------------------------------------------------
0022AC  3               
0022AC  3               getwrd:
0022AC  3  E0 00        	cpx #0
0022AE  3  D0 01        	bne:+ 			; first word in list?
0022B0  3  60           	rts 			; yep, don't search.
0022B1  3               :
0022B1  3  A0 00        	ldy #0
0022B3  3               getwd0:
0022B3  3  B1 rr        	lda (z80_hl),y
0022B5  3  48           	pha
0022B6  3  E6 rr        	inc z80_l
0022B8  3  D0 02        	bne :+
0022BA  3  E6 rr        	inc z80_h
0022BC  3               :
0022BC  3  68           	pla
0022BD  3  C9 80        	cmp #128		; found end?
0022BF  3  30 F2        	bmi getwd0		; no, carry on.
0022C1  3  CA           	dex			; until we have right number.
0022C2  3  D0 EF        	bne getwd0
0022C4  3  60           	rts
0022C5  3               
0022C5  3               ;-----------------------------------------------------------
0022C5  3               ; Bubble sort.
0022C5  3               ;-----------------------------------------------------------
0022C5  3               
0022C5  3               bsort:
0022C5  3  A9 0B        	lda #NUMSPR - 1		; sprites to swap.
0022C7  3  85 rr        	sta qscnt
0022C9  3               
0022C9  3  A9 00        	lda #<sprtab 		; sprite table.
0022CB  3  85 rr        	sta z80_x
0022CD  3  A9 0B        	lda #>sprtab
0022CF  3  85 rr        	sta z80_i
0022D1  3               bsort0:
0022D1  3  A0 00        	ldy #0
0022D3  3  B1 rr        	lda (z80_ix),y 		; first sprite type.
0022D5  3  C9 FF        	cmp #255 		; is it switched off?
0022D7  3  F0 30        	beq swemp		; yes, may need to switch another in here.
0022D9  3               
0022D9  3  A0 11        	ldy #TABSIZ
0022DB  3  B1 rr        	lda (z80_ix),y 		; check next slot exists.
0022DD  3  C9 FF        	cmp #255 		; is it enabled?
0022DF  3  F0 0A        	beq bsort2 		; no, nothing to swap.
0022E1  3               
0022E1  3  A0 14        	ldy #TABSIZ+3
0022E3  3  B1 rr        	lda (z80_ix),y 		; fetch next sprite's coordinate.
0022E5  3  A0 03        	ldy #3
0022E7  3  D1 rr        	cmp (z80_ix),y 		; compare with this x coordinate.
0022E9  3  90 10        	bcc bsort1		; next sprite is higher - may need to switch.
0022EB  3               bsort2:
0022EB  3  18           	clc
0022EC  3  A5 rr        	lda z80_x
0022EE  3  69 11        	adc #TABSIZ 		; distance to next odd/even entry.
0022F0  3  85 rr        	sta z80_x
0022F2  3  90 02        	bcc :+
0022F4  3  E6 rr        	inc z80_i
0022F6  3               :
0022F6  3  C6 rr        	dec qscnt
0022F8  3  D0 D7        	bne bsort0		; repeat for remaining sprites.
0022FA  3  60           	rts
0022FB  3               
0022FB  3               bsort1:
0022FB  3  A0 11        	ldy #TABSIZ
0022FD  3  B1 rr        	lda (z80_ix),y		; sprite on/off flag.
0022FF  3  C9 FF        	cmp #255		; is it enabled?
002301  3  F0 E8        	beq bsort2		; no, nothing to swap.
002303  3  20 17 23     	jsr swspr		; swap positions.
002306  3  4C EB 22     	jmp bsort2
002309  3               swemp:
002309  3  A0 11        	ldy #TABSIZ
00230B  3  B1 rr        	lda (z80_ix),y		; next table entry.
00230D  3  C9 FF        	cmp #255		; is that one on?
00230F  3  F0 DA        	beq bsort2		; no, nothing to swap.
002311  3  20 17 23     	jsr swspr		; swap positions.
002314  3  4C EB 22     	jmp bsort2
002317  3               
002317  3               ; Swap sprites.
002317  3               
002317  3               swspr:
002317  3  A5 rr        	lda z80_x		; table address
002319  3  85 rr        	sta z80_e		; copy to de pair.
00231B  3  85 rr        	sta z80_l		; copy to hl pair.
00231D  3  A5 rr        	lda z80_i
00231F  3  85 rr        	sta z80_h
002321  3  85 rr        	sta z80_d
002323  3               
002323  3  18           	clc
002324  3  A5 rr        	lda z80_l
002326  3  69 11        	adc #TABSIZ		; distance to second entry.
002328  3  85 rr        	sta z80_l
00232A  3  90 02        	bcc :+
00232C  3  E6 rr        	inc z80_h
00232E  3               :
00232E  3  A9 11        	lda #TABSIZ		; bytes to swap.
002330  3  85 rr        	sta z80_b
002332  3  A0 00        	ldy #0
002334  3               swspr0:
002334  3  B1 rr        	lda (z80_hl),y		; fetch second byte.
002336  3  48           	pha
002337  3  B1 rr        	lda (z80_de),y 		; fetch first byte.
002339  3  91 rr        	sta (z80_hl),y 		; copy to second.
00233B  3  68           	pla
00233C  3  91 rr        	sta (z80_de),y 		; copy to first sprite entry.
00233E  3               
00233E  3  E6 rr        	inc z80_e 		; next byte.
002340  3  D0 02        	bne :+
002342  3  E6 rr        	inc z80_d
002344  3               :
002344  3  E6 rr        	inc z80_l 		; next byte.
002346  3  D0 02        	bne :+
002348  3  E6 rr        	inc z80_h
00234A  3               :
00234A  3  C6 rr        	dec z80_b
00234C  3  D0 E6        	bne swspr0 		; swap all bytes in table entry.
00234E  3  60           	rts
00234F  3               
00234F  3               ;----------------------------------------------------
00234F  3               ; Process sprites.
00234F  3               ;----------------------------------------------------
00234F  3               
00234F  3               pspr:
00234F  3  A9 0C        	lda #NUMSPR		; sprites to process.
002351  3  85 rr        	sta sprptr
002353  3               
002353  3  A9 00        	lda #<sprtab 		; sprite table.
002355  3  85 rr        	sta z80_x
002357  3  A9 0B        	lda #>sprtab
002359  3  85 rr        	sta z80_i
00235B  3               pspr1:
00235B  3  A0 00        	ldy #0
00235D  3  B1 rr        	lda (z80_ix),y		; fetch sprite type.
00235F  3  C9 09        	cmp #9 			; within range of sprite types?
002361  3  B0 03        	bcs :+
002363  3  20 76 23     	jsr pspr2 		; yes, process this one.
002366  3               :
002366  3  18           	clc
002367  3  A5 rr        	lda z80_x
002369  3  69 11        	adc #TABSIZ 		; distance to next odd/even entry.
00236B  3  85 rr        	sta z80_x
00236D  3  90 02        	bcc :+
00236F  3  E6 rr        	inc z80_i		; next sprite.
002371  3               :
002371  3  C6 rr        	dec sprptr 		; repeat for remaining sprites.
002373  3  D0 E6        	bne pspr1
002375  3  60           	rts
002376  3               
002376  3               pspr2:
002376  3  A5 rr        	lda z80_x 		; store original sprite pointer.
002378  3  85 rr        	sta ogptr
00237A  3  A5 rr        	lda z80_i
00237C  3  85 rr        	sta ogptr+1
00237E  3  20 8A 23     	jsr pspr3		; do the routine.
002381  3               rtorg:
002381  3  A5 rr        	lda ogptr 		; restore original pointer to sprite.
002383  3  85 rr        	sta z80_x
002385  3  A5 rr        	lda ogptr+1
002387  3  85 rr        	sta z80_i
002389  3               rtorg0:
002389  3  60           	rts
00238A  3               
00238A  3               pspr3:
00238A  3  A9 BF        	lda #<evtyp0		; sprite type events list.
00238C  3  85 rr        	sta z80_l
00238E  3  A9 23        	lda #>evtyp0
002390  3  85 rr        	sta z80_h
002392  3               pspr4:
002392  3  B1 rr        	lda (z80_ix),y
002394  3  0A           	asl a			; double accumulator.
002395  3  18           	clc
002396  3  65 rr        	adc z80_l
002398  3  85 rr        	sta z80_l
00239A  3  90 02        	bcc :+
00239C  3  E6 rr        	inc z80_h
00239E  3               :
00239E  3  B1 rr        	lda (z80_hl),y
0023A0  3  85 rr        	sta z80_e 		; copy to de.
0023A2  3  48           	pha
0023A3  3               
0023A3  3  E6 rr        	inc z80_l 		; next byte of address.
0023A5  3  D0 02        	bne :+
0023A7  3  E6 rr        	inc z80_h
0023A9  3               :
0023A9  3  B1 rr        	lda (z80_hl),y 		; address high.
0023AB  3  85 rr        	sta z80_d
0023AD  3               
0023AD  3  48           	pha	 		; swap address into hl.
0023AE  3  A5 rr        	lda z80_h
0023B0  3  85 rr        	sta z80_d
0023B2  3  68           	pla
0023B3  3  85 rr        	sta z80_h
0023B5  3  68           	pla
0023B6  3  85 rr        	sta z80_l
0023B8  3  A5 rr        	lda z80_l
0023BA  3  85 rr        	sta z80_e
0023BC  3               
0023BC  3  6C rr rr     	jmp (z80_hl) 		; go there.
0023BF  3               
0023BF  3               ; Address of each sprite type's routine.
0023BF  3               
0023BF  3  5C 29        evtyp0:	.word evnt00
0023C1  3  32 31        evtyp1:	.word evnt01
0023C3  3  0D 35        evtyp2:	.word evnt02
0023C5  3  FA 37        evtyp3:	.word evnt03
0023C7  3  67 38        evtyp4:	.word evnt04
0023C9  3  45 39        evtyp5:	.word evnt05
0023CB  3  46 39        evtyp6:	.word evnt06
0023CD  3  47 39        evtyp7:	.word evnt07
0023CF  3  48 39        evtyp8:	.word evnt08
0023D1  3               
0023D1  3               ;--------------------------------------------------------------
0023D1  3               ; Display sprites.
0023D1  3               ;
0023D1  3               ; Input:
0023D1  3               ;  IX = sprite table
0023D1  3               ;--------------------------------------------------------------
0023D1  3               
0023D1  3               dspr:
0023D1  3  A9 06        	lda #(NUMSPR/2)		; number of sprites to display.
0023D3  3  85 rr        	sta sprcnt
0023D5  3               
0023D5  3               dspr0:
0023D5  3  A0 00        	ldy #var_Type
0023D7  3  B1 rr        	lda (z80_ix),y 		; get sprite type.
0023D9  3  C9 FF        	cmp #255 			; is it enabled?
0023DB  3  D0 45        	bne dspr1 			; yes, it needs deleting.
0023DD  3               
0023DD  3               dspr5:
0023DD  3  A0 05        	ldy #var_newType
0023DF  3  B1 rr        	lda (z80_ix),y 		; new type.
0023E1  3  C9 FF        	cmp #255			; is it enabled?
0023E3  3  F0 03        	beq dspr2			; no, skip
0023E5  3  4C 71 24     	jmp dspr3 			; yes, it needs drawing.
0023E8  3               
0023E8  3               dspr2:
0023E8  3  A0 05        	ldy #var_newType
0023EA  3  B1 rr        	lda (z80_ix),y 		; copy new type.
0023EC  3  A0 00        	ldy #var_Type
0023EE  3  91 rr        	sta (z80_ix),y
0023F0  3  A0 06        	ldy #var_newImage
0023F2  3  B1 rr        	lda (z80_ix),y 		; copy new image number.
0023F4  3  A0 01        	ldy #var_Image
0023F6  3  91 rr        	sta (z80_ix),y
0023F8  3  A0 07        	ldy #var_newFrame
0023FA  3  B1 rr        	lda (z80_ix),y 		; copy new frame.
0023FC  3  A0 02        	ldy #var_Frame
0023FE  3  91 rr        	sta (z80_ix),y
002400  3  A0 08        	ldy #var_newY
002402  3  B1 rr        	lda (z80_ix),y 		; copy new y.
002404  3  A0 03        	ldy #var_Y
002406  3  91 rr        	sta (z80_ix),y
002408  3  A0 09        	ldy #var_newX
00240A  3  B1 rr        	lda (z80_ix),y 		; copy new x.
00240C  3  A0 04        	ldy #var_X
00240E  3  91 rr        	sta (z80_ix),y
002410  3               
002410  3  18           	clc
002411  3  A5 rr        	lda z80_x
002413  3  69 22        	adc #(TABSIZ*2)		; distance to next odd/even entry.
002415  3  85 rr        	sta z80_x
002417  3  A5 rr        	lda z80_i
002419  3  69 00        	adc #0
00241B  3  85 rr        	sta z80_i 			; next sprite.
00241D  3  C6 rr        	dec sprcnt
00241F  3  D0 B4        	bne dspr0			; repeat for remaining sprites.
002421  3  60           	rts
002422  3               
002422  3               dspr1:
002422  3               	; _BEEB clipping code copied from CPC Engine
002422  3  A0 03        	ldy #var_Y
002424  3  B1 rr        	lda (z80_ix), y		; old x coord
002426  3  C9 B1        	cmp #SpriteMaxY     ; beyond maximum?
002428  3  B0 B3        	bcs dspr5			; yes, don't delete it.
00242A  3               
00242A  3  A0 05        	ldy #var_newType
00242C  3  B1 rr        	lda (z80_ix),y 		; type of new sprite.
00242E  3  C9 FF        	cmp #255			; is this enabled?
002430  3  D0 06        	bne dspr4 			; yes, display both.
002432  3               
002432  3               dspr6:
002432  3  20 33 10     	jsr sspria 			; show single sprite.
002435  3  4C E8 23     	jmp dspr2
002438  3               
002438  3               ; Displaying two sprites.  Don't bother redrawing if nothing has changed.
002438  3               
002438  3               dspr4:
002438  3               	; _BEEB clipping code copied from CPC Engine
002438  3  A0 08        	ldy #var_newY
00243A  3  B1 rr        	lda (z80_ix), y		; old x coord
00243C  3  C9 B1        	cmp #SpriteMaxY     ; beyond maximum?
00243E  3  B0 F2        	bcs dspr6			; yes, don't display it.
002440  3               
002440  3  A0 04        	ldy #var_X
002442  3  B1 rr        	lda (z80_ix),y		; old x.
002444  3  A0 09        	ldy #var_newX
002446  3  D1 rr        	cmp (z80_ix),y 		; compare with new value.
002448  3  D0 21        	bne dspr7 			; they differ, need to redraw.
00244A  3               
00244A  3  A0 03        	ldy #var_Y
00244C  3  B1 rr        	lda (z80_ix),y		; old y.
00244E  3  A0 08        	ldy #var_newY
002450  3  D1 rr        	cmp (z80_ix),y 		; compare against new value.
002452  3  D0 17        	bne dspr7			; they differ, need to redraw.
002454  3               
002454  3  A0 02        	ldy #var_Frame
002456  3  B1 rr        	lda (z80_ix),y 		; old frame.
002458  3  A0 07        	ldy #var_newFrame
00245A  3  D1 rr        	cmp (z80_ix),y 		; compare against new value.
00245C  3  D0 0D        	bne dspr7 			; they differ, need to redraw.
00245E  3               
00245E  3  A0 01        	ldy #var_Image
002460  3  B1 rr        	lda (z80_ix),y 		; old image.
002462  3  A0 06        	ldy #var_newImage
002464  3  D1 rr        	cmp (z80_ix),y 		; compare against new value.
002466  3  D0 03        	bne dspr7 			; they differ, need to redraw.
002468  3  4C E8 23     	jmp dspr2			; everything is the same, don't redraw.
00246B  3               
00246B  3               dspr7:
00246B  3  20 6A 10     	jsr sspric 			; delete old sprite, draw new one simultaneously.
00246E  3  4C E8 23     	jmp dspr2
002471  3               
002471  3               dspr3:
002471  3               	; _BEEB clipping code copied from CPC Engine
002471  3  A0 08        	ldy #var_newY
002473  3  B1 rr        	lda (z80_ix), y		; old x coord
002475  3  C9 B1        	cmp #SpriteMaxY     ; beyond maximum?
002477  3  90 03        	bcc :+				; no, continue
002479  3  4C E8 23     	jmp dspr2			; yes, don't display it.
00247C  3               :
00247C  3  20 64 10     	jsr ssprib 			; show single sprite.
00247F  3  4C E8 23     	jmp dspr2
002482  3               
002482  3               ;-----------------------------------------
002482  3               ; Get sprite address calculations.
002482  3               ; gspran = new sprite, gsprad = old sprite.
002482  3               ;
002482  3               ; Input:
002482  3               ;  IX = sprite address
002482  3               ;-----------------------------------------
002482  3               
002482  3               gspran:
002482  3  A0 08        	ldy #var_newY
002484  3  B1 rr        	lda (z80_ix),y 		; new y coordinate.
002486  3  85 rr        	sta dispy
002488  3  A0 09        	ldy #var_newX
00248A  3  B1 rr        	lda (z80_ix),y 		; new x coordinate.
00248C  3  85 rr        	sta dispx
00248E  3  A0 06        	ldy #var_newImage
002490  3  B1 rr        	lda (z80_ix),y 		; new sprite image.
002492  3  20 64 27     	jsr gfrm		; fetch start frame for this sprite.
002495  3               
002495  3  A0 00        	ldy #0
002497  3  B1 rr        	lda (z80_hl),y 		; frame in accumulator.
002499  3  A0 07        	ldy #var_newFrame
00249B  3  18           	clc
00249C  3  71 rr        	adc (z80_ix),y 		; new add frame number.
00249E  3  4C BD 24     	jmp gspra0
0024A1  3               
0024A1  3               ;-----------------------------------------
0024A1  3               ; Calculate old sprite address
0024A1  3               ;
0024A1  3               ; Input:
0024A1  3               ;  IX = sprite address
0024A1  3               ;
0024A1  3               ; Output:
0024A1  3               ;  B  = right byte mask
0024A1  3               ;  C  = left byte mask
0024A1  3               ;  DE = spriteframe address
0024A1  3               ;  scraddr = screenaddress(dispx,dispy)
0024A1  3               ;-----------------------------------------
0024A1  3               
0024A1  3               gsprad:
0024A1  3  A0 03        	ldy #var_Y
0024A3  3  B1 rr        	lda (z80_ix),y		; y coordinate.
0024A5  3  85 rr        	sta dispy
0024A7  3  A0 04        	ldy #var_X
0024A9  3  B1 rr        	lda (z80_ix),y		; x coordinate.
0024AB  3  85 rr        	sta dispx
0024AD  3  A0 01        	ldy #var_Image
0024AF  3  B1 rr        	lda (z80_ix),y 		; sprite image.
0024B1  3  20 64 27     	jsr gfrm 		; fetch start frame for this sprite.
0024B4  3               
0024B4  3  A0 00        	ldy #0
0024B6  3  B1 rr        	lda (z80_hl),y 		; frame in accumulator.
0024B8  3  A0 02        	ldy #var_Frame
0024BA  3  18           	clc
0024BB  3  71 rr        	adc (z80_ix),y 		; add frame number.
0024BD  3               
0024BD  3               gspra0:
0024BD  3               .if 0
0024BD  3               	lsr a	  		; multiply by 128.
0024BD  3               	sta z80_d 		; store in d.
0024BD  3               	lda #0
0024BD  3               	ror a
0024BD  3               	sta z80_e 		; got low byte.
0024BD  3               .else
0024BD  3  85 rr        	sta z80_e
0024BF  3  A9 00        	lda #0
0024C1  3  85 rr        	sta z80_d
0024C3  3               
0024C3  3  06 rr        	asl z80_e
0024C5  3  26 rr        	rol z80_d
0024C7  3  06 rr        	asl z80_e
0024C9  3  26 rr        	rol z80_d
0024CB  3  06 rr        	asl z80_e
0024CD  3  26 rr        	rol z80_d
0024CF  3  06 rr        	asl z80_e
0024D1  3  26 rr        	rol z80_d
0024D3  3  06 rr        	asl z80_e
0024D5  3  26 rr        	rol z80_d
0024D7  3               
0024D7  3               .endif
0024D7  3               
0024D7  3  18           	clc 			; address of play sprites.
0024D8  3  A5 rr        	lda z80_e
0024DA  3  69 A7        	adc #<sprgfx
0024DC  3  85 rr        	sta z80_e
0024DE  3  A5 rr        	lda z80_d
0024E0  3  69 3E        	adc #>sprgfx
0024E2  3  85 rr        	sta z80_d
0024E4  3               
0024E4  3  A5 rr        	lda dispx 		; y coordinate.
0024E6  3  29 06        	and #6 			; position within byte boundary.
0024E8  3  AA           	tax	 		; low byte of table displacement.
0024E9  3  86 rr        	stx sprshft
0024EB  3               
0024EB  3               .if 0
0024EB  3               	asl a	  		; multiply by 32.
0024EB  3               	asl a  			; already a multiple
0024EB  3               	asl a  			; of 2, so just 4
0024EB  3               	asl a  			; shifts needed.
0024EB  3               
0024EB  3               	clc 			; add to sprite address.
0024EB  3               	adc z80_e
0024EB  3               	sta z80_e
0024EB  3               	bcc :+
0024EB  3               	inc z80_d
0024EB  3               :
0024EB  3               .endif
0024EB  3               
0024EB  3  BD F8 24     	lda spmask,x		 ; pointer to mask table.
0024EE  3  85 rr        	sta z80_c 		; left mask.
0024F0  3  BD F9 24     	lda spmask+1,x
0024F3  3  85 rr        	sta z80_b 		; right mask.
0024F5  3               ; Drop into screen address routine.
0024F5  3  4C 18 10     	jmp scadd
0024F8  3               
0024F8  3  FF 00 3F C0  spmask:	.byte 255,0,63,192,15,240,3,252
0024FC  3  0F F0 03 FC  
002500  3               
002500  3               
002500  3               ;-----------------------------------------------------------
002500  3               ; Animates a sprite.
002500  3               ;
002500  3               ; Input:
002500  3               ;  IX = sprite address
002500  3               ;  HL = last sprite address
002500  3               ;-----------------------------------------------------------
002500  3               
002500  3               animsp:
002500  3  25 rr        	and frmno
002502  3  F0 01        	beq :+
002504  3  60           	rts
002505  3               :
002505  3  A0 06        	ldy #var_newImage
002507  3  B1 rr        	lda (z80_ix),y		; sprite image
002509  3  20 64 27     	jsr gfrm		; get frame data.
00250C  3               
00250C  3  E6 rr        	inc z80_l		; point to frames.
00250E  3  D0 02        	bne :+
002510  3  E6 rr        	inc z80_h
002512  3               :
002512  3  A0 07        	ldy #var_newFrame
002514  3  B1 rr        	lda (z80_ix),y		; sprite frame.
002516  3  18           	clc
002517  3  69 01        	adc #1			; next one along.
002519  3  A0 00        	ldy #0
00251B  3  D1 rr        	cmp (z80_hl),y		; reached the last frame?
00251D  3  90 02        	bcc anims0		; no, not yet.
00251F  3  A9 00        	lda #0			; start at first frame.
002521  3               anims0:
002521  3  A0 07        	ldy #var_newFrame
002523  3  91 rr        	sta (z80_ix),y		; new frame.
002525  3  60           	rts
002526  3               
002526  3               ;--------------------------------------------------------------
002526  3               ; Animate back
002526  3               ;
002526  3               ; Input:
002526  3               ;  IX = sprite address
002526  3               ;  HL = last sprite address
002526  3               ;--------------------------------------------------------------
002526  3               
002526  3               animbk:
002526  3  25 rr        	and frmno
002528  3  F0 01        	beq :+
00252A  3  60           	rts
00252B  3               :
00252B  3  A0 06        	ldy #var_newImage
00252D  3  B1 rr        	lda (z80_ix),y		; sprite image.
00252F  3  20 64 27     	jsr gfrm		; get frame data.
002532  3               
002532  3  E6 rr        	inc z80_l 		; point to frames.
002534  3  D0 02        	bne :+
002536  3  E6 rr        	inc z80_h
002538  3               :
002538  3  A0 07        	ldy #var_newFrame
00253A  3  B1 rr        	lda (z80_ix),y 		; sprite frame.
00253C  3  F0 03        	beq :+
00253E  3  4C 45 25     	jmp rtanb0 		; yes, start at end.
002541  3               :
002541  3  A0 00        	ldy #0
002543  3  B1 rr        	lda (z80_hl),y 		; last sprite.
002545  3               rtanb0:
002545  3  38           	sec
002546  3  E9 01        	sbc #1			; next one along.
002548  3  4C 21 25     	jmp anims0		; set new frame.
00254B  3               
00254B  3               ;--------------------------------------------------------------
00254B  3               ; Check for collision with other sprite, strict enforcement.
00254B  3               ;
00254B  3               ; Input:
00254B  3               ;  b		= sprite to test for
00254B  3               ;  ix		= current sprite pointer
00254B  3               ;
00254B  3               ; global:	b
00254B  3               ; local:	x,y,hl,de,skptr
00254B  3               ; calls:	-
00254B  3               ;--------------------------------------------------------------
00254B  3               
00254B  3               sktyp:
00254B  3  A9 00        	lda #<sprtab				; sprite table.
00254D  3  85 rr        	sta z80_l
00254F  3  A9 0B        	lda #>sprtab
002551  3  85 rr        	sta z80_h
002553  3               numsp2:
002553  3  A9 0C        	lda #NUMSPR				; number of sprites.
002555  3  85 rr        	sta sktptr
002557  3               sktyp0:
002557  3  A5 rr        	lda z80_l 				; store pointer to sprite.
002559  3  85 rr        	sta skptr
00255B  3  A5 rr        	lda z80_h
00255D  3  85 rr        	sta skptr+1
00255F  3               
00255F  3  A0 00        	ldy #0
002561  3  B1 rr        	lda (z80_hl),y 				; get sprite type.
002563  3  C5 rr        	cmp z80_b				; is it the type we seek?
002565  3  F0 1D        	beq coltyp				; yes, we can use this one.
002567  3               :
002567  3               sktyp1:
002567  3  18           	clc
002568  3  A5 rr        	lda skptr				; retrieve sprite pointer.
00256A  3  69 11        	adc #TABSIZ				; size of each entry.
00256C  3  85 rr        	sta z80_l
00256E  3  A5 rr        	lda skptr+1
002570  3  69 00        	adc #0
002572  3  85 rr        	sta z80_h
002574  3  C6 rr        	dec sktptr					; one less iteration.
002576  3  D0 DF        	bne sktyp0				; keep going until we find a slot.
002578  3               :
002578  3  A9 00        	lda #0					; default to ROM address - no sprite.
00257A  3  85 rr        	sta z80_l
00257C  3  85 rr        	sta z80_h
00257E  3  85 rr        	sta skptr				; store pointer to sprite.
002580  3  85 rr        	sta skptr+1
002582  3               
002582  3  18           	clc					; don't return with zero flag set.
002583  3  60           	rts 					; didn't find one.
002584  3               
002584  3               coltyp:
002584  3  A0 00        	ldy #0
002586  3  B1 rr        	lda (z80_ix),y				; current sprite type.
002588  3  C5 rr        	cmp z80_b				; seeking sprite of same type?
00258A  3  F0 3D        	beq colty1				; yes, need to check we're not detecting ourselves.
00258C  3               colty0:
00258C  3  A0 09        	ldy #9					; distance to x position in table.
00258E  3  B1 rr        	lda (z80_hl),y				; fetch x coordinate.
002590  3  85 rr        	sta z80_e
002592  3  88           	dey
002593  3  B1 rr        	lda (z80_hl),y				; fetch y coordinate.
002595  3  85 rr        	sta z80_d
002597  3               
002597  3               ; Drop into collision detection.
002597  3               
002597  3               colc16:
002597  3  A0 09        	ldy #9
002599  3  B1 rr        	lda (z80_ix),y			 	; x coord.
00259B  3  38           	sec					; subtract x.
00259C  3  E5 rr        	sbc z80_e
00259E  3  B0 05        	bcs  colc1a 				; result is positive.
0025A0  3  49 FF        	eor #$ff				; make negative positive.
0025A2  3  18           	clc
0025A3  3  69 01        	adc #1
0025A5  3               colc1a:
0025A5  3  C9 10        	cmp #16 				; within x range?
0025A7  3  B0 BE        	bcs sktyp1				; no - they"ve missed.
0025A9  3  85 rr        	sta z80_c				; store difference.
0025AB  3               
0025AB  3  A0 08        	ldy #8
0025AD  3  B1 rr        	lda (z80_ix),y				; y coord.
0025AF  3  38           	sec
0025B0  3  E5 rr        	sbc z80_d				; subtract y.
0025B2  3  B0 05        	bcs colc1b				; result is positive.
0025B4  3  49 FF        	eor #$ff				; make negative positive.
0025B6  3  18           	clc
0025B7  3  69 01        	adc #1
0025B9  3               colc1b:
0025B9  3  C9 10        	cmp #16					; within y range?
0025BB  3  B0 AA        	bcs sktyp1 				; no - they've missed.
0025BD  3  18           	clc					; add x difference.
0025BE  3  65 rr        	adc z80_c
0025C0  3  C9 1A        	cmp #26					; only 5 corner pixels touching?
0025C2  3  B0 02        	bcs :+
0025C4  3  38           	sec
0025C5  3  60           	rts 					; carry set if there's a collision.
0025C6  3               :
0025C6  3  4C 67 25     	jmp sktyp1				; try next sprite in table.
0025C9  3               colty1:
0025C9  3  A5 rr        	lda z80_x  				; compare the two.
0025CB  3  C5 rr        	cmp z80_l
0025CD  3  D0 09        	bne end_col
0025CF  3  A5 rr        	lda z80_i
0025D1  3  C5 rr        	cmp z80_h
0025D3  3  D0 03        	bne end_col
0025D5  3  4C 67 25     	jmp sktyp1 				; addresses are identical.
0025D8  3               end_col:
0025D8  3  4C 8C 25     	jmp colty0
0025DB  3               
0025DB  3               ;-----------------------------------------------------------
0025DB  3               ; Display number, left aligned
0025DB  3               ;
0025DB  3               ; Input:
0025DB  3               ;  a		= number
0025DB  3               ;
0025DB  3               ; global:	-
0025DB  3               ; local:	a,y,bc,hl,displ0
0025DB  3               ; calls:	num2ch,dmsg3
0025DB  3               ;-----------------------------------------------------------
0025DB  3               
0025DB  3               disply:
0025DB  3  85 rr        	sta z80_a
0025DD  3  A9 03        	lda #<displ0				; display workspace.
0025DF  3  85 rr        	sta z80_c
0025E1  3  A9 26        	lda #>displ0
0025E3  3  85 rr        	sta z80_b
0025E5  3  A5 rr        	lda z80_a
0025E7  3  20 26 1A     	jsr num2ch				; convert accumulator to string.
0025EA  3               displ1:
0025EA  3  C6 rr        	dec z80_c				; back one character.
0025EC  3  D0 02        	bne :+
0025EE  3  C6 rr        	dec z80_b
0025F0  3               :
0025F0  3  A0 00        	ldy #0
0025F2  3  B1 rr        	lda (z80_bc),y				; fetch digit.
0025F4  3  09 80        	ora #128				; insert end marker.
0025F6  3  91 rr        	sta (z80_bc),y				; new value.
0025F8  3               
0025F8  3  A9 03        	lda #<displ0				; display space.
0025FA  3  85 rr        	sta z80_l
0025FC  3  A9 26        	lda #>displ0
0025FE  3  85 rr        	sta z80_h
002600  3  4C 99 21     	jmp dmsg3				; display the string.
002603  3               
002603  3  00 00 00 8D  displ0:	.byte 0,0,0,13+128
002607  3               
002607  3               ;----------------------------------------------------------------
002607  3               ; Initialise screen.
002607  3               ;
002607  3               ; global:	roomtb,scno
002607  3               ; local:	-
002607  3               ; calls:	tstcs
002607  3               ;----------------------------------------------------------------
002607  3               
002607  3               initsc:
002607  3  AD 50 29     	lda roomtb 			; whereabouts in the map are we?
00260A  3  20 14 26     	jsr tstsc 			; find displacement.
00260D  3  C9 FF        	cmp #255 			; is it valid?
00260F  3  F0 02        	beq init_end 			; no, it's rubbish.
002611  3  85 rr        	sta scno			; store new room number.
002613  3               init_end:
002613  3  60           	rts
002614  3               
002614  3               ;----------------------------------------------------------------
002614  3               ; Test screen.
002614  3               ;
002614  3               ; global:	-
002614  3               ; local:	x
002614  3               ; calls:	-
002614  3               ;----------------------------------------------------------------
002614  3               
002614  3               tstsc:
002614  3  85 rr        	sta tmproom
002616  3  18           	clc
002617  3  69 03        	adc #MAPWID 			; add width in case we"re negative.
002619  3  AA           	tax 				; add displacement to map data.
00261A  3  BD 52 29     	lda mapdat-MAPWID,x 		; find room number there.
00261D  3  60           	rts
00261E  3               
00261E  3               ;--------------------------
00261E  3               ; Screen left.
00261E  3               ;--------------------------
00261E  3               
00261E  3               scrl:
00261E  3  AD 50 29     	lda roomtb 			; present room table pointer.
002621  3  38           	sec
002622  3  E9 01        	sbc #1				; room left.
002624  3               scrl0:
002624  3  20 14 26     	jsr tstsc			; test screen.
002627  3  C9 FF        	cmp #255			; is there a screen this way?
002629  3  D0 01        	bne :+
00262B  3  60           	rts				; no, return to loop.
00262C  3               :
00262C  3  A5 rr        	lda tmproom			; restore room displacement.
00262E  3  8D 50 29     	sta roomtb			; new room table position.
002631  3               scrl1:
002631  3  20 07 26     	jsr initsc 			; set new screen.
002634  3  A9 02        	lda #2
002636  3  85 rr        	sta restfl 			; set it.
002638  3  60           	rts
002639  3               scrr:
002639  3  AD 50 29     	lda roomtb 			; room table pointer.
00263C  3  18           	clc
00263D  3  69 01        	adc #1				; room right.
00263F  3  4C 24 26     	jmp scrl0
002642  3               scru:
002642  3  AD 50 29     	lda roomtb 			; room table pointer.
002645  3  38           	sec
002646  3  E9 03        	sbc #MAPWID 			; room up.
002648  3  4C 24 26     	jmp scrl0
00264B  3               scrd:
00264B  3  AD 50 29     	lda roomtb 			; room table pointer.
00264E  3  18           	clc
00264F  3  69 03        	adc #MAPWID 			; room down.
002651  3  4C 24 26     	jmp scrl0
002654  3               
002654  3               ;-----------------------------------------
002654  3               ; Jump to new screen.
002654  3               ;-----------------------------------------
002654  3               
002654  3               nwscr:
002654  3  A2 00        	ldx #0				; start of map data.
002656  3               nwscr0:
002656  3  DD 55 29     	cmp mapdat,x
002659  3  F0 06        	beq nwscr1			; have we found a match for screen?
00265B  3  E8           	inx 				; next room.
00265C  3  E0 50        	cpx #80				; zero room count, 80 to search.
00265E  3  D0 F6        	bne nwscr0			; keep looking.
002660  3  60           	rts
002661  3               nwscr1:
002661  3  8E 50 29     	stx roomtb			; set the map position.
002664  3  4C 31 26     	jmp scrl1			; draw new room.
002667  3               
002667  3               
002667  3               ;----------------------------------------------------------
002667  3               ; Gravity processing.
002667  3               ;----------------------------------------------------------
002667  3               
002667  3               grav:
002667  3  A0 0D        	ldy #var_jumpLo
002669  3  B1 rr        	lda (z80_ix),y			; jump pointer low.
00266B  3  85 rr        	sta z80_l
00266D  3  A0 0E        	ldy #var_jumpHi
00266F  3  B1 rr        	lda (z80_ix),y			; jump pointer high.
002671  3  85 rr        	sta z80_h
002673  3  05 rr        	ora z80_l			; merge in low byte.
002675  3  D0 01        	bne :+
002677  3  60           	rts				; if neither is set, we're not in the air.
002678  3               :
002678  3  A0 00        	ldy #0
00267A  3  B1 rr        	lda (z80_hl),y			; pixels to move.
00267C  3  85 rr        	sta z80_a
00267E  3  C9 63        	cmp #99				; reached the end?
002680  3  D0 0C        	bne grav0			; no, continue.
002682  3               grav2:
002682  3  C6 rr        	dec z80_l			; go back to previous value.
002684  3  C9 FF        	cmp #$ff
002686  3  D0 02        	bne :+
002688  3  C6 rr        	dec z80_h
00268A  3               :
00268A  3  B1 rr        	lda (z80_hl),y			; fetch that from table.
00268C  3  85 rr        	sta z80_a
00268E  3               grav0:
00268E  3  E6 rr        	inc z80_l			; point to next table entry.
002690  3  D0 02        	bne :+
002692  3  E6 rr        	inc z80_h
002694  3               :
002694  3  A5 rr        	lda z80_l
002696  3  A0 0D        	ldy #var_jumpLo
002698  3  91 rr        	sta (z80_ix),y			; store new pointer low.
00269A  3  A5 rr        	lda z80_h
00269C  3  A0 0E        	ldy #var_jumpHi
00269E  3  91 rr        	sta (z80_ix),y			; store new pointer high.
0026A0  3               grav1:
0026A0  3  A5 rr        	lda z80_a
0026A2  3  D0 01        	bne :+				; any movement required?
0026A4  3  60           	rts				; no, not this time.
0026A5  3               :
0026A5  3  A5 rr        	lda z80_a
0026A7  3  C9 80        	cmp #128			; is it up or down?
0026A9  3  B0 15        	bcs gravu			; it's up.
0026AB  3               gravd:
0026AB  3  85 rr        	sta z80_b			; set pixels to move.
0026AD  3               gravd0:
0026AD  3  20 0D 1F     	jsr cangd			; can we go down?
0026B0  3  D0 28        	bne gravst			; can't move down, so stop.
0026B2  3  A0 08        	ldy #var_newY
0026B4  3  B1 rr        	lda (z80_ix),y			; adjust new x coord.
0026B6  3  18           	clc
0026B7  3  69 01        	adc #1
0026B9  3  91 rr        	sta (z80_ix),y
0026BB  3  C6 rr        	dec z80_b
0026BD  3  D0 EE        	bne gravd0
0026BF  3  60           	rts
0026C0  3               gravu:
0026C0  3  49 FF        	eor #$ff			; flip the sign so it's positive.
0026C2  3  18           	clc
0026C3  3  69 01        	adc #1
0026C5  3  85 rr        	sta z80_b			; set pixels to move.
0026C7  3               gravu0:
0026C7  3  20 D8 1E     	jsr cangu			; can we go up?
0026CA  3  D0 6E        	bne ifalls			; can't move up, go down next.
0026CC  3  A0 08        	ldy #var_newY
0026CE  3  B1 rr        	lda (z80_ix),y
0026D0  3  38           	sec
0026D1  3  E9 01        	sbc #1
0026D3  3  91 rr        	sta (z80_ix),y			; adjust new x coord.
0026D5  3  C6 rr        	dec z80_b
0026D7  3  D0 EE        	bne gravu0
0026D9  3  60           	rts
0026DA  3               gravst:
0026DA  3  A0 0D        	ldy #var_jumpLo
0026DC  3  B1 rr        	lda (z80_ix),y			; jump pointer low.
0026DE  3  85 rr        	sta z80_l
0026E0  3  A0 0E        	ldy #var_jumpHi
0026E2  3  B1 rr        	lda (z80_ix),y			; jump pointer high.
0026E4  3  85 rr        	sta z80_h
0026E6  3               
0026E6  3  A9 00        	lda #0				; null value in pointer.
0026E8  3  A0 0D        	ldy #var_jumpLo
0026EA  3  91 rr        	sta (z80_ix),y			; store new pointer low.
0026EC  3  C8           	iny
0026ED  3  91 rr        	sta (z80_ix),y			; store new pointer high.
0026EF  3               
0026EF  3  A0 00        	ldy #0
0026F1  3  B1 rr        	lda (z80_hl),y			; fetch byte from table.
0026F3  3  C9 63        	cmp #99				; is it the end marker?
0026F5  3               evftf:
0026F5  3  F0 01        	beq :+				; yes, fallen too far.
0026F7  3  60           	rts
0026F8  3               :
0026F8  3  4C A7 3A     	jmp evnt15			; EVENT FELLTOOFAR
0026FB  3               
0026FB  3               ;------------------------------------------------
0026FB  3               ; Initiate fall check.
0026FB  3               ;------------------------------------------------
0026FB  3               
0026FB  3               ifall:
0026FB  3  A0 0D        	ldy #var_jumpLo
0026FD  3  B1 rr        	lda (z80_ix),y 			; jump pointer low.
0026FF  3  85 rr        	sta z80_l
002701  3  A0 0E        	ldy #var_jumpHi
002703  3  B1 rr        	lda (z80_ix),y 			; jump pointer high.
002705  3  85 rr        	sta z80_h			; high byte in accumulator.
002707  3  05 rr        	ora z80_l			; merge in low byte.
002709  3  F0 01        	beq :+
00270B  3  60           	rts				; if either is set, we're already in the air.
00270C  3               :
00270C  3  A0 09        	ldy #var_newX
00270E  3  B1 rr        	lda (z80_ix),y			; y coordinate.
002710  3  85 rr        	sta dispx
002712  3               numsp7:
002712  3  A0 08        	ldy #var_newY
002714  3  B1 rr        	lda (z80_ix),y			; look x coordinate.
002716  3  18           	clc
002717  3  69 10        	adc #16				; add 16 pixels.
002719  3  85 rr        	sta dispy			; set up test coordinates.
00271B  3  20 F4 20     	jsr tstbl			; get map address.
00271E  3  20 9F 1F     	jsr plchk			; block, platform check.
002721  3  F0 01        	beq :+
002723  3  60           	rts				; it's solid, don't fall.
002724  3               :
002724  3  E6 rr        	inc bufaddr			; look right one cell.
002726  3  20 9F 1F     	jsr plchk			; block, platform check.
002729  3  F0 01        	beq :+
00272B  3  60           	rts				; it's solid, don't fall.
00272C  3               :
00272C  3  A5 rr        	lda dispx			; y coordinate.
00272E  3  29 07        	and #7				; position straddling block cells.
002730  3  F0 08        	beq ifalls			; no more checks needed.
002732  3  E6 rr        	inc bufaddr			; look to third cell.
002734  3  20 9F 1F     	jsr plchk			; block, platform check.
002737  3  F0 01        	beq :+
002739  3  60           	rts				; it's solid, don't fall.
00273A  3               :
00273A  3               ifalls:
00273A  3  A9 E9        	lda #<jtab			; jump table start.
00273C  3  85 rr        	sta z80_l
00273E  3  A9 4C        	lda #>jtab
002740  3  85 rr        	sta z80_h
002742  3               ifal0:
002742  3  E6 rr        	inc z80_l			; point to next value.
002744  3  D0 02        	bne :+
002746  3  E6 rr        	inc z80_h
002748  3               :
002748  3  A0 00        	ldy #0
00274A  3  B1 rr        	lda (z80_hl),y			; fetch value.
00274C  3  F0 F4        	beq ifal0			; no, get next value.
00274E  3  C9 63        	cmp #99				; reached end of table?
002750  3  D0 01        	bne :+
002752  3  60           	rts				; yes, don't fall.
002753  3               :
002753  3  C9 80        	cmp #128			; is it going up?
002755  3  B0 EB        	bcs ifal0			; yes, looking for first movement down.
002757  3               
002757  3  A0 0D        	ldy #var_jumpLo
002759  3  A5 rr        	lda z80_l
00275B  3  91 rr        	sta (z80_ix),y 			; set jump low.
00275D  3  A0 0E        	ldy #var_jumpHi
00275F  3  A5 rr        	lda z80_h
002761  3  91 rr        	sta (z80_ix),y 			; set jump high.
002763  3  60           	rts
002764  3               
002764  3               
002764  3               ;----------------------------------------------------
002764  3               ; Get frame data for a particular sprite.
002764  3               ; Input:
002764  3               ;  a		= framenumer
002764  3               ; Output:
002764  3               ;  hl		= frame address
002764  3               ;
002764  3               ; global:	hl,frmptr
002764  3               ; local:	-
002764  3               ; calls:	-
002764  3               ;----------------------------------------------------
002764  3               
002764  3               gfrm:
002764  3  0A           	asl a	 		 	; multiple of 2.
002765  3  18           	clc
002766  3  6D 15 18     	adc frmptr 			; frames used by game.
002769  3  85 rr        	sta z80_l
00276B  3  AD 16 18     	lda frmptr+1
00276E  3  69 00        	adc #0
002770  3  85 rr        	sta z80_h 			; point to frame start.
002772  3  60           	rts
002773  3               
002773  3               ;----------------------------------------------------
002773  3               ; Find sprite list for current room.
002773  3               ;
002773  3               ; global:	hl
002773  3               ; local:	x,y
002773  3               ; calls:	-
002773  3               ;----------------------------------------------------
002773  3               
002773  3               sprlst:
002773  3  A9 AB        	lda #<nmedat 			; list of enemy sprites.
002775  3  85 rr        	sta z80_l
002777  3  A9 44        	lda #>nmedat
002779  3  85 rr        	sta z80_h
00277B  3  A6 rr        	ldx scno 			; screen number.
00277D  3  D0 01        	bne sprls2 			; is it the first screen?
00277F  3  60           	rts 				; yes, don't need to search data.
002780  3               sprls2:
002780  3  A0 00        	ldy #0
002782  3               sprls1:
002782  3  B1 rr        	lda (z80_hl),y 			; fetch type of sprite.
002784  3  C9 FF        	cmp #255			; is it an end marker?
002786  3  F0 0E        	beq sprls0 			; yes, end of this room.
002788  3               
002788  3  18           	clc 				; point to next sprite in list.
002789  3  A5 rr        	lda z80_l
00278B  3  69 04        	adc #NMESIZ
00278D  3  85 rr        	sta z80_l
00278F  3  90 02        	bcc :+
002791  3  E6 rr        	inc z80_h
002793  3               :
002793  3  4C 82 27     	jmp sprls1 			; continue until end of room.
002796  3               sprls0:
002796  3  E6 rr        	inc z80_l 			; point to start of next screen.s
002798  3  D0 02        	bne :+
00279A  3  E6 rr        	inc z80_h
00279C  3               :
00279C  3  CA           	dex
00279D  3  D0 E3        	bne sprls1 			; continue until room found.
00279F  3  60           	rts
0027A0  3               
0027A0  3               
0027A0  3               ;----------------------------------------------------
0027A0  3               ; Clear all but a single player sprite.
0027A0  3               ;
0027A0  3               ; global:	-
0027A0  3               ; local:	x,y,ix
0027A0  3               ; calls:	-
0027A0  3               ;----------------------------------------------------
0027A0  3               
0027A0  3               nspr:
0027A0  3  A9 0C        	lda #NUMSPR			; sprite slots in table.
0027A2  3  85 rr        	sta sprcnt
0027A4  3  A9 00        	lda #<sprtab 			; sprite table.
0027A6  3  85 rr        	sta z80_x
0027A8  3  A9 0B        	lda #>sprtab
0027AA  3  85 rr        	sta z80_i
0027AC  3               nspr0:
0027AC  3  A0 00        	ldy #0 				; fetch sprite type.
0027AE  3  B1 rr        	lda (z80_ix),y 			; is it a player?
0027B0  3  F0 1A        	beq nspr1 			; yes, keep this one.
0027B2  3               
0027B2  3  A9 FF        	lda #255
0027B4  3  A0 00        	ldy #0 				; fetch sprite type.
0027B6  3  91 rr        	sta (z80_ix),y 			; delete sprite.
0027B8  3  A0 05        	ldy #5
0027BA  3  91 rr        	sta (z80_ix),y 			; remove next type.
0027BC  3               
0027BC  3  18           	clc	 			; next sprite.
0027BD  3  A5 rr        	lda z80_x
0027BF  3  69 11        	adc #TABSIZ 			; distance to next odd/even entry.
0027C1  3  85 rr        	sta z80_x
0027C3  3  90 02        	bcc :+
0027C5  3  E6 rr        	inc z80_i
0027C7  3               :
0027C7  3  C6 rr        	dec sprcnt	 			; one less space in the table.
0027C9  3  D0 E1        	bne nspr0
0027CB  3  60           	rts
0027CC  3               nspr1:
0027CC  3  A9 FF        	lda #255
0027CE  3  A0 00        	ldy #0
0027D0  3  91 rr        	sta (z80_ix),y 			; delete sprite.
0027D2  3               
0027D2  3  18           	clc	 			; point to next sprite.
0027D3  3  A5 rr        	lda z80_x
0027D5  3  69 11        	adc #TABSIZ 			; distance to next odd/even entry.
0027D7  3  85 rr        	sta z80_x
0027D9  3  90 02        	bcc :+
0027DB  3  E6 rr        	inc z80_i
0027DD  3               :
0027DD  3  C6 rr        	dec sprcnt	 			; one less to do.
0027DF  3  D0 01        	bne nspr2
0027E1  3  60           	rts
0027E2  3               nspr2:
0027E2  3  A9 FF        	lda #255
0027E4  3  A0 00        	ldy #0
0027E6  3  91 rr        	sta (z80_ix),y 			; delete sprite.
0027E8  3  A0 05        	ldy #5
0027EA  3  91 rr        	sta (z80_ix),y 			; remove next type.
0027EC  3               
0027EC  3  18           	clc	 			; next sprite.
0027ED  3  A5 rr        	lda z80_x
0027EF  3  69 11        	adc #TABSIZ 			; distance to next odd/even entry.
0027F1  3  85 rr        	sta z80_x
0027F3  3  90 02        	bcc :+
0027F5  3  E6 rr        	inc z80_i
0027F7  3               :
0027F7  3  C6 rr        	dec sprcnt	 			; one less space in table.
0027F9  3  D0 E7        	bne nspr2
0027FB  3  60           	rts
0027FC  3               
0027FC  3               ;----------------------------------------------------------
0027FC  3               ; Two initialisation routines.
0027FC  3               ; Initialise sprites - copy everything from list to table.
0027FC  3               ;
0027FC  3               ; global:	-
0027FC  3               ; local:	x,y,ix
0027FC  3               ; calls:	cpsp
0027FC  3               ;----------------------------------------------------------
0027FC  3               
0027FC  3               ispr:
0027FC  3  A9 0C        	lda #NUMSPR			; sprite slots in table.
0027FE  3  85 rr        	sta sprcnt
002800  3  A9 00        	lda #<sprtab			; sprite table.
002802  3  85 rr        	sta z80_x
002804  3  A9 0B        	lda #>sprtab
002806  3  85 rr        	sta z80_i
002808  3               ispr2:
002808  3  A0 00        	ldy #0
00280A  3  B1 rr        	lda (z80_hl),y 			; fetch byte.
00280C  3  C9 FF        	cmp #255 			; is it an end marker?
00280E  3  D0 01        	bne :+
002810  3  60           	rts 				; yes, no more to do.
002811  3               :
002811  3               ispr1:
002811  3  A0 00        	ldy #0
002813  3  B1 rr        	lda (z80_ix),y 			; fetch sprite type.
002815  3  C9 FF        	cmp #255 			; is it enabled yet?
002817  3  D0 08        	bne ispr4			; yes, try another slot.
002819  3               
002819  3  A0 05        	ldy #5
00281B  3  B1 rr        	lda (z80_ix),y		 	; next type.
00281D  3  C9 FF        	cmp #255 			; is it enabled yet?
00281F  3  F0 10        	beq ispr3 			; no, process this one.
002821  3               ispr4:
002821  3  18           	clc 				; next sprite.
002822  3  A5 rr        	lda z80_x
002824  3  69 11        	adc #TABSIZ		 	; distance to next odd/even entry.
002826  3  85 rr        	sta z80_x
002828  3  90 02        	bcc :+
00282A  3  E6 rr        	inc z80_i
00282C  3               :
00282C  3  C6 rr        	dec sprcnt
00282E  3  D0 E1        	bne ispr1 			; repeat for remaining sprites.
002830  3  60           	rts  				; no more room in table.
002831  3               ispr3:
002831  3  20 84 28     	jsr cpsp			; initialise a sprite.
002834  3  C6 rr        	dec sprcnt			; one less space in the table.
002836  3  D0 D0        	bne ispr2
002838  3  60           	rts
002839  3               
002839  3               
002839  3               ;-----------------------------------------------------------------------
002839  3               ; Initialise sprites - but not player, we're keeping the old one.
002839  3               ;
002839  3               ; global:	-
002839  3               ; local:	x,y,ix
002839  3               ; calls:	cpsp
002839  3               ;-----------------------------------------------------------------------
002839  3               
002839  3               kspr:
002839  3  A2 0C        	ldx #NUMSPR			; sprite slots in table.
00283B  3  A9 00        	lda #<sprtab 			; sprite table.
00283D  3  85 rr        	sta z80_x
00283F  3  A9 0B        	lda #>sprtab
002841  3  85 rr        	sta z80_i
002843  3               kspr2:
002843  3  A0 00        	ldy #0
002845  3  B1 rr        	lda (z80_hl),y 			; fetch byte.
002847  3  C9 FF        	cmp #255 			; is it an end marker?
002849  3  D0 01        	bne :+
00284B  3  60           	rts 				; yes, no more to do.
00284C  3               :
00284C  3  C9 00        	cmp #0
00284E  3  D0 0E        	bne kspr1 			; no, add to table as normal.
002850  3               
002850  3  18           	clc 				; next sprite.
002851  3  A5 rr        	lda z80_l
002853  3  69 04        	adc #NMESIZ		 	; distance to next odd/even entry.
002855  3  85 rr        	sta z80_l
002857  3  90 02        	bcc :+
002859  3  E6 rr        	inc z80_h
00285B  3               :
00285B  3  4C 43 28     	jmp kspr2
00285E  3               kspr1:
00285E  3  A0 00        	ldy #0 				; fetch sprite type.
002860  3  B1 rr        	lda (z80_ix),y
002862  3  C9 FF        	cmp #255 			; is it enabled yet?
002864  3  D0 08        	bne kspr4 			; yes, try another slot.
002866  3               
002866  3  A0 05        	ldy #5 				; next type.
002868  3  B1 rr        	lda (z80_ix),y
00286A  3  C9 FF        	cmp #255 			; is it enabled yet?
00286C  3  F0 0F        	beq kspr3 			; no, process this one.
00286E  3               kspr4:
00286E  3  18           	clc 				; next sprite.
00286F  3  A5 rr        	lda z80_x
002871  3  69 11        	adc #TABSIZ		 	; distance to next odd/even entry.
002873  3  85 rr        	sta z80_x
002875  3  90 02        	bcc :+
002877  3  E6 rr        	inc z80_i
002879  3               :
002879  3  CA           	dex	 			; repeat for remaining sprites.
00287A  3  D0 E2        	bne kspr1
00287C  3  60           	rts  				; no more room in table.
00287D  3               kspr3:
00287D  3  20 84 28     	jsr cpsp 			; copy sprite to table.
002880  3  CA           	dex	 			; one less space in the table.
002881  3  D0 C0        	bne kspr2
002883  3  60           	rts
002884  3               
002884  3               ;----------------------------------------------
002884  3               ; Copy sprite from list to table.
002884  3               ;
002884  3               ; global:	hl,ix
002884  3               ; local:	y
002884  3               ; calls:	evnt09
002884  3               ;----------------------------------------------
002884  3               
002884  3               cpsp:
002884  3  A0 00        	ldy #0					; fetch byte from table.
002886  3  B1 rr        	lda (z80_hl),y
002888  3               	; y=var_Type
002888  3  91 rr        	sta (z80_ix),y			; set up type.
00288A  3  A0 05        	ldy #var_newType
00288C  3  91 rr        	sta (z80_ix),y 			; set up type.
00288E  3               
00288E  3  E6 rr        	inc z80_l 				; move to next byte.
002890  3  D0 02        	bne :+
002892  3  E6 rr        	inc z80_h
002894  3               :
002894  3  A0 00        	ldy #0 					; fetch byte from table.
002896  3  B1 rr        	lda (z80_hl),y
002898  3  A0 06        	ldy #var_newImage
00289A  3  91 rr        	sta (z80_ix),y			; set up image.
00289C  3               
00289C  3  E6 rr        	inc z80_l 				; move to next byte.
00289E  3  D0 02        	bne :+
0028A0  3  E6 rr        	inc z80_h
0028A2  3               :
0028A2  3  A0 00        	ldy #0
0028A4  3  B1 rr        	lda (z80_hl),y 			; fetch byte from table.
0028A6  3  A0 08        	ldy #var_newY
0028A8  3  91 rr        	sta (z80_ix),y 			; set up coordinate.
0028AA  3               
0028AA  3  A9 C8        	lda #200 				; set initial coordinate off screen.
0028AC  3  A0 03        	ldy #var_Y
0028AE  3  91 rr        	sta (z80_ix),y
0028B0  3               
0028B0  3  E6 rr        	inc z80_l 				; move to next byte.
0028B2  3  D0 02        	bne :+
0028B4  3  E6 rr        	inc z80_h
0028B6  3               :
0028B6  3  A0 00        	ldy #0 					; fetch byte from table.
0028B8  3  B1 rr        	lda (z80_hl),y
0028BA  3  A0 09        	ldy #var_newX
0028BC  3  91 rr        	sta (z80_ix),y 			; set up coordinate.
0028BE  3               
0028BE  3  E6 rr        	inc z80_l 				; move to next byte.
0028C0  3  D0 02        	bne :+
0028C2  3  E6 rr        	inc z80_h
0028C4  3               :
0028C4  3  A9 00        	lda #0					; zeroes in accumulator.
0028C6  3  A0 07        	ldy #var_newFrame 		; reset frame number.
0028C8  3  91 rr        	sta (z80_ix),y
0028CA  3  A0 0A        	ldy #var_Direction 		; reset direction.
0028CC  3  91 rr        	sta (z80_ix),y
0028CE  3  A0 0D        	ldy #var_jumpLo			; reset jump pointer low.
0028D0  3  91 rr        	sta (z80_ix),y
0028D2  3  A0 0E        	ldy #var_jumpHi	 		; reset jump pointer high.
0028D4  3  91 rr        	sta (z80_ix),y
0028D6  3               
0028D6  3  A9 FF        	lda #255 				; reset data pointer to auto-restore.
0028D8  3  A0 10        	ldy #var_dataHi
0028DA  3  91 rr        	sta (z80_ix),y
0028DC  3               evis0:
0028DC  3  A5 rr        	lda z80_i
0028DE  3  48           	pha
0028DF  3  A5 rr        	lda z80_x
0028E1  3  48           	pha
0028E2  3  A5 rr        	lda z80_h
0028E4  3  48           	pha
0028E5  3  A5 rr        	lda z80_l
0028E7  3  48           	pha
0028E8  3               
0028E8  3  20 C0 39     	jsr evnt09 				; perform event.
0028EB  3               
0028EB  3  68           	pla
0028EC  3  85 rr        	sta z80_l
0028EE  3  68           	pla
0028EF  3  85 rr        	sta z80_h
0028F1  3  68           	pla
0028F2  3  85 rr        	sta z80_x
0028F4  3  68           	pla
0028F5  3  85 rr        	sta z80_i
0028F7  3               
0028F7  3  18           	clc
0028F8  3  A5 rr        	lda z80_x 			; distance to next odd/even entry.
0028FA  3  69 11        	adc #TABSIZ		 	; next sprite.
0028FC  3  85 rr        	sta z80_x
0028FE  3  90 02        	bcc :+
002900  3  E6 rr        	inc z80_i
002902  3               :
002902  3  60           	rts
002903  3               
002903  3               
002903  3               ;-------------------------------------
002903  3               ; Clear the play area window.
002903  3               ;-------------------------------------
002903  3               
002903  3               clw:
002903  3  AD 0C 18     	lda wintop			; get coordinates of window.
002906  3  85 rr        	sta dispy			; put into dispx for calculation.
002908  3  AD 0D 18     	lda winlft
00290B  3  85 rr        	sta dispx
00290D  3               
00290D  3  AD 0E 18     	lda winhgt			; height of window.
002910  3  85 rr        	sta rrow			; copy to b register.
002912  3               clw3:
002912  3  AD 0F 18     	lda winwid 			; width of window.
002915  3  85 rr        	sta rcol
002917  3               clw2:
002917  3  20 0A 13     	jsr gprad 			; get print address.
00291A  3  A9 00        	lda #0				; zero byte to write.
00291C  3  A0 07        	ldy #7				; pixel height of each cell.
00291E  3               clw1:
00291E  3  91 rr        	sta (scraddr),y 	; copy to screen.
002920  3  88           	dey					; next screen row down.
002921  3  10 FB        	bpl clw1
002923  3               
002923  3  E6 rr        	inc dispx			; next column.
002925  3  C6 rr        	dec rcol			; one less to do.
002927  3  D0 EE        	bne clw2			; repeat for remaining columns.
002929  3               
002929  3  AD 0D 18     	lda winlft			; get left edge.
00292C  3  85 rr        	sta dispx 			; reset x.
00292E  3  E6 rr        	inc dispy 			; next line down.
002930  3               
002930  3  C6 rr        	dec rrow
002932  3  D0 DE        	bne clw3			; repeat down the screen.
002934  3               
002934  3  AD 0C 18     	lda wintop			; get coordinates of window.
002937  3  85 rr        	sta chary			; put into display position.
002939  3  AD 0D 18     	lda winlft
00293C  3  85 rr        	sta charx
00293E  3  60           	rts
00293F  3               
00293F  3               
00293F  3               ;----------------------------------------------------------
00293F  3               ; Effects code.
00293F  3               ; Ticker routine is called 25 times per second.
00293F  3               ;
00293F  3               ; HL = txtscr = left text screen address
00293F  3               ; DE = txtscr+txtwid-1 = right text screen address
00293F  3               ; BC = txtpos = text scroller position
00293F  3               ;
00293F  3               ;----------------------------------------------------------
00293F  3               
00293F  3               .if sflag
00293F  3               scrly:
00293F  3               	rts
00293F  3               	.word txtscr         	; get left screen address.
00293F  3               	sta scr_l
00293F  3               	lda txtscr+1
00293F  3               	sta scr_l+1
00293F  3               	sta scr_r+1
00293F  3               
00293F  3               	stx xtmp
00293F  3               
00293F  3               	clc         		; get right screen address.
00293F  3               	lda scr_l
00293F  3               	adc txtwid
00293F  3               	sta scr_r
00293F  3               	dec scr_r
00293F  3               scrly1:
00293F  3               	ldy txtwid		; set txtwide
00293F  3               	dey
00293F  3               	clc
00293F  3               scrly0:
00293F  3               	lda (scr_l),y		; scroll 1 line
00293F  3               	rol a
00293F  3               	sta (scr_l),y
00293F  3               	dey
00293F  3               	bpl scrly0
00293F  3               
00293F  3               	clc			; point to next line
00293F  3               	lda scr_l
00293F  3               	adc #32
00293F  3               	sta scr_l
00293F  3               	bcc scrly1		; repeat 8 times
00293F  3               
00293F  3               	lda txtpos 		; get text pointer.
00293F  3               	sta scr_txt
00293F  3               	lda txtpos+1
00293F  3               	sta scr_txt+1
00293F  3               
00293F  3               	ldy #0
00293F  3               	lda (scr_txt),y 		; find character we're displaying.
00293F  3               	and #127 		; remove end marker bit if applicable.
00293F  3               	cmp #ASCII_NEWLINE			; is it newline?
00293F  3               	bne scrly5 		; no, it's okay.
00293F  3               	lda #32			; convert to a space instead.
00293F  3               scrly5:
00293F  3               	sta fntaddr		; calculate char address
00293F  3               	lda #0
00293F  3               	sta fntaddr+1
00293F  3               	asl fntaddr  		; multiply char by 8.
00293F  3               	rol fntaddr+1
00293F  3               	asl fntaddr
00293F  3               	rol fntaddr+1
00293F  3               	asl fntaddr
00293F  3               	rol fntaddr+1
00293F  3               	lda fntaddr
00293F  3               	clc
00293F  3               	adc FontPtr
00293F  3               	sta scrly3+1		; that's the low byte.
00293F  3               	lda fntaddr+1
00293F  3               	adc FontPtr+1
00293F  3               	sta scrly3+2		; add displacement.
00293F  3               
00293F  3               	ldx #0
00293F  3               scrly3:
00293F  3               	lda $3333,x		; get image of char line.
00293F  3               	and txtbit
00293F  3               	beq scrly2		; don't plot pixel
00293F  3               	ldy scrline,x
00293F  3               	lda (scr_r),y
00293F  3               	clc
00293F  3               	ora #1
00293F  3               	sta (scr_r),y		; plot pixel
00293F  3               scrly2:
00293F  3               	inx			; next line of char.
00293F  3               	cpx #8
00293F  3               	bne scrly3
00293F  3               
00293F  3               	lsr txtbit		; bit of text to display.
00293F  3               	bcs :+
00293F  3               	rts
00293F  3               :
00293F  3               	ldy #0
00293F  3               	lda (scr_txt),y 	; what was the character?
00293F  3               	asl a	  		; end of message?
00293F  3               	bcs scrly4
00293F  3               	inc txtpos
00293F  3               	bne :+
00293F  3               	inc txtpos+1
00293F  3               :
00293F  3               	jmp scrly6 		; not yet - continue.
00293F  3               scrly4:
00293F  3               	lda txtini 		; start of scrolling message.
00293F  3               	sta txtpos
00293F  3               	lda txtini+1
00293F  3               	sta txtpos+1
00293F  3               scrly6:
00293F  3               	lda #128
00293F  3               	sta txtbit
00293F  3               	ldx xtmp
00293F  3               	rts
00293F  3               
00293F  3               scrline:	.byte $00,$20,$40,$60,$80,$a0,$c0,$e0
00293F  3               
00293F  3               ;-------------------------------------------------------
00293F  3               ; Entry TICKER command
00293F  3               ;
00293F  3               ; Entry:
00293F  3               ;  z80_b = message nr
00293F  3               ;  z80_c = width
00293F  3               ;-------------------------------------------------------
00293F  3               
00293F  3               iscrly:
00293F  3               	jsr prescr 		; set up display position.
00293F  3               
00293F  3               	lda #<msgdat 		; text messages.
00293F  3               	sta z80_l
00293F  3               	lda #>msgdat
00293F  3               	sta z80_h
00293F  3               
00293F  3               	lda z80_c 		; width.
00293F  3               	sec
00293F  3               	sbc #1			; subtract one.
00293F  3               	cmp #32 		; is it between 1 and 32?
00293F  3               	bcc :+
00293F  3               	lda #$60
00293F  3               	jmp iscrl0		; no, disable messages.
00293F  3               :
00293F  3               	ldx z80_b		; message number.
00293F  3               	jsr getwrd 		; find message start.
00293F  3               
00293F  3               	lda z80_l		; set initial text position.
00293F  3               	sta txtini
00293F  3               	lda z80_h
00293F  3               	sta txtini+1
00293F  3               
00293F  3               	lda #$ad		; code for lda adrr
00293F  3               iscrl0:
00293F  3               	sta scrly		; enable/disable scrolling routine.
00293F  3               
00293F  3               	jsr prescr 		; set up display position.
00293F  3               	jsr gprad 		; get print address.
00293F  3               
00293F  3               	lda scraddr 		; set text screen address.
00293F  3               	sta txtscr
00293F  3               	lda scraddr+1
00293F  3               	sta txtscr+1
00293F  3               
00293F  3               	lda z80_c		; width.
00293F  3               	sta txtwid		; set width in working storage.
00293F  3               
00293F  3               	lda #128 		; start with leftmost bit.
00293F  3               	sta txtbit
00293F  3               
00293F  3               	jmp scrly4
00293F  3               .endif
00293F  3               
00293F  3               ;------------------------------------------------------------------
00293F  3               ; Dig routine, conditional assembly depending on dflag
00293F  3               ;------------------------------------------------------------------
00293F  3               .if dflag
00293F  3               dig:
00293F  3               	and #3
00293F  3               	beq digr		; dig right
00293F  3               	cmp #1
00293F  3               	beq digl		; dig left
00293F  3               	cmp #2
00293F  3               	beq digd		; dig down
00293F  3               
00293F  3               ; Dig up.
00293F  3               
00293F  3               digu:				; dig up
00293F  3               	ldy #var_newY
00293F  3               	lda (z80_ix),y
00293F  3               	sec
00293F  3               	sbc #2
00293F  3               	sta dispy		; set y
00293F  3               
00293F  3               	iny
00293F  3               	lda (z80_ix),y
00293F  3               	sta dispx		; set x
00293F  3               	jmp digv
00293F  3               
00293F  3               ; Dig down.
00293F  3               
00293F  3               digd:
00293F  3               	ldy #var_newX
00293F  3               	lda (z80_ix),y
00293F  3               	sta dispx		; set x
00293F  3               
00293F  3               	dey
00293F  3               	clc
00293F  3               	lda (z80_ix),y
00293F  3               	adc #16
00293F  3               	sta dispy		; set y
00293F  3               	jmp digv
00293F  3               
00293F  3               ; Dig left.
00293F  3               
00293F  3               digl:
00293F  3               	ldy #var_newY
00293F  3               	lda (z80_ix),y
00293F  3               	sta dispy		; set y
00293F  3               
00293F  3               	iny
00293F  3               	lda (z80_ix),y
00293F  3               	sec
00293F  3               	sbc #2			; x=x-2
00293F  3               	sta dispx		; set x
00293F  3               	jmp digh
00293F  3               
00293F  3               ; Dig right.
00293F  3               
00293F  3               digr:
00293F  3               	ldy #var_newY
00293F  3               	lda (z80_ix),y
00293F  3               	sta dispy		; set y
00293F  3               
00293F  3               	iny
00293F  3               	lda (z80_ix),y
00293F  3               	clc
00293F  3               	adc #16
00293F  3               	sta dispx		; set x+16
00293F  3               	jmp digh
00293F  3               
00293F  3               ; Vertical digging
00293F  3               
00293F  3               digv:
00293F  3               	jsr tstbl		; check blocktype in MAP
00293F  3               	jsr fdchk		; test if FODDER
00293F  3               
00293F  3               	clc
00293F  3               	lda dispx		; look 1 cell down
00293F  3               	adc #8
00293F  3               	sta dispx
00293F  3               	jsr tstbl		; check blocktype in MAP
00293F  3               	jsr fdchk
00293F  3               	lda dispx
00293F  3               	and #7
00293F  3               	bne :+
00293F  3               	rts
00293F  3               :
00293F  3               	clc
00293F  3               	lda dispx		; look 1 cell down
00293F  3               	adc #8
00293F  3               	sta dispx
00293F  3               	jsr tstbl		; check blocktype in MAP
00293F  3               	jmp fdchk
00293F  3               
00293F  3               ; Horizontal digging
00293F  3               
00293F  3               digh:
00293F  3               	jsr tstbl		; check blocktype in MAP
00293F  3               	jsr fdchk		; test if FODDER
00293F  3               
00293F  3               	clc
00293F  3               	lda dispy		; look 1 cell down
00293F  3               	adc #8
00293F  3               	sta dispy
00293F  3               	jsr tstbl		; check blocktype in MAP
00293F  3               	jsr fdchk
00293F  3               	lda dispy
00293F  3               	and #7
00293F  3               	bne :+
00293F  3               	rts
00293F  3               :
00293F  3               	clc
00293F  3               	lda dispy		; look 1 cell down
00293F  3               	adc #8
00293F  3               	sta dispy
00293F  3               	jsr tstbl		; check blocktype in MAP
00293F  3               	jmp fdchk
00293F  3               
00293F  3               digcnt:	.byte 0
00293F  3               
00293F  3               .endif
00293F  3               
00293F  3               ;------------------------------------------------------------------
00293F  3               ; Sprite table
00293F  3               ;------------------------------------------------------------------
00293F  3               
00293F  3               
00293F  3               ; ix+0  = type.
00293F  3               ; ix+1  = sprite image number.
00293F  3               ; ix+2  = frame.
00293F  3               ; ix+3  = y coord.
00293F  3               ; ix+4  = x coord.
00293F  3               
00293F  3               ; ix+5  = new type.
00293F  3               ; ix+6  = new image number.
00293F  3               ; ix+7  = new frame.
00293F  3               ; ix+8  = new y coord.
00293F  3               ; ix+9  = new x coord.
00293F  3               
00293F  3               ; ix+10 = direction.
00293F  3               ; ix+11 = parameter 1.
00293F  3               ; ix+12 = parameter 2.
00293F  3               ; ix+13 = jump pointer low.
00293F  3               ; ix+14 = jump pointer high.
00293F  3               ; ix+15 = data pointer low.
00293F  3               ; ix+16 = data pointer high.
00293F  3               
00293F  3               ; block NUMSPR * TABSIZ,255
00293F  3               ; sprtab NUMSPR*TABSIZ,255
00293F  3               
00293F  3  FF FF FF FF  ssprit:	.byte 255,255,255,255,255,255,255,0,192,120,0,0,0,255,255,255,255
002943  3  FF FF FF 00  
002947  3  C0 78 00 00  
002950  3  07           roomtb:	.byte 7                      ; start room map offset.
002951  3               
002951  3               ; User routine.  Put your own code in here to be called with USER instruction.
002951  3               ; if USER has an argument it will be passed in the accumulator.
002951  3               
002951  3               user:
002951  3  60           	rts
002952  3               
002952  3               ; Everything below here will be generated by the editors.
002952  3               
002952  3               script_start:
002952  3               
002952  3               WINDOWTOP = 0
002952  3               WINDOWLFT = 0
002952  3               WINDOWHGT = 23
002952  3               WINDOWWID = 30 ;
002952  3               MAPWID = 3
002952  3  FF FF FF             .byte 255,255,255
002955  3               mapdat:
002955  3  FF 00 FF             .byte 255,0,255
002958  3  FF FF FF             .byte 255,255,255
00295B  3  02           stmap:  .byte 2
00295C  3               
00295C  3               evnt00:
00295C  3  A9 01                lda #1
00295E  3  C5 rr                cmp vare
002960  3  F0 03                beq *+5
002962  3  4C 9F 29             jmp a00126
002965  3  A9 02                lda #2
002967  3  A0 06                ldy #6
002969  3  D1 rr                cmp (z80_ix),y
00296B  3  F0 03                beq *+5
00296D  3  4C 7B 29             jmp a00059
002970  3  20 54 1F             jsr cangr
002973  3  F0 03                beq :+
002975  3  4C 7B 29             jmp a00059
002978  3               :
002978  3  4C 7B 29             jmp a00059
00297B  3  A9 03        a00059: lda #3
00297D  3  A0 06                ldy #6
00297F  3  D1 rr                cmp (z80_ix),y
002981  3  F0 03                beq *+5
002983  3  4C 91 29             jmp a00099
002986  3  20 42 1F             jsr cangl
002989  3  F0 03                beq :+
00298B  3  4C 91 29             jmp a00099
00298E  3               :
00298E  3  4C 91 29             jmp a00099
002991  3  A9 06        a00099: lda #CUSTOM
002993  3  85 rr                sta z80_b
002995  3  20 39 20             jsr tded
002998  3  C5 rr                cmp z80_b
00299A  3  F0 03                beq :+
00299C  3  4C 9F 29             jmp a00126
00299F  3               :
00299F  3  A0 08        a00126: ldy #8
0029A1  3  B1 rr                lda (z80_ix),y
0029A3  3  C9 C8                cmp #200
0029A5  3  90 03                bcc *+5
0029A7  3  4C FF 30             jmp a03930
0029AA  3  A9 0F                lda #15
0029AC  3  A0 08                ldy #8
0029AE  3  D1 rr                cmp (z80_ix),y
0029B0  3  90 03                bcc *+5
0029B2  3  4C 8F 2A             jmp a00599
0029B5  3  A9 10                lda #16
0029B7  3  85 rr                sta z80_c
0029B9  3  A0 08                ldy #8
0029BB  3  B1 rr                lda (z80_ix),y
0029BD  3  38                   sec
0029BE  3  E5 rr                sbc z80_c
0029C0  3  A0 08                ldy #8
0029C2  3  91 rr                sta (z80_ix),y
0029C4  3  A9 02                lda #2
0029C6  3  A0 06                ldy #6
0029C8  3  D1 rr                cmp (z80_ix),y
0029CA  3  F0 03                beq *+5
0029CC  3  4C 07 2A             jmp a00330
0029CF  3  A9 01                lda #1
0029D1  3  C5 rr                cmp vare
0029D3  3  F0 03                beq *+5
0029D5  3  4C E3 29             jmp a00263
0029D8  3  20 54 1F             jsr cangr
0029DB  3  F0 03                beq :+
0029DD  3  4C E3 29             jmp a00263
0029E0  3               :
0029E0  3  4C E3 29             jmp a00263
0029E3  3  A9 03        a00263: lda #3
0029E5  3  A0 06                ldy #6
0029E7  3  D1 rr                cmp (z80_ix),y
0029E9  3  F0 03                beq *+5
0029EB  3  4C F9 29             jmp a00303
0029EE  3  20 42 1F             jsr cangl
0029F1  3  F0 03                beq :+
0029F3  3  4C F9 29             jmp a00303
0029F6  3               :
0029F6  3  4C F9 29             jmp a00303
0029F9  3  A9 06        a00303: lda #CUSTOM
0029FB  3  85 rr                sta z80_b
0029FD  3  20 39 20             jsr tded
002A00  3  C5 rr                cmp z80_b
002A02  3  F0 03                beq :+
002A04  3  4C 07 2A             jmp a00330
002A07  3               :
002A07  3  A9 00        a00330: lda #0
002A09  3  85 rr                sta varq
002A0B  3  A5 rr                lda clock
002A0D  3  C9 32                cmp #50
002A0F  3  90 03                bcc *+5
002A11  3  4C 18 2A             jmp a00364
002A14  3  A9 01                lda #1
002A16  3  85 rr                sta varq
002A18  3  A9 64        a00364: lda #100
002A1A  3  C5 rr                cmp clock
002A1C  3  90 03                bcc *+5
002A1E  3  4C 2E 2A             jmp a00407
002A21  3  A5 rr                lda clock
002A23  3  C9 96                cmp #150
002A25  3  90 03                bcc *+5
002A27  3  4C 2E 2A             jmp a00407
002A2A  3  A9 01                lda #1
002A2C  3  85 rr                sta varq
002A2E  3  A9 C8        a00407: lda #200
002A30  3  C5 rr                cmp clock
002A32  3  90 03                bcc *+5
002A34  3  4C 3B 2A             jmp a00432
002A37  3  A9 01                lda #1
002A39  3  85 rr                sta varq
002A3B  3  A9 00        a00432: lda #0
002A3D  3  C5 rr                cmp varq
002A3F  3  F0 03                beq *+5
002A41  3  4C 62 2A             jmp a00506
002A44  3  A9 01                lda #1
002A46  3  20 18 1B             jsr getob
002A49  3  A9 00                lda #0
002A4B  3  20 18 1B             jsr getob
002A4E  3  A0 09                ldy #9
002A50  3  B1 rr                lda (z80_ix),y
002A52  3  85 rr                sta dispx
002A54  3  A0 08                ldy #8
002A56  3  B1 rr                lda (z80_ix),y
002A58  3  85 rr                sta dispy
002A5A  3  A9 00                lda #0
002A5C  3  20 78 1B             jsr drpob
002A5F  3  4C 7D 2A             jmp a00559
002A62  3  A9 01        a00506: lda #1
002A64  3  20 18 1B             jsr getob
002A67  3  A9 00                lda #0
002A69  3  20 18 1B             jsr getob
002A6C  3  A0 09                ldy #9
002A6E  3  B1 rr                lda (z80_ix),y
002A70  3  85 rr                sta dispx
002A72  3  A0 08                ldy #8
002A74  3  B1 rr                lda (z80_ix),y
002A76  3  85 rr                sta dispy
002A78  3  A9 01                lda #1
002A7A  3  20 78 1B             jsr drpob
002A7D  3  A9 10        a00559: lda #16
002A7F  3  85 rr                sta z80_c
002A81  3  A0 08                ldy #8
002A83  3  B1 rr                lda (z80_ix),y
002A85  3  18                   clc
002A86  3  65 rr                adc z80_c
002A88  3  A0 08                ldy #8
002A8A  3  91 rr                sta (z80_ix),y
002A8C  3  4C 99 2A             jmp a00615
002A8F  3  A9 00        a00599: lda #0
002A91  3  20 18 1B             jsr getob
002A94  3  A9 01                lda #1
002A96  3  20 18 1B             jsr getob
002A99  3  A0 0A        a00615: ldy #10
002A9B  3  B1 rr                lda (z80_ix),y
002A9D  3  85 rr                sta varo
002A9F  3  A0 0A                ldy #10
002AA1  3  B1 rr                lda (z80_ix),y
002AA3  3  85 rr                sta varp
002AA5  3  A5 rr                lda varo
002AA7  3  4A                   lsr a
002AA8  3  4A                   lsr a
002AA9  3  4A                   lsr a
002AAA  3  4A                   lsr a
002AAB  3  85 rr                sta varo
002AAD  3  A5 rr                lda varo
002AAF  3  85 rr                sta varq
002AB1  3  A5 rr                lda varq
002AB3  3  0A                   asl a
002AB4  3  0A                   asl a
002AB5  3  0A                   asl a
002AB6  3  0A                   asl a
002AB7  3  85 rr                sta varq
002AB9  3  A5 rr                lda varq
002ABB  3  85 rr                sta z80_c
002ABD  3  A5 rr                lda varp
002ABF  3  38                   sec
002AC0  3  E5 rr                sbc z80_c
002AC2  3  85 rr                sta varp
002AC4  3  A9 01                lda #1
002AC6  3  C5 rr                cmp varh
002AC8  3  F0 03                beq *+5
002ACA  3  4C EF 2A             jmp a00811
002ACD  3  A9 32                lda #<50
002ACF  3  85 rr                sta z80_l
002AD1  3  A9 00                lda #>50
002AD3  3  85 rr                sta z80_h
002AD5  3  20 0E 1D             jsr addsc
002AD8  3  A9 0A                lda #10
002ADA  3  85 rr                sta varo
002ADC  3  A9 02                lda #2
002ADE  3  85 rr                sta z80_c
002AE0  3  A0 08                ldy #8
002AE2  3  B1 rr                lda (z80_ix),y
002AE4  3  38                   sec
002AE5  3  E5 rr                sbc z80_c
002AE7  3  A0 08                ldy #8
002AE9  3  91 rr                sta (z80_ix),y
002AEB  3  A9 00                lda #0
002AED  3  85 rr                sta varh
002AEF  3  A9 08        a00811: lda #8
002AF1  3  C5 rr                cmp varp
002AF3  3  F0 03                beq *+5
002AF5  3  4C FC 2A             jmp a00836
002AF8  3  A9 00                lda #0
002AFA  3  85 rr                sta varp
002AFC  3  A9 08        a00836: lda #8
002AFE  3  C5 rr                cmp varo
002B00  3  F0 03                beq *+5
002B02  3  4C 09 2B             jmp a00861
002B05  3  A9 00                lda #0
002B07  3  85 rr                sta varo
002B09  3  A0 09        a00861: ldy #9
002B0B  3  B1 rr                lda (z80_ix),y
002B0D  3  C9 04                cmp #4
002B0F  3  90 03                bcc *+5
002B11  3  4C 1A 2B             jmp a00897
002B14  3  A9 F0                lda #240
002B16  3  A0 09                ldy #9
002B18  3  91 rr                sta (z80_ix),y
002B1A  3  A0 08        a00897: ldy #8
002B1C  3  B1 rr                lda (z80_ix),y
002B1E  3  C9 10                cmp #16
002B20  3  90 03                bcc *+5
002B22  3  4C 2F 2B             jmp a00940
002B25  3  A9 10                lda #16
002B27  3  A0 08                ldy #8
002B29  3  91 rr                sta (z80_ix),y
002B2B  3  A9 01                lda #1
002B2D  3  85 rr                sta varo
002B2F  3  A9 F0        a00940: lda #240
002B31  3  A0 09                ldy #9
002B33  3  D1 rr                cmp (z80_ix),y
002B35  3  90 03                bcc *+5
002B37  3  4C 40 2B             jmp a00976
002B3A  3  A9 04                lda #4
002B3C  3  A0 09                ldy #9
002B3E  3  91 rr                sta (z80_ix),y
002B40  3  A9 A0        a00976: lda #160
002B42  3  A0 08                ldy #8
002B44  3  D1 rr                cmp (z80_ix),y
002B46  3  90 03                bcc *+5
002B48  3  4C 4F 2B             jmp a01007
002B4B  3  A9 0C                lda #12
002B4D  3  85 rr                sta varo
002B4F  3  A5 rr        a01007: lda varo
002B51  3  C9 08                cmp #8
002B53  3  90 03                bcc *+5
002B55  3  4C AF 2B             jmp a01196
002B58  3  A9 00                lda #0
002B5A  3  C5 rr                cmp varo
002B5C  3  90 03                bcc *+5
002B5E  3  4C 74 2B             jmp a01080
002B61  3  20 0D 1F             jsr cangd
002B64  3  F0 03                beq :+
002B66  3  4C 74 2B             jmp a01080
002B69  3               :
002B69  3  A0 08                ldy #8
002B6B  3  B1 rr                lda (z80_ix),y
002B6D  3  18                   clc
002B6E  3  69 01                adc #1
002B70  3  A0 08                ldy #8
002B72  3  91 rr                sta (z80_ix),y
002B74  3  A9 01        a01080: lda #1
002B76  3  C5 rr                cmp varo
002B78  3  90 03                bcc *+5
002B7A  3  4C 90 2B             jmp a01136
002B7D  3  20 0D 1F             jsr cangd
002B80  3  F0 03                beq :+
002B82  3  4C 90 2B             jmp a01136
002B85  3               :
002B85  3  A0 08                ldy #8
002B87  3  B1 rr                lda (z80_ix),y
002B89  3  18                   clc
002B8A  3  69 01                adc #1
002B8C  3  A0 08                ldy #8
002B8E  3  91 rr                sta (z80_ix),y
002B90  3  A9 02        a01136: lda #2
002B92  3  C5 rr                cmp varo
002B94  3  90 03                bcc *+5
002B96  3  4C AC 2B             jmp a01192
002B99  3  20 0D 1F             jsr cangd
002B9C  3  F0 03                beq :+
002B9E  3  4C AC 2B             jmp a01192
002BA1  3               :
002BA1  3  A0 08                ldy #8
002BA3  3  B1 rr                lda (z80_ix),y
002BA5  3  18                   clc
002BA6  3  69 01                adc #1
002BA8  3  A0 08                ldy #8
002BAA  3  91 rr                sta (z80_ix),y
002BAC  3  4C 57 2C     a01192: jmp a01544
002BAF  3  A9 08        a01196: lda #8
002BB1  3  C5 rr                cmp varo
002BB3  3  90 03                bcc *+5
002BB5  3  4C F1 2B             jmp a01335
002BB8  3  A9 00                lda #0
002BBA  3  85 rr                sta varq
002BBC  3  A9 0F                lda #15
002BBE  3  A0 08                ldy #8
002BC0  3  D1 rr                cmp (z80_ix),y
002BC2  3  90 03                bcc *+5
002BC4  3  4C DA 2B             jmp a01286
002BC7  3  A9 10                lda #16
002BC9  3  85 rr                sta z80_c
002BCB  3  A0 08                ldy #8
002BCD  3  B1 rr                lda (z80_ix),y
002BCF  3  38                   sec
002BD0  3  E5 rr                sbc z80_c
002BD2  3  A0 08                ldy #8
002BD4  3  91 rr                sta (z80_ix),y
002BD6  3  A9 01                lda #1
002BD8  3  85 rr                sta varq
002BDA  3  20 D8 1E     a01286: jsr cangu
002BDD  3  F0 03                beq :+
002BDF  3  4C F1 2B             jmp a01335
002BE2  3               :
002BE2  3  A9 FF                lda #255
002BE4  3  85 rr                sta z80_c
002BE6  3  A0 08                ldy #8
002BE8  3  B1 rr                lda (z80_ix),y
002BEA  3  18                   clc
002BEB  3  65 rr                adc z80_c
002BED  3  A0 08                ldy #8
002BEF  3  91 rr                sta (z80_ix),y
002BF1  3  A9 09        a01335: lda #9
002BF3  3  C5 rr                cmp varo
002BF5  3  90 03                bcc *+5
002BF7  3  4C 18 2C             jmp a01413
002BFA  3  20 D8 1E             jsr cangu
002BFD  3  F0 03                beq :+
002BFF  3  4C 14 2C             jmp a01405
002C02  3               :
002C02  3  A9 FF                lda #255
002C04  3  85 rr                sta z80_c
002C06  3  A0 08                ldy #8
002C08  3  B1 rr                lda (z80_ix),y
002C0A  3  18                   clc
002C0B  3  65 rr                adc z80_c
002C0D  3  A0 08                ldy #8
002C0F  3  91 rr                sta (z80_ix),y
002C11  3  4C 18 2C             jmp a01413
002C14  3  A9 01        a01405: lda #1
002C16  3  85 rr                sta varo
002C18  3  A9 0A        a01413: lda #10
002C1A  3  C5 rr                cmp varo
002C1C  3  90 03                bcc *+5
002C1E  3  4C 3F 2C             jmp a01492
002C21  3  20 D8 1E             jsr cangu
002C24  3  F0 03                beq :+
002C26  3  4C 3B 2C             jmp a01484
002C29  3               :
002C29  3  A9 FF                lda #255
002C2B  3  85 rr                sta z80_c
002C2D  3  A0 08                ldy #8
002C2F  3  B1 rr                lda (z80_ix),y
002C31  3  18                   clc
002C32  3  65 rr                adc z80_c
002C34  3  A0 08                ldy #8
002C36  3  91 rr                sta (z80_ix),y
002C38  3  4C 3F 2C             jmp a01492
002C3B  3  A9 01        a01484: lda #1
002C3D  3  85 rr                sta varo
002C3F  3  A9 01        a01492: lda #1
002C41  3  C5 rr                cmp varq
002C43  3  F0 03                beq *+5
002C45  3  4C 57 2C             jmp a01544
002C48  3  A9 10                lda #16
002C4A  3  85 rr                sta z80_c
002C4C  3  A0 08                ldy #8
002C4E  3  B1 rr                lda (z80_ix),y
002C50  3  18                   clc
002C51  3  65 rr                adc z80_c
002C53  3  A0 08                ldy #8
002C55  3  91 rr                sta (z80_ix),y
002C57  3  A5 rr        a01544: lda varp
002C59  3  C9 08                cmp #8
002C5B  3  90 03                bcc *+5
002C5D  3  4C CC 2C             jmp a01772
002C60  3  A9 00                lda #0
002C62  3  C5 rr                cmp varp
002C64  3  90 03                bcc *+5
002C66  3  4C 83 2C             jmp a01629
002C69  3  20 54 1F             jsr cangr
002C6C  3  F0 03                beq :+
002C6E  3  4C 7F 2C             jmp a01621
002C71  3               :
002C71  3  A0 09                ldy #9
002C73  3  B1 rr                lda (z80_ix),y
002C75  3  18                   clc
002C76  3  69 01                adc #1
002C78  3  A0 09                ldy #9
002C7A  3  91 rr                sta (z80_ix),y
002C7C  3  4C 83 2C             jmp a01629
002C7F  3  A9 0A        a01621: lda #10
002C81  3  85 rr                sta varp
002C83  3  A9 01        a01629: lda #1
002C85  3  C5 rr                cmp varp
002C87  3  90 03                bcc *+5
002C89  3  4C A6 2C             jmp a01698
002C8C  3  20 54 1F             jsr cangr
002C8F  3  F0 03                beq :+
002C91  3  4C A2 2C             jmp a01690
002C94  3               :
002C94  3  A0 09                ldy #9
002C96  3  B1 rr                lda (z80_ix),y
002C98  3  18                   clc
002C99  3  69 01                adc #1
002C9B  3  A0 09                ldy #9
002C9D  3  91 rr                sta (z80_ix),y
002C9F  3  4C A6 2C             jmp a01698
002CA2  3  A9 0A        a01690: lda #10
002CA4  3  85 rr                sta varp
002CA6  3  A9 02        a01698: lda #2
002CA8  3  C5 rr                cmp varp
002CAA  3  90 03                bcc *+5
002CAC  3  4C C9 2C             jmp a01767
002CAF  3  20 54 1F             jsr cangr
002CB2  3  F0 03                beq :+
002CB4  3  4C C5 2C             jmp a01759
002CB7  3               :
002CB7  3  A0 09                ldy #9
002CB9  3  B1 rr                lda (z80_ix),y
002CBB  3  18                   clc
002CBC  3  69 01                adc #1
002CBE  3  A0 09                ldy #9
002CC0  3  91 rr                sta (z80_ix),y
002CC2  3  4C C9 2C             jmp a01767
002CC5  3  A9 0A        a01759: lda #10
002CC7  3  85 rr                sta varp
002CC9  3  4C 41 2D     a01767: jmp a02007
002CCC  3  A9 08        a01772: lda #8
002CCE  3  C5 rr                cmp varp
002CD0  3  90 03                bcc *+5
002CD2  3  4C F3 2C             jmp a01850
002CD5  3  20 42 1F             jsr cangl
002CD8  3  F0 03                beq :+
002CDA  3  4C EF 2C             jmp a01842
002CDD  3               :
002CDD  3  A9 FF                lda #255
002CDF  3  85 rr                sta z80_c
002CE1  3  A0 09                ldy #9
002CE3  3  B1 rr                lda (z80_ix),y
002CE5  3  18                   clc
002CE6  3  65 rr                adc z80_c
002CE8  3  A0 09                ldy #9
002CEA  3  91 rr                sta (z80_ix),y
002CEC  3  4C F3 2C             jmp a01850
002CEF  3  A9 02        a01842: lda #2
002CF1  3  85 rr                sta varp
002CF3  3  A9 09        a01850: lda #9
002CF5  3  C5 rr                cmp varp
002CF7  3  90 03                bcc *+5
002CF9  3  4C 1A 2D             jmp a01929
002CFC  3  20 42 1F             jsr cangl
002CFF  3  F0 03                beq :+
002D01  3  4C 16 2D             jmp a01921
002D04  3               :
002D04  3  A9 FF                lda #255
002D06  3  85 rr                sta z80_c
002D08  3  A0 09                ldy #9
002D0A  3  B1 rr                lda (z80_ix),y
002D0C  3  18                   clc
002D0D  3  65 rr                adc z80_c
002D0F  3  A0 09                ldy #9
002D11  3  91 rr                sta (z80_ix),y
002D13  3  4C 1A 2D             jmp a01929
002D16  3  A9 02        a01921: lda #2
002D18  3  85 rr                sta varp
002D1A  3  A9 0A        a01929: lda #10
002D1C  3  C5 rr                cmp varp
002D1E  3  90 03                bcc *+5
002D20  3  4C 41 2D             jmp a02007
002D23  3  20 42 1F             jsr cangl
002D26  3  F0 03                beq :+
002D28  3  4C 3D 2D             jmp a01999
002D2B  3               :
002D2B  3  A9 FF                lda #255
002D2D  3  85 rr                sta z80_c
002D2F  3  A0 09                ldy #9
002D31  3  B1 rr                lda (z80_ix),y
002D33  3  18                   clc
002D34  3  65 rr                adc z80_c
002D36  3  A0 09                ldy #9
002D38  3  91 rr                sta (z80_ix),y
002D3A  3  4C 41 2D             jmp a02007
002D3D  3  A9 02        a01999: lda #2
002D3F  3  85 rr                sta varp
002D41  3  A9 00        a02007: lda #0
002D43  3  C5 rr                cmp varp
002D45  3  90 03                bcc *+5
002D47  3  4C 9D 2D             jmp a02182
002D4A  3  20 0D 1F             jsr cangd
002D4D  3  F0 03                beq :+
002D4F  3  4C 55 2D             jmp a02042
002D52  3               :
002D52  3  4C 9D 2D             jmp a02182
002D55  3  A0 09        a02042: ldy #9
002D57  3  B1 rr                lda (z80_ix),y
002D59  3  C5 rr                cmp varb
002D5B  3  90 03                bcc *+5
002D5D  3  4C 60 2D             jmp a02065
002D60  3  A5 rr        a02065: lda varb
002D62  3  A0 09                ldy #9
002D64  3  D1 rr                cmp (z80_ix),y
002D66  3  90 03                bcc *+5
002D68  3  4C 6B 2D             jmp a02087
002D6B  3  A9 00        a02087: lda #0
002D6D  3  85 rr                sta varq
002D6F  3  A9 00                lda #0
002D71  3  C5 rr                cmp varc
002D73  3  F0 03                beq *+5
002D75  3  4C 7C 2D             jmp a02120
002D78  3  A9 01                lda #1
002D7A  3  85 rr                sta varq
002D7C  3  A9 02        a02120: lda #2
002D7E  3  C5 rr                cmp varc
002D80  3  F0 03                beq *+5
002D82  3  4C 89 2D             jmp a02145
002D85  3  A9 01                lda #1
002D87  3  85 rr                sta varq
002D89  3  A9 01        a02145: lda #1
002D8B  3  C5 rr                cmp varq
002D8D  3  F0 03                beq *+5
002D8F  3  4C 9D 2D             jmp a02182
002D92  3  A9 05                lda #5
002D94  3  0A                   asl a
002D95  3  8D 2E 0F             sta sndtyp
002D98  3  A9 00                lda #0
002D9A  3  20 00 25             jsr animsp
002D9D  3  A5 rr        a02182: lda joyval
002D9F  3  29 01                and #1
002DA1  3  F0 03                beq :+
002DA3  3  4C 4F 2E             jmp a02529
002DA6  3               :
002DA6  3  A9 08                lda #8
002DA8  3  C5 rr                cmp varp
002DAA  3  90 03                bcc *+5
002DAC  3  4C 09 2E             jmp a02395
002DAF  3  20 0D 1F             jsr cangd
002DB2  3  F0 03                beq :+
002DB4  3  4C C5 2D             jmp a02259
002DB7  3               :
002DB7  3  A9 FF                lda #255
002DB9  3  85 rr                sta z80_c
002DBB  3  A5 rr                lda varp
002DBD  3  18                   clc
002DBE  3  65 rr                adc z80_c
002DC0  3  85 rr                sta varp
002DC2  3  4C 06 2E             jmp a02391
002DC5  3  A5 rr        a02259: lda joyval
002DC7  3  29 02                and #2
002DC9  3  F0 03                beq :+
002DCB  3  4C D1 2D             jmp a02281
002DCE  3               :
002DCE  3  4C 06 2E             jmp a02391
002DD1  3  A9 03        a02281: lda #3
002DD3  3  A0 06                ldy #6
002DD5  3  91 rr                sta (z80_ix),y
002DD7  3  A9 01                lda #1
002DD9  3  A0 07                ldy #7
002DDB  3  91 rr                sta (z80_ix),y
002DDD  3  A9 02                lda #2
002DDF  3  C5 rr                cmp varc
002DE1  3  F0 03                beq *+5
002DE3  3  4C EC 2D             jmp a02337
002DE6  3  A9 0A                lda #10
002DE8  3  0A                   asl a
002DE9  3  8D 2E 0F             sta sndtyp
002DEC  3  A9 00        a02337: lda #0
002DEE  3  C5 rr                cmp varc
002DF0  3  F0 03                beq *+5
002DF2  3  4C 06 2E             jmp a02391
002DF5  3  A9 0A                lda #10
002DF7  3  0A                   asl a
002DF8  3  8D 2E 0F             sta sndtyp
002DFB  3  A9 FF                lda #255
002DFD  3  85 rr                sta z80_c
002DFF  3  A5 rr                lda varp
002E01  3  18                   clc
002E02  3  65 rr                adc z80_c
002E04  3  85 rr                sta varp
002E06  3  4C 0F 2E     a02391: jmp a02409
002E09  3  A9 00        a02395: lda #0
002E0B  3  A0 06                ldy #6
002E0D  3  91 rr                sta (z80_ix),y
002E0F  3  A5 rr        a02409: lda varp
002E11  3  C9 03                cmp #3
002E13  3  90 03                bcc *+5
002E15  3  4C 4C 2E             jmp a02524
002E18  3  A9 00                lda #0
002E1A  3  C5 rr                cmp varp
002E1C  3  F0 03                beq *+5
002E1E  3  4C 3C 2E             jmp a02492
002E21  3  A9 00                lda #0
002E23  3  C5 rr                cmp varc
002E25  3  F0 03                beq *+5
002E27  3  4C 34 2E             jmp a02479
002E2A  3  A5 rr                lda varp
002E2C  3  18                   clc
002E2D  3  69 01                adc #1
002E2F  3  85 rr                sta varp
002E31  3  4C 39 2E             jmp a02487
002E34  3  A9 00        a02479: lda #0
002E36  3  20 00 25             jsr animsp
002E39  3  4C 4C 2E     a02487: jmp a02524
002E3C  3  A9 00        a02492: lda #0
002E3E  3  C5 rr                cmp varc
002E40  3  F0 03                beq *+5
002E42  3  4C 4C 2E             jmp a02524
002E45  3  A5 rr                lda varp
002E47  3  18                   clc
002E48  3  69 01                adc #1
002E4A  3  85 rr                sta varp
002E4C  3  4C B5 2E     a02524: jmp a02731
002E4F  3  A5 rr        a02529: lda joyval
002E51  3  29 02                and #2
002E53  3  F0 03                beq :+
002E55  3  4C 5B 2E             jmp a02551
002E58  3               :
002E58  3  4C B5 2E             jmp a02731
002E5B  3  A9 00        a02551: lda #0
002E5D  3  C5 rr                cmp varp
002E5F  3  90 03                bcc *+5
002E61  3  4C B5 2E             jmp a02731
002E64  3  20 0D 1F             jsr cangd
002E67  3  F0 03                beq :+
002E69  3  4C 6F 2E             jmp a02586
002E6C  3               :
002E6C  3  4C B5 2E             jmp a02731
002E6F  3  A9 00        a02586: lda #0
002E71  3  C5 rr                cmp varc
002E73  3  F0 03                beq *+5
002E75  3  4C 89 2E             jmp a02640
002E78  3  A9 0A                lda #10
002E7A  3  0A                   asl a
002E7B  3  8D 2E 0F             sta sndtyp
002E7E  3  A9 FF                lda #255
002E80  3  85 rr                sta z80_c
002E82  3  A5 rr                lda varp
002E84  3  18                   clc
002E85  3  65 rr                adc z80_c
002E87  3  85 rr                sta varp
002E89  3  A9 02        a02640: lda #2
002E8B  3  C5 rr                cmp varc
002E8D  3  F0 03                beq *+5
002E8F  3  4C 98 2E             jmp a02669
002E92  3  A9 0A                lda #10
002E94  3  0A                   asl a
002E95  3  8D 2E 0F             sta sndtyp
002E98  3  A9 02        a02669: lda #2
002E9A  3  A0 06                ldy #6
002E9C  3  91 rr                sta (z80_ix),y
002E9E  3  A9 01                lda #1
002EA0  3  A0 07                ldy #7
002EA2  3  91 rr                sta (z80_ix),y
002EA4  3  A0 09                ldy #9
002EA6  3  B1 rr                lda (z80_ix),y
002EA8  3  C5 rr                cmp varb
002EAA  3  90 03                bcc *+5
002EAC  3  4C B5 2E             jmp a02731
002EAF  3  A9 03                lda #3
002EB1  3  A0 06                ldy #6
002EB3  3  91 rr                sta (z80_ix),y
002EB5  3  A5 rr        a02731: lda joyval
002EB7  3  29 02                and #2
002EB9  3  F0 03                beq :+
002EBB  3  4C 6B 2F             jmp a03087
002EBE  3               :
002EBE  3  A9 08                lda #8
002EC0  3  C5 rr                cmp varp
002EC2  3  90 03                bcc *+5
002EC4  3  4C D7 2E             jmp a02797
002EC7  3  A9 00                lda #0
002EC9  3  C5 rr                cmp varc
002ECB  3  F0 03                beq *+5
002ECD  3  4C D7 2E             jmp a02797
002ED0  3  A5 rr                lda varp
002ED2  3  18                   clc
002ED3  3  69 01                adc #1
002ED5  3  85 rr                sta varp
002ED7  3  A9 0B        a02797: lda #11
002ED9  3  C5 rr                cmp varp
002EDB  3  90 03                bcc *+5
002EDD  3  4C E4 2E             jmp a02823
002EE0  3  A9 0B                lda #11
002EE2  3  85 rr                sta varp
002EE4  3  A9 00        a02823: lda #0
002EE6  3  C5 rr                cmp varp
002EE8  3  F0 03                beq *+5
002EEA  3  4C 02 2F             jmp a02877
002EED  3  A9 00                lda #0
002EEF  3  C5 rr                cmp varc
002EF1  3  F0 03                beq *+5
002EF3  3  4C FD 2E             jmp a02869
002EF6  3  A9 09                lda #9
002EF8  3  85 rr                sta varp
002EFA  3  4C 02 2F             jmp a02877
002EFD  3  A9 00        a02869: lda #0
002EFF  3  20 00 25             jsr animsp
002F02  3  A5 rr        a02877: lda varp
002F04  3  C9 05                cmp #5
002F06  3  90 03                bcc *+5
002F08  3  4C 65 2F             jmp a03073
002F0B  3  20 0D 1F             jsr cangd
002F0E  3  F0 03                beq :+
002F10  3  4C 21 2F             jmp a02937
002F13  3               :
002F13  3  A9 FF                lda #255
002F15  3  85 rr                sta z80_c
002F17  3  A5 rr                lda varp
002F19  3  18                   clc
002F1A  3  65 rr                adc z80_c
002F1C  3  85 rr                sta varp
002F1E  3  4C 62 2F             jmp a03069
002F21  3  A5 rr        a02937: lda joyval
002F23  3  29 01                and #1
002F25  3  F0 03                beq :+
002F27  3  4C 2D 2F             jmp a02959
002F2A  3               :
002F2A  3  4C 62 2F             jmp a03069
002F2D  3  A9 02        a02959: lda #2
002F2F  3  A0 06                ldy #6
002F31  3  91 rr                sta (z80_ix),y
002F33  3  A9 01                lda #1
002F35  3  A0 07                ldy #7
002F37  3  91 rr                sta (z80_ix),y
002F39  3  A9 02                lda #2
002F3B  3  C5 rr                cmp varc
002F3D  3  F0 03                beq *+5
002F3F  3  4C 48 2F             jmp a03015
002F42  3  A9 0A                lda #10
002F44  3  0A                   asl a
002F45  3  8D 2E 0F             sta sndtyp
002F48  3  A9 00        a03015: lda #0
002F4A  3  C5 rr                cmp varc
002F4C  3  F0 03                beq *+5
002F4E  3  4C 62 2F             jmp a03069
002F51  3  A9 0A                lda #10
002F53  3  0A                   asl a
002F54  3  8D 2E 0F             sta sndtyp
002F57  3  A9 FF                lda #255
002F59  3  85 rr                sta z80_c
002F5B  3  A5 rr                lda varp
002F5D  3  18                   clc
002F5E  3  65 rr                adc z80_c
002F60  3  85 rr                sta varp
002F62  3  4C 6B 2F     a03069: jmp a03087
002F65  3  A9 01        a03073: lda #1
002F67  3  A0 06                ldy #6
002F69  3  91 rr                sta (z80_ix),y
002F6B  3  A5 rr        a03087: lda joyval
002F6D  3  29 10                and #16
002F6F  3  F0 03                beq :+
002F71  3  4C B5 2F             jmp a03235
002F74  3               :
002F74  3  A9 00                lda #0
002F76  3  A0 0C                ldy #12
002F78  3  D1 rr                cmp (z80_ix),y
002F7A  3  F0 03                beq *+5
002F7C  3  4C AF 2F             jmp a03222
002F7F  3  A9 0A                lda #10
002F81  3  0A                   asl a
002F82  3  8D 2E 0F             sta sndtyp
002F85  3  A9 09                lda #9
002F87  3  C5 rr                cmp varo
002F89  3  90 03                bcc *+5
002F8B  3  4C A2 2F             jmp a03197
002F8E  3  A5 rr                lda varo
002F90  3  C9 0D                cmp #13
002F92  3  90 03                bcc *+5
002F94  3  4C A2 2F             jmp a03197
002F97  3  A9 02                lda #2
002F99  3  85 rr                sta z80_c
002F9B  3  A5 rr                lda varo
002F9D  3  18                   clc
002F9E  3  65 rr                adc z80_c
002FA0  3  85 rr                sta varo
002FA2  3  A5 rr        a03197: lda varo
002FA4  3  C9 05                cmp #5
002FA6  3  90 03                bcc *+5
002FA8  3  4C AF 2F             jmp a03222
002FAB  3  A9 0B                lda #11
002FAD  3  85 rr                sta varo
002FAF  3  A9 02        a03222: lda #2
002FB1  3  A0 0C                ldy #12
002FB3  3  91 rr                sta (z80_ix),y
002FB5  3  A9 00        a03235: lda #0
002FB7  3  85 rr                sta chary
002FB9  3  A9 00                lda #0
002FBB  3  85 rr                sta charx
002FBD  3  A9 00                lda #0
002FBF  3  A0 0C                ldy #12
002FC1  3  D1 rr                cmp (z80_ix),y
002FC3  3  90 03                bcc *+5
002FC5  3  4C EE 2F             jmp a03355
002FC8  3  A5 rr                lda joyval
002FCA  3  29 10                and #16
002FCC  3  F0 03                beq :+
002FCE  3  4C D4 2F             jmp a03297
002FD1  3               :
002FD1  3  4C EE 2F             jmp a03355
002FD4  3  A0 0C        a03297: ldy #12
002FD6  3  B1 rr                lda (z80_ix),y
002FD8  3  C9 07                cmp #7
002FDA  3  90 03                bcc *+5
002FDC  3  4C EE 2F             jmp a03355
002FDF  3  A9 FF                lda #255
002FE1  3  85 rr                sta z80_c
002FE3  3  A0 0C                ldy #12
002FE5  3  B1 rr                lda (z80_ix),y
002FE7  3  18                   clc
002FE8  3  65 rr                adc z80_c
002FEA  3  A0 0C                ldy #12
002FEC  3  91 rr                sta (z80_ix),y
002FEE  3  20 0D 1F     a03355: jsr cangd
002FF1  3  F0 03                beq :+
002FF3  3  4C 85 30             jmp a03663
002FF6  3               :
002FF6  3  A0 06                ldy #6
002FF8  3  B1 rr                lda (z80_ix),y
002FFA  3  C9 02                cmp #2
002FFC  3  90 03                bcc *+5
002FFE  3  4C 10 30             jmp a03425
003001  3  A9 02                lda #2
003003  3  85 rr                sta z80_c
003005  3  A0 06                ldy #6
003007  3  B1 rr                lda (z80_ix),y
003009  3  18                   clc
00300A  3  65 rr                adc z80_c
00300C  3  A0 06                ldy #6
00300E  3  91 rr                sta (z80_ix),y
003010  3  A5 rr        a03425: lda joyval
003012  3  29 10                and #16
003014  3  F0 03                beq :+
003016  3  4C 4F 30             jmp a03554
003019  3               :
003019  3  A0 07                ldy #7
00301B  3  B1 rr                lda (z80_ix),y
00301D  3  C9 02                cmp #2
00301F  3  90 03                bcc *+5
003021  3  4C 4C 30             jmp a03550
003024  3  A9 00                lda #0
003026  3  C5 rr                cmp varc
003028  3  F0 03                beq *+5
00302A  3  4C 38 30             jmp a03507
00302D  3  A0 07                ldy #7
00302F  3  B1 rr                lda (z80_ix),y
003031  3  18                   clc
003032  3  69 01                adc #1
003034  3  A0 07                ldy #7
003036  3  91 rr                sta (z80_ix),y
003038  3  A9 02        a03507: lda #2
00303A  3  C5 rr                cmp varc
00303C  3  F0 03                beq *+5
00303E  3  4C 4C 30             jmp a03550
003041  3  A0 07                ldy #7
003043  3  B1 rr                lda (z80_ix),y
003045  3  18                   clc
003046  3  69 01                adc #1
003048  3  A0 07                ldy #7
00304A  3  91 rr                sta (z80_ix),y
00304C  3  4C 55 30     a03550: jmp a03568
00304F  3  A9 00        a03554: lda #0
003051  3  A0 07                ldy #7
003053  3  91 rr                sta (z80_ix),y
003055  3  A9 00        a03568: lda #0
003057  3  C5 rr                cmp varc
003059  3  F0 03                beq *+5
00305B  3  4C 82 30             jmp a03658
00305E  3  A9 08                lda #8
003060  3  C5 rr                cmp varo
003062  3  90 03                bcc *+5
003064  3  4C 72 30             jmp a03626
003067  3  A9 FF                lda #255
003069  3  85 rr                sta z80_c
00306B  3  A5 rr                lda varo
00306D  3  18                   clc
00306E  3  65 rr                adc z80_c
003070  3  85 rr                sta varo
003072  3  A5 rr        a03626: lda varo
003074  3  C9 04                cmp #4
003076  3  90 03                bcc *+5
003078  3  4C 82 30             jmp a03658
00307B  3  A5 rr                lda varo
00307D  3  18                   clc
00307E  3  69 01                adc #1
003080  3  85 rr                sta varo
003082  3  4C DA 30     a03658: jmp a03842
003085  3  A9 00        a03663: lda #0
003087  3  A0 0C                ldy #12
003089  3  D1 rr                cmp (z80_ix),y
00308B  3  F0 03                beq *+5
00308D  3  4C 94 30             jmp a03693
003090  3  A9 00                lda #0
003092  3  85 rr                sta varo
003094  3  A9 00        a03693: lda #0
003096  3  C5 rr                cmp varp
003098  3  F0 03                beq *+5
00309A  3  4C DA 30             jmp a03842
00309D  3  A9 01                lda #1
00309F  3  A0 06                ldy #6
0030A1  3  D1 rr                cmp (z80_ix),y
0030A3  3  90 03                bcc *+5
0030A5  3  4C C0 30             jmp a03784
0030A8  3  A9 02                lda #2
0030AA  3  85 rr                sta z80_c
0030AC  3  A0 06                ldy #6
0030AE  3  B1 rr                lda (z80_ix),y
0030B0  3  38                   sec
0030B1  3  E5 rr                sbc z80_c
0030B3  3  A0 06                ldy #6
0030B5  3  91 rr                sta (z80_ix),y
0030B7  3  A9 00                lda #0
0030B9  3  A0 07                ldy #7
0030BB  3  91 rr                sta (z80_ix),y
0030BD  3  4C DA 30             jmp a03842
0030C0  3  A9 01        a03784: lda #1
0030C2  3  A0 06                ldy #6
0030C4  3  D1 rr                cmp (z80_ix),y
0030C6  3  90 03                bcc *+5
0030C8  3  4C DA 30             jmp a03842
0030CB  3  A9 FE                lda #254
0030CD  3  85 rr                sta z80_c
0030CF  3  A0 06                ldy #6
0030D1  3  B1 rr                lda (z80_ix),y
0030D3  3  18                   clc
0030D4  3  65 rr                adc z80_c
0030D6  3  A0 06                ldy #6
0030D8  3  91 rr                sta (z80_ix),y
0030DA  3  A5 rr        a03842: lda varo
0030DC  3  0A                   asl a
0030DD  3  0A                   asl a
0030DE  3  0A                   asl a
0030DF  3  0A                   asl a
0030E0  3  85 rr                sta varo
0030E2  3  A5 rr                lda varp
0030E4  3  85 rr                sta z80_c
0030E6  3  A5 rr                lda varo
0030E8  3  18                   clc
0030E9  3  65 rr                adc z80_c
0030EB  3  85 rr                sta varo
0030ED  3  A5 rr                lda varo
0030EF  3  A0 0A                ldy #10
0030F1  3  91 rr                sta (z80_ix),y
0030F3  3  A0 08                ldy #8
0030F5  3  B1 rr                lda (z80_ix),y
0030F7  3  85 rr                sta vara
0030F9  3  A0 09                ldy #9
0030FB  3  B1 rr                lda (z80_ix),y
0030FD  3  85 rr                sta varb
0030FF  3  A9 01        a03930: lda #1
003101  3  C5 rr                cmp vare
003103  3  F0 03                beq *+5
003105  3  4C 31 31             jmp a04039
003108  3  A9 0F                lda #15
00310A  3  A0 08                ldy #8
00310C  3  D1 rr                cmp (z80_ix),y
00310E  3  90 03                bcc *+5
003110  3  4C 31 31             jmp a04039
003113  3  A9 10                lda #16
003115  3  85 rr                sta z80_c
003117  3  A0 08                ldy #8
003119  3  B1 rr                lda (z80_ix),y
00311B  3  38                   sec
00311C  3  E5 rr                sbc z80_c
00311E  3  A0 08                ldy #8
003120  3  91 rr                sta (z80_ix),y
003122  3  A9 10                lda #16
003124  3  85 rr                sta z80_c
003126  3  A0 08                ldy #8
003128  3  B1 rr                lda (z80_ix),y
00312A  3  18                   clc
00312B  3  65 rr                adc z80_c
00312D  3  A0 08                ldy #8
00312F  3  91 rr                sta (z80_ix),y
003131  3  60           a04039: rts
003132  3               .out .sprintf("EVENT 0 SIZE = %d", (* - evnt00))
003132  3               
003132  3               evnt01:
003132  3  A0 0A                ldy #10
003134  3  B1 rr                lda (z80_ix),y
003136  3  85 rr                sta varo
003138  3  A0 0A                ldy #10
00313A  3  B1 rr                lda (z80_ix),y
00313C  3  85 rr                sta varrnd
00313E  3  A5 rr                lda varrnd
003140  3  4A                   lsr a
003141  3  85 rr                sta varrnd
003143  3  A5 rr                lda varrnd
003145  3  85 rr                sta varp
003147  3  A5 rr                lda varrnd
003149  3  0A                   asl a
00314A  3  85 rr                sta varrnd
00314C  3  A5 rr                lda varrnd
00314E  3  85 rr                sta z80_c
003150  3  A5 rr                lda varo
003152  3  38                   sec
003153  3  E5 rr                sbc z80_c
003155  3  85 rr                sta varo
003157  3  A5 rr                lda varp
003159  3  85 rr                sta varrnd
00315B  3  A5 rr                lda varrnd
00315D  3  4A                   lsr a
00315E  3  85 rr                sta varrnd
003160  3  A5 rr                lda varrnd
003162  3  0A                   asl a
003163  3  85 rr                sta varrnd
003165  3  A5 rr                lda varrnd
003167  3  85 rr                sta z80_c
003169  3  A5 rr                lda varp
00316B  3  38                   sec
00316C  3  E5 rr                sbc z80_c
00316E  3  85 rr                sta varp
003170  3  A5 rr                lda varrnd
003172  3  4A                   lsr a
003173  3  85 rr                sta varrnd
003175  3  A5 rr                lda varrnd
003177  3  A0 0A                ldy #10
003179  3  91 rr                sta (z80_ix),y
00317B  3  A9 00                lda #0
00317D  3  85 rr                sta varrnd
00317F  3  A9 00                lda #0
003181  3  85 rr                sta z80_b
003183  3  20 4B 25             jsr sktyp
003186  3  B0 03                bcs :+
003188  3  4C 9A 31             jmp b00239
00318B  3               :
00318B  3  A5 rr                lda vara
00318D  3  A0 08                ldy #8
00318F  3  D1 rr                cmp (z80_ix),y
003191  3  90 03                bcc *+5
003193  3  4C 9A 31             jmp b00239
003196  3  A9 01                lda #1
003198  3  85 rr                sta varrnd
00319A  3  A9 10        b00239: lda #16
00319C  3  85 rr                sta z80_c
00319E  3  A0 08                ldy #8
0031A0  3  B1 rr                lda (z80_ix),y
0031A2  3  38                   sec
0031A3  3  E5 rr                sbc z80_c
0031A5  3  A0 08                ldy #8
0031A7  3  91 rr                sta (z80_ix),y
0031A9  3  A9 00                lda #0
0031AB  3  85 rr                sta z80_b
0031AD  3  20 4B 25             jsr sktyp
0031B0  3  B0 03                bcs :+
0031B2  3  4C C4 31             jmp b00327
0031B5  3               :
0031B5  3  A5 rr                lda vara
0031B7  3  A0 08                ldy #8
0031B9  3  D1 rr                cmp (z80_ix),y
0031BB  3  90 03                bcc *+5
0031BD  3  4C C4 31             jmp b00327
0031C0  3  A9 01                lda #1
0031C2  3  85 rr                sta varrnd
0031C4  3  A9 10        b00327: lda #16
0031C6  3  85 rr                sta z80_c
0031C8  3  A0 08                ldy #8
0031CA  3  B1 rr                lda (z80_ix),y
0031CC  3  18                   clc
0031CD  3  65 rr                adc z80_c
0031CF  3  A0 08                ldy #8
0031D1  3  91 rr                sta (z80_ix),y
0031D3  3  A9 01                lda #1
0031D5  3  C5 rr                cmp varrnd
0031D7  3  F0 03                beq *+5
0031D9  3  4C 1B 32             jmp b00525
0031DC  3  A9 04                lda #4
0031DE  3  85 rr                sta z80_c
0031E0  3  A0 0A                ldy #10
0031E2  3  B1 rr                lda (z80_ix),y
0031E4  3  18                   clc
0031E5  3  65 rr                adc z80_c
0031E7  3  A0 0A                ldy #10
0031E9  3  91 rr                sta (z80_ix),y
0031EB  3  A0 0A                ldy #10
0031ED  3  B1 rr                lda (z80_ix),y
0031EF  3  20 18 1B             jsr getob
0031F2  3  A9 04                lda #4
0031F4  3  85 rr                sta z80_c
0031F6  3  A0 0A                ldy #10
0031F8  3  B1 rr                lda (z80_ix),y
0031FA  3  38                   sec
0031FB  3  E5 rr                sbc z80_c
0031FD  3  A0 0A                ldy #10
0031FF  3  91 rr                sta (z80_ix),y
003201  3  A9 01                lda #1
003203  3  85 rr                sta varh
003205  3  A9 14                lda #20
003207  3  A0 0C                ldy #12
003209  3  91 rr                sta (z80_ix),y
00320B  3  A0 0A                ldy #10
00320D  3  B1 rr                lda (z80_ix),y
00320F  3  0A                   asl a
003210  3  A0 0A                ldy #10
003212  3  91 rr                sta (z80_ix),y
003214  3  A9 02                lda #2
003216  3  A0 05                ldy #5
003218  3  91 rr                sta (z80_ix),y
00321A  3  60                   rts
00321B  3  A9 14        b00525: lda #20
00321D  3  85 rr                sta z80_c
00321F  3  A0 08                ldy #8
003221  3  B1 rr                lda (z80_ix),y
003223  3  38                   sec
003224  3  E5 rr                sbc z80_c
003226  3  A0 08                ldy #8
003228  3  91 rr                sta (z80_ix),y
00322A  3  20 D8 1E             jsr cangu
00322D  3  F0 03                beq :+
00322F  3  4C 90 32             jmp b00757
003232  3               :
003232  3  A9 14                lda #20
003234  3  85 rr                sta z80_d
003236  3  20 44 21             jsr random
003239  3  85 rr                sta z80_h
00323B  3  20 86 1A             jsr imul
00323E  3  A5 rr                lda z80_h
003240  3  85 rr                sta varrnd
003242  3  A9 00                lda #0
003244  3  C5 rr                cmp varrnd
003246  3  F0 03                beq *+5
003248  3  4C 61 32             jmp b00665
00324B  3  A0 08                ldy #8
00324D  3  B1 rr                lda (z80_ix),y
00324F  3  C5 rr                cmp vara
003251  3  90 03                bcc *+5
003253  3  4C 5D 32             jmp b00657
003256  3  A9 00                lda #0
003258  3  85 rr                sta varp
00325A  3  4C 61 32             jmp b00665
00325D  3  A9 01        b00657: lda #1
00325F  3  85 rr                sta varp
003261  3  A9 14        b00665: lda #20
003263  3  85 rr                sta z80_d
003265  3  20 44 21             jsr random
003268  3  85 rr                sta z80_h
00326A  3  20 86 1A             jsr imul
00326D  3  A5 rr                lda z80_h
00326F  3  85 rr                sta varrnd
003271  3  A9 00                lda #0
003273  3  C5 rr                cmp varrnd
003275  3  F0 03                beq *+5
003277  3  4C 90 32             jmp b00757
00327A  3  A0 09                ldy #9
00327C  3  B1 rr                lda (z80_ix),y
00327E  3  C5 rr                cmp varb
003280  3  90 03                bcc *+5
003282  3  4C 8C 32             jmp b00749
003285  3  A9 00                lda #0
003287  3  85 rr                sta varo
003289  3  4C 90 32             jmp b00757
00328C  3  A9 01        b00749: lda #1
00328E  3  85 rr                sta varo
003290  3  A9 14        b00757: lda #20
003292  3  85 rr                sta z80_c
003294  3  A0 08                ldy #8
003296  3  B1 rr                lda (z80_ix),y
003298  3  18                   clc
003299  3  65 rr                adc z80_c
00329B  3  A0 08                ldy #8
00329D  3  91 rr                sta (z80_ix),y
00329F  3  A9 00                lda #0
0032A1  3  C5 rr                cmp varo
0032A3  3  F0 03                beq *+5
0032A5  3  4C F3 32             jmp b00965
0032A8  3  A9 10                lda #16
0032AA  3  85 rr                sta z80_c
0032AC  3  A0 09                ldy #9
0032AE  3  B1 rr                lda (z80_ix),y
0032B0  3  18                   clc
0032B1  3  65 rr                adc z80_c
0032B3  3  A0 09                ldy #9
0032B5  3  91 rr                sta (z80_ix),y
0032B7  3  A9 01                lda #1
0032B9  3  85 rr                sta z80_b
0032BB  3  20 4B 25             jsr sktyp
0032BE  3  B0 03                bcs :+
0032C0  3  4C C7 32             jmp b00874
0032C3  3               :
0032C3  3  A9 01                lda #1
0032C5  3  85 rr                sta varo
0032C7  3  A9 10        b00874: lda #16
0032C9  3  85 rr                sta z80_c
0032CB  3  A0 09                ldy #9
0032CD  3  B1 rr                lda (z80_ix),y
0032CF  3  38                   sec
0032D0  3  E5 rr                sbc z80_c
0032D2  3  A0 09                ldy #9
0032D4  3  91 rr                sta (z80_ix),y
0032D6  3  20 54 1F             jsr cangr
0032D9  3  F0 03                beq :+
0032DB  3  4C EC 32             jmp b00953
0032DE  3               :
0032DE  3  A0 09                ldy #9
0032E0  3  B1 rr                lda (z80_ix),y
0032E2  3  18                   clc
0032E3  3  69 01                adc #1
0032E5  3  A0 09                ldy #9
0032E7  3  91 rr                sta (z80_ix),y
0032E9  3  4C F0 32             jmp b00961
0032EC  3  A9 01        b00953: lda #1
0032EE  3  85 rr                sta varo
0032F0  3  4C 3B 33     b00961: jmp b01117
0032F3  3  A9 10        b00965: lda #16
0032F5  3  85 rr                sta z80_c
0032F7  3  A0 09                ldy #9
0032F9  3  B1 rr                lda (z80_ix),y
0032FB  3  38                   sec
0032FC  3  E5 rr                sbc z80_c
0032FE  3  A0 09                ldy #9
003300  3  91 rr                sta (z80_ix),y
003302  3  A9 01                lda #1
003304  3  85 rr                sta z80_b
003306  3  20 4B 25             jsr sktyp
003309  3  B0 03                bcs :+
00330B  3  4C 12 33             jmp b01030
00330E  3               :
00330E  3  A9 00                lda #0
003310  3  85 rr                sta varo
003312  3  A9 10        b01030: lda #16
003314  3  85 rr                sta z80_c
003316  3  A0 09                ldy #9
003318  3  B1 rr                lda (z80_ix),y
00331A  3  18                   clc
00331B  3  65 rr                adc z80_c
00331D  3  A0 09                ldy #9
00331F  3  91 rr                sta (z80_ix),y
003321  3  20 42 1F             jsr cangl
003324  3  F0 03                beq :+
003326  3  4C 37 33             jmp b01109
003329  3               :
003329  3  A0 09                ldy #9
00332B  3  B1 rr                lda (z80_ix),y
00332D  3  38                   sec
00332E  3  E9 01                sbc #1
003330  3  A0 09                ldy #9
003332  3  91 rr                sta (z80_ix),y
003334  3  4C 3B 33             jmp b01117
003337  3  A9 00        b01109: lda #0
003339  3  85 rr                sta varo
00333B  3  A9 00        b01117: lda #0
00333D  3  C5 rr                cmp varp
00333F  3  F0 03                beq *+5
003341  3  4C B2 33             jmp b01360
003344  3  A9 10                lda #16
003346  3  85 rr                sta z80_c
003348  3  A0 08                ldy #8
00334A  3  B1 rr                lda (z80_ix),y
00334C  3  18                   clc
00334D  3  65 rr                adc z80_c
00334F  3  A0 08                ldy #8
003351  3  91 rr                sta (z80_ix),y
003353  3  A9 01                lda #1
003355  3  85 rr                sta z80_b
003357  3  20 4B 25             jsr sktyp
00335A  3  B0 03                bcs :+
00335C  3  4C 63 33             jmp b01199
00335F  3               :
00335F  3  A9 01                lda #1
003361  3  85 rr                sta varp
003363  3  A9 10        b01199: lda #16
003365  3  85 rr                sta z80_c
003367  3  A0 08                ldy #8
003369  3  B1 rr                lda (z80_ix),y
00336B  3  38                   sec
00336C  3  E5 rr                sbc z80_c
00336E  3  A0 08                ldy #8
003370  3  91 rr                sta (z80_ix),y
003372  3  A9 01                lda #1
003374  3  85 rr                sta varrnd
003376  3  20 0D 1F             jsr cangd
003379  3  F0 03                beq :+
00337B  3  4C 81 33             jmp b01260
00337E  3               :
00337E  3  4C 85 33             jmp b01269
003381  3  A9 00        b01260: lda #0
003383  3  85 rr                sta varrnd
003385  3  A9 8C        b01269: lda #140
003387  3  A0 08                ldy #8
003389  3  D1 rr                cmp (z80_ix),y
00338B  3  90 03                bcc *+5
00338D  3  4C 94 33             jmp b01300
003390  3  A9 00                lda #0
003392  3  85 rr                sta varrnd
003394  3  A9 01        b01300: lda #1
003396  3  C5 rr                cmp varrnd
003398  3  F0 03                beq *+5
00339A  3  4C AB 33             jmp b01348
00339D  3  A0 08                ldy #8
00339F  3  B1 rr                lda (z80_ix),y
0033A1  3  18                   clc
0033A2  3  69 01                adc #1
0033A4  3  A0 08                ldy #8
0033A6  3  91 rr                sta (z80_ix),y
0033A8  3  4C AF 33             jmp b01356
0033AB  3  A9 01        b01348: lda #1
0033AD  3  85 rr                sta varp
0033AF  3  4C 1D 34     b01356: jmp b01582
0033B2  3  A9 10        b01360: lda #16
0033B4  3  85 rr                sta z80_c
0033B6  3  A0 08                ldy #8
0033B8  3  B1 rr                lda (z80_ix),y
0033BA  3  38                   sec
0033BB  3  E5 rr                sbc z80_c
0033BD  3  A0 08                ldy #8
0033BF  3  91 rr                sta (z80_ix),y
0033C1  3  A9 01                lda #1
0033C3  3  85 rr                sta z80_b
0033C5  3  20 4B 25             jsr sktyp
0033C8  3  B0 03                bcs :+
0033CA  3  4C D1 33             jmp b01425
0033CD  3               :
0033CD  3  A9 00                lda #0
0033CF  3  85 rr                sta varp
0033D1  3  A9 01        b01425: lda #1
0033D3  3  85 rr                sta varrnd
0033D5  3  20 D8 1E             jsr cangu
0033D8  3  F0 03                beq :+
0033DA  3  4C E0 33             jmp b01452
0033DD  3               :
0033DD  3  4C E4 33             jmp b01460
0033E0  3  A9 00        b01452: lda #0
0033E2  3  85 rr                sta varrnd
0033E4  3  A9 10        b01460: lda #16
0033E6  3  85 rr                sta z80_c
0033E8  3  A0 08                ldy #8
0033EA  3  B1 rr                lda (z80_ix),y
0033EC  3  18                   clc
0033ED  3  65 rr                adc z80_c
0033EF  3  A0 08                ldy #8
0033F1  3  91 rr                sta (z80_ix),y
0033F3  3  A9 00                lda #0
0033F5  3  A0 08                ldy #8
0033F7  3  D1 rr                cmp (z80_ix),y
0033F9  3  F0 03                beq *+5
0033FB  3  4C 02 34             jmp b01526
0033FE  3  A9 00                lda #0
003400  3  85 rr                sta varrnd
003402  3  A9 01        b01526: lda #1
003404  3  C5 rr                cmp varrnd
003406  3  F0 03                beq *+5
003408  3  4C 19 34             jmp b01574
00340B  3  A0 08                ldy #8
00340D  3  B1 rr                lda (z80_ix),y
00340F  3  38                   sec
003410  3  E9 01                sbc #1
003412  3  A0 08                ldy #8
003414  3  91 rr                sta (z80_ix),y
003416  3  4C 1D 34             jmp b01582
003419  3  A9 00        b01574: lda #0
00341B  3  85 rr                sta varp
00341D  3  A9 00        b01582: lda #0
00341F  3  C5 rr                cmp varo
003421  3  F0 03                beq *+5
003423  3  4C 2F 34             jmp b01616
003426  3  A9 07                lda #7
003428  3  A0 06                ldy #6
00342A  3  91 rr                sta (z80_ix),y
00342C  3  4C 35 34             jmp b01630
00342F  3  A9 06        b01616: lda #6
003431  3  A0 06                ldy #6
003433  3  91 rr                sta (z80_ix),y
003435  3  A9 00        b01630: lda #0
003437  3  85 rr                sta varrnd
003439  3  A9 00                lda #0
00343B  3  C5 rr                cmp varc
00343D  3  F0 03                beq *+5
00343F  3  4C 46 34             jmp b01663
003442  3  A9 01                lda #1
003444  3  85 rr                sta varrnd
003446  3  A9 02        b01663: lda #2
003448  3  C5 rr                cmp varc
00344A  3  F0 03                beq *+5
00344C  3  4C 53 34             jmp b01689
00344F  3  A9 01                lda #1
003451  3  85 rr                sta varrnd
003453  3  A9 01        b01689: lda #1
003455  3  C5 rr                cmp varrnd
003457  3  F0 03                beq *+5
003459  3  4C 6A 34             jmp b01731
00345C  3  A9 01                lda #1
00345E  3  C5 rr                cmp varp
003460  3  F0 03                beq *+5
003462  3  4C 6A 34             jmp b01731
003465  3  A9 00                lda #0
003467  3  20 00 25             jsr animsp
00346A  3  A9 04        b01731: lda #4
00346C  3  85 rr                sta z80_c
00346E  3  A0 0A                ldy #10
003470  3  B1 rr                lda (z80_ix),y
003472  3  18                   clc
003473  3  65 rr                adc z80_c
003475  3  A0 0A                ldy #10
003477  3  91 rr                sta (z80_ix),y
003479  3  A9 10                lda #16
00347B  3  A0 08                ldy #8
00347D  3  D1 rr                cmp (z80_ix),y
00347F  3  90 03                bcc *+5
003481  3  4C BF 34             jmp b01920
003484  3  A9 10                lda #16
003486  3  85 rr                sta z80_c
003488  3  A0 08                ldy #8
00348A  3  B1 rr                lda (z80_ix),y
00348C  3  38                   sec
00348D  3  E5 rr                sbc z80_c
00348F  3  A0 08                ldy #8
003491  3  91 rr                sta (z80_ix),y
003493  3  A0 0A                ldy #10
003495  3  B1 rr                lda (z80_ix),y
003497  3  20 18 1B             jsr getob
00349A  3  A0 09                ldy #9
00349C  3  B1 rr                lda (z80_ix),y
00349E  3  85 rr                sta dispx
0034A0  3  A0 08                ldy #8
0034A2  3  B1 rr                lda (z80_ix),y
0034A4  3  85 rr                sta dispy
0034A6  3  A0 0A                ldy #10
0034A8  3  B1 rr                lda (z80_ix),y
0034AA  3  20 78 1B             jsr drpob
0034AD  3  A9 10                lda #16
0034AF  3  85 rr                sta z80_c
0034B1  3  A0 08                ldy #8
0034B3  3  B1 rr                lda (z80_ix),y
0034B5  3  18                   clc
0034B6  3  65 rr                adc z80_c
0034B8  3  A0 08                ldy #8
0034BA  3  91 rr                sta (z80_ix),y
0034BC  3  4C C6 34             jmp b01934
0034BF  3  A0 0A        b01920: ldy #10
0034C1  3  B1 rr                lda (z80_ix),y
0034C3  3  20 18 1B             jsr getob
0034C6  3  A9 04        b01934: lda #4
0034C8  3  85 rr                sta z80_c
0034CA  3  A0 0A                ldy #10
0034CC  3  B1 rr                lda (z80_ix),y
0034CE  3  38                   sec
0034CF  3  E5 rr                sbc z80_c
0034D1  3  A0 0A                ldy #10
0034D3  3  91 rr                sta (z80_ix),y
0034D5  3  A0 0A                ldy #10
0034D7  3  B1 rr                lda (z80_ix),y
0034D9  3  0A                   asl a
0034DA  3  0A                   asl a
0034DB  3  A0 0A                ldy #10
0034DD  3  91 rr                sta (z80_ix),y
0034DF  3  A5 rr                lda varo
0034E1  3  85 rr                sta z80_c
0034E3  3  A0 0A                ldy #10
0034E5  3  B1 rr                lda (z80_ix),y
0034E7  3  18                   clc
0034E8  3  65 rr                adc z80_c
0034EA  3  A0 0A                ldy #10
0034EC  3  91 rr                sta (z80_ix),y
0034EE  3  A5 rr                lda varp
0034F0  3  85 rr                sta z80_c
0034F2  3  A0 0A                ldy #10
0034F4  3  B1 rr                lda (z80_ix),y
0034F6  3  18                   clc
0034F7  3  65 rr                adc z80_c
0034F9  3  A0 0A                ldy #10
0034FB  3  91 rr                sta (z80_ix),y
0034FD  3  A5 rr                lda varp
0034FF  3  85 rr                sta z80_c
003501  3  A0 0A                ldy #10
003503  3  B1 rr                lda (z80_ix),y
003505  3  18                   clc
003506  3  65 rr                adc z80_c
003508  3  A0 0A                ldy #10
00350A  3  91 rr                sta (z80_ix),y
00350C  3  60                   rts
00350D  3               .out .sprintf("EVENT 1 SIZE = %d", (* - evnt01))
00350D  3               
00350D  3               evnt02:
00350D  3  A9 09                lda #9
00350F  3  A0 06                ldy #6
003511  3  91 rr                sta (z80_ix),y
003513  3  A9 00                lda #0
003515  3  A0 07                ldy #7
003517  3  91 rr                sta (z80_ix),y
003519  3  A0 0A                ldy #10
00351B  3  B1 rr                lda (z80_ix),y
00351D  3  85 rr                sta varp
00351F  3  A0 0A                ldy #10
003521  3  B1 rr                lda (z80_ix),y
003523  3  4A                   lsr a
003524  3  A0 0A                ldy #10
003526  3  91 rr                sta (z80_ix),y
003528  3  A0 0A                ldy #10
00352A  3  B1 rr                lda (z80_ix),y
00352C  3  85 rr                sta varq
00352E  3  A5 rr                lda varq
003530  3  0A                   asl a
003531  3  85 rr                sta varq
003533  3  A5 rr                lda varq
003535  3  85 rr                sta z80_c
003537  3  A5 rr                lda varp
003539  3  38                   sec
00353A  3  E5 rr                sbc z80_c
00353C  3  85 rr                sta varp
00353E  3  A9 00                lda #0
003540  3  A0 0C                ldy #12
003542  3  D1 rr                cmp (z80_ix),y
003544  3  90 03                bcc *+5
003546  3  4C 54 35             jmp c00164
003549  3  A0 0C                ldy #12
00354B  3  B1 rr                lda (z80_ix),y
00354D  3  38                   sec
00354E  3  E9 01                sbc #1
003550  3  A0 0C                ldy #12
003552  3  91 rr                sta (z80_ix),y
003554  3  A9 00        c00164: lda #0
003556  3  A0 0C                ldy #12
003558  3  D1 rr                cmp (z80_ix),y
00355A  3  F0 03                beq *+5
00355C  3  4C FA 35             jmp c00519
00355F  3  A9 00                lda #0
003561  3  85 rr                sta varrnd
003563  3  A9 00                lda #0
003565  3  85 rr                sta z80_b
003567  3  20 4B 25             jsr sktyp
00356A  3  B0 03                bcs :+
00356C  3  4C 7E 35             jmp c00248
00356F  3               :
00356F  3  A5 rr                lda vara
003571  3  A0 08                ldy #8
003573  3  D1 rr                cmp (z80_ix),y
003575  3  90 03                bcc *+5
003577  3  4C 7E 35             jmp c00248
00357A  3  A9 01                lda #1
00357C  3  85 rr                sta varrnd
00357E  3  A9 10        c00248: lda #16
003580  3  85 rr                sta z80_c
003582  3  A0 08                ldy #8
003584  3  B1 rr                lda (z80_ix),y
003586  3  38                   sec
003587  3  E5 rr                sbc z80_c
003589  3  A0 08                ldy #8
00358B  3  91 rr                sta (z80_ix),y
00358D  3  A9 00                lda #0
00358F  3  85 rr                sta z80_b
003591  3  20 4B 25             jsr sktyp
003594  3  B0 03                bcs :+
003596  3  4C A8 35             jmp c00336
003599  3               :
003599  3  A5 rr                lda vara
00359B  3  A0 08                ldy #8
00359D  3  D1 rr                cmp (z80_ix),y
00359F  3  90 03                bcc *+5
0035A1  3  4C A8 35             jmp c00336
0035A4  3  A9 01                lda #1
0035A6  3  85 rr                sta varrnd
0035A8  3  A9 10        c00336: lda #16
0035AA  3  85 rr                sta z80_c
0035AC  3  A0 08                ldy #8
0035AE  3  B1 rr                lda (z80_ix),y
0035B0  3  18                   clc
0035B1  3  65 rr                adc z80_c
0035B3  3  A0 08                ldy #8
0035B5  3  91 rr                sta (z80_ix),y
0035B7  3  A9 01                lda #1
0035B9  3  C5 rr                cmp varrnd
0035BB  3  F0 03                beq *+5
0035BD  3  4C FA 35             jmp c00519
0035C0  3  A9 01                lda #1
0035C2  3  85 rr                sta varh
0035C4  3  A9 01                lda #1
0035C6  3  85 rr                sta varp
0035C8  3  A9 0A                lda #10
0035CA  3  A0 0C                ldy #12
0035CC  3  91 rr                sta (z80_ix),y
0035CE  3  A9 0A                lda #10
0035D0  3  85 rr                sta z80_c
0035D2  3  A0 0A                ldy #10
0035D4  3  B1 rr                lda (z80_ix),y
0035D6  3  18                   clc
0035D7  3  65 rr                adc z80_c
0035D9  3  A0 0A                ldy #10
0035DB  3  91 rr                sta (z80_ix),y
0035DD  3  A0 0A                ldy #10
0035DF  3  B1 rr                lda (z80_ix),y
0035E1  3  20 18 1B             jsr getob
0035E4  3  A9 0A                lda #10
0035E6  3  85 rr                sta z80_c
0035E8  3  A0 0A                ldy #10
0035EA  3  B1 rr                lda (z80_ix),y
0035EC  3  38                   sec
0035ED  3  E5 rr                sbc z80_c
0035EF  3  A0 0A                ldy #10
0035F1  3  91 rr                sta (z80_ix),y
0035F3  3  A9 03                lda #3
0035F5  3  A0 05                ldy #5
0035F7  3  91 rr                sta (z80_ix),y
0035F9  3  60                   rts
0035FA  3  A9 A8        c00519: lda #168
0035FC  3  A0 08                ldy #8
0035FE  3  D1 rr                cmp (z80_ix),y
003600  3  90 03                bcc *+5
003602  3  4C 43 36             jmp c00684
003605  3  A9 0A                lda #10
003607  3  85 rr                sta z80_c
003609  3  A0 0A                ldy #10
00360B  3  B1 rr                lda (z80_ix),y
00360D  3  18                   clc
00360E  3  65 rr                adc z80_c
003610  3  A0 0A                ldy #10
003612  3  91 rr                sta (z80_ix),y
003614  3  A0 0A                ldy #10
003616  3  B1 rr                lda (z80_ix),y
003618  3  20 18 1B             jsr getob
00361B  3  A9 0A                lda #10
00361D  3  85 rr                sta z80_c
00361F  3  A0 0A                ldy #10
003621  3  B1 rr                lda (z80_ix),y
003623  3  38                   sec
003624  3  E5 rr                sbc z80_c
003626  3  A0 0A                ldy #10
003628  3  91 rr                sta (z80_ix),y
00362A  3  A9 00                lda #0
00362C  3  A0 07                ldy #7
00362E  3  91 rr                sta (z80_ix),y
003630  3  A9 0C                lda #12
003632  3  A0 06                ldy #6
003634  3  91 rr                sta (z80_ix),y
003636  3  A9 DC                lda #220
003638  3  A0 0C                ldy #12
00363A  3  91 rr                sta (z80_ix),y
00363C  3  A9 04                lda #4
00363E  3  A0 05                ldy #5
003640  3  91 rr                sta (z80_ix),y
003642  3  60                   rts
003643  3  20 0D 1F     c00684: jsr cangd
003646  3  F0 03                beq :+
003648  3  4C A4 37             jmp c01426
00364B  3               :
00364B  3  A0 08                ldy #8
00364D  3  B1 rr                lda (z80_ix),y
00364F  3  18                   clc
003650  3  69 01                adc #1
003652  3  A0 08                ldy #8
003654  3  91 rr                sta (z80_ix),y
003656  3  20 0D 1F             jsr cangd
003659  3  F0 03                beq :+
00365B  3  4C 61 36             jmp c00741
00365E  3               :
00365E  3  4C 87 36             jmp c00830
003661  3  A9 0A        c00741: lda #10
003663  3  85 rr                sta z80_c
003665  3  A0 0A                ldy #10
003667  3  B1 rr                lda (z80_ix),y
003669  3  18                   clc
00366A  3  65 rr                adc z80_c
00366C  3  A0 0A                ldy #10
00366E  3  91 rr                sta (z80_ix),y
003670  3  A0 0A                ldy #10
003672  3  B1 rr                lda (z80_ix),y
003674  3  20 18 1B             jsr getob
003677  3  A9 0A                lda #10
003679  3  85 rr                sta z80_c
00367B  3  A0 0A                ldy #10
00367D  3  B1 rr                lda (z80_ix),y
00367F  3  38                   sec
003680  3  E5 rr                sbc z80_c
003682  3  A0 0A                ldy #10
003684  3  91 rr                sta (z80_ix),y
003686  3  60                   rts
003687  3  A9 1E        c00830: lda #30
003689  3  85 rr                sta z80_d
00368B  3  20 44 21             jsr random
00368E  3  85 rr                sta z80_h
003690  3  20 86 1A             jsr imul
003693  3  A5 rr                lda z80_h
003695  3  85 rr                sta varrnd
003697  3  A9 01                lda #1
003699  3  C5 rr                cmp varrnd
00369B  3  F0 03                beq *+5
00369D  3  4C B4 36             jmp c00916
0036A0  3  A9 00                lda #0
0036A2  3  C5 rr                cmp varp
0036A4  3  F0 03                beq *+5
0036A6  3  4C B0 36             jmp c00908
0036A9  3  A9 01                lda #1
0036AB  3  85 rr                sta varp
0036AD  3  4C B4 36             jmp c00916
0036B0  3  A9 00        c00908: lda #0
0036B2  3  85 rr                sta varp
0036B4  3  A9 00        c00916: lda #0
0036B6  3  C5 rr                cmp varp
0036B8  3  F0 03                beq *+5
0036BA  3  4C EC 36             jmp c01024
0036BD  3  A0 09                ldy #9
0036BF  3  B1 rr                lda (z80_ix),y
0036C1  3  C9 F0                cmp #240
0036C3  3  90 03                bcc *+5
0036C5  3  4C E5 36             jmp c01012
0036C8  3  20 54 1F             jsr cangr
0036CB  3  F0 03                beq :+
0036CD  3  4C DE 36             jmp c00999
0036D0  3               :
0036D0  3  A0 09                ldy #9
0036D2  3  B1 rr                lda (z80_ix),y
0036D4  3  18                   clc
0036D5  3  69 01                adc #1
0036D7  3  A0 09                ldy #9
0036D9  3  91 rr                sta (z80_ix),y
0036DB  3  4C E2 36             jmp c01007
0036DE  3  A9 01        c00999: lda #1
0036E0  3  85 rr                sta varp
0036E2  3  4C E9 36     c01007: jmp c01020
0036E5  3  A9 01        c01012: lda #1
0036E7  3  85 rr                sta varp
0036E9  3  4C 18 37     c01020: jmp c01111
0036EC  3  A9 00        c01024: lda #0
0036EE  3  A0 09                ldy #9
0036F0  3  D1 rr                cmp (z80_ix),y
0036F2  3  90 03                bcc *+5
0036F4  3  4C 14 37             jmp c01103
0036F7  3  20 42 1F             jsr cangl
0036FA  3  F0 03                beq :+
0036FC  3  4C 0D 37             jmp c01090
0036FF  3               :
0036FF  3  A0 09                ldy #9
003701  3  B1 rr                lda (z80_ix),y
003703  3  38                   sec
003704  3  E9 01                sbc #1
003706  3  A0 09                ldy #9
003708  3  91 rr                sta (z80_ix),y
00370A  3  4C 11 37             jmp c01098
00370D  3  A9 00        c01090: lda #0
00370F  3  85 rr                sta varp
003711  3  4C 18 37     c01098: jmp c01111
003714  3  A9 00        c01103: lda #0
003716  3  85 rr                sta varp
003718  3  A9 10        c01111: lda #16
00371A  3  A0 08                ldy #8
00371C  3  D1 rr                cmp (z80_ix),y
00371E  3  90 03                bcc *+5
003720  3  4C 7C 37             jmp c01336
003723  3  A9 10                lda #16
003725  3  85 rr                sta z80_c
003727  3  A0 08                ldy #8
003729  3  B1 rr                lda (z80_ix),y
00372B  3  38                   sec
00372C  3  E5 rr                sbc z80_c
00372E  3  A0 08                ldy #8
003730  3  91 rr                sta (z80_ix),y
003732  3  A9 0A                lda #10
003734  3  85 rr                sta z80_c
003736  3  A0 0A                ldy #10
003738  3  B1 rr                lda (z80_ix),y
00373A  3  18                   clc
00373B  3  65 rr                adc z80_c
00373D  3  A0 0A                ldy #10
00373F  3  91 rr                sta (z80_ix),y
003741  3  A0 0A                ldy #10
003743  3  B1 rr                lda (z80_ix),y
003745  3  20 18 1B             jsr getob
003748  3  A0 09                ldy #9
00374A  3  B1 rr                lda (z80_ix),y
00374C  3  85 rr                sta dispx
00374E  3  A0 08                ldy #8
003750  3  B1 rr                lda (z80_ix),y
003752  3  85 rr                sta dispy
003754  3  A0 0A                ldy #10
003756  3  B1 rr                lda (z80_ix),y
003758  3  20 78 1B             jsr drpob
00375B  3  A9 0A                lda #10
00375D  3  85 rr                sta z80_c
00375F  3  A0 0A                ldy #10
003761  3  B1 rr                lda (z80_ix),y
003763  3  38                   sec
003764  3  E5 rr                sbc z80_c
003766  3  A0 0A                ldy #10
003768  3  91 rr                sta (z80_ix),y
00376A  3  A9 10                lda #16
00376C  3  85 rr                sta z80_c
00376E  3  A0 08                ldy #8
003770  3  B1 rr                lda (z80_ix),y
003772  3  18                   clc
003773  3  65 rr                adc z80_c
003775  3  A0 08                ldy #8
003777  3  91 rr                sta (z80_ix),y
003779  3  4C A1 37             jmp c01421
00377C  3  A9 0A        c01336: lda #10
00377E  3  85 rr                sta z80_c
003780  3  A0 0A                ldy #10
003782  3  B1 rr                lda (z80_ix),y
003784  3  18                   clc
003785  3  65 rr                adc z80_c
003787  3  A0 0A                ldy #10
003789  3  91 rr                sta (z80_ix),y
00378B  3  A0 0A                ldy #10
00378D  3  B1 rr                lda (z80_ix),y
00378F  3  20 18 1B             jsr getob
003792  3  A9 0A                lda #10
003794  3  85 rr                sta z80_c
003796  3  A0 0A                ldy #10
003798  3  B1 rr                lda (z80_ix),y
00379A  3  38                   sec
00379B  3  E5 rr                sbc z80_c
00379D  3  A0 0A                ldy #10
00379F  3  91 rr                sta (z80_ix),y
0037A1  3  4C E1 37     c01421: jmp c01565
0037A4  3  A9 0A        c01426: lda #10
0037A6  3  85 rr                sta z80_c
0037A8  3  A0 0A                ldy #10
0037AA  3  B1 rr                lda (z80_ix),y
0037AC  3  18                   clc
0037AD  3  65 rr                adc z80_c
0037AF  3  A0 0A                ldy #10
0037B1  3  91 rr                sta (z80_ix),y
0037B3  3  A0 0A                ldy #10
0037B5  3  B1 rr                lda (z80_ix),y
0037B7  3  20 18 1B             jsr getob
0037BA  3  A9 0A                lda #10
0037BC  3  85 rr                sta z80_c
0037BE  3  A0 0A                ldy #10
0037C0  3  B1 rr                lda (z80_ix),y
0037C2  3  38                   sec
0037C3  3  E5 rr                sbc z80_c
0037C5  3  A0 0A                ldy #10
0037C7  3  91 rr                sta (z80_ix),y
0037C9  3  A9 FF                lda #255
0037CB  3  A0 0C                ldy #12
0037CD  3  91 rr                sta (z80_ix),y
0037CF  3  A9 08                lda #8
0037D1  3  A0 06                ldy #6
0037D3  3  91 rr                sta (z80_ix),y
0037D5  3  A9 00                lda #0
0037D7  3  A0 07                ldy #7
0037D9  3  91 rr                sta (z80_ix),y
0037DB  3  A9 08                lda #8
0037DD  3  A0 05                ldy #5
0037DF  3  91 rr                sta (z80_ix),y
0037E1  3  A0 0A        c01565: ldy #10
0037E3  3  B1 rr                lda (z80_ix),y
0037E5  3  0A                   asl a
0037E6  3  A0 0A                ldy #10
0037E8  3  91 rr                sta (z80_ix),y
0037EA  3  A5 rr                lda varp
0037EC  3  85 rr                sta z80_c
0037EE  3  A0 0A                ldy #10
0037F0  3  B1 rr                lda (z80_ix),y
0037F2  3  18                   clc
0037F3  3  65 rr                adc z80_c
0037F5  3  A0 0A                ldy #10
0037F7  3  91 rr                sta (z80_ix),y
0037F9  3  60                   rts
0037FA  3               .out .sprintf("EVENT 2 SIZE = %d", (* - evnt02))
0037FA  3               
0037FA  3               evnt03:
0037FA  3  A9 0A                lda #10
0037FC  3  A0 06                ldy #6
0037FE  3  91 rr                sta (z80_ix),y
003800  3  A9 00                lda #0
003802  3  20 00 25             jsr animsp
003805  3  A0 08                ldy #8
003807  3  B1 rr                lda (z80_ix),y
003809  3  C9 A8                cmp #168
00380B  3  90 03                bcc *+5
00380D  3  4C 4E 38             jmp d00185
003810  3  A0 0B                ldy #11
003812  3  B1 rr                lda (z80_ix),y
003814  3  85 rr                sta z80_c
003816  3  A0 08                ldy #8
003818  3  B1 rr                lda (z80_ix),y
00381A  3  18                   clc
00381B  3  65 rr                adc z80_c
00381D  3  A0 08                ldy #8
00381F  3  91 rr                sta (z80_ix),y
003821  3  A9 00                lda #0
003823  3  A0 0C                ldy #12
003825  3  D1 rr                cmp (z80_ix),y
003827  3  90 03                bcc *+5
003829  3  4C 3A 38             jmp d00140
00382C  3  A0 0C                ldy #12
00382E  3  B1 rr                lda (z80_ix),y
003830  3  38                   sec
003831  3  E9 01                sbc #1
003833  3  A0 0C                ldy #12
003835  3  91 rr                sta (z80_ix),y
003837  3  4C 4B 38             jmp d00180
00383A  3  A0 0B        d00140: ldy #11
00383C  3  B1 rr                lda (z80_ix),y
00383E  3  18                   clc
00383F  3  69 01                adc #1
003841  3  A0 0B                ldy #11
003843  3  91 rr                sta (z80_ix),y
003845  3  A9 03                lda #3
003847  3  A0 0C                ldy #12
003849  3  91 rr                sta (z80_ix),y
00384B  3  4C 66 38     d00180: jmp d00239
00384E  3  A9 00        d00185: lda #0
003850  3  A0 07                ldy #7
003852  3  91 rr                sta (z80_ix),y
003854  3  A9 0C                lda #12
003856  3  A0 06                ldy #6
003858  3  91 rr                sta (z80_ix),y
00385A  3  A9 DC                lda #220
00385C  3  A0 0C                ldy #12
00385E  3  91 rr                sta (z80_ix),y
003860  3  A9 04                lda #4
003862  3  A0 05                ldy #5
003864  3  91 rr                sta (z80_ix),y
003866  3  60           d00239: rts
003867  3               .out .sprintf("EVENT 3 SIZE = %d", (* - evnt03))
003867  3               
003867  3               evnt04:
003867  3  A9 78                lda #120
003869  3  A0 0C                ldy #12
00386B  3  D1 rr                cmp (z80_ix),y
00386D  3  90 03                bcc *+5
00386F  3  4C D6 38             jmp e00241
003872  3  A9 0C                lda #12
003874  3  A0 06                ldy #6
003876  3  91 rr                sta (z80_ix),y
003878  3  A0 0C                ldy #12
00387A  3  B1 rr                lda (z80_ix),y
00387C  3  38                   sec
00387D  3  E9 01                sbc #1
00387F  3  A0 0C                ldy #12
003881  3  91 rr                sta (z80_ix),y
003883  3  A9 D9                lda #217
003885  3  A0 0C                ldy #12
003887  3  D1 rr                cmp (z80_ix),y
003889  3  F0 03                beq *+5
00388B  3  4C 94 38             jmp e00100
00388E  3  A9 01                lda #1
003890  3  A0 07                ldy #7
003892  3  91 rr                sta (z80_ix),y
003894  3  A9 D6        e00100: lda #214
003896  3  A0 0C                ldy #12
003898  3  D1 rr                cmp (z80_ix),y
00389A  3  F0 03                beq *+5
00389C  3  4C A5 38             jmp e00136
00389F  3  A9 02                lda #2
0038A1  3  A0 07                ldy #7
0038A3  3  91 rr                sta (z80_ix),y
0038A5  3  A9 D3        e00136: lda #211
0038A7  3  A0 0C                ldy #12
0038A9  3  D1 rr                cmp (z80_ix),y
0038AB  3  F0 03                beq *+5
0038AD  3  4C B6 38             jmp e00173
0038B0  3  A9 C8                lda #200
0038B2  3  A0 08                ldy #8
0038B4  3  91 rr                sta (z80_ix),y
0038B6  3  A9 78        e00173: lda #120
0038B8  3  A0 0C                ldy #12
0038BA  3  D1 rr                cmp (z80_ix),y
0038BC  3  F0 03                beq *+5
0038BE  3  4C D3 38             jmp e00236
0038C1  3  A9 B0                lda #176
0038C3  3  A0 08                ldy #8
0038C5  3  91 rr                sta (z80_ix),y
0038C7  3  A9 0D                lda #13
0038C9  3  A0 06                ldy #6
0038CB  3  91 rr                sta (z80_ix),y
0038CD  3  A9 00                lda #0
0038CF  3  A0 07                ldy #7
0038D1  3  91 rr                sta (z80_ix),y
0038D3  3  4C 32 39     e00236: jmp e00440
0038D6  3  A9 02        e00241: lda #2
0038D8  3  A0 07                ldy #7
0038DA  3  D1 rr                cmp (z80_ix),y
0038DC  3  F0 03                beq *+5
0038DE  3  4C E8 38             jmp e00279
0038E1  3  A9 FF                lda #255
0038E3  3  A0 05                ldy #5
0038E5  3  91 rr                sta (z80_ix),y
0038E7  3  60                   rts
0038E8  3  A0 08        e00279: ldy #8
0038EA  3  B1 rr                lda (z80_ix),y
0038EC  3  38                   sec
0038ED  3  E9 01                sbc #1
0038EF  3  A0 08                ldy #8
0038F1  3  91 rr                sta (z80_ix),y
0038F3  3  A5 rr                lda varc
0038F5  3  C9 02                cmp #2
0038F7  3  90 03                bcc *+5
0038F9  3  4C 10 39             jmp e00366
0038FC  3  A0 09                ldy #9
0038FE  3  B1 rr                lda (z80_ix),y
003900  3  18                   clc
003901  3  69 01                adc #1
003903  3  A0 09                ldy #9
003905  3  91 rr                sta (z80_ix),y
003907  3  A9 00                lda #0
003909  3  A0 07                ldy #7
00390B  3  91 rr                sta (z80_ix),y
00390D  3  4C 21 39             jmp e00405
003910  3  A0 09        e00366: ldy #9
003912  3  B1 rr                lda (z80_ix),y
003914  3  38                   sec
003915  3  E9 01                sbc #1
003917  3  A0 09                ldy #9
003919  3  91 rr                sta (z80_ix),y
00391B  3  A9 01                lda #1
00391D  3  A0 07                ldy #7
00391F  3  91 rr                sta (z80_ix),y
003921  3  A9 00        e00405: lda #0
003923  3  A0 08                ldy #8
003925  3  D1 rr                cmp (z80_ix),y
003927  3  F0 03                beq *+5
003929  3  4C 32 39             jmp e00440
00392C  3  A9 02                lda #2
00392E  3  A0 07                ldy #7
003930  3  91 rr                sta (z80_ix),y
003932  3  A9 00        e00440: lda #0
003934  3  85 rr                sta z80_b
003936  3  20 4B 25             jsr sktyp
003939  3  B0 03                bcs :+
00393B  3  4C 44 39             jmp e00475
00393E  3               :
00393E  3  A9 02                lda #2
003940  3  A0 07                ldy #7
003942  3  91 rr                sta (z80_ix),y
003944  3  60           e00475: rts
003945  3               .out .sprintf("EVENT 4 SIZE = %d", (* - evnt04))
003945  3               
003945  3               evnt05:
003945  3  60                   rts
003946  3               .out .sprintf("EVENT 5 SIZE = %d", (* - evnt05))
003946  3               
003946  3               evnt06:
003946  3  60                   rts
003947  3               .out .sprintf("EVENT 6 SIZE = %d", (* - evnt06))
003947  3               
003947  3               evnt07:
003947  3  60                   rts
003948  3               .out .sprintf("EVENT 7 SIZE = %d", (* - evnt07))
003948  3               
003948  3               evnt08:
003948  3  A9 00                lda #0
00394A  3  A0 0C                ldy #12
00394C  3  D1 rr                cmp (z80_ix),y
00394E  3  90 03                bcc *+5
003950  3  4C 62 39             jmp i00060
003953  3  A9 FF                lda #255
003955  3  85 rr                sta z80_c
003957  3  A0 0C                ldy #12
003959  3  B1 rr                lda (z80_ix),y
00395B  3  18                   clc
00395C  3  65 rr                adc z80_c
00395E  3  A0 0C                ldy #12
003960  3  91 rr                sta (z80_ix),y
003962  3  A9 D2        i00060: lda #210
003964  3  A0 0C                ldy #12
003966  3  D1 rr                cmp (z80_ix),y
003968  3  F0 03                beq *+5
00396A  3  4C 72 39             jmp i00091
00396D  3  A9 00                lda #0
00396F  3  20 00 25             jsr animsp
003972  3  A9 B4        i00091: lda #180
003974  3  A0 0C                ldy #12
003976  3  D1 rr                cmp (z80_ix),y
003978  3  F0 03                beq *+5
00397A  3  4C 82 39             jmp i00122
00397D  3  A9 00                lda #0
00397F  3  20 00 25             jsr animsp
003982  3  A9 A0        i00122: lda #160
003984  3  A0 0C                ldy #12
003986  3  D1 rr                cmp (z80_ix),y
003988  3  F0 03                beq *+5
00398A  3  4C A3 39             jmp i00198
00398D  3  A0 0A                ldy #10
00398F  3  B1 rr                lda (z80_ix),y
003991  3  0A                   asl a
003992  3  0A                   asl a
003993  3  A0 0A                ldy #10
003995  3  91 rr                sta (z80_ix),y
003997  3  A9 01                lda #1
003999  3  A0 05                ldy #5
00399B  3  91 rr                sta (z80_ix),y
00399D  3  A9 06                lda #6
00399F  3  A0 06                ldy #6
0039A1  3  91 rr                sta (z80_ix),y
0039A3  3  A9 00        i00198: lda #0
0039A5  3  85 rr                sta z80_b
0039A7  3  20 4B 25             jsr sktyp
0039AA  3  B0 03                bcs :+
0039AC  3  4C BF 39             jmp i00254
0039AF  3               :
0039AF  3  A9 01                lda #1
0039B1  3  85 rr                sta varh
0039B3  3  A9 03                lda #3
0039B5  3  A0 0C                ldy #12
0039B7  3  91 rr                sta (z80_ix),y
0039B9  3  A9 03                lda #3
0039BB  3  A0 05                ldy #5
0039BD  3  91 rr                sta (z80_ix),y
0039BF  3  60           i00254: rts
0039C0  3               .out .sprintf("EVENT 8 SIZE = %d", (* - evnt08))
0039C0  3               
0039C0  3               evnt09:
0039C0  3  A9 08                lda #8
0039C2  3  A0 05                ldy #5
0039C4  3  D1 rr                cmp (z80_ix),y
0039C6  3  F0 03                beq *+5
0039C8  3  4C DE 39             jmp j00067
0039CB  3  A9 FF                lda #255
0039CD  3  A0 0C                ldy #12
0039CF  3  91 rr                sta (z80_ix),y
0039D1  3  A5 rr                lda vari
0039D3  3  A0 0A                ldy #10
0039D5  3  91 rr                sta (z80_ix),y
0039D7  3  A5 rr                lda vari
0039D9  3  18                   clc
0039DA  3  69 01                adc #1
0039DC  3  85 rr                sta vari
0039DE  3  60           j00067: rts
0039DF  3               .out .sprintf("EVENT 9 SIZE = %d", (* - evnt09))
0039DF  3               
0039DF  3               evnt10:
0039DF  3  A5 rr                lda varc
0039E1  3  18                   clc
0039E2  3  69 01                adc #1
0039E4  3  85 rr                sta varc
0039E6  3  A9 03                lda #3
0039E8  3  C5 rr                cmp varc
0039EA  3  90 03                bcc *+5
0039EC  3  4C F3 39             jmp k00042
0039EF  3  A9 00                lda #0
0039F1  3  85 rr                sta varc
0039F3  3  A9 00        k00042: lda #0
0039F5  3  85 rr                sta chary
0039F7  3  A9 00                lda #0
0039F9  3  85 rr                sta charx
0039FB  3  20 C2 1C             jsr dscor
0039FE  3  60                   rts
0039FF  3               .out .sprintf("EVENT 10 SIZE = %d", (* - evnt10))
0039FF  3               
0039FF  3               evnt11:
0039FF  3  60                   rts
003A00  3               .out .sprintf("EVENT 11 SIZE = %d", (* - evnt11))
003A00  3               
003A00  3               evnt12:
003A00  3  60                   rts
003A01  3               .out .sprintf("EVENT 12 SIZE = %d", (* - evnt12))
003A01  3               
003A01  3               evnt13:
003A01  3  A9 00                lda #0
003A03  3  85 rr                sta vari
003A05  3  A9 00                lda #0
003A07  3  85 rr                sta vare
003A09  3  60                   rts
003A0A  3               .out .sprintf("EVENT 13 SIZE = %d", (* - evnt13))
003A0A  3               
003A0A  3               evnt14:
003A0A  3  A9 00                lda #0
003A0C  3  85 rr                sta varq
003A0E  3  A9 15                lda #21
003A10  3  85 rr                sta loopa
003A12  3  A5 rr        o00018: lda varq
003A14  3  85 rr                sta chary
003A16  3  A9 1E                lda #30
003A18  3  85 rr                sta charx
003A1A  3  A5 rr                lda charx
003A1C  3  85 rr                sta dispx
003A1E  3  A5 rr                lda chary
003A20  3  85 rr                sta dispy
003A22  3  A9 00                lda #0
003A24  3  20 68 13             jsr pattr
003A27  3  A5 rr                lda charx
003A29  3  85 rr                sta dispx
003A2B  3  A5 rr                lda chary
003A2D  3  85 rr                sta dispy
003A2F  3  A9 00                lda #0
003A31  3  20 68 13             jsr pattr
003A34  3  A5 rr                lda varq
003A36  3  18                   clc
003A37  3  69 01                adc #1
003A39  3  85 rr                sta varq
003A3B  3  C6 rr                dec loopa
003A3D  3  F0 03                beq :+
003A3F  3  4C 12 3A             jmp o00018
003A42  3               :
003A42  3  A9 17                lda #23
003A44  3  85 rr                sta chary
003A46  3  A9 00                lda #0
003A48  3  85 rr                sta charx
003A4A  3  A9 20                lda #32
003A4C  3  85 rr                sta loopa
003A4E  3  A5 rr        o00142: lda charx
003A50  3  85 rr                sta dispx
003A52  3  A5 rr                lda chary
003A54  3  85 rr                sta dispy
003A56  3  A9 03                lda #3
003A58  3  20 68 13             jsr pattr
003A5B  3  C6 rr                dec loopa
003A5D  3  F0 03                beq :+
003A5F  3  4C 4E 3A             jmp o00142
003A62  3               :
003A62  3  A9 15                lda #21
003A64  3  85 rr                sta chary
003A66  3  A9 1E                lda #30
003A68  3  85 rr                sta charx
003A6A  3  A5 rr                lda charx
003A6C  3  85 rr                sta dispx
003A6E  3  A5 rr                lda chary
003A70  3  85 rr                sta dispy
003A72  3  A9 01                lda #1
003A74  3  20 68 13             jsr pattr
003A77  3  A5 rr                lda charx
003A79  3  85 rr                sta dispx
003A7B  3  A5 rr                lda chary
003A7D  3  85 rr                sta dispy
003A7F  3  A9 01                lda #1
003A81  3  20 68 13             jsr pattr
003A84  3  A9 16                lda #22
003A86  3  85 rr                sta chary
003A88  3  A9 1E                lda #30
003A8A  3  85 rr                sta charx
003A8C  3  A5 rr                lda charx
003A8E  3  85 rr                sta dispx
003A90  3  A5 rr                lda chary
003A92  3  85 rr                sta dispy
003A94  3  A9 02                lda #2
003A96  3  20 68 13             jsr pattr
003A99  3  A5 rr                lda charx
003A9B  3  85 rr                sta dispx
003A9D  3  A5 rr                lda chary
003A9F  3  85 rr                sta dispy
003AA1  3  A9 02                lda #2
003AA3  3  20 68 13             jsr pattr
003AA6  3  60                   rts
003AA7  3               .out .sprintf("EVENT 14 SIZE = %d", (* - evnt14))
003AA7  3               
003AA7  3               evnt15:
003AA7  3  60                   rts
003AA8  3               .out .sprintf("EVENT 15 SIZE = %d", (* - evnt15))
003AA8  3               
003AA8  3               evnt16:
003AA8  3  60                   rts
003AA9  3               .out .sprintf("EVENT 16 SIZE = %d", (* - evnt16))
003AA9  3               
003AA9  3               evnt17:
003AA9  3  60                   rts
003AAA  3               .out .sprintf("EVENT 17 SIZE = %d", (* - evnt17))
003AAA  3               
003AAA  3               evnt18:
003AAA  3  60                   rts
003AAB  3               .out .sprintf("EVENT 18 SIZE = %d", (* - evnt18))
003AAB  3               
003AAB  3               evnt19:
003AAB  3  60                   rts
003AAC  3               .out .sprintf("EVENT 19 SIZE = %d", (* - evnt19))
003AAC  3               
003AAC  3               evnt20:
003AAC  3  60                   rts
003AAD  3               .out .sprintf("EVENT 20 SIZE = %d", (* - evnt20))
003AAD  3               
003AAD  3  60           ptcusr: rts
003AAE  3               script_end:
003AAE  3               
003AAE  3               .out .sprintf("TOTAL SCRIPT SIZE = %d", (* - script_start))
003AAE  3               
003AAE  3               data_start:
003AAE  3               msgdat:
003AAE  3  54 54 54 54          .byte "TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT",13
003AB2  3  54 54 54 54  
003AB6  3  54 54 54 54  
003ACF  3  54 54 54 54          .byte "TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT",13
003AD3  3  54 54 54 54  
003AD7  3  54 54 54 54  
003AF0  3  54 54 54 54          .byte "TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT",13
003AF4  3  54 54 54 54  
003AF8  3  54 54 54 54  
003B11  3  54 54 54 54          .byte "TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT",13
003B15  3  54 54 54 54  
003B19  3  54 54 54 54  
003B32  3  54 54 54 54          .byte "TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT",13
003B36  3  54 54 54 54  
003B3A  3  54 54 54 54  
003B53  3  54 54 54 54          .byte "TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT",13
003B57  3  54 54 54 54  
003B5B  3  54 54 54 54  
003B74  3  0D                   .byte 13
003B75  3  8D                   .byte 141
003B76  3  41 41 41 41          .byte "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",13
003B7A  3  41 41 41 41  
003B7E  3  41 41 41 41  
003B97  3  41 41 41 41          .byte "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",13
003B9B  3  41 41 41 41  
003B9F  3  41 41 41 41  
003BB8  3  41 8D                .byte "A",141
003BBA  3               nummsg:
003BBA  3  02                   .byte 2
003BBB  3               .out .sprintf("MESSAGE SIZE = %d", (* - msgdat))
003BBB  3               
003BBB  3               chgfx:
003BBB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003BBF  3  00 00 00 00  
003BC3  3  00 00 00 00  
003BCB  3  00 00 01 A2          .byte 0,0,1,162,138,80,5,35,152,64,34,5,138,138,5,5
003BCF  3  8A 50 05 23  
003BD3  3  98 40 22 05  
003BDB  3  F0 F0 D0 E0          .byte 240,240,208,224,96,160,80,144,96,176,80,192,96,176,176,240
003BDF  3  60 A0 50 90  
003BE3  3  60 B0 50 C0  
003BEB  3  08 00 26 01          .byte 8,0,38,1,19,95,0,34,0,0,38,0,27,25,1,174
003BEF  3  13 5F 00 22  
003BF3  3  00 00 26 00  
003BFB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,4,70,10,137,5
003BFF  3  00 00 00 00  
003C03  3  00 00 00 04  
003C0B  3  D0 50 A0 40          .byte 208,80,160,64,0,16,0,0,0,0,0,0,0,0,0,0
003C0F  3  00 10 00 00  
003C13  3  00 00 00 00  
003C1B  3  D8 50 A2 04          .byte 216,80,162,4,0,16,0,0,0,0,0,0,0,0,0,0
003C1F  3  00 10 00 00  
003C23  3  00 00 00 00  
003C2B  3  00 00 00 00          .byte 0,0,0,0,0,102,17,255,51,255,51,17,102,0,102,0
003C2F  3  00 66 11 FF  
003C33  3  33 FF 33 11  
003C3B  3  00 00 33 99          .byte 0,0,51,153,119,255,102,102,204,34,204,0,255,136,255,204
003C3F  3  77 FF 66 66  
003C43  3  CC 22 CC 00  
003C4B  3  00 00 CC 00          .byte 0,0,204,0,238,0,34,0,85,119,17,238,17,204,0,136
003C4F  3  EE 00 22 00  
003C53  3  55 77 11 EE  
003C5B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,136,0,102,0,17,0,17,0
003C5F  3  00 00 00 00  
003C63  3  88 00 66 00  
003C6B  3  66 00 22 11          .byte 102,0,34,17,17,17,51,17,119,153,102,17,68,0,136,0
003C6F  3  11 11 33 11  
003C73  3  77 99 66 11  
003C7B  3  FF 22 CC 00          .byte 255,34,204,0,136,0,136,0,0,0,0,0,136,0,0,0
003C7F  3  88 00 88 00  
003C83  3  00 00 00 00  
003C8B  3  00 88 11 88          .byte 0,136,17,136,0,68,0,0,0,0,0,0,0,0,0,0
003C8F  3  00 44 00 00  
003C93  3  00 00 00 00  
003C9B  3  00 88 00 88          .byte 0,136,0,136,0,136,0,136,17,136,119,204,51,238,34,102
003C9F  3  00 88 00 88  
003CA3  3  11 88 77 CC  
003CAB  3  88 00 88 00          .byte 136,0,136,0,136,0,68,119,51,255,17,255,17,238,51,204
003CAF  3  88 00 44 77  
003CB3  3  33 FF 11 FF  
003CBB  3  00 00 00 00          .byte 0,0,0,0,0,17,0,0,0,0,0,0,0,0,0,34
003CBF  3  00 11 00 00  
003CC3  3  00 00 00 00  
003CCB  3  00 00 00 44          .byte 0,0,0,68,0,68,255,136,119,0,0,0,0,0,0,0
003CCF  3  00 44 FF 88  
003CD3  3  77 00 00 00  
003CDB  3  00 33 00 11          .byte 0,51,0,17,0,17,0,17,0,34,34,204,17,0,17,0
003CDF  3  00 11 00 11  
003CE3  3  00 22 22 CC  
003CEB  3  33 CC 33 CC          .byte 51,204,51,204,17,204,17,204,0,238,0,119,0,51,0,0
003CEF  3  11 CC 11 CC  
003CF3  3  00 EE 00 77  
003CFB  3  11 44 00 CC          .byte 17,68,0,204,0,238,0,102,0,255,51,51,204,0,0,0
003CFF  3  00 EE 00 66  
003D03  3  00 FF 33 33  
003D0B  3  00 44 00 22          .byte 0,68,0,34,0,17,0,68,0,136,238,0,0,0,0,0
003D0F  3  00 11 00 44  
003D13  3  00 88 EE 00  
003D1B  3  00 00 22 00          .byte 0,0,34,0,204,0,0,0,0,0,0,0,0,0,0,0
003D1F  3  CC 00 00 00  
003D23  3  00 00 00 00  
003D2B  3  00 00 00 00          .byte 0,0,0,0,0,0,17,0,0,0,0,0,0,0,0,0
003D2F  3  00 00 11 00  
003D33  3  00 00 00 00  
003D3B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003D3F  3  00 00 00 00  
003D43  3  00 00 00 00  
003D4B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003D4F  3  00 00 00 00  
003D53  3  00 00 00 00  
003D5B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003D5F  3  00 00 00 00  
003D63  3  00 00 00 00  
003D6B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003D6F  3  00 00 00 00  
003D73  3  00 00 00 00  
003D7B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003D7F  3  00 00 00 00  
003D83  3  00 00 00 00  
003D8B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003D8F  3  00 00 00 00  
003D93  3  00 00 00 00  
003D9B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003D9F  3  00 00 00 00  
003DA3  3  00 00 00 00  
003DAB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003DAF  3  00 00 00 00  
003DB3  3  00 00 00 00  
003DBB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003DBF  3  00 00 00 00  
003DC3  3  00 00 00 00  
003DCB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003DCF  3  00 00 00 00  
003DD3  3  00 00 00 00  
003DDB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003DDF  3  00 00 00 00  
003DE3  3  00 00 00 00  
003DEB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003DEF  3  00 00 00 00  
003DF3  3  00 00 00 00  
003DFB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003DFF  3  00 00 00 00  
003E03  3  00 00 00 00  
003E0B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003E0F  3  00 00 00 00  
003E13  3  00 00 00 00  
003E1B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
003E1F  3  00 00 00 00  
003E23  3  00 00 00 00  
003E2B  3  00 00 00 00          .byte 0,0,0,0,2,8,1,0,2,8,0,0,0,0,0,0
003E2F  3  02 08 01 00  
003E33  3  02 08 00 00  
003E3B  3  00 00 00 00          .byte 0,0,0,0,2,136,1,0,2,136,0,0,0,0,0,0
003E3F  3  02 88 01 00  
003E43  3  02 88 00 00  
003E4B  3  60 A0 D0 50          .byte 96,160,208,80,160,176,208,80,160,176,208,80,160,176,80,96
003E4F  3  A0 B0 D0 50  
003E53  3  A0 B0 D0 50  
003E5B  3  60 A0 D0 50          .byte 96,160,208,80,160,176,208,80,160,176,80,96,96,160,80,96
003E5F  3  A0 B0 D0 50  
003E63  3  A0 B0 50 60  
003E6B  3  30 C0 20 C0          .byte 48,192,32,192,48,64,32,192,16,64,16,128,16,128,16,0
003E6F  3  30 40 20 C0  
003E73  3  10 40 10 80  
003E7B  3               bprop:
003E7B  3  00                   .byte 0
003E7C  3  02                   .byte 2
003E7D  3  00                   .byte 0
003E7E  3  00                   .byte 0
003E7F  3  00                   .byte 0
003E80  3  00                   .byte 0
003E81  3  00                   .byte 0
003E82  3  06                   .byte 6
003E83  3  06                   .byte 6
003E84  3  06                   .byte 6
003E85  3  06                   .byte 6
003E86  3  06                   .byte 6
003E87  3  06                   .byte 6
003E88  3  06                   .byte 6
003E89  3  06                   .byte 6
003E8A  3  06                   .byte 6
003E8B  3  06                   .byte 6
003E8C  3  06                   .byte 6
003E8D  3  06                   .byte 6
003E8E  3  06                   .byte 6
003E8F  3  06                   .byte 6
003E90  3  06                   .byte 6
003E91  3  06                   .byte 6
003E92  3  00                   .byte 0
003E93  3  00                   .byte 0
003E94  3  00                   .byte 0
003E95  3  00                   .byte 0
003E96  3  00                   .byte 0
003E97  3  00                   .byte 0
003E98  3  00                   .byte 0
003E99  3  00                   .byte 0
003E9A  3  00                   .byte 0
003E9B  3  00                   .byte 0
003E9C  3  00                   .byte 0
003E9D  3  00                   .byte 0
003E9E  3  00                   .byte 0
003E9F  3  00                   .byte 0
003EA0  3  00                   .byte 0
003EA1  3  00                   .byte 0
003EA2  3  00                   .byte 0
003EA3  3  00                   .byte 0
003EA4  3  02                   .byte 2
003EA5  3  02                   .byte 2
003EA6  3  02                   .byte 2
003EA7  3               .out .sprintf("BLOCKS SIZE = %d", (* - chgfx))
003EA7  3               
003EA7  3               sprgfx:
003EA7  3  07 E0 08 10          .byte 7,224,8,16,18,8,20,8,20,240,17,80,17,88,9,120,7,224,2,0,5,224,2,232,6,104,7,128,0,112,3,128
003EAB  3  12 08 14 08  
003EAF  3  14 F0 11 50  
003EC7  3  07 E0 08 10          .byte 7,224,8,16,18,8,20,8,20,240,17,80,17,88,9,120,7,224,12,12,9,236,3,240,27,96,22,96,0,0,0,224
003ECB  3  12 08 14 08  
003ECF  3  14 F0 11 50  
003EE7  3  07 E0 08 10          .byte 7,224,8,16,18,8,20,8,20,240,17,80,17,88,9,120,55,224,54,24,16,232,3,228,3,236,11,216,13,16,6,0
003EEB  3  12 08 14 08  
003EEF  3  14 F0 11 50  
003F07  3  07 E0 08 10          .byte 7,224,8,16,16,72,16,40,15,40,10,136,26,136,30,144,7,224,0,64,7,160,23,64,22,96,1,224,14,0,1,192
003F0B  3  10 48 10 28  
003F0F  3  0F 28 0A 88  
003F27  3  07 E0 08 10          .byte 7,224,8,16,16,72,16,40,15,40,10,136,26,136,30,144,7,224,48,48,55,144,15,192,6,216,6,104,0,0,7,0
003F2B  3  10 48 10 28  
003F2F  3  0F 28 0A 88  
003F47  3  07 E0 08 10          .byte 7,224,8,16,16,72,16,40,15,40,10,136,26,136,30,144,7,236,24,108,23,8,39,192,55,192,27,208,8,176,0,96
003F4B  3  10 48 10 28  
003F4F  3  0F 28 0A 88  
003F67  3  00 00 20 FC          .byte 0,0,32,252,49,2,50,65,110,129,36,190,18,42,9,171,4,175,6,92,7,192,7,96,3,252,0,242,0,100,0,24
003F6B  3  31 02 32 41  
003F6F  3  6E 81 24 BE  
003F87  3  01 F8 02 04          .byte 1,248,2,4,4,130,5,2,5,60,4,84,4,86,7,222,2,120,4,192,9,64,19,232,63,244,115,228,0,200,0,112
003F8B  3  04 82 05 02  
003F8F  3  05 3C 04 54  
003FA7  3  01 F8 02 04          .byte 1,248,2,4,4,130,5,2,5,60,4,84,4,86,7,222,127,120,240,192,41,64,7,232,7,244,3,228,0,200,0,112
003FAB  3  04 82 05 02  
003FAF  3  05 3C 04 54  
003FC7  3  00 00 3F 04          .byte 0,0,63,4,64,140,130,76,129,118,125,36,84,72,213,144,245,32,58,96,3,224,6,224,63,192,79,0,38,0,24,0
003FCB  3  40 8C 82 4C  
003FCF  3  81 76 7D 24  
003FE7  3  1F 80 20 40          .byte 31,128,32,64,65,32,64,160,60,160,42,32,106,32,123,224,30,64,3,32,2,144,23,200,47,252,39,206,19,0,14,0
003FEB  3  41 20 40 A0  
003FEF  3  3C A0 2A 20  
004007  3  1F 80 20 40          .byte 31,128,32,64,65,32,64,160,60,160,42,32,106,32,123,224,30,254,3,15,2,148,23,224,47,224,39,192,19,0,14,0
00400B  3  41 20 40 A0  
00400F  3  3C A0 2A 20  
004027  3  03 E0 04 10          .byte 3,224,4,16,8,40,8,8,7,240,2,160,2,160,7,240,11,232,17,196,18,36,52,22,46,58,19,228,10,40,6,48
00402B  3  08 28 08 08  
00402F  3  07 F0 02 A0  
004047  3  00 00 03 E0          .byte 0,0,3,224,4,16,8,40,8,8,7,240,122,175,42,170,19,228,9,200,28,28,38,50,36,18,18,36,11,232,6,48
00404B  3  04 10 08 28  
00404F  3  08 08 07 F0  
004067  3  00 00 00 00          .byte 0,0,0,0,3,224,4,16,8,40,8,8,7,240,14,184,18,164,35,226,77,217,118,55,36,18,18,36,11,232,6,48
00406B  3  03 E0 04 10  
00406F  3  08 28 08 08  
004087  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,192,7,240,11,152,45,172,54,236,58,158,29,126
00408B  3  00 00 00 00  
00408F  3  00 00 00 00  
0040A7  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,5,224,14,248,38,204,195,86,119,118,161,79,179,127,81,111,43,111,54,247,29,254
0040AB  3  00 00 00 00  
0040AF  3  00 00 05 E0  
0040C7  3  00 80 02 B0          .byte 0,128,2,176,0,188,2,190,0,83,1,85,64,93,129,83,160,95,200,109,242,237,119,219,31,62,0,254,31,204,53,228
0040CB  3  00 BC 02 BE  
0040CF  3  00 53 01 55  
0040E7  3  01 08 01 08          .byte 1,8,1,8,3,216,7,176,8,194,53,230,254,54,32,43,24,92,7,48,3,104,1,152,9,240,14,224,7,0,0,0
0040EB  3  03 D8 07 B0  
0040EF  3  08 C2 35 E6  
004107  3  01 08 01 08          .byte 1,8,1,8,3,216,7,176,8,192,53,224,254,48,32,32,24,86,7,55,3,100,1,152,9,240,14,224,7,0,0,0
00410B  3  03 D8 07 B0  
00410F  3  08 C0 35 E0  
004127  3  01 08 01 08          .byte 1,8,1,8,3,216,7,176,8,192,53,224,254,48,32,32,24,112,7,56,3,157,1,203,9,246,14,228,7,0,0,0
00412B  3  03 D8 07 B0  
00412F  3  08 C0 35 E0  
004147  3  10 80 10 80          .byte 16,128,16,128,27,192,13,224,67,16,103,172,108,127,212,4,58,24,12,224,22,192,25,128,15,144,7,112,0,224,0,0
00414B  3  1B C0 0D E0  
00414F  3  43 10 67 AC  
004167  3  10 80 10 80          .byte 16,128,16,128,27,192,13,224,3,16,7,172,12,127,4,4,106,24,236,224,38,192,25,128,15,144,7,112,0,224,0,0
00416B  3  1B C0 0D E0  
00416F  3  03 10 07 AC  
004187  3  10 80 10 80          .byte 16,128,16,128,27,192,13,224,3,16,7,172,12,127,4,4,14,24,28,224,185,192,211,128,111,144,39,112,0,224,0,0
00418B  3  1B C0 0D E0  
00418F  3  03 10 07 AC  
0041A7  3  00 01 00 01          .byte 0,1,0,1,0,123,0,246,1,24,6,188,31,198,4,4,3,12,0,246,0,66,0,132,1,30,1,60,1,226,0,124
0041AB  3  00 7B 00 F6  
0041AF  3  01 18 06 BC  
0041C7  3  00 00 00 01          .byte 0,0,0,1,0,1,0,123,0,246,1,24,6,188,31,198,4,4,3,12,0,246,56,66,116,142,125,28,125,226,56,124
0041CB  3  00 01 00 7B  
0041CF  3  00 F6 01 18  
0041E7  3  00 01 00 01          .byte 0,1,0,1,0,123,0,246,1,24,6,188,31,198,4,4,3,12,61,246,122,66,253,132,253,30,255,60,126,226,60,124
0041EB  3  00 7B 00 F6  
0041EF  3  01 18 06 BC  
004207  3  00 00 00 20          .byte 0,0,0,32,15,160,31,96,34,216,104,156,124,126,225,254,141,62,130,198,1,216,1,156,2,12,3,0,2,0,0,0
00420B  3  0F A0 1F 60  
00420F  3  22 D8 68 9C  
004227  3  00 00 10 00          .byte 0,0,16,0,25,192,15,32,6,180,11,52,105,204,68,112,210,32,218,32,191,208,31,216,31,188,15,20,6,4,0,0
00422B  3  19 C0 0F 20  
00422F  3  06 B4 0B 34  
004247  3  00 00 10 00          .byte 0,0,16,0,25,192,15,32,6,180,11,52,105,204,68,112,210,34,218,70,191,187,31,184,31,208,15,0,6,0,0,0
00424B  3  19 C0 0F 20  
00424F  3  06 B4 0B 34  
004267  3  00 00 00 00          .byte 0,0,0,0,0,0,3,224,6,176,6,176,11,104,25,204,9,72,4,144,3,96,0,128,11,232,4,16,0,0,0,0
00426B  3  00 00 03 E0  
00426F  3  06 B0 06 B0  
004287  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,5,64,4,0,8,32,9,64,4,64,0,0,4,64,5,64,5,64,4,64
00428B  3  00 00 00 00  
00428F  3  00 00 00 00  
0042A7  3  00 10 18 38          .byte 0,16,24,56,24,100,36,64,6,64,0,0,5,80,20,0,8,32,9,64,4,64,0,0,5,64,4,64,0,0,0,0
0042AB  3  18 64 24 40  
0042AF  3  06 40 00 00  
0042C7  3  60 16 90 01          .byte 96,22,144,1,192,13,40,34,0,0,0,0,96,6,144,9,136,17,64,6,0,2,0,0,0,0,0,0,0,0,0,0
0042CB  3  C0 0D 28 22  
0042CF  3  00 00 00 00  
0042E7  3  00 00 07 C0          .byte 0,0,7,192,24,48,32,8,64,100,64,20,128,10,128,10,128,2,144,2,80,4,72,4,32,8,24,48,7,192,0,0
0042EB  3  18 30 20 08  
0042EF  3  40 64 40 14  
004307  3  0F E0 10 10          .byte 15,224,16,16,32,8,64,100,64,20,128,10,128,10,128,10,160,2,160,2,144,2,80,4,72,4,32,8,24,48,7,192
00430B  3  20 08 40 64  
00430F  3  40 14 80 0A  
004327  3  04 20 06 60          .byte 4,32,6,96,114,78,16,8,0,0,192,3,96,6,0,0,0,0,96,6,192,3,0,0,16,8,114,78,6,96,4,32
00432B  3  72 4E 10 08  
00432F  3  00 00 C0 03  
004347  3               frmlst:
004347  3  00 03                .byte 0,3
004349  3  03 03                .byte 3,3
00434B  3  06 03                .byte 6,3
00434D  3  09 03                .byte 9,3
00434F  3  0C 03                .byte 12,3
004351  3  0F 03                .byte 15,3
004353  3  12 03                .byte 18,3
004355  3  15 03                .byte 21,3
004357  3  18 03                .byte 24,3
004359  3  1B 01                .byte 27,1
00435B  3  1C 02                .byte 28,2
00435D  3  1E 01                .byte 30,1
00435F  3  1F 03                .byte 31,3
004361  3  22 03 25 00          .byte 34,3,37,0
004365  3               .out .sprintf("SPRITES SIZE = %d", (* - sprgfx))
004365  3               
004365  3               scdat:
004365  3  7B 00 C6 00          .word 123,198
004369  3  FF 00 50 17          .byte 255,0,80,23,255,0,5,23,255,0,6,23,255,0,5,23,255,0,4,7,8,9,10,255,0,26,11,12,13,14,255,0,26
00436D  3  FF 00 05 17  
004371  3  FF 00 06 17  
00438A  3  0F 10 11 12          .byte 15,16,17,18,255,0,26,19,20,21,22,255,0,5,23,255,0,8,23,255,0,34,23,255,0,12,23,255,0,5,23,255,0,102
00438E  3  FF 00 1A 13  
004392  3  14 15 16 FF  
0043AC  3  FF 01 0E FF          .byte 255,1,14,255,0,10,23,255,0,5,6,255,5,12,6,255,0,4,23,255,0,70,23,255,0,8,23,255,0,6,23,255,0,48
0043B0  3  00 0A 17 FF  
0043B4  3  00 05 06 FF  
0043CE  3  17 FF 00 4C          .byte 23,255,0,76,255,1,8,255,0,16,255,1,6,255,2,8,255,4,16,255,2,6
0043D2  3  FF 01 08 FF  
0043D6  3  00 10 FF 01  
0043E4  3  FF 00 50 17          .byte 255,0,80,23,255,0,5,23,255,0,6,23,255,0,5,23,255,0,29,1,1,255,0,11,1,1,1,255,0,7,7,8,9
0043E8  3  FF 00 05 17  
0043EC  3  FF 00 06 17  
004405  3  0A 00 00 00          .byte 10,0,0,0,5,5,255,0,11,5,41,5,255,0,7,11,12,13,14,255,0,17,42,255,0,8,15,16,17,18,255,0,17
004409  3  05 05 FF 00  
00440D  3  0B 05 29 05  
004426  3  2B FF 00 08          .byte 43,255,0,8,19,20,21,22,0,23,255,0,12,23,255,0,5,23,255,0,18,1,1,1,255,0,27,5,41,5,255,0,28
00442A  3  13 14 15 16  
00442E  3  00 17 FF 00  
004447  3  2A FF 00 1D          .byte 42,255,0,29,43,255,0,16,23,255,0,4,1,1,1,255,0,10,7,8,9,10,0,0,23,255,0,10,5,41,5,255,0,10
00444B  3  2B FF 00 10  
00444F  3  17 FF 00 04  
004469  3  0B 0C 0D 0E          .byte 11,12,13,14,255,0,14,42,255,0,11,15,16,17,18,255,0,13,23,43,255,0,7,23,0,0,0,19,20,21,22,255,0,48
00446D  3  FF 00 0E 2A  
004471  3  FF 00 0B 0F  
00448B  3  17 FF 01 04          .byte 23,255,1,4,255,0,26,255,5,4,255,0,42,255,1,8,255,0,16,255,1,6,255,2,8,255,4,16,255,2,6
00448F  3  FF 00 1A FF  
004493  3  05 04 FF 00  
0044AA  3               numsc:
0044AA  3  02                   .byte 2
0044AB  3               .out .sprintf("SCREENS SIZE = %d", (* - scdat))
0044AB  3               
0044AB  3               nmedat:
0044AB  3  00 00 98 08          .byte 0,0,152,8,8,8,80,120,8,8,80,72,8,8,80,168,8,8,152,208,8,8,152,40,255
0044AF  3  08 08 50 78  
0044B3  3  08 08 50 48  
0044C4  3  00 00 98 08          .byte 0,0,152,8,8,8,16,72,8,8,16,176,8,8,56,120,8,8,88,64,8,8,128,120,255
0044C8  3  08 08 10 48  
0044CC  3  08 08 10 B0  
0044DD  3               .out .sprintf("POSITIONS SIZE = %d", (* - nmedat))
0044DD  3               
0044DD  3               NUMOBJ = 34
0044DD  3               objdta:
0044DD  3  00 00 00 00          .byte 0,0,0,0,30,56,59,124,125,174,125,182,255,214,255,222,255,222,255,220,127,188,63,120,30,240,8,32,4,64,2,128,255,80,88,255,80,88
0044E1  3  1E 38 3B 7C  
0044E5  3  7D AE 7D B6  
004503  3  00 00 1E 00          .byte 0,0,30,0,59,0,125,184,125,188,255,204,255,214,255,214,255,222,127,158,63,60,30,124,9,248,8,240,4,64,2,128,255,8,8,255,8,8
004507  3  3B 00 7D B8  
00450B  3  7D BC FF CC  
004529  3  00 00 1E 00          .byte 0,0,30,0,59,0,125,128,125,128,255,192,255,192,255,192,255,192,127,128,63,0,30,0,8,0,8,0,4,0,2,0,255,0,0,255,0,0
00452D  3  3B 00 7D 80  
004531  3  7D 80 FF C0  
00454F  3  00 00 00 F0          .byte 0,0,0,240,1,216,3,188,3,188,7,254,7,254,7,254,7,254,3,252,1,248,0,240,0,32,0,64,0,128,0,128,255,64,112,255,64,112
004553  3  01 D8 03 BC  
004557  3  03 BC 07 FE  
004575  3  00 00 03 C0          .byte 0,0,3,192,7,224,15,176,15,208,31,216,31,248,31,248,31,248,15,240,7,224,7,224,3,192,1,0,0,128,1,0,255,64,144,255,64,144
004579  3  07 E0 0F B0  
00457D  3  0F D0 1F D8  
00459B  3  00 00 03 C0          .byte 0,0,3,192,7,224,15,176,15,208,31,216,31,248,31,248,31,248,15,240,7,224,7,224,3,192,1,0,0,128,1,0,255,0,0,255,0,0
00459F  3  07 E0 0F B0  
0045A3  3  0F D0 1F D8  
0045C1  3  00 00 03 C0          .byte 0,0,3,192,7,224,15,176,15,208,31,216,31,248,31,248,31,248,15,240,7,224,7,224,3,192,1,0,0,128,1,0,255,0,0,255,0,0
0045C5  3  07 E0 0F B0  
0045C9  3  0F D0 1F D8  
0045E7  3  00 00 03 C0          .byte 0,0,3,192,7,224,15,176,15,208,31,216,31,248,31,248,31,248,15,240,7,224,7,224,3,192,1,0,0,128,1,0,255,0,0,255,0,0
0045EB  3  07 E0 0F B0  
0045EF  3  0F D0 1F D8  
00460D  3  00 00 03 C0          .byte 0,0,3,192,7,224,15,176,15,208,31,216,31,248,31,248,31,248,15,240,7,224,7,224,3,192,1,0,0,128,1,0,255,0,0,255,0,0
004611  3  07 E0 0F B0  
004615  3  0F D0 1F D8  
004633  3  00 00 03 C0          .byte 0,0,3,192,7,224,15,176,15,208,31,216,31,248,31,248,31,248,15,240,7,224,7,224,3,192,1,0,0,128,1,0,255,0,0,255,0,0
004637  3  07 E0 0F B0  
00463B  3  0F D0 1F D8  
004659  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,5,64,27,176,55,216,119,220,111,236,239,238,144,18,110,236,17,16,9,32,5,64,255,0,0,255,0,0
00465D  3  00 00 00 00  
004661  3  00 00 05 40  
00467F  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,5,64,27,176,55,216,119,220,111,236,239,238,144,18,110,236,17,16,9,32,5,64,255,0,0,255,0,0
004683  3  00 00 00 00  
004687  3  00 00 05 40  
0046A5  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,5,64,27,176,55,216,119,220,111,236,239,238,144,18,110,236,17,16,9,32,5,64,255,0,0,255,0,0
0046A9  3  00 00 00 00  
0046AD  3  00 00 05 40  
0046CB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,5,64,27,176,55,216,119,220,111,236,239,238,144,18,110,236,17,16,9,32,5,64,255,0,0,255,0,0
0046CF  3  00 00 00 00  
0046D3  3  00 00 05 40  
0046F1  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,5,64,27,176,55,216,119,220,111,236,239,238,144,18,110,236,17,16,9,32,5,64,255,0,0,255,0,0
0046F5  3  00 00 00 00  
0046F9  3  00 00 05 40  
004717  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,5,64,27,176,55,216,119,220,111,236,239,238,144,18,110,236,17,16,9,32,5,64,255,0,0,255,0,0
00471B  3  00 00 00 00  
00471F  3  00 00 05 40  
00473D  3  00 00 00 00          .byte 0,0,0,0,0,0,3,224,6,176,6,176,11,104,25,204,9,72,4,144,3,96,0,128,11,232,4,16,0,0,0,0,255,0,0,255,0,0
004741  3  00 00 03 E0  
004745  3  06 B0 06 B0  
004763  3  00 00 03 C0          .byte 0,0,3,192,5,96,10,176,13,80,26,168,21,88,26,168,21,88,26,168,13,80,10,176,5,96,2,192,1,128,1,0,255,32,24,255,32,24
004767  3  05 60 0A B0  
00476B  3  0D 50 1A A8  
004789  3  00 00 03 C0          .byte 0,0,3,192,4,32,8,16,8,80,16,40,16,40,16,8,16,8,16,8,8,16,8,16,4,32,2,64,1,128,1,0,255,0,0,255,0,0
00478D  3  04 20 08 10  
004791  3  08 50 10 28  
0047AF  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
0047B3  3  00 00 00 00  
0047B7  3  00 00 00 00  
0047D5  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
0047D9  3  00 00 00 00  
0047DD  3  00 00 00 00  
0047FB  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
0047FF  3  00 00 00 00  
004803  3  00 00 00 00  
004821  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
004825  3  00 00 00 00  
004829  3  00 00 00 00  
004847  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
00484B  3  00 00 00 00  
00484F  3  00 00 00 00  
00486D  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
004871  3  00 00 00 00  
004875  3  00 00 00 00  
004893  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
004897  3  00 00 00 00  
00489B  3  00 00 00 00  
0048B9  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
0048BD  3  00 00 00 00  
0048C1  3  00 00 00 00  
0048DF  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
0048E3  3  00 00 00 00  
0048E7  3  00 00 00 00  
004905  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,59,184,34,168,58,168,10,168,59,184,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
004909  3  00 00 00 00  
00490D  3  3B B8 22 A8  
00492B  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,59,184,10,40,11,168,8,168,11,184,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
00492F  3  00 00 00 00  
004933  3  3B B8 0A 28  
004951  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,46,238,42,170,42,170,42,170,46,238,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
004955  3  00 00 00 00  
004959  3  2E EE 2A AA  
004977  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,46,238,40,170,46,170,34,170,46,238,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
00497B  3  00 00 00 00  
00497F  3  2E EE 28 AA  
00499D  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,238,238,42,170,234,170,138,170,238,238,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
0049A1  3  00 00 00 00  
0049A5  3  EE EE 2A AA  
0049C3  3  00 00 00 00          .byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,255,0,0
0049C7  3  00 00 00 00  
0049CB  3  00 00 00 00  
0049E9  3               .out .sprintf("OBJECTS SIZE = %d", (* - objdta))
0049E9  3               
0049E9  3               font:
0049E9  3  87 3E 02 CD          .byte 135,62,2,205,153,128,205,158
0049ED  3  99 80 CD 9E  
0049F1  3  87 C9 C9 C9          .byte 135,201,201,201,201,201,0,24
0049F5  3  C9 C9 00 18  
0049F9  3  6C 6C 6C 00          .byte 108,108,108,0,0,0,0,0
0049FD  3  00 00 00 00  
004A01  3  6C 6C FE 6C          .byte 108,108,254,108,254,108,108,0
004A05  3  FE 6C 6C 00  
004A09  3  30 7C C0 78          .byte 48,124,192,120,12,248,48,0
004A0D  3  0C F8 30 00  
004A11  3  00 C6 CC 18          .byte 0,198,204,24,48,102,198,0
004A15  3  30 66 C6 00  
004A19  3  38 6C 38 76          .byte 56,108,56,118,220,204,118,0
004A1D  3  DC CC 76 00  
004A21  3  60 60 C0 00          .byte 96,96,192,0,0,0,0,0
004A25  3  00 00 00 00  
004A29  3  18 30 60 60          .byte 24,48,96,96,96,48,24,0
004A2D  3  60 30 18 00  
004A31  3  60 30 18 18          .byte 96,48,24,24,24,48,96,0
004A35  3  18 30 60 00  
004A39  3  00 66 3C FF          .byte 0,102,60,255,60,102,0,0
004A3D  3  3C 66 00 00  
004A41  3  00 30 30 FC          .byte 0,48,48,252,48,48,0,0
004A45  3  30 30 00 00  
004A49  3  00 00 00 00          .byte 0,0,0,0,0,48,48,96
004A4D  3  00 30 30 60  
004A51  3  00 00 00 FC          .byte 0,0,0,252,0,0,0,0
004A55  3  00 00 00 00  
004A59  3  00 00 00 00          .byte 0,0,0,0,0,48,48,0
004A5D  3  00 30 30 00  
004A61  3  06 0C 18 30          .byte 6,12,24,48,96,192,128,0
004A65  3  60 C0 80 00  
004A69  3  38 4C C6 C6          .byte 56,76,198,198,198,100,56,0
004A6D  3  C6 64 38 00  
004A71  3  18 38 18 18          .byte 24,56,24,24,24,24,126,0
004A75  3  18 18 7E 00  
004A79  3  7C C6 0E 3C          .byte 124,198,14,60,120,224,254,0
004A7D  3  78 E0 FE 00  
004A81  3  7E 0C 18 3C          .byte 126,12,24,60,6,198,124,0
004A85  3  06 C6 7C 00  
004A89  3  1C 3C 6C CC          .byte 28,60,108,204,254,12,12,0
004A8D  3  FE 0C 0C 00  
004A91  3  FC C0 FC 06          .byte 252,192,252,6,6,198,124,0
004A95  3  06 C6 7C 00  
004A99  3  3C 60 C0 FC          .byte 60,96,192,252,198,198,124,0
004A9D  3  C6 C6 7C 00  
004AA1  3  FE C6 0C 18          .byte 254,198,12,24,48,48,48,0
004AA5  3  30 30 30 00  
004AA9  3  7C C6 C6 7C          .byte 124,198,198,124,198,198,124,0
004AAD  3  C6 C6 7C 00  
004AB1  3  7C C6 C6 7E          .byte 124,198,198,126,6,12,120,0
004AB5  3  06 0C 78 00  
004AB9  3  00 30 30 00          .byte 0,48,48,0,0,48,48,0
004ABD  3  00 30 30 00  
004AC1  3  00 30 30 00          .byte 0,48,48,0,0,48,48,96
004AC5  3  00 30 30 60  
004AC9  3  18 30 60 C0          .byte 24,48,96,192,96,48,24,0
004ACD  3  60 30 18 00  
004AD1  3  00 00 FC 00          .byte 0,0,252,0,0,252,0,0
004AD5  3  00 FC 00 00  
004AD9  3  60 30 18 0C          .byte 96,48,24,12,24,48,96,0
004ADD  3  18 30 60 00  
004AE1  3  78 CC 0C 18          .byte 120,204,12,24,48,0,48,0
004AE5  3  30 00 30 00  
004AE9  3  7C C6 DE DE          .byte 124,198,222,222,222,192,120,0
004AED  3  DE C0 78 00  
004AF1  3  38 6C C6 C6          .byte 56,108,198,198,254,198,198,0
004AF5  3  FE C6 C6 00  
004AF9  3  FC C6 C6 FC          .byte 252,198,198,252,198,198,252,0
004AFD  3  C6 C6 FC 00  
004B01  3  3C 66 C0 C0          .byte 60,102,192,192,192,102,60,0
004B05  3  C0 66 3C 00  
004B09  3  F8 CC C6 C6          .byte 248,204,198,198,198,204,248,0
004B0D  3  C6 CC F8 00  
004B11  3  FE C0 C0 FC          .byte 254,192,192,252,192,192,254,0
004B15  3  C0 C0 FE 00  
004B19  3  FE C0 C0 FC          .byte 254,192,192,252,192,192,192,0
004B1D  3  C0 C0 C0 00  
004B21  3  3E 60 C0 CE          .byte 62,96,192,206,198,102,62,0
004B25  3  C6 66 3E 00  
004B29  3  C6 C6 C6 FE          .byte 198,198,198,254,198,198,198,0
004B2D  3  C6 C6 C6 00  
004B31  3  7E 18 18 18          .byte 126,24,24,24,24,24,126,0
004B35  3  18 18 7E 00  
004B39  3  1E 06 06 06          .byte 30,6,6,6,198,198,124,0
004B3D  3  C6 C6 7C 00  
004B41  3  C6 CC D8 F0          .byte 198,204,216,240,248,220,206,0
004B45  3  F8 DC CE 00  
004B49  3  60 60 60 60          .byte 96,96,96,96,96,96,126,0
004B4D  3  60 60 7E 00  
004B51  3  C6 EE FE FE          .byte 198,238,254,254,214,198,198,0
004B55  3  D6 C6 C6 00  
004B59  3  C6 E6 F6 FE          .byte 198,230,246,254,222,206,198,0
004B5D  3  DE CE C6 00  
004B61  3  7C C6 C6 C6          .byte 124,198,198,198,198,198,124,0
004B65  3  C6 C6 7C 00  
004B69  3  FC C6 C6 C6          .byte 252,198,198,198,252,192,192,0
004B6D  3  FC C0 C0 00  
004B71  3  7C C6 C6 C6          .byte 124,198,198,198,222,204,122,0
004B75  3  DE CC 7A 00  
004B79  3  FC C6 C6 CE          .byte 252,198,198,206,248,220,206,0
004B7D  3  F8 DC CE 00  
004B81  3  78 CC C0 7C          .byte 120,204,192,124,6,198,124,0
004B85  3  06 C6 7C 00  
004B89  3  7E 18 18 18          .byte 126,24,24,24,24,24,24,0
004B8D  3  18 18 18 00  
004B91  3  C6 C6 C6 C6          .byte 198,198,198,198,198,198,124,0
004B95  3  C6 C6 7C 00  
004B99  3  C6 C6 C6 EE          .byte 198,198,198,238,124,56,16,0
004B9D  3  7C 38 10 00  
004BA1  3  C6 C6 D6 FE          .byte 198,198,214,254,254,238,198,0
004BA5  3  FE EE C6 00  
004BA9  3  C6 EE 7C 38          .byte 198,238,124,56,124,238,198,0
004BAD  3  7C EE C6 00  
004BB1  3  66 66 66 3C          .byte 102,102,102,60,24,24,24,0
004BB5  3  18 18 18 00  
004BB9  3  FE 0E 1C 38          .byte 254,14,28,56,112,224,254,0
004BBD  3  70 E0 FE 00  
004BC1  3  78 60 60 60          .byte 120,96,96,96,96,96,120,0
004BC5  3  60 60 78 00  
004BC9  3  C0 60 30 18          .byte 192,96,48,24,12,6,2,0
004BCD  3  0C 06 02 00  
004BD1  3  78 18 18 18          .byte 120,24,24,24,24,24,120,0
004BD5  3  18 18 78 00  
004BD9  3  10 38 6C C6          .byte 16,56,108,198,0,0,0,0
004BDD  3  00 00 00 00  
004BE1  3  00 00 00 00          .byte 0,0,0,0,0,0,0,255
004BE5  3  00 00 00 FF  
004BE9  3  30 30 18 00          .byte 48,48,24,0,0,0,0,0
004BED  3  00 00 00 00  
004BF1  3  00 00 3C 66          .byte 0,0,60,102,102,102,59,0
004BF5  3  66 66 3B 00  
004BF9  3  60 60 7C 66          .byte 96,96,124,102,102,102,124,0
004BFD  3  66 66 7C 00  
004C01  3  00 00 3E 60          .byte 0,0,62,96,96,96,62,0
004C05  3  60 60 3E 00  
004C09  3  06 06 3E 66          .byte 6,6,62,102,102,102,62,0
004C0D  3  66 66 3E 00  
004C11  3  00 00 3C 66          .byte 0,0,60,102,126,96,62,0
004C15  3  7E 60 3E 00  
004C19  3  0E 18 18 7E          .byte 14,24,24,126,24,24,24,0
004C1D  3  18 18 18 00  
004C21  3  00 00 3E 66          .byte 0,0,62,102,102,62,6,60
004C25  3  66 3E 06 3C  
004C29  3  60 60 60 7C          .byte 96,96,96,124,102,102,102,0
004C2D  3  66 66 66 00  
004C31  3  00 18 00 18          .byte 0,24,0,24,24,24,24,0
004C35  3  18 18 18 00  
004C39  3  00 06 00 06          .byte 0,6,0,6,6,6,102,60
004C3D  3  06 06 66 3C  
004C41  3  60 60 62 64          .byte 96,96,98,100,104,124,102,0
004C45  3  68 7C 66 00  
004C49  3  18 18 18 18          .byte 24,24,24,24,24,24,24,0
004C4D  3  18 18 18 00  
004C51  3  00 00 76 6B          .byte 0,0,118,107,107,107,107,0
004C55  3  6B 6B 6B 00  
004C59  3  00 00 7C 66          .byte 0,0,124,102,102,102,102,0
004C5D  3  66 66 66 00  
004C61  3  00 00 3C 66          .byte 0,0,60,102,102,102,60,0
004C65  3  66 66 3C 00  
004C69  3  00 00 7C 66          .byte 0,0,124,102,102,124,96,96
004C6D  3  66 7C 60 60  
004C71  3  00 00 3E 66          .byte 0,0,62,102,102,62,6,6
004C75  3  66 3E 06 06  
004C79  3  00 00 6E 70          .byte 0,0,110,112,96,96,96,0
004C7D  3  60 60 60 00  
004C81  3  00 00 3C 40          .byte 0,0,60,64,60,6,124,0
004C85  3  3C 06 7C 00  
004C89  3  30 30 FC 30          .byte 48,48,252,48,48,48,28,0
004C8D  3  30 30 1C 00  
004C91  3  00 00 66 66          .byte 0,0,102,102,102,102,60,0
004C95  3  66 66 3C 00  
004C99  3  00 00 66 66          .byte 0,0,102,102,102,36,24,0
004C9D  3  66 24 18 00  
004CA1  3  00 00 63 6B          .byte 0,0,99,107,107,107,54,0
004CA5  3  6B 6B 36 00  
004CA9  3  00 00 63 36          .byte 0,0,99,54,28,54,99,0
004CAD  3  1C 36 63 00  
004CB1  3  00 00 66 66          .byte 0,0,102,102,44,24,48,96
004CB5  3  2C 18 30 60  
004CB9  3  00 00 7E 0C          .byte 0,0,126,12,24,48,126,0
004CBD  3  18 30 7E 00  
004CC1  3  1C 30 30 E0          .byte 28,48,48,224,48,48,28,0
004CC5  3  30 30 1C 00  
004CC9  3  18 18 18 00          .byte 24,24,24,0,24,24,24,0
004CCD  3  18 18 18 00  
004CD1  3  E0 30 30 1C          .byte 224,48,48,28,48,48,224,0
004CD5  3  30 30 E0 00  
004CD9  3  76 DC 00 00          .byte 118,220,0,0,0,0,0,0
004CDD  3  00 00 00 00  
004CE1  3  00 10 38 6C          .byte 0,16,56,108,198,198,254,0
004CE5  3  C6 C6 FE 00  
004CE9  3               .out .sprintf("FONT SIZE = %d", (* - font))
004CE9  3               
004CE9  3               jtab:
004CE9  3  63                   .byte 99
004CEA  3  42 61 68 48  keys:   .byte 66,97,104,72,98,16,55,48,49,17,18
004CEE  3  62 10 37 30  
004CF2  3  31 11 12     
004CF5  3               .out .sprintf("KEYS SIZE = %d", (* - keys))
004CF5  3               
004CF5  3               data_end:
004CF5  3               .out .sprintf("TOTAL DATA SIZE = %d", (* - data_start))
004CF5  3               
004CF5  2               
004CF5  1               
004CF5  1               end_asm:
004CF5  1               
004CF5  1               ;----------------------------------------------------------------------
004CF5  1               ; RELOCATION OF BEEB CODE FROM LOAD ADDRESS
004CF5  1               ;----------------------------------------------------------------------
004CF5  1               
004CF5  1               relocate:
004CF5  1               ; Issue *TAPE otherwise DFS goes mental that we've overwritten workspace from &E00 - &1100
004CF5  1               
004CF5  1  A9 8C            lda #$8C
004CF7  1  A2 0C            ldx #$0C
004CF9  1  A0 00            ldy #$00
004CFB  1  20 F4 FF         jsr OSBYTE					; *FX &8C,0,0 - *TAPE 1200
004CFE  1               
004CFE  1  78           	sei
004CFF  1  A9 7F        	lda #$7f
004D01  1  8D 4E FE     	sta $fe4e					; disable all interupts
004D04  1  A9 82        	lda #$82
004D06  1  8D 4E FE     	sta $fe4e					; enable vsync interupt only
004D09  1  58           	cli
004D0A  1               
004D0A  1               ; Other one off initialisation could happen here...
004D0A  1               
004D0A  1               ; Relocate all code down to &E00
004D0A  1  A2 3F        	ldx #>(end_asm - start_asm) + 1
004D0C  1  A0 00        	ldy #0
004D0E  1               reloop:
004D0E  1  B9 00 12     	lda load_address, y
004D11  1  99 00 0E     	sta asm_code, y
004D14  1  C8           	iny
004D15  1  D0 F7        	bne reloop
004D17  1  EE 10 51     	inc reloop + 2 + load_address - asm_code
004D1A  1  EE 13 51     	inc reloop + 5 + load_address - asm_code
004D1D  1  CA           	dex
004D1E  1  D0 EE        	bne reloop
004D20  1  4C 03 0E     	jmp boot_game
004D20  1               
